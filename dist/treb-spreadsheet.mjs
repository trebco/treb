/*! TREB v31.9.1. Copyright 2018-2024 trebco, llc. All rights reserved. LGPL: https://treb.app/license */
var no=Object.defineProperty;var oo=(l,e)=>{for(var t in e)no(l,t,{get:e[t],enumerable:!0})};var Ct=class{get list(){return this.sheets_.slice(0)}get length(){return this.sheets_.length}names=new Map;ids=new Map;sheets_=[];Assign(e){this.sheets_=[...e],this.UpdateIndexes()}Add(e){this.sheets_.push(e),this.UpdateIndexes()}Splice(e,t,...r){this.sheets_.splice(e,t,...r),this.UpdateIndexes()}Find(e){return typeof e=="string"?this.names.get(e.toLocaleUpperCase()):this.ids.get(e)}Name(e){return this.ids.get(e)?.name||void 0}ID(e){return this.names.get(e.toLocaleUpperCase())?.id||void 0}UpdateIndexes(){this.names.clear(),this.ids.clear();for(let e of this.sheets_){let t=e.name.toLocaleUpperCase();this.names.set(t,e),this.ids.set(e.id,e)}}};var wi={spreadsheet_semantics:!0,dimensioned_quantities:!1,fractions:!0,decimal_mark:".",argument_separator:",",boolean_true:"TRUE",boolean_false:"FALSE"};var xe=/[\s-+=<>!()]/,ki=/['*\\]/,xr=34,Cr=39,so=160,xi=32,ao=9,lo=10,co=13,Me=48,it=57,Sr=46,Ar=43,nt=45,Ci=40,kr=41,ot=44,uo=37,Rr=95,St=36,ho=123,mo=125,st=91,Si=93,fo=63,po=33,Ai=59,Er=35,bo=64,Je=65,at=97,go=69,_o=101,At=90,kt=122,yo=105,Tr=192,Mr=382,Ur={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},vo={"@":50,"-":100,"+":100},wo=[...Object.keys(Ur),"@"].sort((l,e)=>e.length-l.length),We=class{get argument_separator(){return this.flags.argument_separator}get decimal_mark(){return this.flags.decimal_mark}flags={...wi};r1c1_regex=/[rR]((?:\[[-+]{0,1}\d+\]|\d*))[cC]((?:\[[-+]{0,1}\d+\]|\d*))$/;argument_separator_char=ot;decimal_mark_char=Sr;imaginary_char=yo;imaginary_number="i";id_counter=0;expression="";data=[];index=0;length=0;valid=!0;error_position;error;dependencies={addresses:{},ranges:{}};address_refcount={};full_reference_list=[];parser_state_cache=[];SetLocaleSettings(e,t){if(typeof t>"u"&&(t=e===","?";":","),t===e)throw new Error("invalid locale setting");this.flags.argument_separator=t,this.flags.decimal_mark=e}Save(){this.parser_state_cache.push(JSON.stringify(this.flags))}Restore(){let e=this.parser_state_cache.shift();if(e)try{this.flags=JSON.parse(e)}catch(t){console.error(t)}else console.warn("No parser state to restore")}Walk2(e,t){let r=t(e);if(typeof r=="object")return r;switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":break;case"dimensioned":r&&(e.expression=this.Walk2(e.expression,t),e.unit=this.Walk2(e.unit,t));break;case"range":t(e)&&(e.start=this.Walk2(e.start,t),e.end=this.Walk2(e.end,t));break;case"binary":t(e)&&(e.left=this.Walk2(e.left,t),e.right=this.Walk2(e.right,t));break;case"unary":t(e)&&(e.operand=this.Walk2(e.operand,t));break;case"group":t(e)&&(e.elements=e.elements.map(i=>this.Walk2(i,t)));break;case"call":t(e)&&(e.args=e.args.map(i=>this.Walk2(i,t)));break}return e}Walk(e,t){switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":t(e);return;case"dimensioned":t(e)&&(this.Walk(e.expression,t),this.Walk(e.unit,t));return;case"range":t(e)&&(this.Walk(e.start,t),this.Walk(e.end,t));return;case"binary":t(e)&&(this.Walk(e.left,t),this.Walk(e.right,t));return;case"unary":t(e)&&this.Walk(e.operand,t);return;case"group":if(t(e))for(let r of e.elements)this.Walk(r,t);return;case"call":if(t(e))for(let r of e.args)this.Walk(r,t)}}Transpose(e){let t=e.length,r=[],i=0;for(let n=0;n<t;n++)Array.isArray(e[n])&&(i=Math.max(i,e[n].length));for(let n=0;n<i;n++){r[n]=[];for(let o=0;o<t;o++)r[n][o]=e[o]?e[o][n]:void 0}return r}Render(e,t={}){let r=t.offset||{rows:0,columns:0},i=t.missing??"(missing)",{convert_decimal:n,convert_argument_separator:o,long_structured_references:s,table_name:a}=t,c=this.flags.argument_separator+" ";o===","?c=", ":o===";"&&(c="; ");let d=n===","?",":".",u=this.flags.decimal_mark===","?/,/:/\./,h=this.flags.decimal_mark===","?/,/g:/\./g;switch(e.type){case"address":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e,t.r1c1_base):this.AddressLabel(e,r);case"range":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e.start,t.r1c1_base)+":"+this.R1C1Label(e.end,t.r1c1_base):this.AddressLabel(e.start,r)+":"+this.AddressLabel(e.end,r);case"missing":return i;case"array":return"{"+this.Transpose(e.values).map(m=>m.map(f=>typeof f=="string"?'"'+f+'"':f).join(", ")).join("; ")+"}";case"binary":return this.Render(e.left,t)+" "+e.operator+" "+this.Render(e.right,t);case"unary":return e.operator+this.Render(e.operand,t);case"complex":if(e.text)return n?e.text.replace(h,d):e.text;{let m=Math.abs(e.imaginary).toString();if((n===","||this.flags.decimal_mark===",")&&(m=m.replace(/\./,",")),e.real){let f=e.real.toString();(n===","||this.flags.decimal_mark===",")&&(f=f.replace(/\./,","));let p=Math.abs(e.imaginary);return`${f}${e.imaginary<0?" - ":" + "}${p===1?"":m}i`}else return e.imaginary===-1?"-i":e.imaginary===1?"i":`${e.imaginary<0?"-":""}${m}i`}break;case"literal":if(typeof e.value=="string")return'"'+e.value.replace(/"/g,'""')+'"';if(typeof e.value=="boolean")return e.value?t.boolean_true||this.flags.boolean_true||"true":t.boolean_false||this.flags.boolean_false||"false";if(n&&typeof e.value=="number")if(e.text){let m=e.text;return n===","&&this.flags.decimal_mark==="."&&(m=m.replace(/,/g,"")),m.replace(u,d)}else return e.value.toString().replace(/\./,d);else if(e.text)return e.text;return e.value.toString();case"identifier":return e.name;case"operator":return"["+e.operator+"]";case"group":return e.explicit?"("+e.elements.map(m=>this.Render(m,t)).join(c)+")":e.elements.map(m=>this.Render(m,t)).join(c);case"call":return e.name+"("+e.args.map(m=>this.Render(m,t)).join(c)+")";case"dimensioned":return this.Render(e.expression)+" "+this.Render(e.unit);case"structured-reference":{let m=e.column;/[^A-Za-z]/.test(m)&&(m="["+m+"]");let f=e.table;switch(!f&&s&&a&&(f=a),e.scope){case"all":return`${f}[[#all],${m}]`;case"row":return s?`${f}[[#this row],${m}]`:`${f}[@${m}]`;case"column":return`${f}[${m}]`}throw new Error("unhandled scope in structured reference")}}return"??"}Parse(e){switch(e=e.trim(),e[0]==="="&&(e=e.substr(1).trim()),this.expression=e,this.data=[],this.length=e.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.flags.argument_separator){case";":this.argument_separator_char=Ai;break;default:this.argument_separator_char=ot;break}switch(this.flags.decimal_mark){case",":this.decimal_mark_char=ot;break;default:this.decimal_mark_char=Sr;break}for(let i=0;i<this.length;i++)this.data[i]=e.charCodeAt(i);let t=this.ParseGeneric(),r={};for(let i of Object.keys(this.dependencies.addresses))this.address_refcount[i]&&(r[i]=this.dependencies.addresses[i]);return this.dependencies.addresses=r,{expression:t||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.flags.argument_separator,decimal_mark:this.flags.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(e){if(e===1/0)return"";let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}R1C1Label(e,t){let r="";e.sheet&&(r=(xe.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!");let i=e.absolute_row||!t?(e.row+1).toString():`[${e.row-t.row}]`,n=e.absolute_column||!t?(e.column+1).toString():`[${e.column-t.column}]`;return r+=`R${i}C${n}`,r}AddressLabel(e,t){let r=e.column;!e.absolute_column&&e.column!==1/0&&(r+=t.columns);let i=e.row;if(!e.absolute_row&&e.row!==1/0&&(i+=t.rows),i<0||r<0||i===1/0&&r===1/0)return"#REF";let n="";return e.sheet&&(n=(xe.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!"),i===1/0?n+(e.absolute_column?"$":"")+this.ColumnLabel(r):r===1/0?n+(e.absolute_row?"$":"")+(i+1):n+(e.absolute_column?"$":"")+this.ColumnLabel(r)+(e.absolute_row?"$":"")+(i+1)+(e.spill?"#":"")}ParseGeneric(e=[0]){let t=[];for(;this.index<this.length;){let r=this.ParseNext(t.length===0);if(typeof r=="number"){if(e.some(i=>r===i))break;if(r===Ci){this.index++;let i=this.ParseGeneric([kr]);this.index++,i&&t.push({type:"group",id:this.id_counter++,elements:[i],explicit:!0})}else{let i=this.ConsumeOperator();i?t.push(i):(this.error=`unexpected character [1]: ${String.fromCharCode(r)}, 0x${r.toString(16)}`,this.valid=!1,this.index++)}}else t.push(r)}if(t.length){if(t=this.BinaryToRange2(t),this.flags.fractions){let r=[],i=o=>o.type==="literal"&&typeof o.value=="number"&&o.value%1===0,n=0;for(;n<t.length-3;n++)if(i(t[n])&&i(t[n+1])&&t[n+2].type==="operator"&&t[n+2].operator==="/"&&i(t[n+3])){let o=t[n],s=t[n+1],a=t[n+3],c=(o.value<0?-1:1)*(s.value/a.value);n+=3,r.push({id:t[n].id,type:"literal",text:this.expression.substring(o.position,a.position+1),value:o.value+c,position:o.position})}else r.push(t[n]);for(;n<t.length;n++)r.push(t[n]);t=r}if(t=t.map(r=>r.type==="identifier"&&r.name===this.imaginary_number?{type:"complex",real:0,imaginary:1,position:r.position,text:r.name,id:this.id_counter++}:r),this.flags.dimensioned_quantities){let r=[],i;for(let n=0;n<t.length;n++){let o=t[n];if(!i)i=o;else if(o.type==="identifier"&&(i.type==="literal"||i.type==="group"||i.type==="call")){let s=o;for(;t[n+1]?.type==="identifier";)s.name+=" "+t[++n].name;r.push({type:"dimensioned",expression:i,unit:o,id:this.id_counter++}),i=void 0}else r.push(i),i=o}i&&r.push(i),t=r}}return t.length===0?null:t.length===1?t[0]:this.BinaryToComplex(this.ArrangeUnits(t))}UnitToAddress(e){if(e.type==="literal"){if(typeof e.value=="number"&&e.value>0&&!/\./.test(e.text||""))return{type:"address",position:e.position,label:e.value.toString(),row:e.value-1,id:this.id_counter++,column:1/0}}else{let t,r=e.name,i=r.split("!");if(i.length>1&&(t=i.slice(0,i.length-1).join("!"),r=r.substr(t.length+1),t[0]==="'"))if(t.length>1&&t[t.length-1]==="'")t=t.substr(1,t.length-2);else return;let n=r[0]==="$";r=(n?r.substr(1):r).toUpperCase();let o=Number(r);if(isNaN(o)){if(/[A-Z]{1,3}/.test(r)){let s=-1;for(let a=0;a<r.length;a++){let c=r[a].charCodeAt(0);s=26*(1+s)+(c-Je)}return{type:"address",position:e.position,absolute_column:n,label:e.name,column:s,id:this.id_counter++,row:1/0,sheet:t}}}else if(o>0&&o!==1/0&&!/\./.test(r))return{type:"address",position:e.position,absolute_row:n,label:e.name,row:o-1,id:this.id_counter++,column:1/0,sheet:t}}}BinaryToRange2(e){let t=[];for(let r=0;r<e.length;r++){let i=e[r],n=e[r+1],o=e[r+2],s,a="",c;if(i&&n&&o&&n.type==="operator"&&n.operator===":"){if(i.type==="address"&&o.type==="address"){let d=i.position+i.label.length,u=o.position;s={type:"range",id:this.id_counter++,position:i.position,start:i,end:o,label:i.label+this.expression.substring(d,u)+o.label},a=s.start.label+":"+s.end.label,this.address_refcount[s.start.label]--,this.address_refcount[s.end.label]--;let h=[i.position,o.position];this.full_reference_list=this.full_reference_list.filter(m=>m.position!==h[0]&&m.position!==h[1])}else if((i.type==="literal"||i.type==="identifier")&&(o.type==="literal"||o.type==="identifier")){let d=this.UnitToAddress(i);if(!d&&i.type==="literal"&&typeof i.value=="number"&&i.value<0){let h={...i,text:(i.text||"").replace(/^-/,""),position:i.position+1,value:-i.value};d=this.UnitToAddress(h),d&&(c={type:"operator",operator:"-",position:i.position,id:this.id_counter++})}let u=this.UnitToAddress(o);d&&u&&(d.column===1/0&&u.column===1/0||d.row===1/0&&u.row===1/0)&&(a=d.label+":"+u.label,s={type:"range",id:this.id_counter++,position:d.position,start:d,end:u,label:a})}}s?(c&&t.push(c),t.push(s),this.dependencies.ranges[a]=s,this.full_reference_list.push(s),r+=2):t.push(i)}return t}BinaryToComplex(e){if(e.type==="binary")if((e.operator==="+"||e.operator==="-")&&e.left.type==="literal"&&typeof e.left.value=="number"&&e.right.type==="complex"&&!e.right.composited){let t="";t=this.expression.substring(e.left.position,e.right.position+(e.right.text?.length||0));let r=e.right.imaginary;return e.operator==="-"&&(r=-r),{type:"complex",position:e.left.position,text:t,id:this.id_counter++,imaginary:r,real:e.left.value,composited:!0}}else e.left=this.BinaryToComplex(e.left),e.right=this.BinaryToComplex(e.right);else if(e.type==="unary"&&(e.operator==="-"||e.operator==="+")&&e.operand.type==="complex"&&e.operand.text===this.imaginary_number)return{...e.operand,position:e.position,text:this.expression.substring(e.position,e.operand.position+(e.operand.text||"").length),imaginary:e.operand.imaginary*(e.operator==="-"?-1:1)};return e}BinaryToRangeX(e){if(e.type==="binary"){if(e.operator===":"){let t,r="";if(e.left.type==="address"&&e.right.type==="address"){let i=e.left.position+e.left.label.length,n=e.right.position;t={type:"range",id:this.id_counter++,position:e.left.position,start:e.left,end:e.right,label:e.left.label+this.expression.substring(i,n)+e.right.label},r=t.start.label+":"+t.end.label,this.address_refcount[t.start.label]--,this.address_refcount[t.end.label]--;let o=[e.left.position,e.right.position];this.full_reference_list=this.full_reference_list.filter(s=>s.position!==o[0]&&s.position!==o[1])}else if((e.left.type==="literal"||e.left.type==="identifier")&&(e.right.type==="literal"||e.right.type==="identifier")){let i=this.UnitToAddress(e.left),n=this.UnitToAddress(e.right);i&&n&&(i.column===1/0&&n.column===1/0||i.row===1/0&&n.row===1/0)&&(r=i.label+":"+n.label,t={type:"range",id:this.id_counter++,position:e.left.position,start:i,end:n,label:r})}if(t)return this.dependencies.ranges[r]=t,this.full_reference_list.push(t),t;this.error="unexpected character: :",this.valid=!1}e.left=this.BinaryToRangeX(e.left),e.right=this.BinaryToRangeX(e.right)}return e}ArrangeUnits(e){if(e.length===0)return{type:"missing",id:this.id_counter++};if(e.length===1)return e[0];let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(i.type==="operator")if(t.length===0||t[t.length-1].type==="operator")if(vo[i.operator]){let n=this.BinaryToComplex(this.ArrangeUnits(e.slice(r+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:e,explicit:!1};n.type==="binary"?(n.left={type:"unary",id:this.id_counter++,operator:i.operator,operand:n.left,position:i.position},i=n):i={type:"unary",id:this.id_counter++,operator:i.operator,operand:n,position:i.position},r=e.length}else return this.error=`unexpected character [2]: ${i.operator}`,this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};else{t.push(i);continue}if(t.length<2){if(t.length===1&&t[0].type!=="operator")return this.error=`unexpected element [3]: ${i.type}`,this.error_position=i.type==="missing"||i.type==="group"||i.type==="dimensioned"?-1:i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};t.push(i)}else if(t[t.length-1].type==="operator"){let n=t[t.length-2],o=t[t.length-1],s=o.operator,a={type:"binary",id:this.id_counter++,left:n,operator:s,position:o.position,right:i};n.type==="binary"&&Ur[s]>Ur[n.operator]&&(a.left=n.left,a.operator=n.operator,a.position=n.position,a.right={type:"binary",id:this.id_counter++,left:n.right,right:i,operator:s,position:o.position}),t.splice(-2,2,a)}else return this.error="multiple expressions",this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1}}return t[0]}ParseNext(e=!0){this.ConsumeWhiteSpace();let t=this.data[this.index];if(t===xr)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(t>=Me&&t<=it||t===this.decimal_mark_char)return this.ConsumeNumber();if(t===ho)return this.ConsumeArray();if(e&&(t===nt||t===Ar)){let r=this.data[this.index+1];if(r>=Me&&r<=it||r===this.decimal_mark_char)return this.ConsumeNumber()}else if(t>=Je&&t<=At||t>=at&&t<=kt||t===Rr||t===Er||t===Cr||t===St||t===st||t>=Tr&&t<=Mr)return this.ConsumeToken(t);return t}ConsumeArray(){let e={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let t=0,r=0;for(;this.index<this.length;){let i=this.ParseNext(),n=this.index;if(typeof i=="number")switch(this.index++,i){case Ai:r++,t=0;break;case ot:t++;break;case mo:return e;default:this.valid&&(this.error="invalid character in array literal",this.error_position=n,this.valid=!1);break}else switch(i.type){case"literal":e.values[t]||(e.values[t]=[]),e.values[t][r]=i.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=n,this.valid=!1);break}}return e}ConsumeOperator(){for(let e of wo)if(this.expression.substr(this.index,e.length)===e){let t=this.index;return this.index+=e.length,{type:"operator",id:this.id_counter++,operator:e,position:t}}return null}ConsumeArguments(){this.index++;let e=0,t=[];for(;this.index<this.length;){let r=this.ParseGeneric([this.argument_separator_char,kr]);r!==null&&t.push(r);let i=this.data[this.index];if(i===this.argument_separator_char){this.index++,e++;for(let n=t.length;n<e;n++)t.push({type:"missing",id:this.id_counter++})}else if(i===kr)return this.index++,t}return t}ConsumeToken(e){let t=[e],r=this.index,i=e===Cr,n=0,o=!1;for(e===st&&(n=1,o=!0),++this.index;this.index<this.length;this.index++){let u=this.data[this.index];if(u>=Je&&u<=At||u>=at&&u<=kt||u>=Tr&&u<=Mr||u===Rr||u===St||u===Sr||u===po||i||u>=Me&&u<=it||u===st||n>0&&u===Si||u===nt&&this.flags.r1c1&&n===1||n>0&&u===bo&&this.data[this.index-1]===st||n===1&&(u===ot||u===xi)||n>1||u===fo&&n===0)t.push(u),u===st&&(n++,o=!0),u===Si&&n--,u===Cr&&(i=!1);else break}this.data[this.index]===Er&&t.push(this.data[this.index++]);let s=t.map(u=>String.fromCharCode(u)).join("");if(i)return this.error="unbalanced single quote",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:s,position:r};if(n)return this.error="unbalanced square bracket",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:s,position:r};if(this.ConsumeWhiteSpace(),this.data[this.index]===Ci){let u=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:s,args:u,position:r,end:this.index}}if(this.flags.spreadsheet_semantics){let u=this.ConsumeAddress(s,r);if(u)return u;if(o){let h=this.ConsumeStructuredReference(s,r);if(h)return h}}let c=s.toLowerCase();if(c==="true"||this.flags.boolean_true&&c===this.flags.boolean_true.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:r};if(c==="false"||this.flags.boolean_false&&c===this.flags.boolean_false.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:r};let d={type:"identifier",id:this.id_counter++,name:s,position:r};return this.full_reference_list.push(d),d}ConsumeStructuredReference(e,t){let r=e.length,i=e,n="",o=0;for(;o<r;o++){if(e[o]==="["){e=e.substring(o);break}n+=e[o]}if(e[0]!=="["||e[e.length-1]!=="]")return;e=e.substring(1,e.length-1);let s=e.split(",").map(u=>u.trim()),a="column",c="";if(s.length>2)return;s.length===2?(/\[#this row\]/i.test(s[0])?a="row":/\[#all\]/i.test(s[0])&&(a="all"),c=s[1]):(c=s[0],c[0]==="@"&&(a="row",c=c.substring(1,c.length))),c[0]==="["&&c[c.length-1]==="]"&&(c=c.substring(1,c.length-1));let d={type:"structured-reference",id:this.id_counter++,label:i,position:t,scope:a,column:c,table:n};return this.full_reference_list.push(d),d}ConsumeAddress(e,t){let r=t,i=e.length,n,o=e.split("!");if(o.length>1&&(n=o.slice(0,o.length-1).join("!"),t+=n.length+1),this.flags.r1c1){let u=o[o.length-1].match(this.r1c1_regex);if(u){let h={type:"address",id:this.id_counter++,label:e,row:0,column:0,position:r,sheet:n,r1c1:!0};return u[1][0]==="["?(h.offset_row=!0,h.row=Number(u[1].substring(1,u[1].length-1))):u[1]?h.row=Number(u[1])-1:(h.offset_row=!0,h.row=0),u[2][0]==="["?(h.offset_column=!0,h.column=Number(u[2].substring(1,u[2].length-1))):u[2]?h.column=Number(u[2])-1:(h.offset_column=!0,h.column=0),h}}let s=this.ConsumeAddressColumn(t);if(!s)return null;t=s.position;let a=this.ConsumeAddressRow(t);if(!a)return null;t=a.position;let c=n?n+e.substr(n.length,t-r).toUpperCase():e.substr(0,t-r).toUpperCase();n&&n[0]==="'"&&(n=n.substr(1,n.length-2));let d={type:"address",id:this.id_counter++,label:c,row:a.row,column:s.column,absolute_row:a.absolute,absolute_column:s.absolute,position:r,sheet:n,spill:a.spill};return i!==t-r?null:(this.dependencies.addresses[d.label]=d,this.address_refcount[d.label]=(this.address_refcount[d.label]||0)+1,this.full_reference_list.push(d),d)}ConsumeAddressRow(e){let t=this.data[e]===St;t&&e++;let r=e,i=0;for(;;e++){let o=this.data[e];if(o>=Me&&o<=it)i*=10,i+=o-Me;else break}if(r===e||i===0)return!1;let n=!1;return this.data[e]===Er&&(e++,n=!0),{absolute:t,row:i-1,position:e,spill:n}}ConsumeAddressColumn(e){let t=-1,r=0,i=this.data[e]===St;for(i&&e++;;e++,r++){if(r>=4)return!1;let n=this.data[e];if(n>=Je&&n<=At)t=26*(1+t)+(n-Je);else if(n>=at&&n<=kt)t=26*(1+t)+(n-at);else break}return t<0?!1:{absolute:i,column:t,position:e}}ConsumeNumber(){let e=this.index,t=0,r=!1,i=!1,n=0,o=0,s=0,a="integer",c=0,d=!1,u=this.index;for(;this.index<this.length;this.index++,c++){let m=this.data[this.index];if(m===this.decimal_mark_char)if(a==="integer")a="fraction";else break;else if(m===uo){n/=100,s/=100,this.index++;break}else if(m===Ar||m===nt)if(c===0)m===nt&&(i=!0);else break;else if(m===go||m===_o)if(a==="integer"||a==="fraction")a="exponent",this.index<this.length-1&&(this.data[this.index+1]===Ar?this.index++:this.data[this.index+1]===nt&&(this.index++,r=!0));else break;else if(m===this.imaginary_char){let f=this.data[this.index+1];if(f>=Je&&f<=At||f>=at&&f<=kt||f>=Tr&&f<=Mr||f===Rr)break;if(a==="integer"||a==="fraction"){this.index++,d=!0;break}}else if(m>=Me&&m<=it)switch(a){case"integer":n=n*10+(m-Me);break;case"fraction":s=s*10+(m-Me),o++;break;case"exponent":t=t*10+(m-Me);break}else break}let h=n+s/Math.pow(10,o);return a==="exponent"&&(h=h*Math.pow(10,(r?-1:1)*t)),d?{type:"complex",id:this.id_counter++,position:e,imaginary:i?-h:h,real:0,text:this.expression.substring(u,this.index)||""}:{type:"literal",id:this.id_counter++,position:e,value:i?-h:h,text:this.expression.substring(u,this.index)||""}}ConsumeString(){this.index++;let e=[];for(;this.index<this.length;this.index++){let t=this.data[this.index];if(t===xr&&(this.index++,this.index>=this.length||this.data[this.index]!==xr))break;e.push(t)}return e.map(t=>String.fromCharCode(t)).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){let e=this.data[this.index];if(e===xi||e===ao||e===lo||e===co||e===so)this.index++;else return}}};var Ri=(l,e=",")=>{let t=0,r=[],i="",n=[],o=l.length;if(/[\r\n"]/.test(e))throw new Error("invalid delimiter");for(let s=0;s<o;s++){let a=l[s];if(!(s===0&&a.charCodeAt(0)===65279))if(t===0)switch(a){case e:r.push(i),i="";break;case"\r":break;case`
`:r.push(i),i="",n.push(r),r=[];break;case'"':i.length===0?t=1:i+=a;break;default:i+=a;break}else a==='"'?s+1<o&&l[s+1]==='"'?(i+='"',s++):t=0:i+=a}return(r.length||i.length)&&(r.push(i),n.push(r)),n};var Ie=class l{static _instance=new l;constructor(){}static get instance(){return this._instance}HTML(e,t={}){t={br:!0,...t};let r=[];for(let i of e){let n=[];for(let o of i)o.pre&&n.push("<pre>"),o.emphasis&&n.push("<em>"),o.strong&&n.push("<strong>"),o.strike&&n.push("<strike>"),n.push(o.text),o.strike&&n.push("</strike>"),o.strong&&n.push("</strong>"),o.emphasis&&n.push("</em>"),o.pre&&n.push("</pre>");r.push(n.join(""))}return r.join(t.br?`<br/>
`:`
`)}Dummy(e=""){return e.split(/\n/).map(t=>[{text:t}])}Parse(e=""){let t=this.Tokenize(e);for(let r=0;r<t.length;r++){let i=t[r];if(i.type==="delimeter"){let n=t[r-1],o=t[r+1],s=!n||n.type==="whitespace"||n.type==="newline",a=n&&n.type==="text"&&/[^\w\d]$/.test(n.text),c=!o||o.type==="whitespace"||o.type==="newline",d=o&&o.type==="text"&&/^[^\w\d]/.test(o.text);i.left_flanking=!c&&(!d||s),i.right_flanking=!s&&(!a||c||d)}}return this.ApplyFormatting(t),this.Consolidate(t)}IsWhitespace(e){return e===" "||e==="	"}IsNewline(e){return e==="\r"||e===`
`}IsDelimeter(e){return e==="*"||e==="_"||e==="~"}Consolidate(e){let t=[],r={},i=[],n={type:"text",text:""};for(let o of e)if(o.type==="newline")n.text.length&&i.push(n),n={...r,text:"",type:"text"},t.push(i),i=[];else switch((!!r.strong!=!!o.strong||!!r.emphasis!=!!o.emphasis||!!r.strike!=!!o.strike)&&(r.strong=!!o.strong,r.emphasis=!!o.emphasis,r.strike=!!o.strike,n.text.length&&i.push(n),n={...r,text:"",type:"text"}),o.type){case"text":case"whitespace":n.text+=o.text;break;case"delimeter":for(let s=0;s<o.length;s++)n.text+=o.char;break}return n.text.length&&i.push(n),i.length&&t.push(i),t}ApplyFormatting(e,t){let r=0,i=e.length;for(r=0;r<i;r++){let n=e[r];if(n.type==="delimeter"){if(t&&n.right_flanking&&t.char===n.char&&n.length>0)return{index:r,token:n};if(n.left_flanking){let o=this.ApplyFormatting(e.slice(r+1),n);if(o.token){let s=Math.min(o.token.length,n.length),a=n.char==="~",c=!a&&!!(s%2),d=!a&&s>=2;for(let u=r+1;u<=r+o.index;u++)e[u].strong=!!e[u].strong||d,e[u].emphasis=!!e[u].emphasis||c,e[u].strike=!!e[u].strike||a;o.token.length-=s,n.length-=s,n.length>0?r--:r+=o.index}}}}return{index:r}}Tokenize(e=""){let t=[],r=e.length,i=0,n=!1,o="";for(i=0;i<r;i++){let s=e[i];if(this.IsWhitespace(s)){o&&t.push({type:"text",text:o});let a=s;for(;;){let c=e[i+1];if(this.IsWhitespace(c))a+=c,i++;else break}t.push({type:"whitespace",text:a}),n=!1,o=""}else if(this.IsNewline(s)){o&&t.push({type:"text",text:o}),t.push({type:"newline",text:s});let a="";for(;;){let c=e[i+1];if(this.IsNewline(c))a+=c,i++;else break}a.length&&t.push({type:"newline",text:a}),n=!1,o=""}else if(n)o+=s,n=!1;else if(this.IsDelimeter(s)){o&&t.push({type:"text",text:o});let a=s;for(;;){let c=e[i+1];if(c===s)a+=c,i++;else break}t.push({type:"delimeter",text:a,char:s,length:a.length}),n=!1,o=""}else s==="\\"?n=!0:o+=s}return o&&t.push({type:"text",text:o}),t}};var N=l=>l!==null&&typeof l=="object"&&"row"in l&&"column"in l,ct=l=>l!==null&&typeof l=="object"&&"start"in l&&N(l.start)&&"end"in l&&N(l.end),y=class l{start_;end_;constructor(e,t=e,r=!1){this.end_=this.PatchNull(t),this.start_=this.PatchNull(e),r&&this.Normalize()}static FromColumn(e){return new l({row:1/0,column:e})}static FromRow(e){return new l({row:e,column:1/0})}static ColumnToLabel(e){let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}static CellAddressToLabel(e,t=!1){if(e.row===1/0&&e.column===1/0)throw new Error("this is going to break something");let r=t?`${e.sheet_id||0}!`:"";return e.row===1/0?r+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column):e.column===1/0?r+(e.absolute_row?"$":"")+(e.row+1):r+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column)+(e.absolute_row?"$":"")+(e.row+1)+(e.spill?"#":"")}static Join(e,...t){let r=new l(e.start,e.end);for(let i of t)i&&(r.ConsumeAddress(i.start),r.ConsumeAddress(i.end));return r}static Bleed(e,t=1){return new l({row:Math.max(0,e.start.row-t),column:Math.max(0,e.start.column-t),sheet_id:e.start.sheet_id},{row:e.end.row+t,column:e.end.column+t})}static PatchArea(e,t){let{before_column:r,column_count:i,before_row:n,row_count:o}=t,s=new l(e.start,e.end),a=e.start.sheet_id;if(i&&r<=s.end.column){if(i>0)r<=s.start.column?s.Shift(0,i):r>s.start.column&&r<=s.end.column?s.ConsumeAddress({row:s.end.row,column:s.end.column+i}):console.warn("AA X case 1",r,i,JSON.stringify(s));else if(i<0)if(r-i<=s.start.column)s.Shift(0,i);else{if(r<=s.start.column&&r-i>s.end.column)return!1;if(r<=s.start.column){let c=r-i-1;s=new l({row:s.start.row,column:c+1+i,sheet_id:a},{row:s.end.row,column:s.end.column+i})}else r<=s.end.column?r-i-1>=s.end.column?s=new l({row:s.start.row,column:s.start.column,sheet_id:a},{row:s.end.row,column:r-1}):s=new l({row:s.start.row,column:s.start.column,sheet_id:a},{row:s.end.row,column:s.start.column+s.columns+i-1}):console.warn("AA X case 2",r,i,JSON.stringify(s))}}if(o&&n<=s.end.row){if(o>0)n<=s.start.row?s.Shift(o,0):n>s.start.row&&n<=s.end.row?s.ConsumeAddress({row:s.end.row+o,column:s.end.column}):console.warn("AA X case 3",n,o,JSON.stringify(s));else if(o<0)if(n-o<=s.start.row)s.Shift(o,0);else{if(n<=s.start.row&&n-o>s.end.row)return!1;if(n<=s.start.row){let c=n-o-1;s=new l({column:s.start.column,row:c+1+o,sheet_id:a},{column:s.end.column,row:s.end.row+o})}else n<=s.end.row?n-o-1>=s.end.row?s=new l({column:s.start.column,row:s.start.row,sheet_id:a},{column:s.end.column,row:n-1}):s=new l({column:s.start.column,row:s.start.row,sheet_id:a},{column:s.end.column,row:s.start.row+s.rows+o-1}):console.warn("AA X case 4",n,o,JSON.stringify(s))}}return s}get start(){return{...this.start_}}set start(e){this.start_=e}get end(){return{...this.end_}}set end(e){this.end_=e}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(e){let t={...e};return t.row===null&&(t.row=1/0),t.column===null&&(t.column=1/0),t}SetSheetID(e){this.start_.sheet_id=e}Normalize(){let e={...this.start_},t={...this.end_};e.row===1/0||t.row===1/0?e.row=t.row=1/0:e.row>t.row&&(e.row=this.end_.row,e.absolute_row=this.end_.absolute_row,t.row=this.start_.row,t.absolute_row=this.start_.absolute_row),e.column===1/0||t.column===1/0?e.column=t.column=1/0:e.column>t.column&&(e.column=this.end_.column,e.absolute_column=this.end_.absolute_column,t.column=this.start_.column,t.absolute_column=this.start_.absolute_column),this.start_=e,this.end_=t}TopLeft(){let e={row:0,column:0};return this.entire_row||(e.column=this.start.column),this.entire_column||(e.row=this.start.row),e}BottomRight(){let e={row:0,column:0};return this.entire_row||(e.column=this.end.column),this.entire_column||(e.row=this.end.row),e}ContainsRow(e){return this.entire_column||e>=this.start_.row&&e<=this.end_.row}ContainsColumn(e){return this.entire_row||e>=this.start_.column&&e<=this.end_.column}Contains(e){return(this.entire_column||e.row>=this.start_.row&&e.row<=this.end_.row)&&(this.entire_row||e.column>=this.start_.column&&e.column<=this.end_.column)}ContainsArea(e){return this.start.column<=e.start.column&&this.end.column>=e.end.column&&this.start.row<=e.start.row&&this.end.row>=e.end.row}Intersects(e){return!(e.start.column>this.end.column||this.start.column>e.end.column||e.start.row>this.end.row||this.start.row>e.end.row)}Equals(e){return e.start_.row===this.start_.row&&e.start_.column===this.start_.column&&e.end_.row===this.end_.row&&e.end_.column===this.end_.column}Equals2(e){return e.start.row===this.start_.row&&e.start.column===this.start_.column&&e.end.row===this.end_.row&&e.end.column===this.end_.column}Clone(){return new l(this.start,this.end)}get left(){let e=new l(this.start_,this.end_);return e.end_.column=e.start_.column,e}get right(){let e=new l(this.start_,this.end_);return e.start_.column=e.end_.column,e}get top(){let e=new l(this.start_,this.end_);return e.end_.row=e.start_.row,e}get bottom(){let e=new l(this.start_,this.end_);return e.start_.row=e.end_.row,e}Shift(e,t){return this.start_.row+=e,this.start_.column+=t,this.end_.row+=e,this.end_.column+=t,this}ConsumeAddress(e){this.entire_row||(e.column<this.start_.column&&(this.start_.column=e.column),e.column>this.end_.column&&(this.end_.column=e.column)),this.entire_column||(e.row<this.start_.row&&(this.start_.row=e.row),e.row>this.end_.row&&(this.end_.row=e.row))}Reshape(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}ConsumeArea(e){this.ConsumeAddress(e.start),this.ConsumeAddress(e.end)}Resize(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}[Symbol.iterator](){if(this.entire_row||this.entire_column)throw new Error("don't iterate infinite area");let e=this.start_.row,t=this.start_.column;return{next:()=>{let r={column:t,row:e,sheet_id:this.start_.sheet_id};return t>this.end_.column?{done:!0,value:void 0}:(++e>this.end_.row&&(e=this.start_.row,t++),{value:r})}}}get spreadsheet_label(){let e;return this.entire_sheet?"":this.entire_column?(e=l.ColumnToLabel(this.start_.column),e+=":"+l.ColumnToLabel(this.end_.column),e):this.entire_row?(e=String(this.start_.row+1),e+=":"+(this.end_.row+1),e):(e=l.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?e+":"+l.CellAddressToLabel(this.end_):e)}toJSON(){return{start:{...this.start_},end:{...this.end_}}}};var ue=l=>typeof l=="object"&&!!l&&typeof l.real=="number"&&typeof l.imaginary=="number",Xe=l=>l.real?l.imaginary?l.imaginary>0?`${l.real} + ${l.imaginary}i`:`${l.real} - ${Math.abs(l.imaginary)}i`:l.real.toString():l.imaginary?l.imaginary+"i":"0",Dr=l=>typeof l=="object"&&!!l&&typeof l.value=="number"&&typeof l.unit=="string",zr=["undefined","formula","string","number","boolean","object","error","complex","array","dimensioned_quantity"];var pe=l=>{switch(typeof l){case"undefined":return 0;case"number":return 3;case"boolean":return 4;case"object":return l===null?0:ue(l)?7:Dr(l)?9:5;case"string":return l[0]==="="?1:2;default:return 6}};var se=class{static StringToColumn(e){let t=0;e=e.toUpperCase();for(let r=0;r<e.length;r++)t*=26,t+=e.charCodeAt(r)-64;return t-1}value;type=0;calculated;calculated_type;formatted;rendered_type;style;area;spill;merge_area;table;renderer_data;render_clean=[];note;hyperlink;editing;render_function;click_function;constructor(e,t){typeof e<"u"&&this.Set(e,t)}ValueIsNumber(){return this.type===3}ValueIsFormula(){return this.type===1}ValueIsBoolean(){return this.type===4}ValueIsComplex(){return this.type===7}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_clean=[]}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_clean=[]}Reset(){this.type=0,this.value=this.spill=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_clean=[]}Set(e,t=pe(e)){this.value=e,this.type=t,this.spill=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_clean=[]}SetCalculatedValue(e,t=pe(e)){e===void 0&&(e=0,t=3),this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_clean=[])}GetValue(){return this.calculated_type?this.calculated:typeof this.value=="string"&&this.value[0]==="'"?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===1?{type:3,value:0}:{type:this.type,value:typeof this.value=="string"&&this.value[0]==="'"?this.value.slice(1):this.value}}SetNote(e){this.note=e,this.render_clean=[]}SetCalculationError(e="ERR"){this.SetCalculatedValue(e,6)}SetArray(e){this.type=0,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}SetArrayHead(e,t){this.type=pe(t),this.value=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}};var Lr=l=>!l.cells,dt=l=>!!l[0]&&Lr(l[0]),Ir=l=>!!l[0]&&l[0].row!==void 0,xo=zr.map((l,e)=>({[l]:e})).reduce((l,e)=>({...l,...e}),{}),Rt=class{data=[];rows_=0;columns_=0;get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(e){this.rows_=Math.max(e+1,this.rows_)}EnsureColumn(e){this.columns_=Math.max(e+1,this.columns_)}InsertColumns(e=0,t=1){this.data=this.data.map(r=>{if(r.length>=e){let i=r.slice(0,e),n=e+t,o=r.slice(e);for(let s=0;s<o.length;s++)i[n++]=o[s];return i}return r}),this.columns_+=t}DeleteColumns(e,t=1){this.data.forEach(r=>r.splice(e,t)),this.columns_-=t}DeleteRows(e,t=1){this.data.splice(e,t),this.rows_-=t}InsertRows(e=0,t=1){let r=[e,0,[]];for(let i=1;i<t;i++)r.push([]);Array.prototype.splice.apply(this.data,r),this.rows_+=t}GetCell(e,t){let{row:r,column:i}=e;if(!this.data[r])if(t)this.data[r]=[],this.rows_=Math.max(this.rows_,r+1);else return;return this.data[r][i]||t&&(this.data[r][i]=new se,this.columns_=Math.max(this.columns_,i+1)),this.data[r][i]}EnsureCell(e){let{row:t,column:r}=e,i=this.data[t];i||(this.data[t]=i=[],this.rows_=Math.max(this.rows_,t+1));let n=i[r];return n||(n=i[r]=new se,this.columns_=Math.max(this.columns_,r+1)),n}FromArray(e=[],t=!1){this.data=[];let r=0,i=0;if(t){i=e.length;for(let n=0;n<i;n++){let o=e[n];r=Math.max(r,o.length);for(let s=0;s<o.length;s++)this.data[s]||(this.data[s]=[]),this.data[s][n]=new se(o[s])}}else{r=e.length;for(let n=0;n<r;n++){let o=[],s=e[n];i=Math.max(i,s.length);for(let a=0;a<s.length;a++)o[a]=new se(s[a]);this.data[n]=o}}this.rows_=r,this.columns_=i}SerializedTypeToValueType(e){if(e)return typeof e=="number"?e:xo[e]||void 0}ValueTypeToSerializedType(e){return e?zr[e]:void 0}FromJSON(e=[],t){if(this.data=[],!dt(e)){let i=[];if(Ir(e))for(let n of e)for(let o of n.cells)i.push({...o,row:n.row});else for(let n of e)for(let o of n.cells)i.push({...o,column:n.column});e=i}let r=[];for(let i of e){this.data[i.row]||(this.data[i.row]=[]);let n=new se(i.value);if(typeof i.calculated<"u"&&(n.SetCalculatedValue(i.calculated,this.SerializedTypeToValueType(i.calculated_type)),i.spill&&(n.spill=new y(i.spill.start,i.spill.end))),t&&typeof i.style_ref<"u"&&(n.style=t[i.style_ref]),typeof i.note<"u"&&(n.note=i.note),typeof i.hyperlink<"u"&&(n.hyperlink=i.hyperlink),this.data[i.row][i.column]&&this.data[i.row][i.column].area&&(n.area=this.data[i.row][i.column].area),this.data[i.row][i.column]=n,i.area){let o=new y(i.area.start,i.area.end);for(let s=o.start.row;s<=o.end.row;s++)for(let a=o.start.column;a<=o.end.column;a++)this.data[s]||(this.data[s]=[]),this.data[s][a]||(this.data[s][a]=new se),this.data[s][a].area=o}if(i.table&&r.push({...i.table}),i.merge_area){let o=new y(i.merge_area.start,i.merge_area.end);for(let s=o.start.row;s<=o.end.row;s++)for(let a=o.start.column;a<=o.end.column;a++)this.data[s]||(this.data[s]=[]),this.data[s][a]||(this.data[s][a]=new se),this.data[s][a].merge_area=o}}for(let i of r)for(let n=i.area.start.row;n<=i.area.end.row;n++)for(let o=i.area.start.column;o<=i.area.end.column;o++)this.data[n]||(this.data[n]=[]),this.data[n][o]||(this.data[n][o]=new se),this.data[n][o].table=i;this.rows_=this.data.length,this.columns_=this.data.reduce((i,n)=>Math.max(i,n.length),0)}toJSON(e={}){let t=0,r=0,i=this.data.length-1,n;e.subset&&(t=e.subset.start.column,r=e.subset.start.row,i=e.subset.end.row);let o=[],s=-1,a=-1,c={},d={};for(let u=r;u<=i;u++)if(this.data[u]){let h=this.data[u];n=h.length-1,e.subset&&(n=e.subset.end.column);for(let m=t;m<=n;m++){let f=h[m],p=f&&f.merge_area&&f.merge_area.start.row===u&&f.merge_area.start.column===m,b=f&&f.area&&f.area.start.row===u&&f.area.start.column===m,g=f&&f.table&&f.table.area.start.row===u&&f.table.area.start.column===m,x=f?f.type===2&&!f.value:!0;if(f&&(!x||e.preserve_empty_strings)&&(p||f.type||f.calculated_type&&e.expand_arrays||f.calculated_type&&e.calculated_value||f.note||e.decorated_cells&&f.style&&(f.style.fill||f.style.border_bottom||f.style.border_top||f.style.border_left||f.style.border_right))){let v={row:u,column:m,value:f.value};f.note&&(v.note=f.note),f.hyperlink&&(v.hyperlink=f.hyperlink),e.preserve_type&&(v.type=this.ValueTypeToSerializedType(f.type)),e.sheet_id&&(v.sheet_id=e.sheet_id),e.calculated_value&&typeof f.calculated<"u"&&(v.calculated=f.calculated,f.spill&&(v.spill=f.spill.toJSON()),(e.preserve_type||f.calculated_type===6)&&(v.calculated_type=this.ValueTypeToSerializedType(f.calculated_type))),f.table&&g&&e.tables&&(v.table=JSON.parse(JSON.stringify(f.table))),f.area&&b&&(v.area=f.area.toJSON()),f.merge_area&&(v.merge_area=f.merge_area.toJSON()),e.cell_style_refs&&e.cell_style_refs[m]&&e.cell_style_refs[m][u]&&(v.style_ref=e.cell_style_refs[m][u],e.cell_style_refs[m][u]=0),c[u]=u,d[m]=m,s=Math.max(u,s),a=Math.max(m,a),o.push(v)}}}if(e.nested){let u=Object.keys(c),h=Object.keys(d);if(u.length<=h.length&&u.length){let m={},f=[];for(let p of o){let{row:b,...g}=p;m[p.row]||(m[p.row]=[]),m[p.row].push(g)}for(let p of u){let b=Number(p);f.push({row:b,cells:m[b]})}return{data:f,rows:s,columns:a+1}}else if(h.length){let m={},f=[];for(let p of o){let{column:b,...g}=p;m[p.column]||(m[p.column]=[]),m[p.column].push(g)}for(let p of h){let b=Number(p);f.push({column:b,cells:m[b]})}return{data:f,rows:s,columns:a+1}}}return{data:o,rows:s+1,columns:a+1}}GetAll(e=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},e)}Normalize(e,t){return e={...e,row:e.row==1/0?0:e.row,column:e.column==1/0?0:e.column},t&&(t={...t,row:t.row==1/0?this.rows_-1:t.row,column:t.column==1/0?this.columns_-1:t.column}),{from:e,to:t}}RawValue(e,t=e){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].value:void 0;let r=[],i=this.data.slice(e.row,t.row+1),n=e.column,o=t.column+1;for(let s of i){let a=[];for(let c=n,d=0;c<o;c++,d++){let u=s[c];a.push(u?u.value:void 0)}r.push(a)}return r}GetRange(e,t,r=!1){if({from:e,to:t}=this.Normalize(e,t),!t||e===t||e.column===t.column&&e.row===t.row)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue():void 0;let i=[];if(r)for(let n=e.column;n<=t.column;n++){let o=[];for(let s=e.row;s<=t.row;s++)this.data[s]&&this.data[s][n]?o.push(this.data[s][n].GetValue()):o.push(void 0);i.push(o)}else for(let n=e.row;n<=t.row;n++){let o=[];for(let s=e.column;s<=t.column;s++)this.data[n]&&this.data[n][s]?o.push(this.data[n][s].GetValue()):o.push(void 0);i.push(o)}return i}GetRange4(e,t=e,r=!1){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue4():{value:void 0,type:0};let i=[];if(r)for(let n=e.column;n<=t.column;n++){let o=[];for(let s=e.row;s<=t.row;s++)this.data[s]&&this.data[s][n]?o.push(this.data[s][n].GetValue4()):o.push({type:0});i.push(o)}else for(let n=e.row;n<=t.row;n++){let o=[];for(let s=e.column;s<=t.column;s++)this.data[n]&&this.data[n][s]?o.push(this.data[n][s].GetValue4()):o.push({type:0});i.push(o)}return{type:8,value:i}}SetArea(e,t){if(ArrayBuffer.isView(t))throw new Error("ABIV");if(Array.isArray(t))for(let r=e.start.row,i=0;r<=e.end.row;r++,i++){this.data[r]||(this.data[r]=[]);let n=this.data[r];if(t[i])for(let o=e.start.column,s=0;o<=e.end.column;o++,s++)n[o]||(n[o]=new se),n[o].Set(t[i][s])}else{let r=pe(t);for(let i=e.start.row;i<=e.end.row;i++){this.data[i]||(this.data[i]=[]);let n=this.data[i];for(let o=e.start.column;o<=e.end.column;o++)n[o]||(n[o]=new se),n[o].Set(t,r)}}this.rows_=Math.max(this.rows_,e.end.row+1),this.columns_=Math.max(this.columns_,e.end.column+1)}*IterateRC(e,t=!1){if(!e&&t&&(e=new y({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e)if(t)for(let r=e.start.row;r<=e.end.row;r++){this.data[r]||(this.data[r]=[]);let i=this.data[r];for(let n=e.start.column;n<=e.end.column;n++)i[n]||(i[n]=new se),yield{cell:i[n],row:r,column:n}}else for(let r=e.start.row;r<=e.end.row;r++){let i=this.data[r];if(i)for(let n=e.start.column;n<=e.end.column;n++){let o=i[n];o&&(yield{cell:o,row:r,column:n})}}else for(let[r,i]of this.data.entries())if(i)for(let[n,o]of i.entries())o&&(yield{cell:o,row:r,column:n})}*Iterate(e,t=!1){if(!e&&t&&(e=new y({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e){N(e)&&(e=new y(e)),(e.entire_column||e.entire_row)&&(e=new y(e.start,e.end),e.start.column===1/0&&(e.start.column=0,e.end.column=this.columns_-1),e.start.row===1/0&&(e.start.row=0,e.end.row=this.rows_-1));let r=e.start,i=e.end;if(t)for(let n=r.row;n<=i.row;n++){this.data[n]||(this.data[n]=[]);let o=this.data[n];for(let s=r.column;s<=i.column;s++)o[s]||(o[s]=new se),yield o[s]}else for(let n=r.row;n<=i.row;n++)if(this.data[n]){let o=this.data[n];for(let s=r.column;s<=i.column;s++)o[s]&&(yield o[s])}}else for(let r of this.data)if(r)for(let i of r)i&&(yield i)}FlushCellStyles(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushStyle()}FlushCachedValues(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushCache()}};var F=class{static locale="en-us";static decimal_separator=".";static argument_separator=",";static grouping_separator=",";static date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]};static UpdateLocale(e){if(e)this.locale=e;else if(typeof self<"u"){let i=self?.document?.location;if(i&&i.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(i.search)){let n=i.search.match(/locale=(.*?)(?:\?|$|&)/);n&&(this.locale=n[1]),console.info("override locale",this.locale)}else typeof navigator<"u"&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}this.locale==="C"&&(console.warn("Locale not set, defaulting to en-us"),this.locale="en-us");let t=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=t===","?",":".",this.decimal_separator===","?(this.argument_separator=";",this.grouping_separator=" "):(this.argument_separator=",",this.grouping_separator=",");let r=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,r),r=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,r),r=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,r),r=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,r),r=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,r),r=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,r),r=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,r),r=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,r),r=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,r),r=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,r),r=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,r),r=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,r)}static UpdateDateComponent(e,t,r){t>=0&&(this.date_components.short_days[t]=r.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[t]=r.toLocaleString(this.locale,{weekday:"long"})),e>=0&&(this.date_components.short_months[e]=r.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[e]=r.toLocaleString(this.locale,{month:"long"}))}};F.UpdateLocale();var B=class l{constructor(e=0,t=0,r=0,i=0){this.left=e;this.top=t;this.width=r;this.height=i}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(e){return new l(e.left||0,e.top||0,e.width||0,e.height||0)}static IsRectangle(e){return!!e&&typeof e=="object"&&typeof e.left=="number"&&typeof e.top=="number"&&typeof e.width=="number"&&typeof e.height=="number"}Shift(e=0,t=0){return new l(this.left+e,this.top+t,this.width,this.height)}Scale(e=1,t=e){return new l(this.left*e,this.top*t,this.width*e,this.height*t)}Expand(e=0,t=0){return new l(this.left,this.top,this.width+e,this.height+t)}Combine(e){return new l(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right)-Math.min(this.left,e.left),Math.max(this.bottom,e.bottom)-Math.min(this.top,e.top))}Contains(e,t,r=0){return e>=this.left-r&&e<=this.left+this.width+r&&t>=this.top-r&&t<=this.top+this.height+r}ContextFill(e){e.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(e){e.strokeRect(this.left,this.top,this.width,this.height)}Clamp(e,t){return e=Math.min(Math.max(e,this.left),this.right),t=Math.min(Math.max(t,this.top),this.bottom),{x:e,y:t}}ApplyStyle(e){e.style.top=this.top+"px",e.style.left=this.left+"px",e.style.width=this.width+"px",e.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}};var Co=JSON.stringify({}),So={Background:0,Text:1,Background2:2,Text2:3,Accent:4,Accent2:5,Accent3:6,Accent4:7,Accent5:8,Accent6:9},Fr=l=>typeof l.theme=="number"?l.theme:So[l.theme]||0,Y=l=>!!l&&typeof l.text=="string",Ke=l=>!!l&&typeof l.theme<"u",Ei=l=>!!l&&(typeof l.text=="string"||typeof l.theme<"u"),I={DefaultProperties:{horizontal_align:"",vertical_align:"",number_format:"General",nan:"NaN",font_size:{unit:"em",value:1},bold:!1,italic:!1,underline:!1,strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},CompositeBorders:l=>({top:{width:l.border_top||0,color:l.border_top_fill||{}},left:{width:l.border_left||0,color:l.border_left_fill||{}},right:{width:l.border_right||0,color:l.border_right_fill||{}},bottom:{width:l.border_bottom||0,color:l.border_bottom_fill||{}}}),Merge:(l,e,t=!0)=>{let r=t?{...l,...e}:{...e};return JSON.parse(JSON.stringify(r))},Composite:l=>JSON.parse(JSON.stringify(l.reduce((e,t)=>({...e,...t}),{}))),Empty:l=>JSON.stringify(l)===Co,ParseFontSize:(l="",e="em")=>{let t=l.match(/(-*[\d.]+)\s*(\S*)/);if(t){let r=Number(t[1]);if(!r||isNaN(r)||r<0)return{};let i=t[2].toLowerCase()||e;if(i==="pt"||i==="em"||i==="%"||i==="px")return{font_size:{unit:i,value:r}}}return{}},RelativeFontSize:(l,e)=>{let t=12,r=12;switch(l.font_size?.unit){case"pt":if(!l.font_size.value)return 1;r=l.font_size.value;break;case"px":if(!l.font_size.value)return 1;r=Math.round(l.font_size.value*300/4)/100;break;case"em":return l.font_size.value||1;case"%":return(l.font_size.value||100)/100;default:return 1}switch(e.font_size?.unit){case"pt":if(!e.font_size.value)return 1;t=e.font_size.value;break;case"px":if(!e.font_size.value)return 1;t=Math.round(e.font_size.value*300/4)/100;break;default:return 1}return r/t},FontSize:(l,e=!0)=>{let t=l.font_size?.value;switch(l.font_size?.unit){case"pt":return(t||12)+"pt";case"px":return e?Math.round((t||16)*300/4)/100+"pt":(t||16)+"px";case"em":return(t||1)+"em";case"%":return(t||100)+"%"}return""},CompositeFontSize:(l,e,t=1,r=!1)=>{let i={...l};return e.unit==="pt"||e.unit==="px"?i={...e}:(i.value=e.value*l.value,e.unit==="%"&&(i.value/=100)),i.unit==="px"&&r&&(i.value=Math.round((i.value||16)*300/4)/100),i.value*=t,i},CompositeFont:(l,e,t,r)=>{let i,n,o,s=[];e.bold&&s.push("bold"),e.italic&&s.push("italic");let a=e.font_face||"stack:default";if(a.startsWith("stack:")){let c=r.font_stacks[a.substring(6)||"default"];c||(c=r.font_stacks.default),c&&(n=e.font_size,o=I.CompositeFontSize(c.size,e.font_size||{unit:"pt",value:10},t),s.push(o.value.toFixed(2)+o.unit),s.push(c.font||""),i=c.variants)}else o=I.CompositeFontSize(l,e.font_size||{unit:"pt",value:10},t),s.push(o.value.toFixed(2)+o.unit),s.push(a||"");return{font:s.join(" "),variants:i,base:l,size:e.font_size,scale:t,stack_size:n,font_size:o}}};var Et=l=>!!l&&Array.isArray(l)&&Array.isArray(l[0]),X=(l,e)=>(typeof e>"u"&&(e=pe(l)),{value:l,type:e}),ae=l=>l.imaginary?{type:7,value:l}:{type:3,value:l.real};var j={Darken:(l,e,t,r,i=!1)=>{let{h:n,s:o,l:s}=j.RGBToHSL(l,e,t);return i?s-=s*r/100:s-=r/100,s=Math.max(0,Math.min(1,s)),j.HSLToRGB(n,o,s)},Lighten:(l,e,t,r,i=!1)=>{let{h:n,s:o,l:s}=j.RGBToHSL(l,e,t);return i?s+=s*r/100:s+=r/100,s=Math.max(0,Math.min(1,s)),j.HSLToRGB(n,o,s)},RGBToHSL:(l,e,t)=>{l/=255,e/=255,t/=255;let r=Math.max(l,e,t),i=Math.min(l,e,t),n=0,o=0,s=(r+i)/2;if(r===i)n=o=0;else{let a=r-i;switch(o=s>.5?a/(2-r-i):a/(r+i),r){case l:n=(e-t)/a+(e<t?6:0);break;case e:n=(t-l)/a+2;break;case t:n=(l-e)/a+4;break}n/=6}return{h:n*360,s:o,l:s}},HSLToRGB:(l,e,t)=>{let r,i,n;if(e===0)r=i=n=t;else{l=l/360;let o=t<.5?t*(1+e):t+e-t*e,s=2*t-o;r=j.HueToRGB(s,o,l+.3333333333333333),i=j.HueToRGB(s,o,l),n=j.HueToRGB(s,o,l-.3333333333333333)}return{r:Math.round(r*255),g:Math.round(i*255),b:Math.round(n*255)}},HueToRGB:(l,e,t)=>(t<0&&(t+=1),t>1&&(t-=1),t<.16666666666666666?l+(e-l)*6*t:t<.5?e:t<.6666666666666666?l+(e-l)*(.6666666666666666-t)*6:l),GetLuminance:([l,e,t])=>{let r=[l,e,t].map(i=>(i/=255,i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)));return .2126*r[0]+.7152*r[1]+.0722*r[2]},WeightedLuminance:([l,e,t],r=[1,1,1])=>{let i=[l,e,t].map(n=>(n/=255,n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4)));return .2126*i[0]*r[0]+.7152*i[1]*r[1]+.0722*i[2]*r[2]},GetContrastRatio:l=>(l.sort((e,t)=>t-e),(l[0]+.05)/(l[1]+.05)),GetTextColor:(l,e,t)=>{let r=[.4,.3,.3],i=j.WeightedLuminance(l,r),n=j.WeightedLuminance(e,r),o=j.WeightedLuminance(t,r),s=j.GetContrastRatio([n,i]),a=j.GetContrastRatio([o,i]);return s>a?e:t}};var Ao="http://www.w3.org/2000/svg",H=class l{static instances=[];static GetInstance(e){for(let r of this.instances)if(r.doc===e)return r;let t=new l(e);return this.instances.push(t),t}doc;view;get HTMLElement(){return this.view?.HTMLElement}constructor(e){e&&(this.doc=e,this.view=e?.defaultView)}GetSelection(){return this.view?.getSelection()}Div(e,t,r){return this.Create("div",e,t,r)}ClassNames(e,t){e.classList.add(...(Array.isArray(t)?t:[t]).reduce((r,i)=>[...r,...i.split(/\s+/g)],[]))}SVG(e,t,r){let i=this.doc.createElementNS(Ao,e);return t&&this.ClassNames(i,t),r&&r.appendChild(i),i}Text(e){return this.doc.createTextNode(e)}Fragment(){return this.doc.createDocumentFragment()}Create(e,t,r,i){let n=this.doc.createElement(e);if(t&&this.ClassNames(n,t),i){if(i.attrs)for(let[o,s]of Object.entries(i.attrs))n.setAttribute(o,s);if(i.data)for(let[o,s]of Object.entries(i.data))n.dataset[o]=s;if(i.text&&(n.textContent=i.text),i.html&&(n.innerHTML=i.html),i.events)for(let[o,s]of Object.entries(i.events))n.addEventListener(o,s);if(i.style)for(let[o,s]of Object.entries(i.style))n.style[o]=s}return r&&r.appendChild(n),n}};var ko=1e3,be=class{constructor(e=!1,t){this.verbose=e;this.log_id=t}queue=[];dispatched=!1;subscribers=[];Publish(e){this.verbose&&console.info(`es publish (${this.log_id})`,e),Array.isArray(e)?this.queue.push(...e):this.queue.push(e),this.dispatched||(this.dispatched=!0,Promise.resolve().then(()=>{let t=this.queue.slice(0);this.dispatched=!1,this.queue=[];for(let r of t)for(let i of this.subscribers)i.subscriber(r)}))}Subscribe(e){let t=ko++;return this.subscribers.push({subscriber:e,token:t}),t}Cancel(e){this.subscribers=this.subscribers.filter(t=>t.token!==e)}CancelAll(){this.subscribers=[]}};var oe=class{static color_measurement_canvas;static text_measurement_node;static color_cache={};static MeasureColorARGB(e){let t=this.MeasureColor(e),r="FF";for(let i=0;i<3;i++){let n=t[i].toString(16);n.length===0?r+="00":n.length===1?r+=`0${n}`:r+=n}return r.toUpperCase()}static MeasureColor(e){let t=this.color_cache[e];if(t)return t;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);let r=this.color_measurement_canvas.getContext("2d",{willReadFrequently:!0});return r?(r.fillStyle="#fff",r.fillRect(0,0,1,1),r.fillStyle=e,r.fillRect(0,0,1,1),t=new Uint8ClampedArray(r.getImageData(0,0,1,1).data),this.color_cache[e]=t,t):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){let e=document.querySelector(".treb-chart-measurement-node");e?this.text_measurement_node=e:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.height="initial",this.text_measurement_node.style.width="initial",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(e,t=!1,r=400){let i=`${t?"italic":""} ${r} 20pt ${e}`,n=this.MeasureText(`${i}, sans-serif`,"check font"),o=this.MeasureText(`${i}, serif`,"check font"),s=this.MeasureText(`${i}, monospace`,"check font");return n.width===o.width&&o.width===s.width}static MeasureText(e,t,r=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=e,/\n/.test(t)?(t=t.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=t):this.text_measurement_node.textContent=t,this.text_measurement_node.style.lineHeight="1em",r?this.text_measurement_node.style.transform=`rotate(${r}deg)`:this.text_measurement_node.style.transform="";let i=this.text_measurement_node.getBoundingClientRect();return{width:i.width,height:i.height}}};var Nr,Ti=l=>{let e=new Map;for(let t=0;t<l.length;t++){let r=l[t];e.set(r,l.getPropertyValue(r))}return e},Ro=(l,e,t)=>{let r=new Map,i=Ti(e);for(let[o,s]of i.entries())s!==t.get(o)&&r.set(o,s);return(Array.from(r.entries()).map(([o,s])=>`${o}: ${s}`).join("; ")+"; "+(l.getAttribute("style")||"")).trim().replace(/"/g,"'")},Mi=(l,e)=>{let t=l.cloneNode(!1),r=getComputedStyle(l),i=Ro(l,r,e);t.removeAttribute("class"),t.setAttribute("style",i);let n;return Array.prototype.forEach.call(l.childNodes,o=>{switch(o.nodeType){case Node.ELEMENT_NODE:n||(n=Ti(r)),t.appendChild(Mi(o,n));break;case Node.TEXT_NODE:l.textContent&&t.appendChild(document.createTextNode(l.textContent));break;case Node.COMMENT_NODE:break;default:console.warn("unhandled node type in serialize",o)}}),t},Ui=l=>{if(!Nr){let t=new Map,r=document.createElement("iframe");r.style.width="10px",r.style.height="10px",r.style.position="absolute",r.style.left="-100px",document.body.appendChild(r);let i=r.contentDocument;if(i){let n=i.createElement("div");i.body.appendChild(n);let o=getComputedStyle(n);Array.prototype.forEach.call(o,s=>t.set(s,o[s]))}document.body.removeChild(r),Nr=t}let e=Mi(l,Nr);return e instanceof Element&&e.tagName==="svg"&&(e.hasAttribute("version")||e.setAttribute("version","1.1"),e.hasAttribute("xmlns")||e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.hasAttribute("xmlns:xlink")||e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),e};var Eo={data:!0,same_origin:!0,remote:!1},Tt=(l,e={})=>{let t={...Eo,...e};try{let r=new URL(l,document.location.href);return r.protocol==="data:"?t.data?r.href:void 0:r.origin===document.location.origin?t.same_origin?r.href:void 0:t.remote?r.hash:void 0}catch(r){console.error(r)}};var Vi=(l,e,t=6.5,r=!1,i=!1)=>{if(e===l)e++,l&&l--;else{let u=Math.round(e*1e5)/1e5;Math.abs(u-e)/(e-l)<1e-5&&(e=u)}let n=e-l,o=Math.log(n)/Math.log(10),s=Math.floor(Math.abs(o))*(o<0?-1:1)-1;i&&(s=Math.max(0,s));let a=i?[1,2,5,10,15,20,25,50,100]:[.1,.25,.5,1,2.5,5,10,25,50,100],c=-1,d=0;for(let u of a){let h=u*Math.pow(10,s),m=Math.floor(l/h)*h,p=(Math.ceil(e/h)*h-m)/h,b=Math.abs(p-t);(c<0||b<d)&&(!r||p<=t)&&(d=b,c=h)}return l=Math.floor(l/c)*c,e=Math.ceil(e/c)*c,t=Math.round((e-l)/c),{scale:s,step:c,count:t,min:l,max:e}};var Ue=class{date_format=!1;string_format=!1;fraction_format=!1;twelve_hour=!1;fraction_denominator=0;fraction_integer=!0;fraction_align=0;fraction_denominator_digits=0;integer_min_digits=0;decimal_min_digits=0;decimal_max_digits=0;grouping=!1;has_number_format=!1;prefix=[{text:""}];suffix=[{text:""}];scaling=0;percent=!1;exponential=!1;has_asterisk=!1};var Di=42,zi=95,Pr=63,Mt=48,Li=46,Hr=44,Ii=37,Or=34,ut=35,Fi=59,Ut=92,Ni=64,To=91,Mo=93,Pi=69,Hi=101,Uo=72,Vo=104,Do=77,zo=109,Lo=83,Io=115,Fo=68,No=100,Po=89,Ho=121,Oo=65,Go=97;var Vt=class{static date_pattern=!1;static pattern="";static char_index=0;static characters=[];static sections=[];static current_section=new Ue;static preserve_formatting_characters=!1;static decimal_mark=Li;static group_separator=Hr;static Parse(e){if(this.pattern=e,this.characters=e.split("").map(t=>t.charCodeAt(0)),this.char_index=0,this.current_section=new Ue,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new Ue,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let e="";for(this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Ut:this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(e+=this.pattern[++this.char_index]);break;case Or:return this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated string")}static ConsumeFormatting(){let e="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Ut:throw new Error("invalid escape character in formatting block");case Mo:return this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated format")}static ScanFractionFormat(){let e=/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/,r=this.pattern.substr(this.char_index).match(e);if(!r)return!1;let i=(r[1]||"").length+r[2].length+r[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!r[1];let n=Number(r[3]);return isNaN(n)||(this.current_section.fraction_denominator=n),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=r[3].length,this.char_index+=i,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let e=0;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let r=!1;for(let i=this.char_index+1;!r&&i<this.characters.length;i++){let n=this.characters[i];if(n===this.decimal_mark||n===ut||n===Mt)r=!0;else if(n!==Hr)break}if(r){if(e===1)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=(this.current_section.scaling||1)*1e3}break;case this.decimal_mark:if(e===1)throw new Error("too many decimal marks");e=1;break;case ut:e===1?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case Mt:e===1?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(e=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],e&&this.char_index++}static AppendString(e){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=e:this.current_section.prefix[this.current_section.prefix.length-1].text+=e}static AppendTextPart(e){this.current_section.has_number_format?(this.current_section.suffix.push(e),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(e),this.current_section.prefix.push({text:""}))}static ConsumeChar(){let e=this.characters[this.char_index];if(!((e===Pr||e===ut)&&!this.current_section.has_number_format&&!this.current_section.string_format&&this.ScanFractionFormat()))switch(e){case Fi:this.char_index++,this.current_section=new Ue,this.sections.length===3&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case Ni:this.char_index++,this.AppendTextPart({text:"@",flag:5}),this.current_section.string_format=!0;break;case Mt:case ut:case Li:case Hr:!this.current_section.has_number_format&&!this.current_section.string_format?(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0):this.AppendCharAsText();break;case To:this.AppendTextPart({text:this.ConsumeFormatting(),flag:6});break;case Or:this.AppendString(this.ConsumeString());break;case Pr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case zi:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case Di:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case Hi:case Pi:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case Ii:!this.current_section.exponential&&!this.current_section.string_format&&(this.current_section.percent=!0),this.AppendCharAsText();break;case Ut:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(let e of this.sections)for(let t of e.prefix)t.flag&&t.flag&7&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach((e,t)=>{if(e.flag===3&&(e.text==="mm"||e.text==="m")){if(t)for(let r=t-1;r;r--){let i=this.sections[0].prefix[r];if(i.flag===3){/h/i.test(i.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}if(t<this.sections[0].prefix.length-1)for(let r=t+1;r<this.sections[0].prefix.length;r++){let i=this.sections[0].prefix[r];if(i.flag===3){/s/i.test(i.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}}})),this.date_pattern}static ConsumeDatePart(){let e=this.pattern[this.char_index++],t=e.toLowerCase(),r={text:e,flag:3};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===t;)r.text+=this.pattern[this.char_index++];if(t==="s"&&this.pattern[this.char_index]===".")for(r.text+=this.pattern[this.char_index++];this.pattern[this.char_index]==="0";)r.text+=this.pattern[this.char_index++];return r}static ConsumeAMPM(){let e=this.pattern.substr(this.char_index,5);if(e==="am/pm"||e==="AM/PM")return this.char_index+=5,this.sections[0].twelve_hour=!0,{text:e,flag:3};if(e=this.pattern.substr(this.char_index,3),e==="a/p"||e==="A/P")return this.char_index+=3,this.sections[0].twelve_hour=!0,{text:e,flag:3}}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case Fi:this.char_index=this.characters.length;break;case Mt:case ut:case Hi:case Pi:case Ii:case Ni:this.date_pattern=!1;break;case Uo:case Vo:case Do:case zo:case Lo:case Io:case Fo:case No:case Po:case Ho:this.AppendTextPart(this.ConsumeDatePart());break;case Oo:case Go:{let t=this.ConsumeAMPM();t?this.AppendTextPart(t):this.AppendCharAsText()}break;case Or:this.AppendString(this.ConsumeString());break;case Pr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case zi:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case Di:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case Ut:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}};var Re=l=>(l>=60&&l--,new Date(-22090752e5+864e5*l)),Ce=(l,e=!0)=>{if(e){let t=new Date(l);l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()).getTime()}return l=(l+22090752e5)/864e5,l>=60&&l++,l},le=class l{static grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g;static fraction_limits=[9,99,999,9999];static imaginary_character="\u{1D456}";static minus_character="-";magic_decimal=!1;transform_value;_pattern="";sections;decimal_zero_regexp=[];cloned=[];get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}constructor(e){if(this._pattern=e,this.sections=Vt.Parse(e),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new Ue),this.sections[1]||(this.sections[1]={...this.sections[0]},this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]={...this.sections[0]},this.cloned[2]=!0),!this.sections[3]){for(let t of this.sections[0].prefix)if(t.flag===5){this.sections[3]={...this.sections[0]},this.sections[3].string_format=!0,this.cloned[3]=!0;break}}this.decimal_zero_regexp=this.sections.map(t=>{if(t.decimal_max_digits>t.decimal_min_digits)return new RegExp(`0{1,${t.decimal_max_digits-t.decimal_min_digits}}(?:$|e)`)})}static FormatPartsAsText(e,t=0){let r=-1,i=e.map((n,o)=>{switch(n.flag){case 2:return r=o,n.text;case 1:return n.text.replace(/./g," ");case 6:return"";default:return n.text}});if(r>=0&&t){let n=i.reduce((s,a,c)=>c===r?s:s+a.length,0),o="";for(let s=0;s<t-n;s++)o+=i[r];i[r]=o}return i.join("")}SetDecimal(e){for(let t of this.sections)t.fraction_format||(t.decimal_min_digits=e,t.decimal_max_digits=e)}IncreaseDecimal(){this.sections.forEach(e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.min(e.fraction_denominator_digits+1,4)):(e.decimal_min_digits++,e.decimal_max_digits=e.decimal_min_digits)})}DecreaseDecimal(){this.sections.forEach(e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.max(e.fraction_denominator_digits-1,1)):(e.decimal_min_digits=Math.max(0,e.decimal_min_digits-1),e.decimal_max_digits=e.decimal_min_digits)})}AddGrouping(){this.sections.forEach(e=>{e.grouping=!0})}RemoveGrouping(){this.sections.forEach(e=>{e.grouping=!1})}ToggleGrouping(){let e=!this.sections[0].grouping;this.sections.forEach(t=>{t.grouping=e})}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter((e,t)=>!this.cloned[t]).map(e=>{let t="",r=0;if(e.fraction_format){e.fraction_integer&&(t+="? ");let i="";for(let n=0;n<e.fraction_denominator_digits;n++)i+="#";t+=i,t+="/",e.fraction_denominator?t+=e.fraction_denominator:t+=i}else if(e.has_number_format){for(r=0;r<e.integer_min_digits;r++)t+="0";if(e.grouping&&(t.length<4&&(t=("####"+t).slice(-4)),t=t.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),e.decimal_max_digits||e.decimal_min_digits){for(t+=".",r=0;r<e.decimal_min_digits;r++)t+="0";for(;r<e.decimal_max_digits;r++)t+="#"}if(e.scaling){let i=Math.log10(e.scaling)/3;for(r=0;r<i;r++)t+=","}e.exponential&&(t+="e")}return e.prefix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.flag===6?"["+i.text+"]":i.text).join("")+t+e.suffix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.text).join("")}).join(";")}FormatDimensionedQuantity(e){if(this.transform_value){let r=this.transform_value(e);if(Dr(r))e=r;else return typeof r=="string"?r:this.FormatParts(r)}let t=this.FormatParts(e.value||0);return e.unit&&t.push({text:" "},{text:e.unit}),t}FormatComplex(e){if(e.imaginary===1/0||e.imaginary===-1/0||e.real===1/0||e.real===-1/0)return[{text:"Infinity"}];let t=[],r=[],i=!1,n=!!e.imaginary;n&&(t=this.FormatParts(e.imaginary),n=t.some(a=>/[1-9]/.test(a.text)),t.length===1&&this.sections[0].integer_min_digits<=1&&t[0].text==="1"?(t[0].text="",i=!0):t.length===1&&this.sections[1].integer_min_digits<=1&&t[0].text==="-1"&&(t[0].text="-",i=!0));let o=!!e.real;o&&(r=this.FormatParts(e.real),o=r.some(a=>/[1-9]/.test(a.text)));let s=[];if(o||!o&&!n){if(s.push(...r),n){s.push({text:e.imaginary<0?` ${l.minus_character} `:" + "});let a=i?[]:this.FormatParts(Math.abs(e.imaginary));s.push(...a,{text:l.imaginary_character})}}else n&&s.push(...t,{text:l.imaginary_character});return s}FormatParts(e){if(typeof e!="number"&&!this.sections[3])return[{text:(e??"").toString()}];let{parts:t,section:r}=this.BaseFormat(e),i=[];if(r.date_format||r.string_format)for(let n of t)typeof n=="string"?i.push({text:n}):i.push(n);else this.magic_decimal&&t[1]===""&&t.splice(1,1),i=[...r.prefix.map(n=>({...n})),{text:r.has_number_format?t.join(F.decimal_separator):""},...r.suffix.map(n=>({...n}))];for(let n=1;n<i.length;n++)i[n].flag===i[n-1].flag&&(i[n].text=i[n-1].text+i[n].text,i[n-1].text="");return i.filter(n=>n.text)}Format(e,t=0){return l.FormatPartsAsText(this.FormatParts(e),t)}ZeroPad(e,t){for(;e.length<t;)e="0"+e;return e}DateFormat(e){let t=Re(e),r=this.sections[0],i=t.getUTCHours();return r.twelve_hour&&(i>12&&(i-=12),i===0&&(i=12)),{parts:r.prefix.map(o=>{if(o.flag===4)return o.text==="mm"?{text:this.ZeroPad(t.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(t.getUTCMinutes().toString(),1)};if(o.flag===3){switch(o.text.toLowerCase()){case"am/pm":case"a/p":{let a=o.text.split("/");return{text:t.getUTCHours()>12?a[1]:a[0]}}case"mmmmm":return{text:F.date_components.long_months[t.getUTCMonth()][0]};case"mmmm":return o.text==="MMMM"?{text:F.date_components.long_months[t.getUTCMonth()].toUpperCase()}:{text:F.date_components.long_months[t.getUTCMonth()]};case"mmm":return o.text==="MMM"?{text:F.date_components.short_months[t.getUTCMonth()].toUpperCase()}:{text:F.date_components.short_months[t.getUTCMonth()]};case"mm":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return o.text==="DDDDD"||o.text==="DDDD"?{text:F.date_components.long_days[t.getUTCDay()].toUpperCase()}:{text:F.date_components.long_days[t.getUTCDay()]};case"ddd":return o.text==="DDD"?{text:F.date_components.short_days[t.getUTCDay()].toUpperCase()}:{text:F.date_components.short_days[t.getUTCDay()]};case"dd":return{text:this.ZeroPad(t.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(t.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:t.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((t.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(i.toString(),2)};case"h":return{text:this.ZeroPad(i.toString(),1)};case"ss":return{text:this.ZeroPad(t.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(t.getUTCSeconds().toString(),1)}}let s=o.text.match(/^(s+)\.(0+)$/);if(s)return{text:this.ZeroPad(t.getUTCSeconds().toString(),s[1].length)+F.decimal_separator+(t.getUTCMilliseconds()/1e3).toFixed(s[2].length).substr(2)}}return{...o}}),section:r}}StringFormat(e,t){let r=[];for(let i of t.prefix)i.flag===5?r.push({text:e}):r.push({...i});return{parts:r,section:t}}Round2(e,t){let r=Math.pow(10,t);return Math.round(r*e)/r}FormatFraction(e,t){t.percent&&(e*=100);let r={denominator:1,numerator:Math.round(e),error:Math.abs(Math.round(e)-e)};if(t.fraction_denominator)r.denominator=t.fraction_denominator,r.numerator=Math.round(e*r.denominator);else if(r.error){let n=l.fraction_limits[t.fraction_denominator_digits-1]||l.fraction_limits[0];for(let o=2;o<=n;o++){let s=Math.round(e*o),a=Math.abs(s/o-e);if(a<r.error&&(r={numerator:s,denominator:o,error:a},!a))break}}let i=[];if(t.fraction_integer){let n=Math.floor(r.numerator/r.denominator);r.numerator%=r.denominator,(n||!r.numerator)&&(i.push(n.toString()),r.numerator&&i.push(" "))}else r.numerator||i.push("0");return r.numerator&&(i.push(r.numerator.toString()),i.push("/"),i.push(r.denominator.toString())),i.join("")}BaseFormat(e){if(this.sections[0].date_format)return this.DateFormat(Number(e));if(typeof e!="number")return this.StringFormat((e??"").toString(),this.sections[3]);let t=this.sections[0],r=this.decimal_zero_regexp[0];e<0&&(t=this.sections[1]);let i=t.percent?t.decimal_max_digits+2:t.decimal_max_digits,n=Math.pow(10,-i)/2,o=Math.abs(e);if(o<n&&(t=this.sections[2],r=this.decimal_zero_regexp[2]),t.scaling&&(o/=t.scaling,o<n&&(t=this.sections[2],r=this.decimal_zero_regexp[2])),t.string_format)return this.StringFormat(e.toString(),t);let s="";if(t.fraction_format)return{parts:[this.FormatFraction(o,t)],section:t};t.exponential?s=o.toExponential(t.decimal_max_digits):(t.percent&&(o*=100),s=this.Round2(o,t.decimal_max_digits).toFixed(t.decimal_max_digits)),r&&(s=s.replace(r,""));let a=s.split(".");for(;a[0].length<t.integer_min_digits;)a[0]=("0000000000000000"+a[0]).slice(-t.integer_min_digits);return t.integer_min_digits===0&&a[0]==="0"&&(a[0]=""),t.grouping&&(a[0]=a[0].replace(l.grouping_regexp,"$&"+F.grouping_separator)),{parts:a,section:t}}};var L=class{static cache={};static complex_general;static symbolc_name_map={};static base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"};static aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"};static Get(e,t=!1){if(t&&e==="General")return this.complex_general;let r=this.symbolc_name_map[e.toLowerCase()],i=this.cache[r||e];return i||(i=new le(e),this.cache[e]=i),i}static Equals(e,t){if(e===t)return!0;let r=this.Get(e),i=this.Get(t);return r.pattern===i.pattern}static Translate(e){let t=this.symbolc_name_map[e.toLowerCase()];return t?this.cache[t].toString():e}static SymbolicName(e){for(let t of Object.keys(this.base_formats))if(e===this.base_formats[t])return t;return null}static InitCache(){for(let e of Object.keys(this.base_formats))this.cache[e]=new le(this.base_formats[e]),this.symbolc_name_map[e.toLowerCase()]=e;this.cache.General.magic_decimal=!0,this.complex_general=new le("0.###"),this.complex_general.magic_decimal=!0;for(let e of Object.keys(this.aliases))this.cache[e]=this.cache[this.aliases[e]],this.symbolc_name_map[e.toLowerCase()]=e}};L.InitCache();var Oi=new Date().getUTCFullYear(),Br=class{compare_day;compare_month;TestDate(e){let t=Date.parse(e);if(isNaN(t))return!1;let r=new Date(t),n=e.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map(a=>a.trim()).filter(a=>!!a);if(!n.length)return t;if(!this.compare_month){this.compare_month={};for(let a=0;a<12;a++)this.compare_month[F.date_components.long_months[a].toLocaleLowerCase().replace(/\./,"")]=a,this.compare_month[F.date_components.short_months[a].toLocaleLowerCase().replace(/\./,"")]=a}if(!this.compare_day){this.compare_day={};for(let a=0;a<7;a++)this.compare_day[F.date_components.long_days[a].toLocaleLowerCase().replace(/\./,"")]=a,this.compare_day[F.date_components.short_days[a].toLocaleLowerCase().replace(/\./,"")]=a}let o=!1,s=!1;for(let a of n){let c=!1;for(let[d,u]of Object.entries(this.compare_month))if(a===d){if(o||r.getUTCMonth()!==u)return!1;c=!0,o=!0}if(!c){for(let[d,u]of Object.entries(this.compare_day))if(a===d){if(s||r.getUTCDay()!==u)return!1;c=!0,s=!0}}if(!c)return!1}return s&&!o?!1:t}TryParse(e=""){let t={};if(e[0]==="'")return{value:e,type:2};if(e==="")return{value:e,type:2};if(e==="NaN")return{value:NaN,type:3,hints:{Nan:!0}};let r=e.trim(),i=r.match(/^[$](.*?)$/);i&&(r=i[1],t.Currency=!0);let n=r.match(/^\((.*?)\)$/);n&&(r=n[1],t.Parens=!0);let o=r.match(/^(.*?)%\s*$/);o&&(r=o[1],t.Percent=!0),F.decimal_separator==="."?/,/.test(r)&&(r=r.replace(/,/g,""),t.Grouping=!0):(r=r.replace(/(\d)\s+/g,"$1"),r=r.replace(/\./g,""),r=r.replace(/,/,"."));let s=Number(r);if(s===null||isNaN(s)){let a=e.toLowerCase();if(a==="false")return{value:!1,type:4};if(a==="true")return{value:!0,type:4};let c=this.TestDate(e);if(c!==!1&&!isNaN(c)){let d=new Date(c),u=d.getUTCFullYear();if(u>=Oi-200&&u<=Oi+200)return t={Date:!0},(d.getHours()||d.getMinutes()||d.getSeconds())&&(t.Time=!0),{value:Ce(c,!0),type:3,hints:t}}return{value:e,type:2}}if(n&&(s=-s),o){let a=s<0?-1:1,c=(a*s).toString().split(".");c[0]=("00"+c[0]).replace(/(\d\d)$/,".$1"),s=Number(c.join(""))*a}return/e/.test(e)&&(t.Exponential=!0),{value:s,type:3,hints:t}}},ge=new Br;var Dt=class{constructor(e,t,r={x:0,y:0},i){this.theme=t;this.offset=r;let n=H.GetInstance(i.ownerDocument);this.g=n.SVG("g"),this.g.setAttribute("transform",`translate(${r.x}, ${r.y})`),this.outline=n.SVG("rect","treb-selection-outline"),e?(this.g.setAttribute("class","selection primary-selection"),this.fill=n.SVG("path","treb-selection-fill"),this.nub=n.SVG("rect","treb-selection-nub"),this.g.appendChild(this.fill),this.g.appendChild(this.outline),this.g.appendChild(this.nub)):(this.g.setAttribute("class","selection alternate-selection"),this.fill=n.SVG("rect","treb-selection-fill"),this.g.appendChild(this.fill),this.g.appendChild(this.outline))}g;outline;fill;nub;Offset(e){this.g.setAttribute("transform",`translate(${e.x}, ${e.y})`)}Show(e=!0){this.g.style.display=e?"block":"none"}SetOutline(e,t=!1){this.outline.setAttribute("x",(e.left-1).toString()),this.outline.setAttribute("y",(e.top-1).toString()),this.outline.setAttribute("width",(e.width+1).toString()),this.outline.setAttribute("height",(e.height+1).toString()),t&&this.fill&&(this.fill.setAttribute("x",e.left.toString()),this.fill.setAttribute("y",e.top.toString()),this.fill.setAttribute("width",e.width.toString()),this.fill.setAttribute("height",e.height.toString()))}SetFill(e,t){if(!this.fill)return;let r=[];r.push("M"+e.left+" "+e.top),r.push("L"+e.left+" "+e.bottom),r.push("L"+e.right+" "+e.bottom),r.push("L"+e.right+" "+e.top),r.push("Z"),r.push("M"+t.left+" "+t.top),r.push("L"+t.right+" "+t.top),r.push("L"+t.right+" "+t.bottom),r.push("L"+t.left+" "+t.bottom),r.push("Z"),this.fill.setAttribute("d",r.join(" "))}SetNub(e){this.nub&&(this.nub.setAttribute("x",(e.left+e.width-4).toString()),this.nub.setAttribute("y",(e.top+e.height-4).toString()),this.nub.setAttribute("width","7"),this.nub.setAttribute("height","7"))}};var Oe=class{constructor(e,t,r){this.theme=e;this.container=t;this.orientation=r;let i=H.GetInstance(t.ownerDocument);this.g=i.SVG("g","treb-header-overlay"),this.overlay=i.SVG("rect","treb-overlay"),this.highlight=i.SVG("rect","treb-highlight"),this.g.style.display="none",this.g.appendChild(this.highlight),this.g.appendChild(this.overlay),t.appendChild(this.g)}g;overlay;highlight;Remove(){this.container.removeChild(this.g)}Hide(){this.g.style.display="none"}Show(e,t,r,i){this.overlay.setAttribute("x",e.toString()),this.overlay.setAttribute("y",t.toString()),this.overlay.setAttribute("width",r.toString()),this.overlay.setAttribute("height",i.toString()),this.orientation===0?(this.highlight.setAttribute("x",e.toString()),this.highlight.setAttribute("y",(t+i-2).toString()),this.highlight.setAttribute("width",r.toString()),this.highlight.setAttribute("height","2")):(this.highlight.setAttribute("x",(e+r-2).toString()),this.highlight.setAttribute("y",t.toString()),this.highlight.setAttribute("width","2"),this.highlight.setAttribute("height",i.toString())),this.g.style.display="block"}};var zt=class{constructor(e,t,r,i,n,o){this.theme=e;this.layout=t;this.model=r;this.view=i;this.primary_selection=n;this.additional_selections=o}nub_rectangle=new B(-1,-1,0,0);cached_additional_selections="";grid_selections=[];row_header_selections=[];column_header_selections=[];corner_selections=[];row_overlay;column_overlay;corner_row_overlay;corner_column_overlay;Initialize(){this.row_overlay=new Oe(this.theme,this.layout.row_header_selection,0),this.column_overlay=new Oe(this.theme,this.layout.column_header_selection,1),this.corner_row_overlay=new Oe(this.theme,this.layout.corner_selection,0),this.corner_column_overlay=new Oe(this.theme,this.layout.corner_selection,1)}RenderSelections(e=!0,t=!0){let r=this.primary_selection.empty;e||(this.primary_selection.empty=!0);let i=[this.primary_selection].concat(this.additional_selections);this.RenderSelectionGroup(i,this.layout.grid_selection,void 0,void 0,this.grid_selections,void 0,t);let n=new B(-1,-1,0,0);if(!this.primary_selection.empty){let a=this.view.active_sheet.RealArea(this.primary_selection.area);n=this.layout.CellAddressToRectangle(a.start).Combine(this.layout.CellAddressToRectangle(a.end))}if(!this.primary_selection.empty&&this.layout.header_offset.y>2?(this.row_overlay.Show(n.left,0,n.width,this.layout.header_offset.y),this.corner_row_overlay.Show(n.left+this.layout.header_offset.x,0,n.width,this.layout.header_offset.y)):(this.row_overlay.Hide(),this.corner_row_overlay.Hide()),!this.primary_selection.empty&&this.layout.header_offset.x>2?(this.column_overlay.Show(0,n.top,this.layout.header_offset.x,n.height),this.corner_column_overlay.Show(0,n.top+this.layout.header_offset.y,this.layout.header_offset.x,n.height)):(this.column_overlay.Hide(),this.corner_column_overlay.Hide()),!this.view.active_sheet.freeze.columns&&!this.view.active_sheet.freeze.rows){this.primary_selection.empty=r;return}let o=[],s=[];if(this.primary_selection.empty)o.push(!1),s.push(!1);else{let a=this.primary_selection.area.start;o.push(a.row<=this.view.active_sheet.freeze.rows||a.row===1/0),s.push(a.column<=this.view.active_sheet.freeze.columns||a.column===1/0)}for(let{area:a}of this.additional_selections)o.push(a.start.row<=this.view.active_sheet.freeze.rows||a.start.row===1/0),s.push(a.start.column<=this.view.active_sheet.freeze.columns||a.start.column===1/0);this.view.active_sheet.freeze.rows&&this.RenderSelectionGroup(i,this.layout.row_header_selection,o,void 0,this.row_header_selections,{x:0,y:this.layout.header_offset.y}),this.view.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.column_header_selection,s,void 0,this.column_header_selections,{x:this.layout.header_offset.x,y:0}),this.view.active_sheet.freeze.rows&&this.view.active_sheet.freeze.columns&&this.RenderSelectionGroup(i,this.layout.corner_selection,s,o,this.corner_selections,{...this.layout.header_offset}),this.primary_selection.empty=r}RenderSelectionGroup(e,t,r,i,n,o,s=!0){for(let a=0;a<e.length;a++)if((!e[a].area.start.sheet_id||e[a].area.start.sheet_id===this.view.active_sheet.id)&&!e[a].empty&&(!r||r[a])&&(!i||i[a])){if(s||!e[a].rendered){let d=this.EnsureGridSelectionBlock(t,n,a,o);this.RenderSVGSelection(e[a],d,a)}}else n[a]&&n[a].Show(!1);for(let a=e.length;a<n.length;a++)n[a]&&n[a].Show(!1)}EnsureGridSelectionBlock(e,t,r,i){let n=t[r];if(!n)if(n=new Dt(!r,this.theme,void 0,e),t[r]=n,r){let o=e.querySelector(".alternate-selections");o||(o=this.layout.DOM.SVG("g","alternate-selections"),e.appendChild(o)),o?.appendChild(n.g)}else e.appendChild(n.g);return i&&n.Offset(i),n}ClampEnd(e){return{row:Math.min(e.row,this.view.active_sheet.rows-1),column:Math.min(e.column,this.view.active_sheet.columns-1)}}RenderSVGSelection(e,t,r=0){let i=this.view.active_sheet.RealArea(e.area,!0),n=this.layout.CellAddressToRectangle(i.start);if(i.count>1)n=n.Combine(this.layout.CellAddressToRectangle(i.end));else if(r){let o=this.view.active_sheet.CellData(e.target);o.merge_area&&(n=this.layout.CellAddressToRectangle(o.merge_area.start),n=n.Combine(this.layout.CellAddressToRectangle(o.merge_area.end)))}if(r||(this.nub_rectangle=new B(n.left+n.width-6,n.top+n.height-6,11,11)),n.top===0&&this.layout.header_offset.y<=1&&(n.top=1,n.height-=1),n.left===0&&this.layout.header_offset.x<=1&&(n.left=1,n.width-=1),n.height<=0||n.height<=0){t.Show(!1);return}if(t.SetOutline(n,!!r),r)e.rendered=!0;else{let o=this.layout.CellAddressToRectangle(e.target),s=this.view.active_sheet.CellData(e.target);s.merge_area&&(o=this.layout.CellAddressToRectangle(s.merge_area.start),o=o.Combine(this.layout.CellAddressToRectangle(s.merge_area.end))),t.SetFill(o,n),t.SetNub(n)}t.Show()}};function Se(l,e=[],t,r){typeof e=="string"&&(e=[e]);let i,n=s=>{s.stopPropagation(),s.preventDefault(),i(),r&&r(s)},o=s=>{if(s.stopPropagation(),s.preventDefault(),!s.buttons){i(),r&&r(s);return}t&&t(s)};i=()=>{l.style.display="none",l.removeEventListener("mousemove",o),l.removeEventListener("mouseup",n);for(let s of e)l.classList.remove(s)};for(let s of e)l.classList.add(s);l.style.display="block",t&&l.addEventListener("mousemove",o),r&&l.addEventListener("mouseup",n)}var Lt=class extends be{constructor(t){super();this.container=t;this.format=L.Get("0.0");let r=H.GetInstance(t.ownerDocument);this.input=r.Create("input","treb-scale-input",t,{events:{keypress:n=>{switch(n.key){case"ArrowUp":case"ArrowDown":n.stopPropagation(),n.preventDefault(),console.info("mark?");break}},keydown:n=>{switch(n.key){case"Enter":this.input.blur();break;case"ArrowUp":this.Tick(-1);break;case"ArrowDown":this.Tick(1);break;case"Escape":this.input.value=this.format.Format(this.scale)+"%",this.input.blur();break;default:return}n.stopPropagation(),n.preventDefault()},focusin:()=>this.input.select(),change:()=>{let n=this.input.value;n=n.replace(/%/g,"");let o=ge.TryParse(n);o.type===3?this.UpdateScale(Number(o.value),!0):this.input.value=this.format.Format(this.scale)+"%"}}});let i=r.Div("treb-slider-container",t);this.slider=r.Create("input",void 0,i,{attrs:{type:"range",min:"50",max:"200",value:"100",step:"2.5"},events:{input:()=>this.UpdateScale(Number(this.slider.value),!0)}}),t.addEventListener("wheel",n=>{n.stopPropagation(),n.preventDefault(),this.Tick(n.deltaY)})}input;slider;scale=0;format;timeout=0;Tick(t){let r=Math.round(this.scale/2.5)*2.5;t>0?this.UpdateScale(r-2.5,!0,!0):t<0&&this.UpdateScale(r+2.5,!0,!0)}UpdateScale(t,r=!1,i=!1){t=Math.max(50,Math.min(200,t)),t!==this.scale&&(this.scale=t,this.input.value=this.format.Format(t)+"%",this.slider.value=t.toFixed(1),r&&(this.timeout||(this.timeout=requestAnimationFrame(()=>{this.timeout=0,this.Publish({type:"scale",value:this.scale/100,keep_focus:i})}))))}};var It=class extends be{constructor(t,r,i,n,o,s){super();this.layout=t;this.model=r;this.view=i;this.options=n;this.theme=o;if(this.DOM=H.GetInstance(s.ownerDocument),this.container=s.querySelector(".treb-spreadsheet-footer"),!this.container)throw new Error("missing container for tab bar");if(n.tab_bar!=="auto"&&this.container.removeAttribute("hidden"),this.tab_container=this.container.querySelector(".treb-spreadsheet-tabs"),this.container.addEventListener("click",a=>{let c=a.target?.dataset.command;if(c)switch(a.stopPropagation(),a.preventDefault(),c){case"add-tab":this.Publish({type:"add-sheet"});break;case"delete-tab":this.Publish({type:"delete-sheet"});break;default:console.info("unhandled command",c)}}),this.options.stats&&(this.stats_panel=this.container.querySelector(".treb-stats-panel")),this.options.scale_control){let a=this.container.querySelector(".treb-scale-control");this.scale_control=new Lt(a),this.scale_control.Subscribe(c=>{this.Publish(c)}),this.UpdateScale(this.options.initial_scale||1)}}tab_container;scale_control;stats_panel;dragging=!1;double_click_data={};tab_color_cache=new Map;_visible=!1;get visible(){return this._visible}set stats_data(t){if(this.stats_panel){this.stats_panel.innerText="";for(let r of t)this.DOM.Create("span","treb-stats-label",this.stats_panel,{text:r.label}),this.DOM.Create("span","treb-stats-value",this.stats_panel,{text:r.value})}}container;DOM;IsDoubleClick(t,r=300){return this.double_click_data.index===t?(clearTimeout(this.double_click_data.timeout),this.double_click_data.index=void 0,this.double_click_data.timeout=void 0,!0):(this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.index=t,this.double_click_data.timeout=window.setTimeout(()=>{this.double_click_data.index=void 0,this.double_click_data.timeout=void 0},r),!1)}Hide(){this.Show(!1)}Show(t=!0){this.container&&(this._visible=t,t?this.container.removeAttribute("hidden"):this.container.setAttribute("hidden",""))}SetActive(t,r){r?(t.setAttribute("selected",""),t.dataset.background_color&&(t.style.backgroundColor=`color-mix(in srgb, ${t.dataset.background_color} 20%, var(--treb-tab-bar-active-tab-background, #fff))`,t.style.color=""),requestAnimationFrame(()=>{t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})})):(t.removeAttribute("selected"),t.dataset.background_color&&(t.style.backgroundColor=t.dataset.background_color),t.dataset.foreground_color&&(t.style.color=t.dataset.foreground_color))}UpdateScale(t){this.scale_control?.UpdateScale(t*100)}DoubleClickTab(t,r,i){if(r.contentEditable="true",this.DOM.doc){let n=this.DOM.GetSelection();if(n){n.removeAllRanges();let o=this.DOM.doc.createRange();o.selectNodeContents(r),n.addRange(o)}}r.addEventListener("keydown",n=>{switch(n.key){case"Enter":this.Publish({type:"rename-sheet",name:r.innerText.trim(),sheet:i});break;case"Escape":r.innerText=i.name,this.Publish({type:"cancel"}),this.Update();break;default:return}n.stopPropagation(),n.preventDefault()}),r.addEventListener("focusout",()=>{let n=r.innerText.trim();n!==i.name?this.Publish({type:"rename-sheet",name:n,sheet:i}):this.Update()}),r.focus()}MouseDownTab(t,r,i,n,o){if(t.stopPropagation(),t.preventDefault(),this.IsDoubleClick(n))return;this.Publish({type:"activate-sheet",sheet:i});let s=o.map(p=>p.getBoundingClientRect()),a=n*2-1,c=s[0].left,d=s[s.length-1].right,u=s[0].top,h=s[0].bottom,m=-1,f=(s.length-1)*2+1;for(let p of o)this.SetActive(p,p===r);this.dragging=!0,Se(this.layout.mask,[],p=>{let[b,g]=[p.clientX,p.clientY];if(g>u&&g<h){let x=a;if(b<c)x=m;else if(b>d)x=f;else for(let v=0;v<s.length;v++){let w=s[v];if(b>=w.left&&b<=w.right){v!==n&&(b>=w.left+w.width/2?x=v*2+1:x=v*2-1);break}}x!==a&&(a=x,r.style.order=a.toString(),s=o.map(v=>v.getBoundingClientRect()))}},()=>{let p=n,b=(a+1)/2;this.dragging=!1;for(let g=0;g<this.model.sheets.length;g++)this.model.sheets.list[g].visible||(p>=g&&p++,b>=g&&b++);p===b||p===0&&b<=0||p===o.length-1&&b>=o.length-1||this.Publish({type:"reorder-sheet",index:p,move_before:b})})}UpdateTheme(){this.tab_color_cache.clear(),this.Update()}Update(){if(this.tab_color_cache.clear(),this.dragging)return;if(this.options.tab_bar==="auto"){if(this.model.sheets.list.reduce((i,n)=>n.visible?i+1:i,0)<=1){this.Show(!1);return}this.Show(!0)}if(!this.tab_container)return;this.tab_container.innerText="";let t=[];for(let r of this.model.sheets.list){if(!r.visible)continue;let i=t.length,n=this.DOM.Create("li");if(n.setAttribute("tabindex","0"),r.tab_color){let a=r.id;if(!this.tab_color_cache.has(a)){let d=V(this.theme,r.tab_color),u=V(this.theme,{offset:r.tab_color});d&&u&&this.tab_color_cache.set(a,{background:d,foreground:u})}let c=this.tab_color_cache.get(a);c&&(n.style.backgroundColor=c.background,n.style.color=c.foreground,n.dataset.background_color=c.background,n.dataset.foreground_color=c.foreground)}n.style.order=(i*2).toString(),n.role="tab",this.SetActive(n,r===this.view.active_sheet);let o=a=>this.MouseDownTab(a,n,r,i,t),s=a=>{n.removeEventListener("mousedown",o),n.removeEventListener("dblclick",s),this.DoubleClickTab(a,n,r)};n.textContent=r.name,n.addEventListener("dblclick",s),n.addEventListener("mousedown",o),this.tab_container.appendChild(n),t.push(n)}}};var Ye=class{constructor(e,t,r=!1,i=H.GetInstance()){this.model=e;this.view=t;this.DOM=i;if(r)return;if(!i)throw new Error("missing DOM context");this.dpr=Math.max(1,self.devicePixelRatio||1),this.mask=i.Div("treb-mouse-mask"),this.tooltip=i.Div("treb-tooltip"),this.spill_border=i.SVG("svg","treb-spill-border"),this.spill_border.tabIndex=-1,this.dropdown_caret=i.SVG("svg","treb-dropdown-caret"),this.dropdown_caret.setAttribute("viewBox","0 0 24 24"),this.dropdown_caret.tabIndex=-1;let n=i.SVG("path");n.setAttribute("d","M5,7 L12,17 L19,7"),this.dropdown_caret.appendChild(n),this.dropdown_caret.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.grid_cover.classList.remove("nub-select");let s=this.dropdown_caret.getAttribute("class")||"";/active/i.test(s)?this.dropdown_caret.setAttribute("class","treb-dropdown-caret"):(this.dropdown_caret.setAttribute("class","treb-dropdown-caret active"),this.dropdown_list.focus())}),this.dropdown_list=i.Div("treb-dropdown-list",void 0,{attrs:{tabindex:"-1"}}),this.dropdown_list.addEventListener("keydown",o=>{let s=0;switch(o.key){case"ArrowDown":s=1;break;case"ArrowUp":s=-1;break;case"Escape":break;case"Enter":break;default:console.info(o.key);return}if(o.stopPropagation(),o.preventDefault(),o.key==="Escape"||o.key==="Enter"){if(this.container?.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),o.key==="Enter"&&this.dropdown_callback&&this.dropdown_selected){let a=this.dropdown_selected.dataset.dropdown_value;this.dropdown_callback.call(0,a?JSON.parse(a):void 0)}}else if(s&&this.dropdown_selected)if(s>0&&this.dropdown_selected.nextSibling){this.dropdown_selected.nextSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.nextSibling;let a=this.dropdown_selected.offsetTop+this.dropdown_selected.offsetHeight;a>this.dropdown_list.offsetHeight+this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=a-this.dropdown_list.offsetHeight)}else s<0&&this.dropdown_selected.previousSibling&&(this.dropdown_selected.previousSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.previousSibling,this.dropdown_selected.offsetTop<this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=this.dropdown_selected.offsetTop))}),this.dropdown_list.addEventListener("mousedown",o=>{let s=o.target;if(o.target!==this.dropdown_list&&(o.stopPropagation(),o.preventDefault(),this.container?.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_callback)){let a=s.dataset.dropdown_value;this.dropdown_callback.call(0,a?JSON.parse(a):void 0)}}),this.dropdown_list.addEventListener("mousemove",o=>{let s=o.target;s!==this.dropdown_selected&&(this.grid_cover.classList.remove("nub-select"),this.dropdown_selected&&this.dropdown_selected.classList.remove("selected"),s.classList.add("selected"),this.dropdown_selected=s)}),this.mock_selection=i.Div("mock-selection-node",void 0,{html:"&nbsp;"}),this.note_node=i.Div("treb-note"),this.title_node=i.Div("treb-hover-title"),this.sort_button=i.Create("button","treb-sort-button",void 0,{attrs:{title:"Sort table",tabindex:"-1"}}),this.HideNote()}column_header;row_header;contents;buffer_canvas;corner;corner_canvas;grid_selection;grid_cover;column_header_cover;row_header_cover;annotation_container;mask;mock_selection;container;grid_tiles=[];column_header_tiles=[];row_header_tiles=[];corner_selection;row_header_selection;column_header_selection;corner_annotations;row_header_annotations;column_header_annotations;frozen_row_tiles=[];frozen_column_tiles=[];header_size={width:0,height:0};applied_theme_colors=[];last_column=0;total_height=0;total_width=0;default_row_height=0;default_column_width=0;header_offset={x:0,y:0};dpr=1;scale=1;scroll_reference_node;get scroll_offset(){return this.scroll_reference_node?{x:this.scroll_reference_node.scrollLeft,y:this.scroll_reference_node.scrollTop}:{x:0,y:0}}set scroll_offset(e){this.scroll_reference_node&&(this.scroll_reference_node.scrollLeft=e.x,this.scroll_reference_node.scrollTop=e.y)}dropdown_caret;spill_border;trident=typeof navigator<"u"&&navigator.userAgent&&/trident/i.test(navigator.userAgent);default_tile_size={width:1200,height:800};tooltip_state;tooltip;dropdown_list;dropdown_caret_visible=!1;dropdown_callback;dropdown_selected;note_node;sort_button;title_node;row_cache=[];column_cache=[];initialized=!1;FocusInLayout(e){return!1}UpdateDPR(){let e=Math.max(1,self.devicePixelRatio||1);return e===this.dpr?!1:(this.dpr=e,!0)}ColumnWidth(e){return Math.round(this.view.active_sheet.GetColumnWidth(e)*this.scale)}RowHeight(e){return Math.round(this.view.active_sheet.GetRowHeight(e)*this.scale)}SetRowHeight(e,t){this.view.active_sheet.SetRowHeight(e,Math.round(t/this.scale))}SetColumnWidth(e,t){this.view.active_sheet.SetColumnWidth(e,Math.round(t/this.scale))}ShowSelections(e=!0){this.grid_selection.style.display=e?"block":"none"}HideTitle(){this.title_node.style.opacity="0"}ShowTitle(e,t){if(this.title_node.textContent=e,!this.title_node.parentElement)return;let r=this.title_node.parentElement.getBoundingClientRect(),i=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.title_node.style.left=r.left+i.left-this.scroll_reference_node.scrollLeft+0+"px",this.title_node.style.top=r.top+i.bottom-this.scroll_reference_node.scrollTop+8+"px",this.title_node.style.opacity="1"}HideNote(){this.note_node.style.opacity="0",this.note_node.style.pointerEvents="none"}HideTableSortButton(){this.sort_button.style.opacity="0",this.sort_button.style.pointerEvents="none",this.sort_button.setAttribute("tabindex","-1")}ShowTableSortButton(e,t,r){if(!this.sort_button.parentElement)return;let i=!0,n=!1;e.sort&&e.sort.column===t&&(i=!e.sort.asc,n=!0),this.sort_button.setAttribute("tabindex","0  "),this.sort_button.style.opacity="1",this.sort_button.style.pointerEvents="initial",this.sort_button.classList.remove("asc","desc"),n&&this.sort_button.classList.add(i?"asc":"desc"),this.sort_button.dataset.asc=i.toString(),this.sort_button.dataset.table=e.name,this.sort_button.dataset.column=t.toString();let o=this.OffsetCellAddressToRectangle(r).Shift(this.header_size.width,this.header_size.height),s=this.sort_button.getBoundingClientRect();this.sort_button.style.left=o.right-s.width-s.width/2+"px",this.sort_button.style.top=o.top+(o.height-s.height)/2+"px"}ShowNote(e,t,r,i){if(i?this.note_node.innerHTML=i:this.note_node.textContent=e,!this.note_node.parentElement)return;let n=this.note_node.getBoundingClientRect(),o=this.note_node.parentElement.getBoundingClientRect(),s={x:8,y:2},a=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.note_node.style.left=o.left+a.right-this.scroll_reference_node.scrollLeft+s.x+"px",this.note_node.style.top=o.top+a.top-this.scroll_reference_node.scrollTop-n.height/5-s.y+"px",this.note_node.style.opacity="1",this.note_node.style.pointerEvents="auto"}AnnotationLayoutOrder(e,t){let r=-1;for(let n=0;n<this.view.active_sheet.annotations.length;n++)if(this.view.active_sheet.annotations[n]===e){r=n;break}if(r<0)return!1;let i=Math.min(Math.max(0,r+t),this.view.active_sheet.annotations.length-1);if(i===r)return!1;this.view.active_sheet.annotations.splice(r,1),this.view.active_sheet.annotations.splice(i,0,e);for(let n=0;n<this.view.active_sheet.annotations.length;n++){let o=this.view.active_sheet.annotations[n].key,s=this.container?.querySelectorAll(`.annotation[data-key="${o}"]`);if(s)for(let a=0;a<s?.length;a++)s[a].style.zIndex=(n+1).toString()}return!0}PointToAnnotationCorner(e){let t=this.PointToAddress_Grid(e,!1),r=this.CellAddressToRectangle(t);return{address:t,offset:{x:(e.x-r.left)/r.width,y:(e.y-r.top)/r.height}}}RectToAnnotationLayout(e){return{tl:this.PointToAnnotationCorner({x:(e.left||0)+1,y:(e.top||0)+1}),br:this.PointToAnnotationCorner({x:e.right||e.left||100,y:e.bottom||e.top||100})}}AddressToAnnotationLayout(e,t){let r={tl:this.CellAddressToRectangle(e),br:this.CellAddressToRectangle(t)};return{tl:this.PointToAnnotationCorner({x:r.tl.left||0,y:r.tl.top||0}),br:this.PointToAnnotationCorner({x:r.br.right||r.tl.left||100,y:r.br.bottom||r.tl.left||100})}}AnnotationLayoutToRect(e){let t=this.CellAddressToRectangle(e.tl.address),r=this.CellAddressToRectangle(e.br.address),i=t.left+t.width*e.tl.offset.x-1,n=t.top+t.height*e.tl.offset.y-1;return new B(i,n,r.left+r.width*e.br.offset.x-i,r.top+r.height*e.br.offset.y-n)}UpdateAnnotation(e,t){Array.isArray(e)||(e=[e]);for(let r of e){let i=r.view[this.view.view_index]||{};if(i.node){let n=10*this.scale;if(r.data.style?.font_size?.unit==="em"&&(n*=r.data.style.font_size.value),i.node.dataset.scale=this.scale.toString(),r.data.style?.font_face&&r.data.style.font_face.startsWith("stack:")){let o=r.data.style.font_face.substring(6),s=t.font_stacks[o];s?(i.node.classList.add("treb-inherit-font"),i.node.style.fontFamily=s.font||"",s.variants&&(i.node.style.fontVariant=s.variants)):(i.node.classList.remove("treb-inherit-font"),i.node.style.fontFamily="",i.node.style.fontVariant="")}else i.node.classList.remove("treb-inherit-font"),i.node.style.fontFamily="",i.node.style.fontVariant="";if(r.data.style?.bold?i.node.style.fontWeight="600":i.node.style.fontWeight="400",r.data.style?.italic?i.node.style.fontStyle="italic":i.node.style.fontStyle="",r.data.style?.underline?i.node.style.textDecoration="underline":i.node.style.textDecoration="",i.node.style.fontSize=`${n}pt`,r.rect&&!r.data.layout&&(r.scaled_rect=r.rect.Scale(this.scale),r.data.layout=this.RectToAnnotationLayout(r.scaled_rect)),r.data.layout){let o=this.AnnotationLayoutToRect(r.data.layout);o.ApplyStyle(i.node),r.scaled_rect=o}i.node.dataset.key=r.key.toString(),(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.CloneFrozenAnnotation(r)}}}GetFrozenAnnotations(e){return[this.row_header_annotations,this.column_header_annotations,this.corner_annotations].map(r=>r.querySelector(`.annotation[data-key="${e.key}"]`)).filter(r=>r!==null)}CloneFrozenAnnotations(){for(let e of this.view.active_sheet.annotations)e.view[this.view.view_index]?.node&&e.key&&this.CloneFrozenAnnotation(e)}ClearFrozenAnnotations(){for(let e of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let t=e.querySelectorAll(".annotation");for(let r=0;r<t.length;r++)t[r].parentElement?.removeChild(t[r])}}RemoveFrozenAnnotation(e){for(let t of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=t.querySelector(`.annotation[data-key="${e.key}"]`);r&&r.parentElement?.removeChild(r)}}CloneFrozenAnnotation(e){for(let t of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=t.querySelector(`.annotation[data-key="${e.key}"]`);r&&r.parentElement?.removeChild(r);let i=e.view[this.view.view_index];if(r=i?.node?.cloneNode(!0),r){let n=r.querySelector(".annotation-move-target"),o=r.querySelector(".annotation-resize-target");r.addEventListener("mousedown",s=>{let a=i.node;requestAnimationFrame(()=>{a?.focus()}),this.AnnotationMouseDown(e,i.node,s,n,o)}),t.appendChild(r)}}}RemoveAnnotation(e){let t=e.view[this.view.view_index]||{};t.node&&t.node.parentElement?.removeChild(t.node),this.RemoveFrozenAnnotation(e)}RemoveAnnotationNodes(){let e=Array.prototype.map.call(this.annotation_container.children,t=>t);for(let t of e)this.annotation_container.removeChild(t);(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.ClearFrozenAnnotations()}AddAnnotation(e,t){let r=e.view[this.view.view_index]||{};if(!r.node)throw new Error("annotation view/node missing");this.annotation_container.appendChild(r.node),this.UpdateAnnotation(e,t)}AnnotationMouseDown(e,t,r,i,n){let o=e.scaled_rect;return o?new Promise(s=>{let a={left:o.left,top:o.top,width:o.width,height:o.height},c=this.scroll_reference_node,d=c.getBoundingClientRect(),u=t.getBoundingClientRect();if(r.target===i||r.target!==n&&r.altKey){r.stopPropagation(),r.preventDefault(),t.focus();let h={x:u.left+r.offsetX-o.left,y:u.top+r.offsetY-o.top},m=[t,...this.GetFrozenAnnotations(e)],f=25,p=this.CellAddressToRectangle({row:0,column:0}).Combine(this.CellAddressToRectangle({row:this.view.active_sheet.rows-1,column:this.view.active_sheet.columns-1})).Expand(-1,-1);Se(this.mask,"move",b=>{if(b.offsetY-d.top<this.header_offset.y){let g=Math.min(f,c.scrollTop);c.scrollTop-=g,h.y+=g}else if(b.offsetY-d.top>=d.height&&c.scrollTop+d.height<p.height){let g=f;c.scrollTop+=g,h.y-=g}if(b.offsetX-d.left<this.header_offset.x){let g=Math.min(f,c.scrollLeft);c.scrollLeft-=g,h.x+=g}else if(b.offsetX-d.left>=d.width&&c.scrollLeft+d.width<p.width){let g=f;c.scrollLeft+=g,h.x-=g}if(o.top=b.offsetY-h.y,o.left=b.offsetX-h.x,b.shiftKey){let g=Math.abs(o.left-a.left),x=Math.abs(o.top-a.top);g<=x?o.left=a.left:o.top=a.top}if(b.ctrlKey){let g=this.ClampToGrid({x:o.left,y:o.top});o.left=g.x,o.top=g.y}for(let g of m)g.style.top=o.top+"px",g.style.left=o.left+"px"},()=>{e.data.extent=void 0,e.data.layout=this.RectToAnnotationLayout(o),s({type:"annotation",annotation:e,event:"move"})});return}else if(r.target===n){r.stopPropagation(),r.preventDefault(),t.focus();let h=0;e.data.type==="image"&&e.data.data&&e.data.data.original_size&&e.data.data.original_size.width&&e.data.data.original_size.height&&(h=e.data.data.original_size.width/e.data.data.original_size.height);let m=t.getBoundingClientRect(),f={x:m.left+r.offsetX-o.width+n.offsetLeft,y:m.top+r.offsetY-o.height+n.offsetTop};Se(this.mask,"nw-resize",p=>{let b=[t,...this.GetFrozenAnnotations(e)];if(o.height=p.offsetY-f.y,o.width=p.offsetX-f.x,p.shiftKey&&p.ctrlKey){if(h){let g=Math.abs(o.width-a.width),x=Math.abs(o.height-a.height);g<x?o.width=h*o.height:o.height=o.width/h}}else if(p.shiftKey){let g=Math.abs(o.height-a.height),x=Math.abs(o.width-a.width);g>x?o.width=a.width:o.height=a.height}else if(p.ctrlKey){let g=this.ClampToGrid({x:o.right,y:o.bottom});o.width=g.x-o.left+1,o.height=g.y-o.top+1}for(let g of b)g.style.height=o.height+"px",g.style.width=o.width+"px"},()=>{e.data.extent=void 0,e.data.layout=this.RectToAnnotationLayout(o),s({type:"annotation",annotation:e,event:"resize"})});return}else s()}):(console.info("missing scaled rect!"),Promise.reject())}Initialize(e,t,r=!0){this.mask.parentElement||e.parentElement?.parentElement?.appendChild(this.mask),this.tooltip.parentElement||e.appendChild(this.tooltip),this.spill_border.parentElement||e.appendChild(this.spill_border),this.dropdown_caret.parentElement||e.appendChild(this.dropdown_caret),this.dropdown_list.parentElement||e.appendChild(this.dropdown_list),this.note_node.parentElement||e.appendChild(this.note_node),this.sort_button.parentElement||(e.appendChild(this.sort_button),this.sort_button.addEventListener("click",()=>{t.sort(this.sort_button.dataset.table||"",Number(this.sort_button.dataset.column||"0")||0,/true/i.test(this.sort_button.dataset.asc||"")),this.sort_button.classList.remove("asc","desc"),this.sort_button.dataset.asc==="true"?(this.sort_button.dataset.asc="false",this.sort_button.classList.add("desc")):(this.sort_button.dataset.asc="true",this.sort_button.classList.add("asc")),t.focus()})),this.title_node.parentElement||e.appendChild(this.title_node),this.InitializeInternal(e,t.scroll),!r&&this.scroll_reference_node&&(this.scroll_reference_node.style.overflow="hidden"),this.dropdown_callback=t.dropdown,this.initialized=!0}MockSelection(){if(this.container&&!this.trident&&this.DOM.doc){let e=this.DOM.GetSelection();if(e){let t=this.DOM.doc.createRange();t.selectNodeContents(this.mock_selection),e.removeAllRanges(),e.addRange(t)}}}CreateTile(e,t,r,i,n,o,s,a=!0){let c=this.DOM.Create("canvas");return c.setAttribute("class",e),c.logical_size=t,c.width=t.width*this.dpr,c.height=t.height*this.dpr,c.style.width=`${t.width}px`,c.style.height=`${t.height}px`,c.tile_position=r,c.first_cell=i,this.UpdateTileGridPosition(c),c.last_cell={row:i.row+n.rows-1,column:i.column+n.columns-1},c.pixel_start=o,c.pixel_end={x:o.x+t.width,y:o.y+t.height},c.dirty=!!a,c.needs_full_repaint=!0,s.appendChild(c),c}ApplyThemeColors(){if(this.container)for(let[e,t]of this.applied_theme_colors.entries())this.container.style.setProperty(`--treb-applied-theme-color-${e+1}`,t)}ApplyTheme(e){this.row_header.style.backgroundColor=this.column_header.style.backgroundColor=this.corner.style.backgroundColor=e.headers?.fill?V(e,e.headers.fill,0):"",this.corner.style.borderColor=e.grid_color||"";for(let t of this.grid_tiles)for(let r of t)r.style.backgroundColor=V(e,e.grid_cell?.fill,0)||"#fff";this.dropdown_list.style.font=I.CompositeFont(e.grid_cell_font_size,{font_face:"stack:default"},this.scale,e).font,this.applied_theme_colors=e.theme_colors?.slice(4,10)||[],this.container&&this.ApplyThemeColors()}UpdateTotalSize(){this.total_height=0;let e=this.view.active_sheet.rows;for(let r=0;r<e;r++)this.total_height+=this.RowHeight(r);this.total_width=0;let t=this.view.active_sheet.columns;for(let r=0;r<t;r++)this.total_width+=this.ColumnWidth(r)}UpdateContentsSize(){let e=this.row_header_tiles.reduce((r,i)=>r+i.logical_size.height,0),t=this.column_header_tiles.reduce((r,i)=>r+i.logical_size.width,0);this.column_header.style.width=this.contents.style.width=`${t}px`,this.row_header.style.height=this.contents.style.height=`${e}px`}HideTooltip(){this.tooltip.style.display="none",this.tooltip_state=void 0,this.tooltip.classList.remove("arrow-up"),this.tooltip.classList.remove("arrow-left")}ShowTooltip(e={}){e.up?(this.tooltip.classList.add("arrow-up"),this.tooltip_state="up"):e.left&&(this.tooltip.classList.add("arrow-left"),this.tooltip_state="left"),this.tooltip.style.display="block",this.UpdateTooltip(e)}ShowDropdownCaret(e,t,r){let i=this.OffsetCellAddressToRectangle(e.start);e.count>1&&(i=i.Combine(this.OffsetCellAddressToRectangle(e.end))),i=i.Shift(this.header_size.width,this.header_size.height);let n=Math.round(this.scale*Math.max(8,Math.min(20,i.height)));this.dropdown_caret.style.height=`${n}px`,this.dropdown_caret.style.width=`${n}px`,this.dropdown_caret.style.left=`${i.right+1}px`,this.dropdown_caret.style.top=`${i.bottom-n}px`,this.dropdown_list.style.top=`${i.bottom+2}px`,this.dropdown_list.style.left=`${i.left+2}px`,this.dropdown_list.style.minWidth=`${i.width}px`,this.dropdown_list.style.fontSize=this.scale.toFixed(2)+"em",this.dropdown_list.textContent="";for(let o of t){let s=this.DOM.Div(void 0,this.dropdown_list);r===o&&(this.dropdown_selected=s,s.classList.add("selected")),s.dataset.dropdown_value=JSON.stringify(o),s.textContent=o?.toString()||""}this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.style.display="block",this.dropdown_caret_visible=!0}ShowSpillBorder(e){if(this.spill_border.textContent="",e){let t=new y(e.start,e.end),r=this.OffsetCellAddressToRectangle(t.start);t.count>1&&(r=r.Combine(this.OffsetCellAddressToRectangle(t.end))),r=r.Shift(this.header_size.width,this.header_size.height),this.spill_border.style.display="block",this.spill_border.style.top=(r.top-5).toString()+"px",this.spill_border.style.left=(r.left-5).toString()+"px",this.spill_border.style.width=(r.width+10).toString()+"px",this.spill_border.style.height=(r.height+10).toString()+"px";let i=this.DOM.SVG("rect",void 0,this.spill_border);i.setAttribute("x","4.5"),i.setAttribute("y","4.5"),i.setAttribute("width",(r.width+1).toString()),i.setAttribute("height",(r.height+1).toString())}else this.spill_border.style.display="none"}HideDropdownCaret(){this.dropdown_caret_visible&&(this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret_visible=!1,this.dropdown_caret.style.display="none")}GetScrollOffset(){return{x:this.scroll_reference_node.scrollLeft+this.header_offset.x,y:this.scroll_reference_node.scrollTop+this.header_offset.y}}ScrollTo(e,t=!0,r=!0,i=!1){let n=this.CellAddressToRectangle(e);if(i&&this.scroll_reference_node.scrollTo){let o={left:this.scroll_reference_node.scrollLeft,top:this.scroll_reference_node.scrollTop},s={left:t?n.left:o.left,top:r?n.top:o.top,behavior:"smooth"};this.scroll_reference_node.scrollTo(s)}else r&&(this.scroll_reference_node.scrollTop=n.top),t&&(this.scroll_reference_node.scrollLeft=n.left)}ScrollIntoView(e,t=!1){let r=this.CellAddressToRectangle(e),i=this.scroll_reference_node.clientWidth-this.row_header.offsetWidth,n=this.scroll_reference_node.clientHeight-this.column_header.offsetHeight,o={x:0,y:0},s={x:!1,y:!1},a=new B(this.scroll_reference_node.scrollLeft,this.scroll_reference_node.scrollTop,i,n);(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&(this.view.active_sheet.freeze.rows&&e.row>=this.view.active_sheet.freeze.rows?o.y=this.frozen_row_tiles[0].logical_size.height:this.view.active_sheet.freeze.rows&&(s.y=!0),this.view.active_sheet.freeze.columns&&e.column>=this.view.active_sheet.freeze.columns?o.x=this.frozen_column_tiles[0].logical_size.width:this.view.active_sheet.freeze.columns&&(s.x=!0));let c={behavior:t?"smooth":"auto"};e.row!==1/0&&(r.top<a.top+o.y&&!s.y?c.top=r.top-o.y:r.bottom>a.bottom&&(c.top=r.bottom-n)),e.column!==1/0&&(r.left<a.left+o.x&&!s.x?c.left=r.left-o.x:r.right>a.right&&(c.left=r.right-i)),this.scroll_reference_node.scrollTo(c)}UpdateTooltip(e={}){if(typeof e.text<"u"&&(this.tooltip.textContent=e.text),typeof e.x<"u"){let t=e.x||0;this.tooltip_state==="up"&&(t-=this.tooltip.offsetWidth/2),this.tooltip.style.left=Math.round(t)+"px"}if(typeof e.y<"u"){let t=e.y||0;this.tooltip_state==="left"&&(t-=this.tooltip.offsetHeight/2),this.tooltip.style.top=Math.round(t)+"px"}}CoordinateToRowHeader(e){let t={column:1/0,row:0};if(this.view.active_sheet.freeze.rows&&this.frozen_row_tiles[0].pixel_end.y>=e-this.scroll_reference_node.scrollTop){let r=0;e-=this.scroll_reference_node.scrollTop;for(let i=0;i<this.view.active_sheet.freeze.rows;i++)if(r+=this.RowHeight(i),r>=e)return t.row=i,t}for(let r of this.row_header_tiles)if(r.pixel_end.y>=e){let i=e-r.pixel_start.y,n=0;for(t.row=r.first_cell.row;t.row<=r.last_cell.row;t.row++,i-=n)if(n=this.RowHeight(t.row),n>i)return t;return t}return t}CoordinateToColumnHeader(e){let t={row:1/0,column:0};if(this.view.active_sheet.freeze.columns&&this.frozen_column_tiles[0].pixel_end.x>=e-this.scroll_reference_node.scrollLeft){let r=0;e-=this.scroll_reference_node.scrollLeft;for(let i=0;i<this.view.active_sheet.freeze.columns;i++)if(r+=this.ColumnWidth(i),r>=e)return t.column=i,t}for(let r of this.column_header_tiles)if(r.pixel_end.x>=e){let i=e-r.pixel_start.x,n=0;for(t.column=r.first_cell.column;t.column<=r.last_cell.column;t.column++,i-=n)if(n=this.ColumnWidth(t.column),n>i)return t;return t}return t}PointToAddress_Grid(e,t=!0){if(t){if(this.view.active_sheet.freeze.rows){let o=this.frozen_row_tiles[0].logical_size.height;e.y-this.scroll_reference_node.scrollTop<o&&(e.y-=this.scroll_reference_node.scrollTop)}if(this.view.active_sheet.freeze.columns){let o=this.frozen_column_tiles[0].logical_size.width;e.x-this.scroll_reference_node.scrollLeft<o&&(e.x-=this.scroll_reference_node.scrollLeft)}}let r={row:0,column:0},i=this.grid_tiles[this.grid_tiles.length-1],n=i[i.length-1];if(e.y>n.pixel_end.y){let o=e.y-n.pixel_end.y;for(r.row=n.last_cell.row;o>0;)r.row++,o-=this.default_row_height}else for(let o of i)if(o.pixel_start.y<=e.y&&o.pixel_end.y>=e.y){let s=e.y-o.pixel_start.y,a=0;for(r.row=o.first_cell.row;r.row<=o.last_cell.row&&(a=this.RowHeight(r.row),!(a>s));r.row++,s-=a);break}if(e.x>n.pixel_end.x){let o=e.x-n.pixel_end.x;for(r.column=n.last_cell.column;o>0;)r.column++,o-=this.default_column_width}else for(let o of this.grid_tiles)if(o[0].pixel_start.x<=e.x&&o[0].pixel_end.x>=e.x){let s=o[0],a=e.x-s.pixel_start.x,c=0;for(r.column=s.first_cell.column;r.column<=s.last_cell.column&&(c=this.ColumnWidth(r.column),!(c>a));r.column++,a-=c);break}return r}AdjacentTile(e,t=0,r=0){if(!t&&!r)return e;let i=e.tile_position,n=e.tile_position.row+t,o=e.tile_position.column+r;if(!(n<0||o<0)){if(this.grid_tiles[i.column]&&this.grid_tiles[i.column][i.row]===e&&this.grid_tiles[o])return this.grid_tiles[o][n];if(!i.column&&this.frozen_column_tiles[i.row]===e)return this.frozen_column_tiles[n];if(!i.row&&this.frozen_row_tiles[i.column]===e)return this.frozen_row_tiles[o]}}UpdateTiles(){if(!this.container)throw new Error("invalid container");this.grid_tiles.forEach(w=>{w.forEach(_=>{_.parentElement&&_.parentElement.removeChild(_)})});for(let w of[this.column_header_tiles,this.row_header_tiles,this.frozen_row_tiles,this.frozen_column_tiles])for(let _ of w)_.parentElement&&_.parentElement.removeChild(_);this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.row_header_tiles=[],this.column_header_tiles=[],this.grid_tiles=[];let e=this.view.active_sheet;this.default_row_height=Math.round(e.default_row_height*this.scale),this.default_column_width=Math.round(e.default_column_width*this.scale),this.header_offset={x:Math.round(e.header_offset.x*this.scale),y:Math.round(e.header_offset.y*this.scale)},this.UpdateContainingGrid();let t=this.view.active_sheet.rows,r=this.view.active_sheet.columns;t||(t=100),r||(r=40);let i=0,n=0;for(let w=0;w<t;w++)i+=this.RowHeight(w);for(let w=0;w<r;w++)n+=this.ColumnWidth(w);if(!n||!i)throw"unexpected missing total size";if(i||(i=this.default_row_height*t),n||(n=this.default_column_width*r),this.container.clientWidth>n+this.header_size.width){let w=Math.ceil((this.container.offsetWidth-n)/this.default_column_width);n+=w*this.default_column_width,r+=w}if(this.last_column=r,this.container.clientHeight>i+this.header_size.height){let w=Math.ceil((this.container.offsetHeight-i)/this.default_row_height);i+=w*this.default_row_height,t+=w}this.column_header.style.width=this.contents.style.width=`${n}px`,this.row_header.style.height=this.contents.style.height=`${i}px`;let o=[],s=[],a=0,c=0;for(let w=0;w<r;w++){let _=this.ColumnWidth(w);a&&a+_>this.default_tile_size.width&&(o.push(a),s.push(c),c=w,a=0),a+=_}o.push(a),s.push(c);let d=[],u=[],h=0,m=0;for(let w=0;w<t;w++){let _=this.RowHeight(w);h&&h+_>this.default_tile_size.height&&(d.push(h),u.push(m),h=0,m=w),h+=_}d.push(h),u.push(m);let f=o.length,p=d.length,b=0,g=0,x=0,v=0;for(let w=0;w<this.view.active_sheet.freeze.rows;w++)x+=this.RowHeight(w);for(let w=0;w<this.view.active_sheet.freeze.columns;w++)v+=this.ColumnWidth(w);for(let w=0;w<f;w++){let _=[];b=0;let C=w===f-1?r-s[w]:s[w+1]-s[w];this.column_header_tiles.push(this.CreateTile("column-header-tile",{height:this.header_offset.y,width:o[w]},{row:0,column:w},{row:0,column:s[w]},{rows:0,columns:C},{x:g,y:0},this.column_header)),this.view.active_sheet.freeze.rows&&this.frozen_row_tiles.push(this.CreateTile("frozen-row-tile",{height:x,width:o[w]},{row:1,column:w},{row:0,column:s[w]},{rows:0,columns:C},{x:g,y:0},this.column_header));for(let S=0;S<p;S++){let A=S===p-1?t-u[S]:u[S+1]-u[S];w||(this.row_header_tiles.push(this.CreateTile("row-header-tile",{height:d[S],width:this.header_offset.x},{row:S,column:0},{row:u[S],column:0},{rows:A,columns:1},{x:0,y:b},this.row_header)),this.view.active_sheet.freeze.columns&&this.frozen_column_tiles.push(this.CreateTile("frozen-column-tile",{height:d[S],width:v},{row:S,column:1},{row:u[S],column:0},{rows:A,columns:1},{x:0,y:b},this.row_header))),_.push(this.CreateTile("grid-tile",{height:d[S],width:o[w]},{row:S,column:w},{row:u[S],column:s[w]},{rows:A,columns:C},{x:g,y:b},this.contents)),b+=d[S]}this.grid_tiles.push(_),g+=o[w]}this.total_height=i,this.total_width=n,this.ClearLayoutCaches(),this.UpdateGridTemplates(!0,!0)}ClearLayoutCaches(){this.row_cache=[],this.column_cache=[]}TileIndexForColumn(e){for(let t of this.column_header_tiles)if(t.first_cell.column<=e&&t.last_cell.column>=e)return t.tile_position.column;return-1}TileIndexForRow(e){for(let t of this.row_header_tiles)if(t.first_cell.row<=e&&t.last_cell.row>=e)return t.tile_position.row;return-1}DirtyHeaders(e){if(e){for(let t of this.column_header_tiles){if(t.dirty)continue;let r=new y({row:e.start.row,column:t.first_cell.column},{row:e.start.row,column:t.last_cell.column});(e.entire_row||r.Intersects(e))&&(t.dirty=!0)}for(let t of this.row_header_tiles){if(t.dirty)continue;let r=new y({column:e.start.column,row:t.first_cell.row},{column:e.start.column,row:t.last_cell.row});(e.entire_column||r.Intersects(e))&&(t.dirty=!0)}}}DirtyAll(){for(let e of this.grid_tiles)for(let t of e)t.dirty=!0}DirtyArea(e){if(this.initialized){Array.isArray(e)||(e=[e]);for(let t of e){let r={row:0,column:0},i={row:this.grid_tiles[0].length-1,column:this.grid_tiles.length-1};t.start.column!==1/0&&(r.column=i.column=this.TileIndexForColumn(t.start.column),t.end.column!==t.start.column&&(i.column=this.TileIndexForColumn(t.end.column))),t.start.row!==1/0&&(r.row=i.row=this.TileIndexForRow(t.start.row),t.end.row!==t.start.row&&(i.row=this.TileIndexForRow(t.end.row)));for(let n=r.column;n<=i.column;n++)for(let o=r.row;o<=i.row;o++)this.grid_tiles[n][o].dirty=!0}}}VisibleTiles(){let e=[{row:0,column:0},{row:0,column:0}];if(!this.container||!this.grid_tiles.length||!this.grid_tiles[0].length)return new y(e[0],e[1]);let t=this.scroll_reference_node.scrollLeft,r=t+this.scroll_reference_node.offsetWidth,i=this.scroll_reference_node.scrollTop,n=i+this.scroll_reference_node.offsetHeight;for(let o of this.grid_tiles){let s=o[0];if(s.pixel_start.x<=t&&s.pixel_end.x>=t){for(s of o)if(s.pixel_start.y<=i&&s.pixel_end.y>=i){e[0]=s.tile_position;break}}if(o===this.grid_tiles[this.grid_tiles.length-1]||s.pixel_start.x<=r&&s.pixel_end.x>=r){for(s of o)if(s===o[o.length-1]||s.pixel_start.y<=n&&s.pixel_end.y>=n)return e[1]=s.tile_position,new y(e[0],e[1])}}return new y(e[0],e[1])}UpdateTileHeights(e=!0,t=-1){let r=0;for(let i=0;i<this.row_header_tiles.length;i++){let n=this.row_header_tiles[i];if(t>n.last_cell.row){r+=n.logical_size.height;continue}let o=0;for(let a=n.first_cell.row;a<=n.last_cell.row;a++)o+=this.RowHeight(a);let s=n.logical_size.height===o;if(n.pixel_start.y=r,r+=o,n.pixel_end.y=r,!s){if(n.logical_size.height=o,n.style.height=`${o}px`,n.height=this.dpr*o,this.view.active_sheet.freeze.columns){let a=this.frozen_column_tiles[i];a.logical_size.height=o,a.style.height=`${o}px`,a.height=this.dpr*o}e&&(n.dirty=!0,n.needs_full_repaint=!0)}for(let a of this.grid_tiles){let c=a[i];c.pixel_start.y=n.pixel_start.y,c.pixel_end.y=n.pixel_end.y,s||(c.logical_size.height=o,c.style.height=`${o}px`,c.height=this.dpr*o,e&&(c.dirty=!0,c.needs_full_repaint=!0))}}if(this.view.active_sheet.freeze.rows){let i=0;for(let n=0;n<this.view.active_sheet.freeze.rows;n++)i+=this.RowHeight(n);for(let n of this.frozen_row_tiles)n.style.height=`${i}px`,n.height=i*this.dpr;i+=this.header_offset.y,this.corner_canvas.style.height=`${i}px`,this.corner_canvas.height=i*this.dpr;for(let n of this.grid_tiles)n[0].dirty=!0}this.UpdateGridTemplates(!1,!0),this.row_header.style.height=this.contents.style.height=`${r}px`,this.ClearLayoutCaches()}UpdateTileWidths(e=!0,t=-1){let r=0;for(let i=0;i<this.column_header_tiles.length;i++){let n=this.column_header_tiles[i],o=this.grid_tiles[i];if(t>n.last_cell.column){r+=n.logical_size.width;continue}let s=0;for(let c=n.first_cell.column;c<=n.last_cell.column;c++)s+=this.ColumnWidth(c);let a=n.logical_size.width===s;if(n.pixel_start.x=r,r+=s,n.pixel_end.x=r,!a){if(n.logical_size.width=s,n.style.width=`${s}px`,n.width=this.dpr*s,this.view.active_sheet.freeze.rows){let c=this.frozen_row_tiles[i];c.logical_size.width=s,c.style.width=`${s}px`,c.width=this.dpr*s}e&&(n.dirty=!0,n.needs_full_repaint=!0)}for(let c of o)c.pixel_start.x=n.pixel_start.x,c.pixel_end.x=n.pixel_end.x,a||(c.logical_size.width=s,c.style.width=`${s}px`,c.width=this.dpr*s,e&&(c.dirty=!0,c.needs_full_repaint=!0))}if(this.view.active_sheet.freeze.columns){let i=0;for(let n=0;n<this.view.active_sheet.freeze.columns;n++)i+=this.ColumnWidth(n);for(let n of this.frozen_column_tiles)n.style.width=`${i}px`,n.width=i*this.dpr;i+=this.header_offset.x,this.corner_canvas.style.width=`${i}px`,this.corner_canvas.width=i*this.dpr;for(let n of this.grid_tiles[0])n.dirty=!0}this.UpdateGridTemplates(!0,!1),this.column_header.style.width=this.contents.style.width=`${r}px`,this.ClearLayoutCaches()}ClampToGrid(e){let t=this.PointToAddress_Grid(e),r=this.OffsetCellAddressToRectangle(t);return e.x>r.left+r.width/2?e.x=r.left+r.width-1:e.x=r.left-1,e.y>r.top+r.height/2?e.y=r.top+r.height-1:e.y=r.top-1,e}OffsetCellAddressToRectangle(e){let t=this.CellAddressToRectangle(e);return e.column>=0&&e.column<this.view.active_sheet.freeze.columns&&(t=t.Shift(this.scroll_reference_node.scrollLeft,0)),e.row>=0&&e.row<this.view.active_sheet.freeze.rows&&(t=t.Shift(0,this.scroll_reference_node.scrollTop)),t}CellAddressToRectangle(e){let t=e.row===1/0||e.row<0?0:e.row,r=e.column===1/0||e.column<0?0:e.column;if(this.column_cache.length<=r+1){this.column_cache.length||(this.column_cache[0]=0);for(let o=this.column_cache.length-1;o<=r;o++)this.column_cache[o+1]=this.column_cache[o]+this.ColumnWidth(o)}if(this.row_cache.length<=t+1){this.row_cache.length||(this.row_cache[0]=0);for(let o=this.row_cache.length-1;o<=t;o++)this.row_cache[o+1]=this.row_cache[o]+this.RowHeight(o)}let i=this.column_cache[r],n=this.row_cache[t];return new B(i,n,this.column_cache[r+1]-i,this.row_cache[t+1]-n)}ResizeTileWidth(e,t,r=!0){let i=this.column_header_tiles[e],n=t-i.logical_size.width;i.logical_size.width=t,i.style.width=`${t}px`,i.width=this.dpr*t,i.pixel_end.x+=n,r&&(i.dirty=!0,i.needs_full_repaint=!0);for(let s=e+1;s<this.column_header_tiles.length;s++){this.column_header_tiles[s].pixel_start.x+=n,this.column_header_tiles[s].pixel_end.x+=n;for(let a of this.grid_tiles[s])a.pixel_start.x+=n,a.pixel_end.x+=n}let o=this.grid_tiles[e];for(i of o)i.logical_size.width=t,i.style.width=`${t}px`,i.width=this.dpr*t,i.pixel_end.x+=n,r&&(i.dirty=!0,i.needs_full_repaint=!0);this.UpdateTotalSize(),this.UpdateGridTemplates(!0,!1),this.UpdateContentsSize()}ResizeTileHeight(e,t,r=!0){let i=this.row_header_tiles[e],n=t-i.logical_size.height;i.logical_size.height=t,i.style.height=`${t}px`,i.height=this.dpr*t,i.pixel_end.y+=n,r&&(i.dirty=!0,i.needs_full_repaint=!0);for(let o=e+1;o<this.row_header_tiles.length;o++)i=this.row_header_tiles[o],i.pixel_start.y+=n,i.pixel_end.y+=n;for(let o of this.grid_tiles){i=o[e],i.logical_size.height=t,i.style.height=`${t}px`,i.height=this.dpr*t,i.pixel_end.y+=n,r&&(i.dirty=!0,i.needs_full_repaint=!0);for(let s=e+1;s<o.length;s++)o[s].pixel_start.y+=n,o[s].pixel_end.y+=n}this.UpdateTotalSize(),this.UpdateGridTemplates(!1,!0),this.UpdateContentsSize()}};var Ft=class extends Ye{constructor(e,t){super(e,t,!0)}InitializeInternal(){}UpdateGridTemplates(){}UpdateTileGridPosition(){}UpdateContainingGrid(){}ResizeCursor(){}};var Nt=class extends Ye{constructor(e,t,r){super(e,t,!1,r),this.column_header=r.Div("treb-top-header"),this.row_header=r.Div("treb-left-header"),this.corner=r.Div("treb-corner"),this.corner_canvas=r.Create("canvas"),this.corner.appendChild(this.corner_canvas),this.contents=r.Div("treb-contents"),this.buffer_canvas=r.Create("canvas","treb-buffer-canvas",this.contents),this.grid_selection=r.SVG("svg","treb-grid-selection",this.contents),this.row_header_selection=r.SVG("svg",["frozen-selection","frozen-selection-rows"],this.column_header),this.row_header_annotations=r.Div("frozen-annotation-container frozen-annotation-container-rows",this.column_header),this.column_header_selection=r.SVG("svg",["frozen-selection","frozen-selection-columns"],this.row_header),this.column_header_annotations=r.Div("frozen-annotation-container frozen-annotation-container-columns",this.row_header),this.corner_selection=r.SVG("svg","frozen-selection",this.corner),this.corner_annotations=r.Div("frozen-annotation-container frozen-annotation-container-corner",this.corner),this.annotation_container=r.Div("treb-annotation-container"),this.grid_cover=r.Div("tile-cover grid-cover"),this.column_header_cover=r.Div("tile-cover column-header-cover"),this.row_header_cover=r.Div("tile-cover row-header-cover")}InitializeInternal(e,t){this.container=e,this.scroll_reference_node=this.container,e.appendChild(this.column_header),e.appendChild(this.row_header),e.appendChild(this.corner),e.appendChild(this.contents),e.appendChild(this.annotation_container),e.appendChild(this.grid_cover),e.appendChild(this.column_header_cover),e.appendChild(this.row_header_cover),e.appendChild(this.mock_selection),this.container.addEventListener("scroll",()=>t()),this.ApplyThemeColors()}FocusInLayout(e){return!!(e&&e instanceof Element&&this.container?.contains(e))}ResizeCursor(e){switch(e){case"row":this.row_header_cover.classList.add("resize");break;case"column":this.column_header_cover.classList.add("resize");break;default:this.row_header_cover.classList.remove("resize"),this.column_header_cover.classList.remove("resize");break}}UpdateTileGridPosition(e){e.style.gridColumn=`${e.tile_position.column+1} / ${e.tile_position.column+2}`,e.style.gridRow=`${e.tile_position.row+1} / ${e.tile_position.row+2}`}UpdateContainingGrid(){if(!this.container)throw new Error("missing container");this.header_size.width=this.header_offset.x,this.header_size.height=this.header_offset.y;let e=this.header_offset.x,t=this.header_offset.y;if(this.view.active_sheet.freeze.columns)for(let r=0;r<this.view.active_sheet.freeze.columns;r++)e+=this.ColumnWidth(r);if(this.view.active_sheet.freeze.rows)for(let r=0;r<this.view.active_sheet.freeze.rows;r++)t+=this.RowHeight(r);this.container.style.gridTemplateColumns=`${this.header_offset.x}px auto`,this.container.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.corner_canvas.setAttribute("width",`${this.dpr*e}`),this.corner_canvas.setAttribute("height",`${this.dpr*t}`),this.column_header.style.height=`${t}px`,this.corner_canvas.style.width=`${e}px`,this.corner_canvas.style.height=`${t}px`}UpdateGridTemplates(){let e=0,t=0;this.column_header.style.gridTemplateColumns=this.contents.style.gridTemplateColumns=this.column_header_tiles.map(s=>(e+=s.logical_size.width,`${s.logical_size.width}px`)).join(" "),this.column_header.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.row_header.style.gridTemplateRows=this.contents.style.gridTemplateRows=this.row_header_tiles.map(s=>(t+=s.logical_size.height,`${s.logical_size.height}px`)).join(" ");let r=this.header_offset.y;if(this.view.active_sheet.freeze.rows)for(let s=0;s<this.view.active_sheet.freeze.rows;s++)r+=this.RowHeight(s);this.column_header.style.height=`${r}px`,this.row_header_selection.style.display="block",this.row_header_selection.style.width=`${e}px`,this.corner_selection.style.height=this.row_header_selection.style.height=`${r}px`,this.corner_selection.style.top=this.row_header_selection.style.top="0px",this.row_header_selection.style.left="0px";let i=this.header_offset.x;if(this.view.active_sheet.freeze.columns)for(let s=0;s<this.view.active_sheet.freeze.columns;s++)i+=this.ColumnWidth(s);this.column_header_selection.style.display="block",this.corner_selection.style.width=this.column_header_selection.style.width=`${i}px`,this.column_header_selection.style.height=`${t}px`,this.column_header_selection.style.top="0px",this.corner_selection.style.left=this.column_header_selection.style.left="0px";let n={x:this.view.active_sheet.header_offset.x*this.scale,y:this.view.active_sheet.header_offset.y*this.scale},o=this.view.active_sheet.freeze;o.rows&&o.columns?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="block"):o.rows?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"):o.columns?(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="none"):(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"),this.row_header_annotations.style.width=`${e}px`,this.corner_annotations.style.height=this.row_header_annotations.style.height=`${r-n.y}px`,this.corner_annotations.style.top=this.row_header_annotations.style.top=`${n.y}px`,this.column_header_annotations.style.width=this.corner_annotations.style.width=`${i-n.x}px`,this.column_header_annotations.style.height=`${t}px`,this.corner_annotations.style.left=this.column_header_annotations.style.left=`${n.x}px`,this.corner_selection.style.display="block",this.grid_selection.style.width=`${e}px`,this.grid_selection.style.height=`${t}px`,this.grid_selection.style.top=`${this.header_offset.y}px`,this.grid_selection.style.left=`${this.header_offset.x}px`,this.annotation_container.style.width=`${e}px`,this.annotation_container.style.height=`${t}px`,this.annotation_container.style.top=`${this.header_offset.y}px`,this.annotation_container.style.left=`${this.header_offset.x}px`}};var Fe=class l extends be{constructor(t,r,i){super();this.model=t;this.view=r;this.autocomplete=i;this.parser=t.parser}static FormulaChars=("$^&*(-+={[<>/~%@"+F.argument_separator).split("");active_cell;autocomplete_matcher;container_node;active_editor;nodes=[];target_address;assume_formula=!1;text_formula=!1;get selecting(){if(this.assume_formula)return!0;if(!this.text_formula)return!1;if(this.active_editor&&this.active_editor.node===this.active_editor.node.ownerDocument.activeElement){let t=this.active_editor.node.ownerDocument.defaultView,r=t.getSelection();if(r?.rangeCount){let o=r?.getRangeAt(0);if((o?.endContainer instanceof t.HTMLElement?o.endContainer:o.endContainer?.parentElement)?.dataset.reference!==void 0)return!0;if(o?.startContainer instanceof t.Text){let a=(o.startContainer.textContent?.substring(0,o.startOffset)||"").trim();if(a.length&&l.FormulaChars.includes(a[a.length-1]))return!0}else console.info("mark 21",o)}let n=this.SubstringToCaret2(this.active_editor.node)[1].trim();if(n.length){let o=n[n.length-1];return l.FormulaChars.includes(o)}}return!1}composite_dependencies=[];get dependencies(){return this.composite_dependencies}parser;FocusEditor(){this.active_editor&&this.active_editor.node.focus()}RegisterListener(t,r,i){t.node.addEventListener(r,i),t.listeners||(t.listeners=new Map),t.listeners.set(r,i)}SelectAll(t){let i=t.ownerDocument.defaultView.getSelection(),n=t.ownerDocument.createRange();n.selectNode(t),i?.removeAllRanges(),i?.addRange(n)}SetCaret(t,r){let i=t.node.ownerDocument,n=i?.defaultView,o=n.getSelection(),s=i?.createRange(),a=d=>{let u=d;for(;u&&!(u instanceof n.Text)&&u.firstChild;)u=u.firstChild;return u},c=a(t.node);if(r){let d=a(r.node);o&&s&&(s.setStart(c,t.offset),s.setEnd(d,r.offset),o.removeAllRanges(),o.addRange(s))}else o&&s&&(s.setStart(c,t.offset),s.setEnd(c,t.offset),s.collapse(!0),o.removeAllRanges(),o.addRange(s))}InsertReference(t){if(!this.active_editor)return;let r=this.active_editor.node.ownerDocument.defaultView,i=r.getSelection();if(!i)throw new Error("error getting selection");if(i.rangeCount===0)return"";let n=i.getRangeAt(0),o=this.active_editor.node.textContent||"";if(n.startContainer instanceof r.Text)if(!n.collapsed&&n.startOffset<n.endOffset){let s=this.SubstringToCaret2(this.active_editor.node);this.active_editor.node.textContent=s[0]+t+o.substring(s[1].length),this.SetCaret({node:this.active_editor.node,offset:s[0].length},{node:this.active_editor.node,offset:s[0].length+t.length})}else{let s=n.startContainer.parentElement;if(s instanceof r.HTMLElement&&s.dataset.reference)s.textContent=t,this.SetCaret({node:s,offset:t.length});else{let a=this.SubstringToCaret2(this.active_editor.node)[1],c="",d=a.trim();if(d.length){let u=d[d.length-1];l.FormulaChars.includes(u)||(a.length===d.length?c=" +":c="+")}this.active_editor.node.textContent=a+c+t+o.substring(a.length),this.SetCaret({node:this.active_editor.node,offset:a.length+t.length+c.length})}}else n.startContainer instanceof r.HTMLElement?(n.startContainer.textContent=t,this.SetCaret({node:n.startContainer,offset:t.length})):console.warn("unexpected range start container",n.startContainer);this.UpdateText(this.active_editor),this.UpdateColors(),this.active_editor.node.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}UpdateColors(t=!1,r=!1){let i=new Map,n=new Map;for(let s of this.nodes)for(let a of s.references||[]){let c=this.model.AddressToLabel(a);i.has(c)||(i.set(c,a),n.set(c,n.size))}for(let s of this.nodes){for(let a of Array.from(s.node.childNodes)){let c=a.ownerDocument?.defaultView;if(c&&a instanceof c.HTMLElement&&a.dataset.reference){let d=n.get(a.dataset.reference);a.dataset.highlightIndex=typeof d=="number"?(d%5+1).toString():"?"}}s.check=s.node.innerHTML.length}let o=Array.from(i.values());!t&&JSON.stringify(this.composite_dependencies)===JSON.stringify(o)||(this.composite_dependencies=o,r||this.Publish({type:"update",dependencies:this.composite_dependencies}))}UpdateDependencies(t,r){let i=[];for(let a of r.full_reference_list||[])switch(a.type){case"address":case"range":{let c=a.type==="range"?a.start:a;c.sheet_id||(c.sheet?c.sheet_id=this.model.sheets.Find(c.sheet)?.id||0:c.sheet_id=this.view.active_sheet.id),i.push(a);break}case"structured-reference":if(this.target_address){let c=this.model.ResolveStructuredReference(a,this.target_address);c&&i.push(c)}else console.info("target address not set");break;case"identifier":{let c=this.model.GetName(a.name,this.view.active_sheet.id);c?.type==="range"&&(c.area.count===1?i.push({type:"address",...c.area.start,label:a.name,position:a.position,id:a.id}):i.push({type:"range",start:{type:"address",position:a.position,id:a.id,label:a.name,...c.area.start},end:{type:"address",position:a.position,label:a.name,id:a.id,...c.area.end},label:a.name,position:a.position,id:a.id}));break}}i.sort((a,c)=>a.position-c.position);let n=[],o=new Set,s=new Map;for(let a of i){let c=this.model.AddressToLabel(a),d=N(a)?new y(a):new y(a.start,a.end);o.has(c)||(n.push(d),o.add(c)),s.set(a.label,c)}return this.UpdateReferences(t,n),s}UpdateReferences(t,r=[]){t.node.dataset.references=JSON.stringify(r.map(i=>this.model.AddressToLabel(i))),t.references=r}UpdateText(t,r={}){let i=t.node,n=i.textContent||"",o=H.GetInstance(i.ownerDocument);if(this.text_formula=n[0]==="=",this.active_editor&&!this.assume_formula&&(this.active_editor.node.spellcheck=!this.text_formula,!this.text_formula)||n===t.formatted_text)return;let[s,a]=this.SubstringToCaret2(i),c=s.length,d=a.length;if(c===0&&d===0&&(d=n.length),!n)this.UpdateReferences(t);else{let h=this.parser.Parse(n);if(h.expression){let m=this.UpdateDependencies(t,h),f=n[0]==="="?1:0,p=0,b,g,x=0,v,w=o.Fragment(),_=(C,S="text",A="",R=!1)=>{let k=o.Text(C);if((R||(c>x||c===0&&x===0)&&c<=x+C.length)&&(b={offset:c-x,node:k}),d>x&&d<=x+C.length&&(g={offset:d-x,node:k}),S!=="text"){let z=o.Create("span",S);A&&(z.dataset.reference=A),z.appendChild(k),w.appendChild(z)}else w.appendChild(k);v=k,x+=C.length};this.parser.Walk(h.expression,C=>{if(C.type==="missing"||C.type==="group"||C.type==="dimensioned")return!0;let S=C.position+f,A=n.substring(p,S),R="",k=C.type,z="";switch(C.type){case"identifier":R=n.substring(S,S+C.name.length),z=m.get(C.name)||"";break;case"call":R=n.substring(S,S+C.name.length);break;case"literal":if(typeof C.value=="string")R=n.substring(S,S+C.value.length+2),k="string";else return!1;break;case"address":case"range":case"structured-reference":z=m.get(C.label)||"???",R=r.rewrite_addresses?C.label:n.substring(S,S+C.label.length);break;default:return!0}return _(A),_(R,k,z),p=S+R.length,C.type!=="range"}),p<n.length&&_(n.substring(p)),b||(v?b={node:v,offset:(v.data||"").length}:_("",void 0,"",!0)),i.textContent="",i.appendChild(w),b&&!r.format_only&&i===this.active_editor?.node&&this.SetCaret(b,g)}}t.formatted_text=n;let u=this.autocomplete_matcher;u&&Promise.resolve().then(()=>{let h=u.Exec({text:n,cursor:a.length}),m=this.NodeAtIndex(h.completions?.length?h.position||0:h.function_position||0);this.Autocomplete(h,m)})}NodeAtIndex(t){let r=this.active_editor?.node.childNodes||[];for(let i=0;i<r.length;i++){let n=r[i].textContent?.length||0;if(n>t)return r[i];t-=n}}AcceptAutocomplete(t){if(!this.active_editor)return;let r;if(t.data&&t.data.completions){for(let d of t.data.completions)if(d.name.toLowerCase()===t.value?.toLowerCase()){r=d.type;break}}let i=t.data?.position||0,n=i+(t.data?.token?.length||0),o=r==="token"?t.value:t.value+"(",s=this.active_editor.node.textContent||"",a=s.substring(0,i)+o,c=a.length;a+=s.substring(n),this.active_editor.node.textContent=a,this.SetCaret({node:this.active_editor.node,offset:c}),this.autocomplete?.Hide(),this.UpdateText(this.active_editor),this.UpdateColors()}Autocomplete(t,r){if(!this.container_node||!this.autocomplete)return;let i;r?.nodeType===Node.ELEMENT_NODE?i=r.getBoundingClientRect():i=this.container_node.getBoundingClientRect();let n=new B(Math.round(i.left),Math.round(i.top),i.width,i.height);this.autocomplete.Show(this.AcceptAutocomplete.bind(this),t,n)}SubstringToCaret2(t,r=!1){let i=["",""];if(!r&&t!==t.ownerDocument.activeElement||t!==this.active_editor?.node)return i;let o=t.ownerDocument.defaultView,s=[!1,!1],a=(d,u)=>{if(d===u.startContainer&&d===u.endContainer&&!(d instanceof o.Text)){s[0]=s[1]=!0,i[0]+=d.textContent,i[1]+=d.textContent;return}if(d===u.startContainer&&(i[0]+=(d.textContent||"").substring(0,u.startOffset),s[0]=!0),d===u.endContainer&&(i[1]+=(d.textContent||"").substring(0,u.endOffset),s[1]=!0),!(s[0]&&s[1])){if(d instanceof o.Text){let h=d.textContent||"";s[0]||(i[0]+=h),s[1]||(i[1]+=h)}else if(d.hasChildNodes()){for(let h of Array.from(d.childNodes))if(a(h,u),s[0]&&s[1])return}}},c=o.getSelection();if(c?.rangeCount??!1){let d=c?.getRangeAt(0);d&&a(t,d)}return i}};var Bo=typeof navigator>"u"?"":navigator.appVersion,Ve=typeof navigator>"u"?"":navigator.userAgent,$r=class{is_edge=/Edge/.test(Bo);is_ipad=/iPad|iPhone/.test(Ve);is_android=/android|samsung/i.test(Ve);is_mobile=this.is_ipad||this.is_android;is_firefox=/firefox/i.test(Ve);is_safari=/safari/i.test(Ve)&&!/edg/i.test(Ve);is_mac=/macintosh/i.test(Ve);is_chrome=/Chrome/i.test(Ve);is_windows=/win64|win32|windows\s+nt/i.test(Ve);is_modern=!this.is_edge&&!(this.is_firefox&&this.is_android)&&/webkit|firefox/i.test(Ve)},$o={is_edge:!1,is_ipad:!1,is_android:!1,is_firefox:!1,is_safari:!1,is_mac:!1,is_chrome:!1,trident:!1,is_windows:!1,is_modern:!0,is_node:!0,is_mobile:!1},q=typeof navigator>"u"?$o:new $r;var Pt=class extends Fe{constructor(t,r,i,n,o){super(i,n,o);this.container=t;this.theme=r;this.container_node=t.querySelector(".treb-overlay-container"),this.edit_node=this.container_node.querySelector(".treb-overlay-editor"),q.is_firefox&&this.edit_node.classList.add("firefox"),this.edit_node.inputMode="none";let s={node:this.edit_node};this.nodes=[s],this.active_editor=s,this.RegisterListener(s,"input",a=>{if(a instanceof InputEvent&&a.isComposing)return;if(!a.isTrusted){this.reset_selection=!0;return}this.reset_selection&&this.Publish({type:"reset-selection"});let c=this.edit_node.firstChild;c&&c.tagName==="BR"&&this.edit_node.removeChild(c),this.editing&&(this.UpdateText(s),this.UpdateColors())}),this.RegisterListener(s,"keyup",a=>{a.isComposing||!this.editing||this.autocomplete&&this.autocomplete.HandleKey("keyup",a).handled}),this.edit_inset=this.container_node.querySelector(".treb-overlay-inset"),this.ClearContents()}internal_selection={target:{row:0,column:0},area:new y({row:0,column:0})};get selection(){return this.internal_selection}set selection(t){if(t){let r=t.target||t.area.start;this.internal_selection={target:{row:r.row,column:r.column},area:new y(t.area.start,t.area.end)}}else{let r={row:0,column:0};this.internal_selection={target:r,area:new y(r)}}}edit_style;reset_selection=!1;edit_node;container_node;edit_inset;scale=1;internal_editing=!1;get editing(){return this.internal_editing}set editing(t){this.internal_editing!==t&&(this.internal_editing=t,t?(this.container_node.style.opacity="1",this.container_node.style.pointerEvents="initial"):(this.container_node.style.opacity="0",this.container_node.style.pointerEvents="none"))}UpdateCaption(t=""){this.edit_node.setAttribute("aria-label",t)}Focus(t=""){this.edit_node!==this.edit_node.ownerDocument.activeElement&&(this.container_node.style.top=`${this.container.scrollTop+this.view.active_sheet.header_offset.y}px`,this.container_node.style.left=`${this.container.scrollLeft+this.view.active_sheet.header_offset.x}px`),this.edit_node.focus(),this.UpdateCaption(t)}CloseEditor(){this.editing=!1,this.reset_selection=!1,this.ClearContents(),this.edit_node.spellcheck=!0,this.autocomplete?.Hide(),this.active_cell=void 0}ClearContents(){q.is_firefox?this.edit_node.innerHTML="<span></span>":this.edit_node.textContent=""}Edit(t,r,i,n,o,s){this.Publish({type:"start-editing",editor:"ice"}),this.active_cell=i,this.target_address={...t.target},this.reset_selection=!1;let a=JSON.parse(JSON.stringify(i.style||{}));this.edit_style=s,s?.font_face&&(a.font_face=s.font_face);let c=I.CompositeFont(this.theme.grid_cell_font_size,a,this.scale,this.theme);switch(this.edit_node.style.font=c.font,c.variants?this.edit_node.style.fontVariant=c.variants:this.edit_node.style.fontVariant="",this.edit_node.style.color=V(this.theme,a.text,1),this.edit_inset.style.backgroundColor=V(this.theme,a.fill,0),a.horizontal_align){case"right":this.container_node.classList.remove("align-center","align-left"),this.container_node.classList.add("align-right");break;case"center":this.container_node.classList.remove("align-right","align-left"),this.container_node.classList.add("align-center");break;default:this.container_node.classList.remove("align-right","align-center"),this.container_node.classList.add("align-left");break}this.edit_node.style.paddingBottom=`${Math.max(0,(self.devicePixelRatio||1)-1)}px`;let d=n?.toString()||"";d&&d[0]==="="&&(this.edit_node.spellcheck=!1),r.ApplyStyle(this.container_node);let u=q.is_mac?0:.5;if(this.edit_node.style.bottom=u.toFixed(2)+"px",this.autocomplete?.ResetBlock(),this.selection=t,typeof n<"u"){let h=d[0]!=="="&&d[d.length-1]==="%",m=d.length;this.edit_node.textContent=d,this.SetCaret({node:this.edit_node,offset:m-(h?1:0)})}this.editing=!0,Promise.resolve().then(()=>{this.active_editor&&(this.active_editor.formatted_text=void 0,this.UpdateText(this.active_editor),this.UpdateColors()),!o&&n!==void 0&&this.Publish({type:"update",text:n.toString(),dependencies:this.composite_dependencies})})}GetEditState(){let t=this.active_editor?.node?.textContent||"",r="";return this.active_editor?.node&&(r=this.SubstringToCaret2(this.active_editor.node,!0)[0]),{text:t,substring:r}}HandleKeyDown(t){if(this.editing){if(this.autocomplete){let r=this.autocomplete.HandleKey("keydown",t);if(r.accept&&this.AcceptAutocomplete(r),r.handled)return"handled"}switch(t.key){case"Enter":case"Tab":return"commit";case"Escape":case"Esc":return"discard";case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Up":case"Down":case"Left":case"Right":return this.selecting?void 0:"commit"}return"handled"}}UpdateScale(t){this.scale=t}};var Gi=new Map,Qe,Ge=(l,e)=>{let t=l,r=Gi.get(t);return r||(r=jo(l,e),Gi.set(t,r),r)};var jo=(l,e)=>{Qe||typeof document<"u"&&(Qe=document.createElement("canvas")),Qe&&(e?Qe.style.fontVariant=e:Qe.style.fontVariant="");let t=Qe?.getContext("2d",{alpha:!1});if(!t)throw new Error("invalid context");t.textBaseline="alphabetic",t.textAlign="center",t.font=l;let r=t.measureText("("),i=r.actualBoundingBoxRight+r.actualBoundingBoxLeft;r=t.measureText("#");let n=r.actualBoundingBoxRight+r.actualBoundingBoxLeft;return r=t.measureText("Mljy!"),{paren:i,hash:n,ascent:r.fontBoundingBoxAscent,descent:r.fontBoundingBoxDescent,height:r.fontBoundingBoxAscent+r.fontBoundingBoxDescent}};var qo="  ",Ht=class{constructor(e,t,r,i,n){this.theme=e;this.layout=t;this.model=r;this.view=i;this.options=n;this.buffer_canvas=t.buffer_canvas,this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;let o=this.buffer_canvas.getContext("2d",{alpha:!1});if(o){let s=this.layout.dpr;this.buffer_context=o,this.buffer_context.setTransform(s,0,0,s,0,0),this.buffer_context.textAlign="left",this.buffer_context.textBaseline="alphabetic"}}cell_edge_buffer=4;overflow_areas=[];buffer_canvas;buffer_context;buffer_canvas_size={width:256,height:256};FlushOverflows(){let e=this.view.active_sheet.cells;for(let t of e.Iterate())t.renderer_data?.overflowed&&(t.renderer_data=void 0,t.render_clean[this.view.view_index]=!1);for(let t of this.overflow_areas)t.tile.dirty=!0;this.overflow_areas=[]}MeasureText(e,t,r){let i=this.layout.grid_tiles[0][0],n=r??this.layout.scale,o=e.style||{},s=I.CompositeFont(this.theme.grid_cell_font_size,o,n,this.theme),a=Ge(s.font,s.variants),c={base:s.font,strong:I.CompositeFont(this.theme.grid_cell_font_size,{...o,bold:!0},n,this.theme).font,emphasis:I.CompositeFont(this.theme.grid_cell_font_size,{...o,italic:!0},n,this.theme).font,strong_emphasis:I.CompositeFont(this.theme.grid_cell_font_size,{...o,bold:!0,italic:!0},n,this.theme).font};s.variants?i.style.fontVariant=s.variants:i.style.fontVariant="";let d=i.getContext("2d",{alpha:!1});if(!d)throw new Error("context failed");let u=this.PrepText(d,c,e,t),h=u.width,m=a.height*u.strings.length;return{width:h,height:m}}EnsureBuffer(e=0,t=0,r=0){let i=this.layout.dpr;if(e=e*i,t=t*i,r=r*i,e>this.buffer_canvas_size.width||t>this.buffer_canvas_size.height){this.buffer_canvas_size.width=Math.max(Math.ceil(e/256)*256,this.buffer_canvas_size.width),this.buffer_canvas_size.height=Math.max(Math.ceil(t/256)*256,this.buffer_canvas_size.height),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;let n=this.buffer_canvas.getContext("2d",{alpha:!1});n&&(this.buffer_context=n,this.buffer_context.textAlign="left",this.buffer_context.textBaseline="alphabetic")}this.buffer_context.setTransform(i,0,0,i,r,0)}OverflowDirty(e=!1){let t=[];for(let r of this.overflow_areas){let i=r.area.start.row,n=e;if(!n)for(let o=r.area.start.column;!n&&o<=r.area.end.column;o++){let s=this.view.active_sheet.cells.GetCell({row:i,column:o},!1);n=!!(s&&!s.render_clean[this.view.view_index])}if(n){for(let o=r.area.start.column;o<=r.area.end.column;o++){let s=this.view.active_sheet.cells.GetCell({row:i,column:o},!1);s&&(s.render_clean[this.view.view_index]=!1,s.renderer_data&&s.renderer_data.overflowed&&(s.renderer_data=void 0))}r.tile.dirty=!0}else t.push(r)}this.overflow_areas=t}RenderCorner(){let t=this.layout.corner_canvas.getContext("2d",{alpha:!1});if(!t)throw new Error("invalid context");let r=I.CompositeFont(this.theme.grid_cell_font_size,this.theme.headers||{},this.layout.scale,this.theme),i=Ge(r.font,r.variants),n=this.layout.dpr,o=this.layout.header_offset,s=o.x;for(let c=0;c<this.view.active_sheet.freeze.columns;c++)s+=this.layout.ColumnWidth(c);let a=o.y;for(let c=0;c<this.view.active_sheet.freeze.rows;c++)a+=this.layout.RowHeight(c);t.setTransform(n,0,0,n,0,0),t.fillStyle=this.theme.headers?.fill?V(this.theme,this.theme.headers.fill):"",t.fillRect(0,0,s,o.y),t.fillRect(0,0,o.x,a),t.strokeStyle=this.theme.headers_grid_color||"",t.beginPath(),t.moveTo(o.x-.5,0),t.lineTo(o.x-.5,o.y),t.moveTo(0,o.y-.5),t.lineTo(o.x,o.y-.5),t.stroke(),!(!this.view.active_sheet.freeze.columns&&!this.view.active_sheet.freeze.rows)&&(t.strokeStyle=this.theme.grid_color||"",t.beginPath(),a!==o.y&&(t.moveTo(o.x-.5,o.y),t.lineTo(o.x-.5,a)),s!==o.x&&(t.moveTo(o.x,o.y-.5),t.lineTo(s,o.y-.5)),t.stroke(),t.strokeStyle=this.theme.headers_grid_color||"",t.textAlign="center",t.textBaseline="middle",t.font=r.font,t.fillStyle=V(this.theme,this.theme.headers?.text),this.view.active_sheet.freeze.rows&&this.layout.header_offset.x>1&&(t.setTransform(n,0,0,n,0,0),t.translate(0,o.y),t.beginPath(),t.moveTo(0,0-.5),t.lineTo(o.x,0-.5),t.stroke(),this.RenderRowLabels(t,0,this.view.active_sheet.freeze.rows-1,i.height)),this.view.active_sheet.freeze.columns&&this.layout.header_offset.y>1&&(t.setTransform(n,0,0,n,0,0),t.translate(o.x,0),t.beginPath(),t.moveTo(0-.5,0),t.lineTo(0-.5,o.y),t.stroke(),this.RenderColumnLabels(t,0,this.view.active_sheet.freeze.columns-1)))}RenderColumnLabels(e,t,r){let i=this.layout.header_offset.y;if(!(i<=1)){for(e.fillStyle=V(this.theme,this.theme.headers?.text,0),e.beginPath();t<=r;t++){let n=this.layout.ColumnWidth(t),o=y.ColumnToLabel(t),s=e.measureText(o);n>s.width&&e.fillText(o,n/2,i/2+1),e.moveTo(n-.5,0),e.lineTo(n-.5,i),e.translate(n,0)}e.stroke()}}RenderRowLabels(e,t,r,i){let n=this.layout.header_offset.x;if(!(n<=1)){for(e.fillStyle=V(this.theme,this.theme.headers?.text,0),e.beginPath();t<=r;t++){let o=this.layout.RowHeight(t);o>=i*1.2&&e.fillText(`${t+1}`,n/2,o/2+1),e.moveTo(0,o-.5),e.lineTo(n,o-.5),e.translate(0,o)}e.stroke()}}RenderHeaders(e,t=!1){let r=this.layout.dpr,i=this.layout.header_offset,n=I.CompositeFont(this.theme.grid_cell_font_size,this.theme.headers||{},this.layout.scale,this.theme),o=Ge(n.font,n.variants);for(let s=e.start.column;s<=e.end.column;s++){let a=this.layout.column_header_tiles[s];if(a.dirty||t){let c=a.getContext("2d",{alpha:!1});if(!c)continue;c.setTransform(r,0,0,r,0,0),c.textAlign="center",c.textBaseline="middle",c.font=n.font,n.variants?a.style.fontVariant=n.variants:a.style.fontVariant="",c.fillStyle=this.theme.headers?.fill?V(this.theme,this.theme.headers.fill):"",c.fillRect(0,0,a.logical_size.width,this.layout.header_offset.y),c.strokeStyle=this.theme.headers_grid_color||"",c.beginPath(),c.moveTo(0,i.y-.5),c.lineTo(a.logical_size.width,i.y-.5),c.stroke(),c.strokeStyle=this.theme.headers_grid_color||"",this.RenderColumnLabels(c,a.first_cell.column,a.last_cell.column),a.dirty=!1}}for(let s=e.start.row;s<=e.end.row;s++){let a=this.layout.row_header_tiles[s];if(a.dirty||t){let c=a.getContext("2d",{alpha:!1});if(!c)continue;c.fillStyle=this.theme.headers?.fill?V(this.theme,this.theme.headers.fill):"",c.setTransform(r,0,0,r,0,0),c.textAlign="center",c.textBaseline="middle",c.font=n.font,n.variants?a.style.fontVariant=n.variants:a.style.fontVariant="",c.fillRect(0,0,this.layout.header_offset.x,a.logical_size.height),c.strokeStyle=this.theme.headers_grid_color||"",c.beginPath(),c.moveTo(i.x-.5,0),c.lineTo(i.x-.5,a.logical_size.height),c.stroke(),c.strokeStyle=this.theme.headers_grid_color||"",this.RenderRowLabels(c,a.first_cell.row,a.last_cell.row,o.height),a.dirty=!1}}(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.RenderCorner()}CopyToAdjacent(e,t,r,i,n,o,s){let a=this.layout.AdjacentTile(e,i,r);if(!a)return;let c=n,d=o;r>0?c=n-(e.pixel_end.x-e.pixel_start.x)*t:r<0&&(c=n+(a.pixel_end.x-a.pixel_start.x)*t),i>0&&(d=o-(e.pixel_end.y-e.pixel_start.y)*t);let u=a.getContext("2d",{alpha:!1});u&&(u.setTransform(t,0,0,t,c,d),u.drawImage(this.buffer_canvas,0,0,(s.width||0)*t,(s.height||0)*t,s.left||0,0,s.width||0,s.height||0))}Render(e){let t=e.getContext("2d",{alpha:!1});if(!t)return;t.textBaseline="alphabetic";let r=this.layout.dpr;t.setTransform(r,0,0,r,0,0);let i=0,n=0;for(let a=e.first_cell.column;a<=e.last_cell.column;a++){let c=this.layout.ColumnWidth(a);if(c){n=0;for(let d=e.first_cell.row;d<=e.last_cell.row;d++){let u=this.layout.RowHeight(d);if(u){t.setTransform(r,0,0,r,i,n);let h=this.view.active_sheet.CellData({row:d,column:a});if(e.needs_full_repaint||!h.render_clean[this.view.view_index]){let m=this.RenderCell(e,h,t,{row:d,column:a},c,u,e.pixel_start.x+i,e.pixel_start.y+n);m.tile_overflow_right&&this.CopyToAdjacent(e,r,1,0,i,n,m),m.tile_overflow_left&&this.CopyToAdjacent(e,r,-1,0,i,n,m),m.tile_overflow_bottom&&this.CopyToAdjacent(e,r,0,1,i,n,m)}}n+=u*r}i+=c*r}}if(!this.view.active_sheet.freeze.rows&&!this.view.active_sheet.freeze.columns)return;let o=0,s=0;if(e.first_cell.row<=this.view.active_sheet.freeze.rows-1)for(let a=e.first_cell.row;a<this.view.active_sheet.freeze.rows&&a<=e.last_cell.row;a++)o+=this.layout.RowHeight(a);if(e.first_cell.column<=this.view.active_sheet.freeze.columns-1)for(let a=e.first_cell.column;a<this.view.active_sheet.freeze.columns&&a<=e.last_cell.column;a++)s+=this.layout.ColumnWidth(a);if(o){let a=this.layout.frozen_row_tiles[e.tile_position.column];if(!a)throw new Error("can't find matching header tile");let c=a.getContext("2d",{alpha:!0});if(!c)throw new Error("header context failed");c.setTransform(r,0,0,r,0,0),c.drawImage(e,0,0,e.logical_size.width*r,o*r,0,0,e.logical_size.width,o)}if(s){let a=this.layout.frozen_column_tiles[e.tile_position.row];if(!a)throw new Error("can't find matching header tile");let c=a.getContext("2d",{alpha:!0});if(!c)throw new Error("header context failed");c.setTransform(r,0,0,r,0,0),c.drawImage(e,0,0,s*r,e.logical_size.height*r,0,0,s,e.logical_size.height)}if(s&&o){let a=this.layout.corner_canvas.getContext("2d",{alpha:"false"});if(!a)throw new Error("corner context failed");a.setTransform(r,0,0,r,this.layout.header_offset.x*r,this.layout.header_offset.y*r),a.drawImage(e,0,0,s*r,o*r,0,0,s,o)}}PrepText(e,t,r,i){let n=[],o=r.style||{},s,a=0;if(r.rendered_type===4){let m=r.calculated_type?r.calculated:r.value;r.formatted=m?this.model.language_model?.boolean_true||"TRUE":this.model.language_model?.boolean_false||"FALSE"}let c,d=r.editing?"":r.formatted;Array.isArray(d)&&(d=d.filter(m=>m.flag!==8));let u="",h;if(o.indent){for(let m=0;m<o.indent;m++)u+=qo;h=o.horizontal_align,h||(h=r.type===3||r.calculated_type===3||r.type===7||r.calculated_type===7?"right":"left")}if(Array.isArray(d)){u&&(h==="right"?d.push({text:u,flag:8}):(h==="left"||typeof h>"u")&&d.unshift({text:u,flag:8}));for(let m of d){if(m.flag===6){c=m.text;continue}let f=e.measureText(m.text).width,p={width:f,text:m.text,hidden:m.flag===1};n.push(p),m.flag===2?s=p:a+=f}if(s){let m=s.text,f=s.width,p=i-a-2*this.cell_edge_buffer;if(s.width=Math.max(0,p),p>0){let b=Math.floor(p/f);for(let g=1;g<b;g++)s.text+=m;a=i-2*this.cell_edge_buffer}else s.text=""}return{strings:[n],format:c,width:a}}else if(d){r.type===2&&d[0]==="'"&&(d=d.slice(1));let m;this.options.markdown?m=Ie.instance.Parse(d):(m=Ie.instance.Dummy(d),e.font=t.base);let f=0,p=i-2*this.cell_edge_buffer,b=[];if(o.wrap){let g=u&&o.horizontal_align!=="center"?e.measureText(u).width:0;p-=g;for(let x of m){for(let w=1;w<x.length;w++){let _=x[w].text.match(/^(\s+)/);_&&(x[w-1].text+=_[1],x[w].text=x[w].text.replace(/^\s+/,""))}let v=[];for(let w of x){this.options.markdown&&(w.strong&&w.emphasis?e.font=t.strong_emphasis:w.strong?e.font=t.strong:w.emphasis?e.font=t.emphasis:e.font=t.base);let _=w.text.match(/\S+\s*/g);if(_&&_.length)for(let C of _){let S=e.measureText(C.trim()).width,A=e.measureText(C).width;v.push({part:w,text:C,trimmed:S,width:A})}}for(;v.length;){let w=v.shift(),_=[w],C=w.trimmed;for(;C<p&&v.length;){let A=v[0],R=C-w.trimmed+w.width+A.trimmed;if(R>=p)break;w=A,_.push(A),C=R,v.shift(),f=Math.max(f,C)}w.text=w.text.trim(),w.width=w.trimmed,f=Math.max(f,w.width);let S=_.map(A=>({...A.part,hidden:!1,width:A.width,text:A.text}));o.indent&&(h==="right"?S.push({text:u,hidden:!1,width:g}):h==="left"&&S.unshift({text:u,hidden:!1,width:g})),b.push(S)}}}else for(let g of m){let x=[];o.indent&&(h==="right"?g.push({text:u}):h==="left"&&g.unshift({text:u}));let v=0;for(let w of g){this.options.markdown&&(w.strong&&w.emphasis?e.font=t.strong_emphasis:w.strong?e.font=t.strong:w.emphasis?e.font=t.emphasis:e.font=t.base);let _=e.measureText(w.text).width;v+=_,x.push({...w,hidden:!1,width:_})}f=Math.max(f,v),b.push(x)}return{strings:b,width:f}}return{strings:[[{text:"",hidden:!1,width:0}]],width:0}}ResolveColors(e){let t={...e};return t.text={text:V(this.theme,e.text,1)},t}RenderCellBorders(e,t,r,i=0,n=0,o=0,s=0){let a=this.view.active_sheet.SurroundingStyle(e,this.theme.table),c=V(this.theme,a[8].fill);c&&(t.fillStyle=c,t.fillRect(i+0,n-1,o,1)),c=V(this.theme,a[4].fill),c&&(t.fillStyle=c,t.fillRect(i-1,n,1,s)),c=V(this.theme,r.fill),c&&(t.fillStyle=c,t.fillRect(i-1,n-1,o+1,s+1)),c=V(this.theme,a[6].fill),c&&(t.fillStyle=c,t.fillRect(i+o-1,n-1,1,s+1)),c=V(this.theme,a[2].fill),c&&(t.fillStyle=c,t.fillRect(i-1,n+s-1,o+1,1)),a[6].border_top&&!a[6].border_left&&(t.fillStyle=V(this.theme,a[6].border_top_fill,1),t.fillRect(i+o-1,n-2+a[6].border_top,1,1)),a[9].border_left&&(t.fillStyle=V(this.theme,a[9].border_left_fill,1),t.fillRect(i+o-1,n-1,1,1)),a[9].border_bottom&&(t.fillStyle=V(this.theme,a[9].border_bottom_fill,1),t.fillRect(i+o-1,n-2+a[9].border_bottom,1,1)),a[4].border_top&&!a[4].border_right&&(t.fillStyle=V(this.theme,a[4].border_right_fill,1),t.fillRect(i-1,n-2+a[4].border_top,1,1)),a[7].border_right&&(t.fillStyle=V(this.theme,a[7].border_right_fill,1),t.fillRect(i-1,n-1,1,1)),a[7].border_bottom&&(t.fillStyle=V(this.theme,a[7].border_bottom_fill,1),t.fillRect(i-1,n-2+a[7].border_bottom,1,1)),a[6].border_bottom&&!a[6].border_left&&(t.fillStyle=V(this.theme,a[6].border_bottom_fill,1),t.fillRect(i+o-1,n+s-a[6].border_bottom,1,1)),a[3].border_left&&(t.fillStyle=V(this.theme,a[3].border_left_fill,1),t.fillRect(i+o-1,n+s-1,1,1)),a[3].border_top&&(t.fillStyle=V(this.theme,a[3].border_top_fill,1),t.fillRect(i+o-1,n+s-a[3].border_top,1,1)),a[4].border_bottom&&!a[4].border_right&&(t.fillStyle=V(this.theme,a[4].border_bottom_fill,1),t.fillRect(i-1,n+s-a[4].border_bottom,1,1)),a[1].border_right&&(t.fillStyle=V(this.theme,a[1].border_right_fill,1),t.fillRect(i-1,n+s-1,1,1)),a[1].border_top&&(t.fillStyle=V(this.theme,a[1].border_top_fill,1),t.fillRect(i-1,n+s-a[1].border_top,1,1)),a[8].border_bottom&&(t.fillStyle=V(this.theme,a[8].border_bottom_fill,1),a[8].border_bottom===2&&(t.fillRect(i-1,n-2,o+1,1),t.fillRect(i-1,n-0,o+1,1),t.fillStyle=V(this.theme,a[8].fill)||V(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(i-1,n-1,o+1,1)),a[4].border_right&&(t.fillStyle=V(this.theme,a[4].border_right_fill,1),t.fillRect(i-1,n-1,1,s+1)),a[6].border_left&&(t.fillStyle=V(this.theme,a[6].border_left_fill,1),t.fillRect(i+o-1,n-1,1,s+1)),a[2].border_top&&(t.fillStyle=V(this.theme,a[2].border_top_fill,1),a[2].border_top===2&&(t.fillRect(i-1,n+s-2,o+1,1),t.fillRect(i-1,n+s-0,o+1,1),t.fillStyle=V(this.theme,a[2].fill)||V(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(i-1,n+s-1,o+1,1)),r.border_top&&(t.fillStyle=V(this.theme,r.border_top_fill,1),r.border_top===2&&(t.fillRect(i-1,n-2,o+1,1),t.fillRect(i-1,n+0,o+1,1),t.fillStyle=V(this.theme,r.fill)||V(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(i-1,n-1,o+1,1)),r.border_left&&(t.fillStyle=V(this.theme,r.border_left_fill,1),t.fillRect(i-1,n-1,1,s+1)),r.border_right&&(t.fillStyle=V(this.theme,r.border_right_fill,1),t.fillRect(i+o-1,n-1,1,s+1)),r.border_bottom&&(t.fillStyle=V(this.theme,r.border_bottom_fill,1),r.border_bottom===2&&(t.fillRect(i-1,n+s-2,o+1,1),t.fillRect(i-1,n+s+0,o+1,1),t.fillStyle=V(this.theme,r.fill)||V(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(i-1,n+s-1,o+1,1))}PaintBackgroundImage(e,t,r,i,n,o,s=0,a=0,c=0){if(!t.width||!t.height)return;let d=(this.layout.scale||1)*this.layout.dpr,u=r/d%t.width,h=i/d%t.height,m=n/d,f=o/d,p=u+m>t.width,b=h+f>t.height;p&&e.drawImage(t,u-t.width,h,m,f,s,a,n-c,o-c),b&&e.drawImage(t,u,h-t.height,m,f,s,a,n-c,o-c),p&&b&&e.drawImage(t,u-t.width,h-t.height,m,f,s,a,n-c,o-c),e.drawImage(t,u,h,m,f,s,a,n-c,o-c)}RenderCellBackground(e,t,r,i,n,o,s=0,a=0){if(r.fillStyle=this.theme.grid_color,r.fillRect(0,0,n,o),this.view.active_sheet.image)this.PaintBackgroundImage(r,this.view.active_sheet.image,s,a,n,o,0,0,1);else{let c=V(this.theme,i.fill);c?(r.fillStyle=c,r.fillRect(0,0,n-1,o-1)):(r.fillStyle=V(this.theme,this.theme.grid_cell?.fill,0)||"#fff",r.fillRect(0,0,n-1,o-1))}this.RenderCellBorders(t,r,i,0,0,n,o),e&&(r.fillStyle=this.theme.note_marker_color,r.beginPath(),r.moveTo(n-2,1),r.lineTo(n-2-8,1),r.lineTo(n-2,9),r.lineTo(n-2,1),r.fill())}RenderCell(e,t,r,i,n,o,s=0,a=0){let c={},d=!t.render_clean[this.view.view_index];if(t.render_clean[this.view.view_index]=!0,e.needs_full_repaint&&t.renderer_data?.overflowed)return{};let u=t.style?{...t.style}:{};if(t.table&&(u=this.view.active_sheet.CellStyleData(i,t.table.theme||this.theme.table)||{}),t.merge_area)if(i.row===t.merge_area.start.row&&i.column===t.merge_area.start.column){for(let T=t.merge_area.start.column+1;T<=t.merge_area.end.column;T++)n+=this.layout.ColumnWidth(T);for(let T=t.merge_area.start.row+1;T<=t.merge_area.end.row;T++)o+=this.layout.RowHeight(T);if(t.merge_area.count>1){let T=this.view.active_sheet.CellStyleData(t.merge_area.end);T&&(u.border_bottom=T.border_bottom,u.border_right=T.border_right,u.border_bottom_fill=T.border_bottom_fill,u.border_right_fill=T.border_right_fill)}t.merge_area.end.column>e.last_cell.column&&(c.tile_overflow_right=!0),t.merge_area.end.row>e.last_cell.row&&(c.tile_overflow_bottom=!0),(c.tile_overflow_bottom||c.tile_overflow_right)&&this.overflow_areas.push({tile:e,head:{...i},area:new y(t.merge_area.start,t.merge_area.end)})}else return{};let h=!!t.hyperlink;if(t.render_function){this.RenderCellBackground(!!t.note,i,r,u,n,o),r.strokeStyle=r.fillStyle=V(this.theme,u.text,1);let T=this.ResolveColors(u);if(t.render_function.call(void 0,{width:n,height:o,context:r,cell:t,style:T,scale:this.layout.scale||1}).handled)return c}let m=I.CompositeFont(this.theme.grid_cell_font_size,u,this.layout.scale,this.theme),f={base:m.font,strong:I.CompositeFont(this.theme.grid_cell_font_size,{...u,bold:!0},this.layout.scale,this.theme).font,emphasis:I.CompositeFont(this.theme.grid_cell_font_size,{...u,italic:!0},this.layout.scale,this.theme).font,strong_emphasis:I.CompositeFont(this.theme.grid_cell_font_size,{...u,bold:!0,italic:!0},this.layout.scale,this.theme).font};if(m.variants?e.style.fontVariant=m.variants:e.style.fontVariant="",r.font=f.base,d||!t.renderer_data||t.renderer_data.width!==n||t.renderer_data.height!==o){let T=this.PrepText(r,f,t,n);t.renderer_data={text_data:T,width:n,height:o}}let p=t.renderer_data.text_data,b=p.width>n-2*this.cell_edge_buffer,g=n,x=0,v=!1,w=t.type===3||t.calculated_type===3||t.type===7||t.calculated_type===7||t.type===9||t.calculated_type===9,_=u.horizontal_align;_||(_=w?"right":"left");let C=[];if(b)if(t.type!==3&&t.calculated_type!==3&&!u.wrap&&!t.merge_area){let de=p.width-n+this.cell_edge_buffer,me=0,Z=0;_==="center"?me=Z=de/2:_==="right"?me=de:Z=de;let re=i.column,E=i.column;for(;Z>0&&re<this.layout.last_column;){re++;let P={row:i.row,column:re},K=this.view.active_sheet.CellData(P),fe=this.layout.ColumnWidth(re);if(Z-=fe,K&&!K.type&&!K.calculated_type)C.push({address:P,cell:K,grid:new B(g,0,fe,o),background:new B(g-1,0,fe,o-1),border:new B(g,0,fe,o)}),g+=fe,K.render_clean[this.view.view_index]=!0,K.renderer_data={overflowed:!0};else{v=!0;break}}for(re>e.last_cell.column&&(c.tile_overflow_right=!0);me>0&&E>=1;){E--;let P={row:i.row,column:E},K=this.view.active_sheet.CellData(P),fe=this.layout.ColumnWidth(E);if(me-=fe,K&&!K.type&&!K.calculated_type)x-=fe,C.push({address:P,cell:K,grid:new B(x,0,fe,o),background:new B(x,0,fe,o-1),border:new B(x,0,fe,o)});else{v=!0;break}}E<e.first_cell.column&&(c.tile_overflow_left=!0),this.overflow_areas.push({head:{...i},tile:e,area:new y({row:i.row,column:E},{row:i.row,column:re})})}else v=!w;let S=!1,A=r;(c.tile_overflow_bottom||c.tile_overflow_left||c.tile_overflow_right)&&(S=!0,c.width=g-x,c.height=o,c.left=x,this.EnsureBuffer(c.width+1,o+1,-x),r=this.buffer_context,r.font=f.base),this.RenderCellBackground(!!t.note,i,r,u,n,o,s,a);for(let T of C)T.cell.style?.fill&&Ei(T.cell.style.fill)&&!this.options.grid_over_background?(r.fillStyle=V(this.theme,T.cell.style.fill,0),r.fillRect(T.grid.left,T.grid.top,T.grid.width,T.grid.height)):(r.fillStyle=this.theme.grid_color||"",r.fillRect(T.grid.left,T.grid.top,T.grid.width,T.grid.height),this.view.active_sheet.image?this.PaintBackgroundImage(r,this.view.active_sheet.image,s+T.background.left,a+T.background.top,T.background.width,T.background.height,T.background.left,T.background.top,0):(r.fillStyle=this.theme.grid_cell?.fill?V(this.theme,this.theme.grid_cell.fill,0):"",r.fillRect(T.background.left,T.background.top,T.background.width,T.background.height))),T.cell.style&&this.RenderCellBorders(T.address,r,T.cell.style,T.border.left,T.border.top,T.border.width,T.border.height);let R=Ge(f.base,m.variants);r.lineWidth=1,r.strokeStyle=r.fillStyle=p.format?p.format:V(this.theme,u.text,1),r.beginPath();let k=this.cell_edge_buffer,z=1,W=p.strings.length,te=W*R.height*z;v=(v||te>=o)&&!S,v&&(r.save(),r.beginPath(),r.moveTo(x+1.5,0),r.lineTo(x+1.5,o),r.lineTo(g-1.5,o),r.lineTo(g-1.5,0),r.clip()),r.beginPath();let he=Math.round(o-R.descent-2+-z*R.height*(W-1));switch(u.vertical_align){case"top":he=Math.round(2+R.ascent);break;case"middle":he=Math.round((o-te)/2+R.ascent)-1.5;break}if((t.type===3||t.calculated_type===3||t.type===7||t.calculated_type===7)&&b){let T=Math.floor((n-2*this.cell_edge_buffer)/R.hash),de="";for(let Z=0;Z<T;Z++)de+="#";let me=r.measureText(de).width;_==="center"?k=Math.round((n-me)/2):_==="right"&&(k=n-this.cell_edge_buffer-me),r.fillText(de,k,he)}else{let T=he;for(let de of p.strings){let me=0;for(let P of de)me+=P.width;_==="center"?k=Math.round((n-me)/2):_==="right"&&(k=n-this.cell_edge_buffer-me);let Z=T+2.5,re=Math.floor(T-R.ascent*1/3)+.5,E=k;for(let P of de)P.strong&&P.emphasis?r.font=f.strong_emphasis:P.strong?r.font=f.strong:P.emphasis?r.font=f.emphasis:r.font=f.base,P.hidden||(P.text&&r.fillText(P.text,E,T),u.underline&&(r.moveTo(E,Z),r.lineTo(E+P.width,Z)),(u.strike||P.strike)&&(r.moveTo(E,re),r.lineTo(E+P.width,re)),h&&(P.left=E,P.top=T-R.ascent,P.height=R.height)),E+=P.width;T+=z*R.height}}if(r.stroke(),v)r.restore();else if(S){let T=this.layout.dpr;A.drawImage(this.buffer_canvas,0,0,(c.width||0)*T,o*T,x,0,c.width||0,o)}return c}};var Ot=class extends Fe{constructor(t,r,i,n,o){super(r,i,o);this.options=n;let s=H.GetInstance(t.ownerDocument),a=t.querySelector(".treb-formula-bar");a.removeAttribute("hidden"),this.address_label_container=a.querySelector(".treb-address-label"),this.address_label=this.address_label_container.firstElementChild,this.InitAddressLabel(),this.container_node=t.querySelector(".treb-editor-container");let c=this.container_node.firstElementChild,d={node:c};if(this.active_editor=d,this.nodes=[d],c&&this.RegisterListener(d,"input",u=>{u.isTrusted&&(this.UpdateText(d),this.UpdateColors())}),this.active_editor.node.spellcheck=!1,this.RegisterListener(d,"focusin",()=>{let u=this.tolled!==void 0;if(this.tolled=void 0,!this.active_editor)return;let h=this.active_editor.node.textContent||"";if(this.shadow&&(this.shadow=!1,h="",this.active_editor.node.textContent=h,this.active_editor.formatted_text=void 0),h[0]==="{"&&h[h.length-1]==="}"&&(h=h.substring(1,h.length-1),this.active_editor.node.textContent=h,this.active_editor.formatted_text=void 0),this.autocomplete?.ResetBlock(),this.UpdateText(this.active_editor),this.UpdateColors(void 0,!0),u){let m=this.NodeAtIndex(h.length-1);m&&this.SetCaret({node:m,offset:(m.textContent||"").length})}this.committed=!1,this.Publish([{type:"start-editing",editor:"formula-bar"},{type:"update",text:h,cell:this.active_cell,dependencies:this.composite_dependencies}]),this.focused_=!0}),this.RegisterListener(d,"focusout",u=>{let h=u.relatedTarget instanceof HTMLElement&&u.relatedTarget.dataset.tollEditor;this.selecting&&console.info("focusout, but selecting..."),this.autocomplete?.Hide();let m=(this.active_editor?this.GetTextContent(this.active_editor.node).join(""):"").trim();if(h){let f=m;this.active_editor?.node&&(f=this.SubstringToCaret2(this.active_editor.node,!0)[0]),this.committed=!0,this.tolled={text:m,substring:f},this.Publish({type:"toll",value:m})}else this.committed?this.Publish([{type:"stop-editing"}]):(this.committed=!0,this.Publish({type:"commit",value:m}));this.Publish([{type:"stop-editing"}]),this.focused_=!1,this.active_editor&&(this.active_editor.node.spellcheck=!1)}),this.RegisterListener(d,"keydown",this.FormulaKeyDown.bind(this)),this.RegisterListener(d,"keyup",this.FormulaKeyUp.bind(this)),this.options.expand_formula_button){let u;this.expand_button=s.Create("button","expand-button",a,{events:{focus:h=>{u=h.relatedTarget instanceof HTMLElement?h.relatedTarget:void 0},click:h=>{h.stopPropagation(),h.preventDefault(),this.active_editor&&(this.active_editor.node.scrollTop=0),a.hasAttribute("expanded")?a.removeAttribute("expanded"):a.setAttribute("expanded",""),u&&u.focus()}}})}}committed=!1;tolled;shadow_=!1;get shadow(){return this.shadow_}set shadow(t){this.shadow_=t,this.active_editor?.node&&(t?this.active_editor.node.classList.add("treb-editor-shadow"):this.active_editor.node.classList.remove("treb-editor-shadow"))}focused_=!1;get focused(){return this.focused_}address_label_container;address_label;button;expand_button;label_update_timer=0;get formula(){return this.active_editor&&this.active_editor.node.textContent||""}set formula(t){this.active_editor&&(this.active_editor.node.textContent=t,this.active_editor.formatted_text=void 0)}get label(){return this.address_label?.textContent||""}set label(t){t.trim().length?(this.address_label.textContent=t,this.label_update_timer||(this.label_update_timer=requestAnimationFrame(()=>{this.label_update_timer=0,this.address_label.scrollWidth>this.address_label.offsetWidth?this.address_label.setAttribute("title",t):this.address_label.removeAttribute("title")}))):(this.address_label.innerHTML="&nbsp;",this.address_label.removeAttribute("title"))}set editable(t){!this.active_editor||!this.container_node||(t?(this.active_editor.node.setAttribute("contenteditable","true"),this.container_node.removeAttribute("locked")):(this.active_editor.node.removeAttribute("contenteditable"),this.container_node.setAttribute("locked","")))}Restore(){let t=this.container_node?.firstElementChild;t&&t.focus()}Release(){this.tolled=void 0}IsElement(t){return t===this.active_editor?.node}IsExpandButton(t){return this.expand_button&&t===this.expand_button}InitAddressLabel(){this.address_label.contentEditable="true",this.address_label.spellcheck=!1,this.address_label.addEventListener("focusin",()=>{let t=this.address_label.ownerDocument;requestAnimationFrame(()=>{let r=t.defaultView.getSelection(),i=t.createRange();i.selectNodeContents(this.address_label),r?.removeAllRanges(),r?.addRange(i)})}),this.address_label.addEventListener("keydown",t=>{if(!t.isComposing)switch(t.key){case"Enter":t.stopPropagation(),t.preventDefault(),this.Publish({type:"address-label-event",text:this.address_label.textContent||void 0});break;case"Esc":case"Escape":t.stopPropagation(),t.preventDefault(),this.Publish({type:"address-label-event"});break}})}GetTextContent(t){let r=t.childNodes,i=[];for(let n=0;n<r.length;n++){let o=r[n];switch(o.nodeType){case Node.ELEMENT_NODE:i.push(...this.GetTextContent(o)),o instanceof Element&&o.tagName==="DIV"&&i.push(`
`);break;case Node.TEXT_NODE:o.nodeValue&&i.push(o.nodeValue);break}}return i}FormulaKeyUp(t){t.isComposing||this.autocomplete&&this.autocomplete.HandleKey("keyup",t).handled}FormulaKeyDown(t){if(!t.isComposing){if(this.autocomplete){let r=this.autocomplete.HandleKey("keydown",t);if(r.accept&&this.AcceptAutocomplete(r),r.handled)return}switch(t.key){case"Enter":case"Tab":{let r=t.key==="Enter"&&t.ctrlKey&&t.shiftKey,i=(this.active_editor?this.GetTextContent(this.active_editor.node).join(""):"").trim();this.committed=!0,this.Publish({type:"commit",value:i,event:t,array:r})}break;case"Escape":case"Esc":this.committed=!0,this.Publish({type:"discard"});break;default:return}t.stopPropagation(),t.preventDefault()}}};var ht=class{constructor(e={}){this.options=e;if(this.DOM=H.GetInstance(e.container?.ownerDocument),!this.DOM.doc)throw new Error("invalid context");this.completion_list=this.DOM.Div("treb-cell-editor-ac-list treb-autocomplete",e.container||this.DOM.doc.body,{events:{mousedown:t=>this.ListMouseDown(t),mousemove:t=>this.ListMouseMove(t)}}),this.tooltip=this.DOM.Div("treb-cell-editor-ac-tooltip treb-autocomplete-tooltip",e.container||this.DOM.doc.body)}completion_list_visible=!1;tooltip_visible=!1;last_completion;completion_list;tooltip;selected_index=0;block=!1;autocomplete_data={};callback;active_element;DOM;Hide(){this.tooltip.style.top="-1000px",this.completion_list.style.top="-1000px",this.completion_list_visible=!1,this.tooltip_visible=!1,this.active_element=void 0}SetBlock(){this.block=!0}ResetBlock(){this.block=!1}ListMouseMove(e){let t=e.target;t.tagName==="A"&&t!==this.active_element&&this.active_element&&(this.active_element.classList.remove("selected"),this.active_element=t,this.active_element.classList.add("selected"),this.selected_index=Number(t.dataset.index||"0"),this.last_completion=t.textContent||"")}ListMouseDown(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;t;){if(t===this.completion_list)return;if(t.tagName==="A")break;t=t.parentElement}t&&(console.info(t),this.callback&&this.callback({handled:!0,accept:!0,value:t.textContent?t.textContent:void 0,data:this.autocomplete_data,click:!0}))}HandleKey(e,t){if(!this.completion_list_visible)return{handled:!1};let r=0,i=!1,n=!1;switch(t.key){case"Up":case"ArrowUp":r=-1;break;case"Down":case"ArrowDown":r=1;break;case"Tab":n=!0;break;case"Escape":case"Esc":i=!0;break;default:return{handled:!1}}if(t.stopPropagation(),t.preventDefault(),e==="keyup")return{handled:!0};if(r){let o=this.completion_list.getBoundingClientRect();this.selected_index+=r,this.selected_index=Math.max(0,this.selected_index);let s=this.completion_list.querySelectorAll("a");this.selected_index=Math.min(this.selected_index,s.length-1);for(let a=0;a<s.length;a++){let c=s[a];if(a===this.selected_index){c.classList.add("selected"),this.active_element=c;let d=c.getBoundingClientRect();d.top<o.top?this.completion_list.scrollBy(0,-d.height):d.bottom>o.bottom&&this.completion_list.scrollBy(0,d.height),this.last_completion=c.textContent||void 0}else c.classList.remove("selected")}return{handled:!0}}else{if(i)return this.block=!0,this.Hide(),{handled:!0};if(n)return{handled:!0,accept:!0,value:this.last_completion,data:this.autocomplete_data}}return{handled:!1}}Show(e,t={},r){if(this.completion_list_visible=!1,this.tooltip_visible=!1,this.autocomplete_data=t,this.callback=e,!this.block)if(t.tooltip?(this.tooltip.innerHTML=t.tooltip+t.arguments+(t.description?`
`+t.description:""),this.tooltip.style.left=r.left+"px",this.options.tooltip_prefer_top?this.tooltip.style.top=r.top-this.tooltip.offsetHeight-5+"px":this.tooltip.style.top=r.bottom+5+"px",this.tooltip_visible=!0):this.tooltip.style.top="-1000px",t.completions&&t.completions.length){this.tooltip.style.top="-1000px",this.selected_index=0,this.completion_list.innerHTML='<ul class="notranslate">'+t.completions.map((s,a)=>(s.name===this.last_completion&&(this.selected_index=a),`<li><a data-index="${a}">${s.name}</a></li>`)).join(`
`)+"<ul>";let i=this.completion_list.offsetHeight,n=!1;this.options.autocomplete_prefer_top?n=r.top>=200:this.DOM.doc?.documentElement&&Math.max(this.DOM.doc.documentElement.clientHeight,this.DOM.view?.innerHeight||0)-r.bottom<200&&(n=!0),n?this.completion_list.style.top=r.top-i-5+"px":this.completion_list.style.top=r.bottom+5+"px",this.completion_list.style.left=r.left+"px";let o=this.completion_list.querySelectorAll("a");this.active_element=o[this.selected_index],o[this.selected_index].classList.add("selected"),this.last_completion=o[this.selected_index].textContent||void 0,this.completion_list.scrollTop=this.active_element.offsetTop,this.completion_list_visible=!0}else this.completion_list.style.top="-1000px"}};var mt=(E=>(E[E.Null=0]="Null",E[E.InsertRows=1]="InsertRows",E[E.InsertColumns=2]="InsertColumns",E[E.ResizeRows=3]="ResizeRows",E[E.ResizeColumns=4]="ResizeColumns",E[E.Select=5]="Select",E[E.SetRange=6]="SetRange",E[E.UpdateStyle=7]="UpdateStyle",E[E.UpdateBorders=8]="UpdateBorders",E[E.Indent=9]="Indent",E[E.MergeCells=10]="MergeCells",E[E.UnmergeCells=11]="UnmergeCells",E[E.Clear=12]="Clear",E[E.UpdateTheme=13]="UpdateTheme",E[E.SetNote=14]="SetNote",E[E.SetLink=15]="SetLink",E[E.Freeze=16]="Freeze",E[E.SetName=17]="SetName",E[E.ShowHeaders=18]="ShowHeaders",E[E.AddSheet=19]="AddSheet",E[E.DuplicateSheet=20]="DuplicateSheet",E[E.DeleteSheet=21]="DeleteSheet",E[E.ActivateSheet=22]="ActivateSheet",E[E.RenameSheet=23]="RenameSheet",E[E.ReorderSheet=24]="ReorderSheet",E[E.ShowSheet=25]="ShowSheet",E[E.DataValidation=26]="DataValidation",E[E.Reset=27]="Reset",E[E.SortTable=28]="SortTable",E[E.InsertTable=29]="InsertTable",E[E.RemoveTable=30]="RemoveTable",E[E.AddConditionalFormat=31]="AddConditionalFormat",E[E.RemoveConditionalFormat=32]="RemoveConditionalFormat",E[E.TabColor=33]="TabColor",E[E.CreateAnnotation=34]="CreateAnnotation",E[E.RemoveAnnotation=35]="RemoveAnnotation",E))(mt||{});var Gt=class{function_names=[];argument_separator=F.argument_separator.charCodeAt(0);function_map=new Map;RemoveFunctions(e){Array.isArray(e)||(e=[e]);for(let t of e)this.function_map.delete(t.name.toLowerCase());this.UpdateNameList()}AddFunctions(e){Array.isArray(e)||(e=[e]);for(let t of e)this.function_map.set(t.name.toLowerCase(),t);this.UpdateNameList()}SetFunctions(e){this.function_map.clear();for(let t of e)this.function_map.set(t.name.toLowerCase(),t);this.UpdateNameList()}NormalizeIdentifier(e){return this.function_map.get(e.toLowerCase())?.name}Get(e){return this.function_map.get(e.toLowerCase())}Exec(e){if(e.text[0]!=="=")return{};let t,r={};if(e.cursor===e.text.length&&(t=e.text.match(/(?:^|[^a-zA-Z\u00C0-\u024F_\d])([a-zA-Z\u00C0-\u024F_][\w\d\u00C0-\u024F_.]*)\s*$/),t)){let n=t[1],o=new RegExp("^"+n.replace(".","\\."),"i");r={completions:this.function_names.filter(a=>o.test(a)).map(a=>this.function_map.get(a.toLowerCase())).filter(a=>!!a),token:n,position:e.cursor-n.length}}let i=this.ParseTooltip(e.text.substr(0,e.cursor));if(i.function){let n=this.function_map.get(i.function.toLowerCase());n&&(r.tooltip='<span class="notranslate">'+n.name+"</span>",r.arguments="("+(n.arguments||[]).map((o,s)=>{let a=o.name||"argument";return s===i.argument?`<span class="active-argument">${a}</span>`:a}).join(F.argument_separator+" ")+")",r.description=n.description?`<span class="function-description">${n.description}</span>`:"",r.function_position=i.position||0)}return r}ParseTooltip(e){let t=[],r=0,i="",n=!1,o=0;for(let a of e){let c=a.charCodeAt(0);if(n)c===34&&(n=!1);else switch(c){case 40:t.push({buffer:i.trim(),argument:r,position:o-i.length}),i="",r=0;break;case this.argument_separator:r++;break;case 41:r=t.pop()?.argument||0;break;case 34:i="",n=!0;break;default:c>=97&&c<=122||c>=65&&c<=90||c>=48&&c<=57||c>=192&&c<=591||c===95||c===46?i+=a:i=""}o++}let s=t.pop();return{function:s?.buffer||void 0,position:s?.position||0,argument:r}}UpdateNameList(){this.function_names=[...this.function_map.keys()].sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))}};var Bi={scrollbars:!0,in_cell_editor:!0,formula_bar:!0,add_tab:!1,tab_bar:"auto",expand_formula_button:!1,expand:!0,comment_markdown:!0,repaint_on_cell_change:!0,grid_over_background:!1};var Jo=l=>{console.error("invalid case")},ft=class{grid_events=new be;command_log=new be;model;view;get active_sheet(){return this.view.active_sheet}set active_sheet(e){this.view.active_sheet=e}get view_index(){return this.view.view_index}batch=0;batch_paint=!1;batch_events=[];autocomplete_matcher=new Gt;flags={};options;parser;constructor(e={},t){this.model=t,this.view={active_sheet:this.model.sheets.list[0],view_index:this.model.view_count++},this.parser=t.parser,this.options={...Bi,...e}}RemoveConditionalFormat(e){this.ExecCommand({key:32,...e})}AddConditionalFormat(e){this.ExecCommand({key:31,format:e})}RemoveTable(e){this.ExecCommand({key:30,table:e})}InsertTable(e,t=!0,r=void 0,i){e.start.sheet_id||(e.start.sheet_id=this.active_sheet.id);let n=this.FindSheet(e);for(let o=e.start.row;o<=e.end.row;o++)for(let s=e.start.column;s<=e.end.column;s++){let a=n.cells.GetCell({row:o,column:s},!1);if(a&&(a.area||a.merge_area||a.table)){this.Error(4);return}}this.ExecCommand({key:29,area:JSON.parse(JSON.stringify(e)),totals:t,sortable:r,theme:i})}ActivateSheet(e){let t=typeof e=="number"?e:void 0,r=typeof e=="string"?e:void 0;this.ExecCommand({key:22,index:t,name:r})}ActivateSheetID(e){this.ExecCommand({key:22,id:e})}DuplicateSheet(e,t,r){let i={key:20,new_name:t,insert_before:r};typeof e>"u"?i.id=this.active_sheet.id:i.index=e,this.ExecCommand(i)}AddSheet(e){this.ExecCommand({key:19,name:e,show:!0})}DeleteSheet(e){if(typeof e>"u"&&!this.model.sheets.list.some((t,r)=>t===this.active_sheet?(e=r,!0):!1))throw new Error("invalid index");this.ExecCommand({key:21,index:e})}InsertSheet(e,t){if(typeof e>"u"&&!this.model.sheets.list.some((r,i)=>r===this.active_sheet?(e=i+1,!0):!1))throw new Error("invalid index");this.ExecCommand({key:19,insert_index:e,name:t,show:!0})}DeleteSheetID(e){this.ExecCommand({key:21,id:e})}Reset(){this.ExecCommand({key:27})}SetLink(e,t){this.ExecCommand({key:15,area:e,reference:t})}ShowAll(){let e=[];for(let t=0;t<this.model.sheets.length;t++)e.push({key:25,index:t,show:!0});this.ExecCommand(e)}ShowSheet(e=0,t=!0){let r={key:25,show:t};typeof e=="string"?r.name=e:r.index=e,this.ExecCommand(r)}SortTable(e,t={}){this.ExecCommand({key:28,table:JSON.parse(JSON.stringify(e)),...ji,...t})}GetFreeze(){return{...this.active_sheet.freeze}}InsertRows(e=0,t=1){this.ExecCommand({key:1,before_row:e,count:t})}GetTableReference(e){return this.model.sheets.Find(e.sheet_id||this.active_sheet.id)?.CellData(e).table||void 0}FromCSV(e){this.parser.Save(),this.parser.SetLocaleSettings(".");let r=Ri(e).map(n=>n.map(o=>{if(o){let s=this.parser.Parse(o);if(s.expression?.type==="complex")return s.expression}return ge.TryParse(o).value}));this.parser.Restore();let i={row:Math.max(0,r.length-1),column:r.reduce((n,o)=>Math.max(n,Math.max(0,o.length-1)),0)};this.ExecCommand([{key:27},{key:6,area:{start:{row:0,column:0},end:i},value:r}])}InsertColumns(e=0,t=1){this.ExecCommand({key:2,before_column:e,count:t})}ReorderSheet(e,t){this.ExecCommand({key:24,index:e,move_before:t})}RenameSheet(e,t){this.ExecCommand({key:23,new_name:t,id:e.id})}Freeze(e=0,t=0,r=!0){this.ExecCommand({key:16,rows:e,columns:t,highlight_transition:r})}SetRowHeight(e,t,r=!0){this.ExecCommand({key:3,row:e,height:t,shrink:r})}SetColumnWidth(e,t){this.ExecCommand({key:4,column:e,width:t})}FilterTable(e,t,r){let i=[];if(!e.area.start.sheet_id)throw new Error("invalid table area");let n=this.model.sheets.Find(e.area.start.sheet_id);if(!n)throw new Error("invalid table sheet");let o=[],s=[],a=e.totals_row?e.area.end.row-1:e.area.end.row;t+=e.area.start.column;for(let c=e.area.start.row+1;c<=a;c++){let d=n.CellData({row:c,column:t}),u=r(d),h=n.GetRowHeight(c);u&&!h?o.push(c):!u&&h&&s.push(c)}o&&i.push({key:3,sheet_id:n.id,row:o,height:n.default_row_height}),s&&i.push({key:3,sheet_id:n.id,row:s,height:0}),i.length&&this.ExecCommand(i)}UpdateSheets(e,t=!1,r){ee.Reset();let i=e.map(n=>ee.FromJSON(n,this.model.theme_style_properties));if(i.length===0&&i.push(ee.Blank(this.model.theme_style_properties)),this.model.sheets.Assign(i),this.ResetMetadata(),this.active_sheet=i[0],r){let n=this.model.sheets.Find(r);n&&(this.active_sheet=n)}}SetAutocompleteFunctions(e){let t=[];for(let i of this.model.named.list)t.push({name:i.name,named:!0,type:"token"});let r=e.slice(0).concat(t);this.autocomplete_matcher.SetFunctions(r)}ResetMetadata(){this.model.document_name=void 0,this.model.user_data=void 0}ResizeColumnsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.column;if(typeof r>"u"){r=[];for(let i=0;i<t.columns;i++)r.push(i)}if(typeof r=="number"&&(r=[r]),e.width)for(let i of r)t.SetColumnWidth(i,e.width);else console.error("auto size not supported")}RemoveAnnotationInternal(e){for(let t=0;t<e.sheet.annotations.length;t++)if(e.annotation===e.sheet.annotations[t]){e.sheet.annotations.splice(t,1),this.grid_events.Publish({type:"annotation",annotation:e.annotation,event:"delete"});return}}CreateAnnotationInternal(e){}ResizeRowsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.row;if(typeof r>"u"){r=[];for(let i=0;i<t.rows;i++)r.push(i)}if(typeof r=="number"&&(r=[r]),e.height)for(let i of r)t.SetRowHeight(i,e.height);else console.error("auto size not supported")}ResetInternal(){ee.Reset(),this.UpdateSheets([],!0),this.model.named.Reset(),this.model.macro_functions.clear(),this.model.tables.clear()}ValidatePasteAreas(e){for(let t of e){let r=this.active_sheet;if(t.start.sheet_id&&t.start.sheet_id!==r.id&&(r=this.model.sheets.Find(t.start.sheet_id)),!r)return!1;for(let i of r.cells.Iterate(t)){if(i.style?.locked)return console.info("invalid: locked cells"),!1;if(i.merge_area&&(!t.Contains(i.merge_area.start)||!t.Contains(i.merge_area.end)))return console.info("invalid: merge area"),!1;if(i.area&&(!t.Contains(i.area.start)||!t.Contains(i.area.end)))return console.info("invalid: array"),!1}}return!0}SetValidationInternal(e){let t=this.FindSheet(e.area);if(!t)throw new Error("invalid sheet in set validation");let r={start:e.area.start,end:e.area.end};e.range?t.AddValidation({type:"range",error:!!e.error,area:e.range,target:[r]}):e.list?t.AddValidation({type:"list",error:!!e.error,list:JSON.parse(JSON.stringify(e.list)),target:[r]}):t.RemoveValidations(r)}GetValidationRange(e){let t,r=this.FindSheet(e);if(r){t=[],e=r.RealArea(new y(e.start,e.end),!0);for(let i=e.start.row;i<=e.end.row;i++)for(let n=e.start.column;n<=e.end.column;n++){let o=r.CellData({row:i,column:n});o&&o.formatted&&(typeof o.formatted=="string"?t.push(o.formatted):t.push(le.FormatPartsAsText(o.formatted)))}}return t}DeleteSheetInternal(e){let t=!1,r=-1,i="",n=!1,o=e.name?e.name.toLowerCase():"",s=this.model.sheets.list.filter((a,c)=>c===e.index||a.id===e.id||a.name.toLowerCase()===o?(t=a===this.active_sheet,this.model.named.RemoveRangesForSheet(a.id),i=a.name,r=c,!1):!0);if(i&&this.RenameSheetReferences(s,i,"#REF")>0&&(n=!0),!s.length)s.push(ee.Blank(this.model.theme_style_properties)),r=0;else if(s.every(a=>!a.visible))s.unshift(ee.Blank(this.model.theme_style_properties)),r=0;else for(r>=s.length&&(r=0);!s[r].visible;)r++;return this.model.sheets.Assign(s),t&&this.ActivateSheetInternal({key:22,index:r}),n}RenameSheetInternal(e,t){if(!t||ki.test(t))throw new Error("invalid sheet name");let r=t.toLowerCase();for(let n of this.model.sheets.list)if(n!==e&&n.name.toLowerCase()===r)throw new Error("sheet name already exists");let i=e.name;e.name=t,this.model.sheets.Assign(this.model.sheets.list),this.RenameSheetReferences(this.model.sheets.list,i,t)}SortTableInternal(e){if(!e.table.area.start.sheet_id)throw new Error("table has invalid area");let t=this.model.sheets.Find(e.table.area.start.sheet_id);if(!t)throw new Error("invalid sheet in table area");let r=[],i=[],n=e.table.area.end.row;e.table.totals_row&&n--;let o=0,s=0;for(let h=e.table.area.start.row+1;h<=n;h++){if(t.GetRowHeight(h))i.push(h);else continue;let f={row:h,number:0,text:"",type:0,data:[]};for(let p=e.table.area.start.column;p<=e.table.area.end.column;p++){let b=t.CellData({row:h,column:p});if(p===e.column+e.table.area.start.column){let g=b.calculated_type||b.type;g===2?o++:g===3&&s++;let x=b.calculated_type?b.calculated:b.value;f.text=x?.toString()||"",f.number=Number(x)||0,f.type=b.calculated_type||b.type}f.data.push({address:{row:h,column:p},data:b.value,type:b.type,style:b.style})}r.push(f)}let a=e.type;a==="auto"&&(s>o?a="numeric":a="text");let c=e.asc?1:-1;switch(a){case"numeric":r.sort((h,m)=>h.type===0?m.type===0?0:1:m.type===0?-1:(h.number-m.number)*c);break;case"text":default:r.sort((h,m)=>h.type===0?m.type===0?0:1:m.type===0?-1:h.text.localeCompare(m.text)*c);break}let d={row:e.table.area.start.row+1,column:e.table.area.start.column};for(let h=0;h<i.length;h++){d.row=i[h];let m=r[h];d.column=e.table.area.start.column;for(let f of m.data){if(f.type===1){let p=f.data,b={columns:0,rows:d.row-m.row},g=this.parser.Parse(p);g.expression&&(p="="+this.parser.Render(g.expression,{offset:b,missing:""})),t.SetCellValue(d,p)}else t.SetCellValue(d,f.data);t.UpdateCellStyle(d,f.style||{},!1),d.column++}}let u=this.model.tables.get(e.table.name.toLowerCase());u&&(u.sort={type:e.type,asc:!!e.asc,column:e.column});{let h=e.table.area.start.row;for(let m=e.table.area.start.column;m<=e.table.area.end.column;m++)t.cells.data[h][m]?.FlushStyle();if(e.table.totals_row){h=e.table.area.end.row;for(let m=e.table.area.start.column;m<=e.table.area.end.column;m++)t.cells.data[h][m]?.FlushStyle()}}return new y(e.table.area.start,e.table.area.end)}UpdateTableColumns(e){if(!e.area.start.sheet_id)throw new Error("invalid area in table");let t=this.model.sheets.Find(e.area.start.sheet_id);if(!t)throw new Error("invalid sheet in table");let r=e.columns?.slice(0)||void 0,i=[],n=e.area.start.row,o=e.area.end.column-e.area.start.column+1,s=e.area.start.column;for(let a=0;a<o;a++,s++){let c=t.CellData({row:n,column:s}),d="";c.type!==2?(typeof c.formatted<"u"?d=c.formatted.toString():typeof c.calculated<"u"?d=c.calculated.toString():typeof c.value<"u"&&(d=c.value.toString()),c.Set(d,2)):d=c.value||"",d||(d=`Column${a+1}`);let u=d,h=!1,m=1;for(;!h;){h=!0;e:for(let f of i)if(f.toLowerCase()===u.toLowerCase()){h=!1,u=`${d}${++m}`;break e}}c.Set(u,2),i.push(u.toLowerCase())}if(r&&r.length===i.length){let a=new Map;for(let c=0;c<r.length;c++){let d=r[c].toLowerCase();d!==i[c]&&a.set(d,i[c])}if(a.size){let c=e.name.toLowerCase();for(let d of this.model.sheets.list)for(let u of d.cells.Iterate())if(u.ValueIsFormula()){let h=!1,m=this.parser.Parse(u.value);m.expression&&(this.parser.Walk(m.expression,f=>{if(f.type==="structured-reference"&&(f.table.toLowerCase()===c||!f.table&&u.table===e))for(let[p,b]of a.entries())f.column.toLowerCase()===p&&(f.column=b,h=!0);return!0}),h&&(console.info("updating value"),u.value="="+this.parser.Render(m.expression,{missing:""})))}}}return e.columns=i,{start:{...e.area.start},end:{row:e.area.start.row,column:e.area.end.column}}}SetRangeInternal(e,t={}){let r=N(e.area)?new y(e.area):new y(e.area.start,e.area.end),i=this.FindSheet(r);if(r.start.sheet_id||(r.start.sheet_id=i.id),!r.entire_row&&!r.entire_column&&(r.end.row>=i.rows||r.end.column>=i.columns)&&(i.cells.EnsureCell(r.end),i===this.active_sheet&&(t.layout=!0)),N(e.area)){let n=i.CellData(e.area);if(n.area&&(n.area.rows>1||n.area.columns>1)){this.Error(2);return}let o=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;return e.r1c1&&(o=this.TranslateR1C1(e.area,o)),e.array?i.SetArrayValue(r,o):i.SetCellValue(e.area,o),r}else{if(e.array){let n=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;e.r1c1&&(n=this.TranslateR1C1(r.start,n)),i.SetArrayValue(r,n)}else{if(e.r1c1){if(Array.isArray(e.value))for(let n=0;n<e.value.length&&n<r.rows;n++){e.value[n]||(e.value[n]=[]);let o=e.value[n];for(let s=0;s<o.length&&s<r.columns;s++){let a={...r.start,row:r.start.row+n,column:r.start.column+s};o[s]=this.TranslateR1C1(a,o[s])}}else if(typeof e.value=="string"&&e.value[0]==="="){let n=[];for(let o=0;o<r.rows;o++){let s=[];for(let a=0;a<r.columns;a++){let c={...r.start,row:r.start.row+o,column:r.start.column+a};s.push(this.TranslateR1C1(c,e.value))}n.push(s)}e.value=n}}i.SetAreaValues2(r,e.value)}return r}}ActivateSheetInternal(e){let t=this.ResolveSheet(e)||this.model.sheets.list[0];if(this.active_sheet===t&&!e.force)return;if(!t.visible)throw new Error("cannot activate hidden sheet");let r=this.active_sheet;this.active_sheet=t,this.grid_events.Publish({type:"sheet-change",deactivate:r,activate:this.active_sheet})}ShowSheetInternal(e){let t=this.ResolveSheet(e);if(t&&t.visible!==e.show){if(!e.show){let r=0;for(let i of this.model.sheets.list)(!t.visible||i===t)&&r++;if(r>=this.model.sheets.length)throw new Error("can't hide all sheets")}if(t.visible=e.show,t===this.active_sheet){let r=this.model.sheets.list;for(let i=0;i<r.length;i++)if(r[i]===this.active_sheet){for(let n=i+1;n<r.length;n++)if(r[n].visible){this.ActivateSheetInternal({key:22,index:n});return}for(let n=0;n<r.length;n++)if(r[n].visible){this.ActivateSheetInternal({key:22,index:n});return}throw new Error("no visible sheet")}}}}NormalizeCommands(e){Array.isArray(e)||(e=[e]);let t=this.active_sheet.id;for(let r of e)switch(r.key){case 0:case 33:case 18:case 25:case 19:case 20:case 21:case 22:case 23:case 24:case 27:case 34:case 35:break;case 28:case 30:r.table.area.start.sheet_id||(r.table.area.start.sheet_id=t);break;case 31:r.format.area.start.sheet_id||(r.format.area.start.sheet_id=t);break;case 3:case 4:case 2:case 1:case 16:r.sheet_id||(r.sheet_id=t);break;case 12:case 14:case 15:case 9:case 8:case 10:case 11:case 26:case 6:case 7:case 17:case 5:case 29:case 32:r.area&&(N(r.area)?r.area.sheet_id||(r.area.sheet_id=t):r.area.start.sheet_id||(r.area.start.sheet_id=t));break;default:Jo(r)}return e}TabColor(e,t){this.ExecCommand({key:33,sheet:e,color:t})}AddSheetInternal(e=ee.default_sheet_name,t=-1){if(!this.options.add_tab){console.warn("add tab option not set or false");return}for(;this.model.sheets.list.some(i=>i.name===e);){let i=e.match(/^(.*?)(\d+)$/);i?e=i[1]+(Number(i[2])+1):e=e+"2"}let r=ee.Blank(this.model.theme_style_properties,e);return t>=0?this.model.sheets.Splice(t,0,r):this.model.sheets.Add(r),r.id}ResolveSheet(e){if(typeof e.index<"u")return this.model.sheets.list[e.index];if(typeof e.name<"u")return this.model.sheets.Find(e.name);if(e.id)return this.model.sheets.Find(e.id)}FindSheet(e){if(e===void 0)return this.active_sheet;let t=typeof e=="number"?e:N(e)?e.sheet_id:e.start.sheet_id;if(!t||t===this.active_sheet.id)return this.active_sheet;let r=this.model.sheets.Find(t);return r||this.active_sheet}PatchFormulasInternal(e,t,r,i,n,o,s){let a=this.parser.Parse(e||""),c=!1;if(a.expression&&(this.parser.Walk(a.expression,d=>{if(d.type==="range"||d.type==="address"){let u=[];d.type==="range"?(d.start.sheet&&d.start.sheet.toLowerCase()===o||!d.start.sheet&&s)&&u.push(d.start,d.end):d.type==="address"&&(d.sheet&&d.sheet.toLowerCase()===o||!d.sheet&&s)&&u.push(d);for(let h of u)r&&h.row>=t&&(r<0&&h.row+r<t?h.column=h.row=-1:h.row+=r,c=!0),n&&h.column>=i&&(n<0&&h.column+n<i?h.column=h.row=-1:h.column+=n,c=!0);return!1}return!0}),c))return"="+this.parser.Render(a.expression,{missing:""})}PatchExpressionSheetName(e,t,r){let i=!1,n=this.parser.Parse(e||"");if(n.expression&&(this.parser.Walk(n.expression,o=>(o.type==="address"&&o.sheet&&o.sheet.toLowerCase()===t&&(o.sheet=r,i=!0),!0)),i))return"="+this.parser.Render(n.expression,{missing:""})}RenameSheetReferences(e,t,r){let i=0;t=t.toLowerCase();for(let n of e){for(let o of n.cells.Iterate())if(o.ValueIsFormula()){let s=this.PatchExpressionSheetName(o.value||"",t,r);s&&(o.value=s,i++)}if(n.conditional_formats?.length)for(let o of n.conditional_formats)switch(o.type){case"cell-match":case"expression":{let s=this.PatchExpressionSheetName(o.expression,t,r);s&&(o.expression=s,i++)}break}for(let o of n.annotations)if(o.data.formula){let s=this.PatchExpressionSheetName(o.data.formula,t,r);s&&(o.data.formula=s,i++)}}for(let n of this.model.connected_elements.values())if(n.formula){let o=this.PatchExpressionSheetName(n.formula,t,r);o&&(n.formula=o,i++)}return i}ApplyBordersInternal(e){let t=e.borders,r=e.borders==="none"?0:e.width,i=new y(e.area.start,e.area.end),n=this.FindSheet(i);i.start.sheet_id=n.id;let o={border_top:r},s={border_bottom:r},a={border_left:r},c={border_right:r},d={border_top:0,border_top_fill:{}},u={border_bottom:0,border_bottom_fill:{}},h={border_left:0,border_left_fill:{}},m={border_right:0,border_right_fill:{}};return e.color?(o.border_top_fill={...e.color},s.border_bottom_fill={...e.color},a.border_left_fill={...e.color},c.border_right_fill={...e.color}):(o.border_top_fill={},s.border_bottom_fill={},a.border_left_fill={},c.border_right_fill={}),(t==="none"||t==="all")&&n.UpdateAreaStyle(i,{...o,...s,...a,...c},!0),(t==="top"||t==="outside")&&(i.entire_column||n.UpdateAreaStyle(i.top,{...o},!0)),(t==="none"||t==="all"||t==="outside"||t==="top")&&(i.entire_column||i.start.row&&n.UpdateAreaStyle(new y({row:i.start.row-1,column:i.start.column},{row:i.start.row-1,column:i.end.column}),{...u},!0)),(t==="bottom"||t==="outside")&&(i.entire_column||n.UpdateAreaStyle(i.bottom,{...s},!0)),(t==="none"||t==="all"||t==="outside"||t==="bottom")&&(i.entire_column||n.UpdateAreaStyle(new y({row:i.end.row+1,column:i.start.column},{row:i.end.row+1,column:i.end.column}),{...d},!0)),(t==="left"||t==="outside")&&(i.entire_row||n.UpdateAreaStyle(i.left,{...a},!0)),(t==="none"||t==="all"||t==="outside"||t==="left")&&(i.entire_row||i.start.column&&n.UpdateAreaStyle(new y({row:i.start.row,column:i.start.column-1},{row:i.end.row,column:i.start.column-1}),{...m},!0)),(t==="right"||t==="outside")&&(i.entire_row||n.UpdateAreaStyle(i.right,{...c},!0)),(t==="none"||t==="all"||t==="outside"||t==="right")&&(i.entire_row||n.UpdateAreaStyle(new y({row:i.start.row,column:i.end.column+1},{row:i.end.row,column:i.end.column+1}),{...h},!0)),y.Bleed(i)}TranslateR1C1(e,t){let r=!1,i=this.parser.flags.r1c1;if(this.parser.flags.r1c1=!0,typeof t=="string"&&t[0]==="="){let n=this.parser.Parse(t);n.expression&&(this.parser.Walk(n.expression,o=>(o.type==="address"&&o.r1c1&&(r=!0,o.offset_column?(o.absolute_column=!1,o.column=o.column+e.column):o.absolute_column=!0,o.offset_row?(o.absolute_row=!1,o.row=o.row+e.row):o.absolute_row=!0),!0)),r&&(t="="+this.parser.Render(n.expression,{missing:""})))}return this.parser.flags.r1c1=i,t}ClearAreaInternal(e){let t;if(e.start.sheet_id?t=this.model.sheets.Find(e.start.sheet_id):t=this.active_sheet,!t){console.warn("can't resolve sheet in ClearAreaInternal");return}e=t.RealArea(e);for(let i of t.cells.Iterate(e))if(i.area&&!e.ContainsArea(i.area)){this.Error(2);return}let r=this.model.tables.keys();for(let i of r){let n=this.model.tables.get(i);if(n&&n.area.start.sheet_id===t.id){let o=new y(n.area.start,n.area.end);if(e.ContainsArea(o)){for(let s=o.start.row;s<=o.end.row;s++)for(let a=o.start.column;a<=n.area.end.column;a++){let c=t.cells.GetCell({row:s,column:a},!1);c&&(c.table=void 0)}this.model.tables.delete(i)}}}t.ClearArea(e)}Error(e){this.grid_events.Publish({type:"error",code:e})}DuplicateSheetInternal(e){if(!this.options.add_tab){console.warn("add tab option not set or false");return}let t=this.ResolveSheet(e),r=this.model.sheets.list.reduce((a,c)=>Math.max(a,c.id),0)+1,i=-1;for(let a=0;a<this.model.sheets.length;a++)this.model.sheets.list[a]===t&&(i=a+1);if(!t||i<0)throw new Error("source sheet not found");if(typeof e.insert_before=="number")i=e.insert_before;else if(typeof e.insert_before=="string"){let a=e.insert_before.toLowerCase();for(let c=0;c<this.model.sheets.length;c++)if(this.model.sheets.list[c].name.toLowerCase()===a){i=c;break}}let n={rendered_values:!0},o=ee.FromJSON(t.toJSON(n),this.model.theme_style_properties),s=e.new_name||t.name;for(;this.model.sheets.list.some(a=>a.name===s);){let a=s.match(/^(.*?)(\d+)$/);a?s=a[1]+(Number(a[2])+1):s=s+"2"}return o.name=s,o.id=r,this.model.sheets.Splice(i,0,o),o.id}SelectInternal(e){}FreezeInternal(e){let t=this.FindSheet(e.sheet_id||this.active_sheet.id);t.freeze.rows=e.rows,t.freeze.columns=e.columns}PatchExpression(e,t){let r=0,i=this.parser.Parse(e);if(i.expression&&(this.parser.Walk(i.expression,n=>{if(n.type==="range"){if(!n.start.sheet||n.start.sheet.toLowerCase()===t.sheet.name.toLowerCase()){let o=y.PatchArea(n,t);o?(n.start.row=o.start.row,n.start.column=o.start.column,n.end.row=o.end.row,n.end.column=o.end.column):n.start.row=n.end.row=n.start.column=n.end.column=-1}return r++,!1}else if(n.type==="address"){let o=y.PatchArea({start:n,end:n},t);return o?(n.row=o.start.row,n.column=o.start.column):n.row=n.column=-1,r++,!1}return!0}),r))return this.parser.Render(i.expression,{missing:""})}PatchConditionalsAndValidations(e){if(e.sheet.data_validation.length){let t=new Set;for(let r of e.sheet.data_validation){let i=[];for(let n of r.target){let o=y.PatchArea(n,e);o&&i.push(o)}if(i.length>0){if(r.target=i,r.type==="range"&&r.area.start.sheet_id===e.sheet.id){let n=y.PatchArea(r.area,e);n?r.area=n:t.add(r)}}else t.add(r)}t.size&&(e.sheet.data_validation=e.sheet.data_validation.filter(r=>!t.has(r)))}if(e.sheet.conditional_formats?.length){let t=new Set;for(let r of e.sheet.conditional_formats){let i=y.PatchArea(r.area,e);if(i)r.area=JSON.parse(JSON.stringify(i));else{t.add(r);continue}switch(r.type){case"expression":case"cell-match":{let n=this.PatchExpression(r.expression,e);n&&(r.expression=n)}break}}t.size&&(e.sheet.conditional_formats=e.sheet.conditional_formats.filter(r=>!t.has(r)))}}InsertRowsInternal(e){let t=this.FindSheet(e.sheet_id);if(e.count===1/0?e.count=1:e.count===-1/0&&(e.count=-t.rows),!t.InsertRows(e.before_row,e.count))return this.Error(2),{error:!0};this.PatchConditionalsAndValidations({sheet:t,before_column:0,column_count:0,before_row:e.before_row,row_count:e.count});for(let a of this.model.connected_elements.values())if(a.formula){let c=this.PatchFormulasInternal(a.formula,e.before_row,e.count,0,0,t.name.toLowerCase(),!1);c&&(a.formula=c)}let r=Array.from(this.model.tables.values());for(let a of r)if(a.area.start.sheet_id===e.sheet_id)if(e.count>0){if(e.before_row<=a.area.start.row)a.area.start.row+=e.count,a.area.end.row+=e.count;else if(e.before_row<=a.area.end.row){a.area.end.row+=e.count;for(let c=a.area.start.row;c<=a.area.end.row;c++)for(let d=a.area.start.column;d<=a.area.end.column;d++){let u=t.CellData({row:c,column:d});u.table=a}}}else if(e.before_row<=a.area.start.row)if(e.before_row-e.count<=a.area.start.row)a.area.start.row+=e.count,a.area.end.row+=e.count;else if(e.before_row-e.count>=a.area.end.row)this.model.tables.delete(a.name.toLowerCase());else{this.model.tables.delete(a.name.toLowerCase());for(let c=e.before_row;c<=a.area.end.row;c++)for(let d=a.area.start.column;d<=a.area.end.column;d++){let u=t.CellData({row:c,column:d});u.table===a&&(u.table=void 0)}}else e.before_row<=a.area.end.row&&(e.before_row-e.count>a.area.end.row&&(a.totals_row=!1),a.area.end.row=Math.max(0,a.area.end.row+e.count,e.before_row-1));this.model.named.PatchNamedRanges(t.id,0,0,e.before_row,e.count);let i=t.name.toLowerCase();for(let a of this.model.sheets.list){let c=a===t;for(let d of a.cells.Iterate())if(d.ValueIsFormula()){let u=this.PatchFormulasInternal(d.value||"",e.before_row,e.count,0,0,i,c);u&&(d.value=u)}for(let d of a.annotations)if(d.data.formula){let u=this.PatchFormulasInternal(d.data.formula||"",e.before_row,e.count,0,0,i,c);u&&(d.data.formula=u)}}let n=[],o=[],s=[];if(e.count>0){let a=e.before_row;for(let c of t.annotations)if(c.data.layout){let[d,u,h]=[c.data.layout.tl.address.row,c.data.layout.br.address.row,c.data.layout.br.offset.y];if(a<=d)c.data.layout.tl.address.row+=e.count,c.data.layout.br.address.row+=e.count;else if(a<u||a===u&&h>0)c.data.layout.br.address.row+=e.count,o.push(c);else continue;n.push(c)}}else if(e.count<0){let a=e.before_row,c=e.before_row-e.count-1;for(let d of t.annotations)if(d.data.layout){let[u,h,m]=[d.data.layout.tl.address.row,d.data.layout.br.address.row,d.data.layout.br.offset.y];if(a<=u)if(c<u)d.data.layout.tl.address.row+=e.count,d.data.layout.br.address.row+=e.count;else if(c<h-1||c===h-1&&m>0)d.data.layout.tl.address.row=a,d.data.layout.tl.offset.y=0,d.data.layout.br.address.row+=e.count,o.push(d);else{s.push(d);continue}else if(a<h||a===h&&m>0)c<h-1||c===h-1&&m>0?(d.data.layout.br.address.row+=e.count,o.push(d)):(d.data.layout.br.address.row=a,d.data.layout.br.offset.y=0,o.push(d));else continue;n.push(d)}}for(let a of s)t.annotations=t.annotations.filter(c=>c!==a);return{update_annotations_list:n,resize_annotations_list:o,delete_annotations_list:s}}InsertColumnsInternal(e){let t=this.FindSheet(e.sheet_id);if(e.count===1/0?e.count=1:e.count===-1/0&&(e.count=-t.columns),!t.InsertColumns(e.before_column,e.count))return this.Error(2),{error:!0};this.PatchConditionalsAndValidations({sheet:t,before_column:e.before_column,column_count:e.count,before_row:0,row_count:0});for(let a of this.model.connected_elements.values())if(a.formula){let c=this.PatchFormulasInternal(a.formula,0,0,e.before_column,e.count,t.name.toLowerCase(),!1);c&&(a.formula=c)}let r=Array.from(this.model.tables.values());for(let a of r)if(a.area.start.sheet_id===e.sheet_id)if(e.count>0){if(e.before_column<=a.area.start.column)a.area.start.column+=e.count,a.area.end.column+=e.count;else if(e.before_column<=a.area.end.column){a.area.end.column+=e.count;for(let c=a.area.start.row;c<=a.area.end.row;c++)for(let d=a.area.start.column;d<=a.area.end.column;d++){let u=t.CellData({row:c,column:d});u.table=a}this.UpdateTableColumns(a)}}else e.before_column<=a.area.start.column?e.before_column-e.count<=a.area.start.column?(a.area.start.column+=e.count,a.area.end.column+=e.count):e.before_column-e.count>=a.area.end.column?this.model.tables.delete(a.name.toLowerCase()):(a.area.start.column=e.before_column,a.area.end.column+=e.count,this.UpdateTableColumns(a)):e.before_column<=a.area.end.column&&(a.area.end.column=Math.max(0,a.area.end.column+e.count,e.before_column-1),this.UpdateTableColumns(a));this.model.named.PatchNamedRanges(t.id,e.before_column,e.count,0,0);let i=t.name.toLowerCase();for(let a of this.model.sheets.list){let c=a===t;for(let d of a.cells.Iterate())if(d.ValueIsFormula()){let u=this.PatchFormulasInternal(d.value||"",0,0,e.before_column,e.count,i,c);u&&(d.value=u)}for(let d of a.annotations)if(d.data.formula){let u=this.PatchFormulasInternal(d.data.formula,0,0,e.before_column,e.count,i,c);u&&(d.data.formula=u)}}let n=[],o=[],s=[];if(e.count>0){let a=e.before_column;for(let c of t.annotations)if(c.data.layout){let[d,u,h]=[c.data.layout.tl.address.column,c.data.layout.br.address.column,c.data.layout.br.offset.x];if(a<=d)c.data.layout.tl.address.column+=e.count,c.data.layout.br.address.column+=e.count;else if(a<u||a===u&&h>0)c.data.layout.br.address.column+=e.count,o.push(c);else continue;n.push(c)}}else if(e.count<0){let a=e.before_column,c=e.before_column-e.count-1;for(let d of t.annotations)if(d.data.layout){let[u,h,m]=[d.data.layout.tl.address.column,d.data.layout.br.address.column,d.data.layout.br.offset.x];if(a<=u)if(c<u)d.data.layout.tl.address.column+=e.count,d.data.layout.br.address.column+=e.count;else if(c<h-1||c===h-1&&m>0)d.data.layout.tl.address.column=a,d.data.layout.tl.offset.x=0,d.data.layout.br.address.column+=e.count,o.push(d);else{s.push(d);continue}else if(a<h||a===h&&m>0)c<h-1||c===h-1&&m>0?(d.data.layout.br.address.column+=e.count,o.push(d)):(d.data.layout.br.address.column=a,d.data.layout.br.offset.x=0,o.push(d));else continue;n.push(d)}}for(let a of s)t.annotations=t.annotations.filter(c=>c!==a);return{update_annotations_list:n,resize_annotations_list:o,delete_annotations_list:s}}ExecCommand(e,t=!0){let r={pending:[]},i=[];e=this.NormalizeCommands(e),t&&this.command_log.Publish({command:e,timestamp:new Date().getTime()});for(let s of e)switch(s.key){case 27:this.ResetInternal();break;case 12:if(s.area){let a=new y(s.area.start,s.area.end);this.ClearAreaInternal(a),r.data_area=y.Join(a,r.data_area),r.formula=!0}break;case 5:this.SelectInternal(s);break;case 16:this.FreezeInternal(s),r.structure_event=!0;break;case 31:{let a=this.FindSheet(s.format.area);a.conditional_formats.push(s.format),a.Invalidate(new y(s.format.area.start,s.format.area.end)),a===this.active_sheet&&(r.render_area=y.Join(s.format.area,r.render_area)),r.structure_event=!0,r.conditional_formatting_event=!0}break;case 32:{let a,c=0;if(s.format){let d=JSON.stringify(s.format);a=this.FindSheet(s.format.area),a.conditional_formats=a.conditional_formats.filter(u=>JSON.stringify(u)===d?(c++,r.render_area=y.Join(u.area,r.render_area),!1):!0)}else if(s.area){let d=new y(s.area.start,s.area.end);a=this.FindSheet(s.area),a.conditional_formats=a.conditional_formats.filter(u=>{let h=new y(u.area.start,u.area.end);return h.Intersects(d)?(c++,r.render_area=y.Join(h,r.render_area),!1):!0})}a&&c&&(a.FlushConditionalFormats(),r.structure_event=!0,r.conditional_formatting_event=!0)}break;case 29:{let a=this.FindSheet(s.area),c=new y(s.area.start,s.area.end),d=!0;e:for(let u=c.start.row;u<=c.end.row;u++)for(let h=c.start.column;h<=c.end.column;h++){let m=a.cells.GetCell({row:u,column:h},!1);if(m&&(m.area||m.merge_area||m.table)){d=!1;break e}}if(d){let u=this.model.tables.size+1,h="";for(;h=`Table${u++}`,!!this.model.tables.has(h.toLowerCase()););let m={area:s.area,name:h,sortable:s.sortable,theme:s.theme};s.totals&&(m.totals_row=!0),this.model.tables.set(h.toLowerCase(),m);for(let f=c.start.row;f<=c.end.row;f++)for(let p=c.start.column;p<=c.end.column;p++){let b=a.cells.GetCell({row:f,column:p},!0);b.table=m}this.UpdateTableColumns(m),a.Invalidate(new y(m.area.start,m.area.end)),a===this.active_sheet?(r.style_area=y.Join(c,r.style_area),r.render_area=y.Join(c,r.render_area)):r.style_event=!0}}break;case 30:{let a=this.FindSheet(s.table.area),c=new y(s.table.area.start,s.table.area.end);for(let u=c.start.row;u<=c.end.row;u++)for(let h=c.start.column;h<=c.end.column;h++){let m=a.cells.GetCell({row:u,column:h},!1);m&&(m.table=void 0)}this.model.tables.delete(s.table.name.toLowerCase());let d=a.RealArea(c.Clone().Shift(-1,-1).Resize(c.rows+2,c.columns+2));a.Invalidate(d),a===this.active_sheet?(r.style_area=y.Join(c,r.style_area),r.render_area=y.Join(c,r.render_area)):r.style_event=!0}break;case 10:{let a=this.FindSheet(s.area);a.MergeCells(new y(s.area.start,s.area.end)),r.structure_event=!0,r.structure_rebuild_required=!0,a===this.active_sheet?(r.data_area=y.Join(s.area,r.data_area),r.render_area=y.Join(s.area,r.render_area)):(r.data_event=!0,r.pending||(r.pending=[]),r.pending.push(a.id))}break;case 11:{let a=this.FindSheet(s.area),c={},d=new y(s.area.start,s.area.end);for(let h of a.cells.Iterate(d,!1))if(h.merge_area){let m=y.CellAddressToLabel(h.merge_area.start)+":"+y.CellAddressToLabel(h.merge_area.end);c[m]=h.merge_area}let u=Object.keys(c);for(let h=0;h<u.length;h++)a.UnmergeCells(c[u[h]]);a===this.active_sheet?(r.render_area=y.Join(s.area,r.render_area),r.data_area=y.Join(s.area,r.data_area)):(r.data_event=!0,r.pending||(r.pending=[]),r.pending.push(a.id)),r.structure_event=!0,r.structure_rebuild_required=!0}break;case 9:{let a,c=this.FindSheet(s.area);if(N(s.area)){a=new y(s.area);let d=c.GetCellStyle(s.area,!0);c.UpdateCellStyle(s.area,{indent:Math.max(0,(d.indent||0)+s.delta)},!0)}else{a=new y(s.area.start,s.area.end);for(let d of a){let u=c.GetCellStyle(d,!0);c.UpdateCellStyle(d,{indent:Math.max(0,(u.indent||0)+s.delta)},!0)}}c===this.active_sheet?(r.style_area=y.Join(a,r.style_area),r.render_area=y.Join(a,r.render_area)):r.style_event=!0}break;case 7:{let a,c=this.FindSheet(s.area);N(s.area)?(a=new y(s.area),c.UpdateCellStyle(s.area,s.style,!!s.delta)):(a=new y(s.area.start,s.area.end),c.UpdateAreaStyle(a,s.style,!!s.delta)),c===this.active_sheet?(r.style_area=y.Join(a,r.style_area),(!s.delta||s.style.fill||s.style.border_top||s.style.border_left||s.style.border_right||s.style.border_bottom)&&(a=y.Bleed(a),this.active_sheet.Invalidate(a)),r.render_area=y.Join(a,r.render_area)):r.style_event=!0}break;case 26:this.SetValidationInternal(s),(!s.area.start.sheet_id||s.area.start.sheet_id===this.active_sheet.id)&&(r.render_area=y.Join(new y(s.area.start,s.area.end),r.render_area));break;case 17:{let a={type:"token",named:!0,name:s.name,scope:s.scope};s.area||s.expression?(s.area?this.model.named.SetNamedRange(s.name,new y(s.area.start,s.area.end),s.scope):s.expression&&this.model.named.SetNamedExpression(s.name,s.expression,s.scope),this.autocomplete_matcher.AddFunctions(a)):(this.model.named.ClearName(s.name,s.scope),this.autocomplete_matcher.RemoveFunctions(a)),r.structure_event=!0,r.structure_rebuild_required=!0}break;case 8:{let a=this.ApplyBordersInternal(s);a.start.sheet_id===this.active_sheet.id?(r.render_area=y.Join(a,r.render_area),r.style_area=y.Join(a,r.style_area)):r.style_event=!0}break;case 25:this.ShowSheetInternal(s),r.sheets=!0,r.structure_event=!0;break;case 33:s.sheet.tab_color=s.color,r.sheets=!0,r.structure_event=!0;break;case 24:{let a=[],c=this.model.sheets.list[s.index];for(let d=0;d<this.model.sheets.length;d++)d!==s.index&&(d===s.move_before&&a.push(c),a.push(this.model.sheets.list[d]));s.move_before>=this.model.sheets.length&&a.push(c),this.model.sheets.Assign(a),r.sheets=!0,r.structure_event=!0}break;case 23:{let a=this.ResolveSheet(s);a&&(this.RenameSheetInternal(a,s.new_name),r.sheets=!0,r.structure_event=!0)}break;case 35:this.RemoveAnnotationInternal(s),r.structure_event=!0,r.structure_rebuild_required=!0,r.annotation_event=!0;break;case 34:this.CreateAnnotationInternal(s),r.structure_event=!0,r.structure_rebuild_required=!0,r.annotation_event=!0;break;case 3:{let a=this.ResizeRowsInternal(s);if(a)if(a.start.sheet_id===this.active_sheet.id){let c=this.active_sheet.RealArea(new y(a.start,a.end));r.render_area=y.Join(c,r.render_area),r.data_area=y.Join(c,r.data_area),r.data_event=!0}else r.data_event=!0,r.pending||(r.pending=[]),a.start.sheet_id&&r.pending.push(a.start.sheet_id);r.structure_event=!0}break;case 4:this.ResizeColumnsInternal(s),r.structure_event=!0;break;case 18:this.active_sheet.SetHeaderSize(s.show?void 0:1,s.show?void 0:1),this.flags.layout=!0,this.flags.repaint=!0;break;case 1:this.InsertRowsInternal(s),r.structure_event=!0,r.structure_rebuild_required=!0;break;case 2:this.InsertColumnsInternal(s),r.structure_event=!0,r.structure_rebuild_required=!0;break;case 15:case 14:{let a=this.FindSheet(s.area),c=a.cells.GetCell(s.area,!0);if(c){let d;c.merge_area?(d=new y(c.merge_area.start),c=a.cells.GetCell(c.merge_area.start,!0)):d=new y(s.area),s.key===14?c.SetNote(s.note):(c.hyperlink=s.reference||void 0,c.render_clean=[]),a===this.active_sheet?(r.style_area=y.Join(d,r.style_area),r.render_area=y.Join(d,r.render_area)):r.style_event=!0}}break;case 28:{let a=this.SortTableInternal(s);a&&a.start.sheet_id===this.active_sheet.id?(r.data_area=y.Join(a,r.data_area),this.options.repaint_on_cell_change&&(r.render_area=y.Join(a,r.render_area))):r.data_event=!0}break;case 6:{let a=this.SetRangeInternal(s,r);if(a){let d=this.model.sheets.Find(a.start.sheet_id||this.active_sheet.id)?.TablesFromArea(a,!0)||[];for(let u of d)this.UpdateTableColumns(u)}a&&a.start.sheet_id===this.active_sheet.id?(r.data_area=y.Join(a,r.data_area),this.options.repaint_on_cell_change&&(r.render_area=y.Join(a,r.render_area))):r.data_event=!0}break;case 21:this.DeleteSheetInternal(s),r.sheets=!0,r.structure_event=!0,r.structure_rebuild_required=!0;break;case 20:this.DuplicateSheetInternal(s),r.sheets=!0,r.structure_event=!0,r.structure_rebuild_required=!0;break;case 19:{let a=this.AddSheetInternal(s.name,s.insert_index);typeof a=="number"&&s.show&&this.ActivateSheetInternal({key:22,id:a}),r.structure_event=!0,r.sheets=!0,r.structure=!0}break;case 22:this.ActivateSheetInternal(s);break;default:console.warn(`unhandled command: ${mt[s.key]} (${s.key})`)}let n,o;return r.data_area?(r.data_area.start.sheet_id||r.data_area.SetSheetID(this.active_sheet.id),n={type:"data",area:r.data_area}):r.data_event&&(n={type:"data"}),r.style_area?(r.style_area.start.sheet_id||r.style_area.SetSheetID(this.active_sheet.id),o={type:"style",area:r.style_area}):r.style_event&&(o={type:"style"}),n&&o?i.push({type:"composite",data_area:n.area,style_area:o.area}):(n&&i.push(n),o&&i.push(o)),r.structure_event&&i.push({type:"structure",rebuild_required:r.structure_rebuild_required,conditional_format:r.conditional_formatting_event,update_annotations:r.annotation_event}),this.batch>0?this.batch_events.push(...i):this.grid_events.Publish(i),r}};var Bt=class extends Fe{get active(){return this.nodes.length>0}Reset(){this.AttachNodes()}AttachNodes(e=[],t=!0){this.assume_formula=t;let r=[];r=e.map(i=>{for(let n of this.nodes)if(n.node===i)return n;return{node:i}});for(let i of this.nodes)if(i.listeners){for(let[n,o]of i.listeners.entries())i.node.removeEventListener(n,o);i.listeners.clear()}this.nodes=r;for(let i of this.nodes){if(i.formatted_text===i.node.textContent){let n=i.node.innerHTML.length;i.check!==n&&(i.formatted_text=void 0)}i.node.ownerDocument.activeElement===i.node&&(this.active_editor=i),this.UpdateText(i,{toll_events:!0}),this.RegisterListener(i,"focusin",()=>{this.active_editor=i}),this.RegisterListener(i,"focusout",()=>{this.active_editor=void 0}),this.RegisterListener(i,"input",n=>{n.isTrusted&&(this.UpdateText(i),this.UpdateColors())})}this.UpdateColors(!0)}};var pt=class extends ft{hide_selection=!1;headless=!1;edit_state={};get scale(){return this.layout.scale}set scale(e){this.layout.scale=e,this.UpdateLayout(),this.UpdateAnnotationLayout(),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.layout.ApplyTheme(this.theme),this.overlay_editor?.UpdateScale(e),this.tab_bar?.UpdateScale(e),this.grid_events.Publish({type:"scale",scale:e});for(let t of this.model.sheets.list)for(let r of t.annotations)r.dirty=!0}theme;selected_annotation;hover_data={};editing_state=0;editing_cell={row:-1,column:-1,sheet_id:0};editing_selection;editing_annotation;pending_reset_selection=!1;view_node;container;layout;tile_update_pending=!1;scroll_offset_pending;pending_layout_update=new Set;decimal_separator_code=46;overlay_editor;autocomplete;formula_bar;RESIZE_PIXEL_BUFFER=5;external_editor_config;external_editor;cell_resize={row:-1,column:-1};render_tiles=new y({row:0,column:0});primary_selection={target:{row:0,column:0},area:new y({row:0,column:0}),empty:!0};spill_selection={target:{row:0,column:0},area:new y({row:0,column:0}),empty:!0};active_selection={target:{row:0,column:0},area:new y({row:0,column:0}),empty:!0};nub_select_flag=!1;additional_selections=[];double_click_data={};layout_token=0;render_token=0;tile_renderer;selection_renderer;tab_bar;DOM=H.GetInstance();constructor(e={},t,r=$t,i=!0,n){if(super(e,t),this.decimal_separator_code=F.decimal_separator.charCodeAt(0),this.theme=JSON.parse(JSON.stringify(r)),!i){this.headless=!0,this.layout=new Ft(this.model,this.view);return}this.DOM=n,this.layout=new Nt(this.model,this.view,n),e.initial_scale&&(typeof e.initial_scale=="string"&&(e.initial_scale=Number(e.initial_scale)),this.layout.scale=e.initial_scale),this.tile_renderer=new Ht(this.theme,this.layout,this.model,this.view,this.options),this.selection_renderer=new zt(this.theme,this.layout,this.model,this.view,this.primary_selection,this.additional_selections)}CopyArea(e,t="copy"){let r=(e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id):this.active_sheet)||this.active_sheet,i=r.GetCellStyle(e,!1),n=t!=="cut",o=[];for(let{cell:s,row:a,column:c}of r.cells.IterateRC(e)){let d=s.value;n&&d&&s.type===1&&(d=this.FormatR1C1(d,{row:a,column:c})[0][0]);let u=a-e.start.row,h=c-e.start.column;o[u]||(o[u]=[]);let m;s.area&&(m={start:{row:s.area.start.row-e.start.row,column:s.area.start.column-e.start.column},end:{row:s.area.end.row-e.start.row,column:s.area.end.column-e.start.column}}),o[u][h]={value:d,calculated:s.calculated,style:i[u][h],area:m}}return t==="cut"&&this.SetRange(e,void 0,{recycle:!0}),o}PasteArea(e,t,r={}){if(!t)throw new Error("no clipboad data");let i=t.length,n=t[0]?.length||0;e.Resize(Math.max(1,Math.floor(e.rows/i))*i,Math.max(1,Math.floor(e.columns/n))*n);let o=(e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id):this.active_sheet)||this.active_sheet,s=[];if(r.values)for(let[d,u]of t.entries()){s[d]=[];for(let h of u)s[d].push(typeof h.calculated>"u"?h.value:h.calculated)}let a=t,c=this.Batch(()=>{if(r.values)this.SetRange(e,s,{r1c1:!0,recycle:!0});else{this.SetRange(e,void 0,{recycle:!0});for(let d of e){let u=(d.row-e.start.row)%i,h=(d.column-e.start.column)%n,m=a[u][h];if(m.area){if(m.area.start.row===u&&m.area.start.column===h){let f=new y(m.area.start,m.area.end);f.Shift(e.start.row,e.start.column),this.SetRange(f,m.value,{r1c1:!0,array:!0})}}else m.value&&this.SetRange(new y(d),m.value,{r1c1:!0})}}if(r.formatting==="number-formats")for(let d of e){let u=(d.row-e.start.row)%i,h=(d.column-e.start.column)%n,m=(a[u][h].style||{}).number_format;o.UpdateCellStyle(d,{number_format:m},!0)}else if(r.formatting!=="target")for(let d of e){let u=(d.row-e.start.row)%i,h=(d.column-e.start.column)%n;o.UpdateCellStyle(d,a[u][h].style||{},!1)}},!0);this.grid_events.Publish(c)}Reselect(){this.primary_selection.empty||this.Select(this.primary_selection,this.primary_selection.area,this.primary_selection.target)}SetNote(e,t){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.target}this.ExecCommand({key:14,area:e,note:t})}FindAnnotation(e){for(let t of this.active_sheet.annotations)if((t.view[this.view_index]||{}).node===e)return t}CreateAnnotation(e={},t=this.active_sheet,r=!0,i=!1,n,o){this.ExecCommand({key:34,properties:e,add_to_sheet:r,offset:i,target:n,focus:o,sheet:t})}CreateAnnotationInternal(e){let t=new Ne(e.properties);if(e.offset)if(!t.data.layout&&t.scaled_rect&&(t.data.layout=this.layout.RectToAnnotationLayout(t.scaled_rect)),!t.data.layout)console.warn("can't offset annotation without layout");else{let r=this.layout.AnnotationLayoutToRect(t.data.layout).Shift(20,20),i=!0;for(;i;){i=!1;for(let n of e.sheet.annotations)if(n!==t&&n.scaled_rect&&n.scaled_rect.top===r.top&&n.scaled_rect.left===r.left){r=r.Shift(20,20),i=!0;break}}t.data.layout=this.layout.RectToAnnotationLayout(r)}if(e.target&&(B.IsRectangle(e.target)?(t.data.layout=void 0,t.rect=B.Create(e.target)):e.target.start&&(t.rect=void 0,t.data.layout=this.layout.AddressToAnnotationLayout(e.target.start,e.target.end||e.target.start))),e.add_to_sheet&&(e.sheet.annotations.some(r=>r===t)||e.sheet.annotations.push(t),this.AddAnnotation(t)),e.focus){let r=t.view[this.view_index];if(r&&r.node){let i=r.node;setTimeout(()=>{i.focus()},1)}}}UpdateAnnotationLayout(){}AddAnnotation(e,t=!1,r=!0){let i=e.view[this.view_index];if(i||(i={},e.view[this.view_index]=i),!i.node){let n=this.DOM.Div("annotation",void 0,{data:{scale:this.layout.scale.toString()},style:{fontSize:`${10*this.layout.scale}pt`},attrs:{tabindex:"-1"},events:{mousedown:a=>{a.button===0&&this.layout.AnnotationMouseDown(e,n,a,o,s).then(c=>{c?this.grid_events.Publish(c):this.selected_annotation!==e&&this.grid_events.Publish({type:"annotation",annotation:e,event:"select"}),e.data.layout&&this.EnsureAddress(e.data.layout.br.address,1)})},focusin:()=>{for(let a of this.layout.GetFrozenAnnotations(e))a.classList.add("clone-focus");this.selected_annotation=e,this.primary_selection.empty=!0,this.primary_selection.target={row:-1,column:-1,sheet_id:this.active_sheet.id},this.HideGridSelection()},focusout:a=>{for(let c of this.layout.GetFrozenAnnotations(e))c.classList.remove("clone-focus");this.formula_bar&&this.formula_bar.IsElement(a.relatedTarget)?(this.primary_selection.empty=!0,this.RenderSelections(),this.editing_annotation=e,this.layout.ShowSelections(!0)):this.formula_bar?.IsExpandButton(a.relatedTarget)||this.layout.FocusInLayout(a.relatedTarget||void 0)&&(this.selected_annotation===e&&(this.selected_annotation=void 0),this.ShowGridSelection())}}});i.node=n,i.content_node=this.DOM.Div("annotation-content",n);let o=this.DOM.Div("annotation-move-target",n),s=this.DOM.Div("annotation-resize-target",n);n.addEventListener("keydown",a=>{let c=e.scaled_rect;if(!c){console.info("missing scaled rect!");return}let d=[n,...this.layout.GetFrozenAnnotations(e)];if(a.ctrlKey||q.is_mac&&a.metaKey){let h=e.data.style?{...e.data.style}:{},m=!0;switch(a.key){case"b":this.ApplyAnnotationStyle({bold:!h.bold});break;case"i":this.ApplyAnnotationStyle({italic:!h.italic});break;case"u":this.ApplyAnnotationStyle({underline:!h.underline});break;default:m=!1}if(m){a.stopPropagation(),a.preventDefault();return}}let u={x:c.left,y:c.top};switch(a.key){case"ArrowUp":case"Up":a.ctrlKey?(this.layout.AnnotationLayoutOrder(e,1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),n.focus()):u.y--;break;case"ArrowLeft":case"Left":if(a.ctrlKey)return;u.x--;break;case"ArrowRight":case"Right":if(a.ctrlKey)return;u.x++;break;case"ArrowDown":case"Down":a.ctrlKey?(this.layout.AnnotationLayoutOrder(e,-1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),n.focus()):u.y++;break;case"Escape":case"Esc":this.Focus();break;case"Backspace":a.metaKey&&q.is_mac&&(this.Focus(),this.RemoveAnnotation(e));break;case"Delete":case"Del":this.Focus(),this.RemoveAnnotation(e);break;default:return}if(a.stopPropagation(),a.preventDefault(),u.x=Math.max(u.x,0),u.y=Math.max(u.y,0),c.left!==u.x||c.top!==u.y){c.left=Math.round(u.x),c.top=Math.round(u.y);for(let h of d)h.style.top=c.top+"px",h.style.left=c.left+"px";e.data.extent=void 0,this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),e.data.layout=this.layout.RectToAnnotationLayout(c)}})}r&&(this.layout.AddAnnotation(e,this.theme),e.data.layout&&this.EnsureAddress(e.data.layout.br.address,1,t)),t||this.grid_events.Publish({type:"annotation",annotation:e,event:"create"})}AnnotationUpdated(e){this.layout.CloneFrozenAnnotation(e)}RemoveAnnotation(e,t=this.active_sheet){this.ExecCommand({key:35,annotation:e,sheet:t})}RemoveAnnotationInternal(e){super.RemoveAnnotationInternal(e),this.layout.RemoveAnnotation(e.annotation)}RemoveAnnotationNodes(){this.headless||this.layout.RemoveAnnotationNodes()}ShowHeaders(e=!0){this.ExecCommand({key:18,show:e})}FromImportData(e,t=!1){this.RemoveAnnotationNodes();let r=e.sheets,i=r.map(()=>ee.Blank(this.model.theme_style_properties).toJSON()),n;if(typeof e.active_tab=="number")n=i[e.active_tab]?.id;else for(let s=0;s<e.sheets.length;s++)if(!e.sheets[s].hidden){n=i[s].id;break}this.UpdateSheets(i,!0,n);let o={};this.model.macro_functions.clear(),this.ClearSelection(this.primary_selection),this.model.tables.clear();for(let s=0;s<r.length;s++){let a=this.model.sheets.list[s];a.ImportData(r[s]),o[a.name]=a.id;for(let c of r[s].cells)c.table&&(c.table.area.start.sheet_id=a.id,this.model.tables.set(c.table.name.toLowerCase(),c.table));for(let c of this.model.tables.values())this.UpdateTableColumns(c)}this.model.sheets.UpdateIndexes(),this.model.named.Reset(),e.named&&this.model.UnserializeNames(e.named,this.active_sheet);for(let s of this.active_sheet.annotations)this.AddAnnotation(s,!0);this.ActivateSheetTasks(),this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}NextSheet(e=1){if(this.model.sheets.length===1)return;let t=this.model.sheets.list.map((r,i)=>({sheet:r,index:i})).filter(r=>r.sheet.visible);if(t.length!==1){for(let r=0;r<t.length;r++)if(t[r].sheet===this.active_sheet){let i=(r+e)%t.length;for(;i<0;)i+=t.length;this.ActivateSheet(t[i].index);return}}}UpdateSheets(e,t=!1,r){if(super.UpdateSheets(e,t,r),this.RemoveAnnotationNodes(),this.ClearSelection(this.primary_selection),e[0]&&e[0].primary_selection){let i=e[0].primary_selection;i.empty||this.Select(this.primary_selection,new y(i.area.start,i.area.end),i.target)}else if(!this.active_sheet.selection.empty){let i=this.active_sheet.selection;this.Select(this.primary_selection,new y(i.area.start,i.area.end),i.target)}this.layout.ClearLayoutCaches();for(let i of this.model.sheets.list)for(let n of i.annotations)this.AddAnnotation(n,!0,i===this.active_sheet);this.ActivateSheetTasks(),this.QueueLayoutUpdate(JSON.parse(JSON.stringify(this.active_sheet.scroll_offset))),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}UpdateLayout(){this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!0)}UpdateTabBar(){this.tab_bar&&this.tab_bar.Update()}UpdateTheme(e=!1,t){if(!e)for(let i of Object.keys(this.theme))delete this.theme[i];let r=JSON.parse(JSON.stringify($t));this.view_node&&(r={...qi(this.view_node,this.options.support_font_stacks)}),r={...this.theme,...r,...t},Object.assign(this.theme,r),this.StyleDefaultFromTheme(),this.active_sheet.UpdateDefaultRowHeight(this.theme),this.active_sheet.FlushCellStyles(),this.layout.ApplyTheme(this.theme),this.tab_bar&&this.tab_bar.UpdateTheme(),e||(this.UpdateLayout(),this.overlay_editor?.UpdateScale(this.layout.scale),this.Repaint(!0,!0,!0))}SetScale(e){e=Math.round(e*1e3)/1e3,e=Math.min(2,Math.max(e,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:e})),this.scale=e}Initialize(e,t=!1){if(!this.tile_renderer||!this.selection_renderer)return;this.view_node=e,this.UpdateTheme(!0);let i=e.querySelector(".treb-spreadsheet-body").querySelector("div");this.options.formula_bar&&(this.autocomplete||(this.autocomplete=new ht({theme:this.theme,container:i})),this.InitFormulaBar(e,this.autocomplete)),this.options.tab_bar&&(this.tab_bar=new It(this.layout,this.model,this.view,this.options,this.theme,e),this.tab_bar.Subscribe(n=>{switch(n.type){case"cancel":break;case"scale":{let o=this.layout.scale;if(o=Math.round(n.value*1e3)/1e3,o=Math.min(2,Math.max(o,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:o})),this.scale=o,n.keep_focus)return}break;case"reorder-sheet":this.ReorderSheet(n.index,n.move_before);break;case"delete-sheet":this.DeleteSheet();break;case"add-sheet":this.AddSheet();break;case"rename-sheet":this.RenameSheet(n.sheet,n.name);break;case"activate-sheet":this.ActivateSheetID(n.sheet.id);break}this.SelectingArgument()||this.Focus()})),this.container=i,this.container.classList.add("treb-grid"),q.is_mac&&q.is_safari&&this.container.classList.add("safari"),this.container.setAttribute("tabindex","-1"),this.layout.Initialize(i,{scroll:()=>this.OnScroll(),dropdown:n=>this.OnDropdownSelect(n),sort:(n,o,s)=>{let a=this.model.tables.get(n.toLowerCase());a&&this.SortTable(a,{column:o,asc:s})},focus:()=>this.Focus()},this.options.scrollbars),this.selection_renderer.Initialize(),this.layout.UpdateTiles(),this.autocomplete||(this.autocomplete=new ht({theme:this.theme,container:i})),this.InitOverlayEditor(this.autocomplete),this.AttachListeners(),this.render_tiles=this.layout.VisibleTiles(),t||(this.tab_bar?.Update(),this.Repaint(!0))}MergeCells(e){!e&&this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:10,area:e||this.primary_selection.area}))}UnmergeCells(e){!e&&this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:11,area:e||this.primary_selection.area}))}GetAnnotationStyle(){if(this.selected_annotation)return this.selected_annotation.data?.style?JSON.parse(JSON.stringify(this.selected_annotation.data.style)):{}}ApplyAnnotationStyle(e={},t=!0){if(this.selected_annotation){let r=this.selected_annotation;r.data.style=JSON.parse(JSON.stringify(t?I.Composite([r.data.style||{},e]):e));let i=r.view[this.view_index]?.node;this.layout.UpdateAnnotation(r,this.theme),i&&i.focus(),this.grid_events.Publish({type:"annotation",event:"update",annotation:r}),this.DelayedRender()}}AnnotationSelected(){return!!this.selected_annotation}Focus(e="",t=!1){if(this.selected_annotation)if(t)this.editing_annotation===this.selected_annotation?this.pending_reset_selection=!0:(this.selected_annotation=void 0,this.ShowGridSelection());else{this.selected_annotation.view[this.view_index].node?.focus();return}q.is_mobile?this.container?.focus():this.overlay_editor?.Focus(e)}SetValidation(e,t,r){if(!e){if(this.primary_selection.empty)throw new Error("invalid target in set validation");e=this.primary_selection.area}let i=new y(e.start,e.end),n={key:26,area:{start:i.start,end:i.end},error:r};t&&(Array.isArray(t)?n.list=t:typeof t=="object"&&t.start&&t.end&&N(t.start)&&N(t.end)&&(n.range=t)),this.ExecCommand(n),!this.primary_selection.empty&&(!e.start.sheet_id||e.start.sheet_id===this.active_sheet.id)&&i.Contains(this.primary_selection.target)&&requestAnimationFrame(()=>this.Select(this.primary_selection,this.primary_selection.area,this.primary_selection.target))}SetName(e,t,r,i,n=!1){let o=this.model.named.ValidateNamed(e);if(!o)throw new Error("invalid name");if(e=o,this.autocomplete_matcher){let a=this.autocomplete_matcher.Get(e);if(a&&(!a.named||!n)&&(t||r))throw new Error("name already defined")}let s={key:17,name:e,scope:i};if(t)N(t)&&(t=new y(t)),t.start.sheet_id||(t=new y({...t.start,sheet_id:this.active_sheet.id},t.end)),s.area=new y(t.start,t.end);else if(r){let a=this.parser.Parse(r);if(a.valid&&a.expression)this.parser.Walk(a.expression,c=>{if(c.type==="address"||c.type==="range"){if(c.type==="range"&&(c=c.start),!c.sheet_id&&c.sheet){let d=this.model.sheets.Find(c.sheet);d&&(c.sheet_id=d.id)}return c.sheet_id||(c.sheet_id=this.active_sheet.id),!1}return!0}),s.expression=a.expression;else throw new Error("invalid expression")}this.ExecCommand(s)}SelectAll(){this.Select(this.primary_selection,new y({row:1/0,column:1/0}),void 0,!0),this.RenderSelections()}ExternalEditor(e){if(this.external_editor_config=e,e){let t=(e.dependencies||[]).filter(r=>!!r).map(r=>N(r)?new y(r):new y(r.start,r.end));if(e.nodes?.length){if(!this.external_editor){let r=new Bt(this.model,this.view);this.external_editor=r,r.Subscribe(()=>this.HighlightDependencies(r.dependencies))}this.external_editor.AttachNodes(e.nodes,e.assume_formula??!0)}else this.external_editor&&this.external_editor.Reset();e.dependencies&&this.HighlightDependencies(t)}else this.external_editor&&this.external_editor.Reset(),this.ClearAdditionalSelections(),this.RenderSelections(!0)}SelectRange(e){this.Select(this.primary_selection,e),this.RenderSelections()}GetRangeStyle(e,t=!1){let r=0;if(N(e)?r=e.sheet_id||this.active_sheet.id:r=e.start.sheet_id||this.active_sheet.id,r)return this.model.sheets.Find(r)?.GetCellStyle(e,t)||void 0}FormatR1C1(e,t){ct(t)&&(t=t.start),Array.isArray(e)||(e=[[e]]);let r={type:"address",label:"",row:t.row,column:t.column,sheet:t.sheet_id?this.model.sheets.Name(t.sheet_id):this.active_sheet.name,position:0,id:0};for(let i=0;i<e.length;i++){let n=e[i];for(let o=0;o<n.length;o++){let s=n[o];if(typeof s=="string"&&s[0]==="="){let a=this.parser.Parse(s);a.expression&&(n[o]="="+this.parser.Render(a.expression,{missing:"",r1c1:!0,r1c1_base:{...r,row:t.row+i,column:t.column+o}}))}}}return e}GetRange(e,t){if(N(e)){let i=this.model.sheets.Find(e.sheet_id||this.active_sheet.id);if(i){if(t==="A1"||t==="R1C1"){let n=i.cells.RawValue(e);return t==="R1C1"?this.FormatR1C1(n,e):n}return t==="formatted"?i.GetFormattedRange(e):i.cells.GetRange(e)}return}let r=this.model.sheets.Find(e.start.sheet_id||this.active_sheet.id);if(r){if(t==="A1"||t==="R1C1"){let i=r.cells.RawValue(e.start,e.end);return t==="R1C1"?this.FormatR1C1(i,e):i}return t==="formatted"?r.GetFormattedRange(e.start,e.end):r.cells.GetRange(e.start,e.end)}}SetRange(e,t,r={}){let{recycle:i,transpose:n,array:o,r1c1:s}=r;if(r.argument_separator){let a={argument_separator:this.parser.argument_separator,decimal_mark:this.parser.decimal_mark};this.parser.Save();let c=!1;if(r.argument_separator===","&&this.parser.argument_separator!==","&&(this.parser.SetLocaleSettings("."),c=!0),r.argument_separator===";"&&this.parser.argument_separator!==";"&&(this.parser.SetLocaleSettings(","),c=!0),c){this.parser.flags.r1c1=s;let d=u=>{if(typeof u=="string"&&u[0]==="="){let h=this.parser.Parse(u);h.expression&&(u="="+this.parser.Render(h.expression,{missing:"",convert_decimal:a.decimal_mark,convert_argument_separator:a.argument_separator,pass_through_addresses:!0}))}return u};Array.isArray(t)?t=t.map(u=>Array.isArray(u)?u.map(h=>d(h)):d(u)):t=d(t)}this.parser.Restore()}if(t=this.model.UntranslateData(t),!Array.isArray(t))i||o?this.ExecCommand({key:6,area:e,value:t,array:o,r1c1:s}):this.ExecCommand({key:6,area:e.start,value:t,array:o,r1c1:s});else{if(Et(t)){if(i){if(e.rows>t.length){let c=Math.floor(e.rows/t.length);if(c>1){let d=[...t];for(let u=0;u<c;u++){let h=JSON.parse(JSON.stringify(d));t.push(...h)}}}let a=0;for(let c of t)a=Math.max(a,c.length);if(e.columns>a){let c=Math.floor(e.columns/a);if(c>1)for(let d of t){for(;d.length<a;)d.push(void 0);let u=[...d];for(let h=0;h<c;h++){let m=JSON.parse(JSON.stringify(u));d.push(...m)}}}}}else if(i){let a=e.entire_column?this.active_sheet.rows:e.rows,c=e.entire_row?this.active_sheet.columns:e.columns,d=a*c;if(d>t.length){let h=t.slice(0),m=Math.ceil(d/h.length);for(let f=1;f<m;f++)h=h.concat(t.slice(0));t=h}let u=[];for(let h=0,m=0;h<c;h++,m+=a)u[h]=t.slice(m,m+a);t=u}else t=[t];n&&(t=this.Transpose(t)),this.ExecCommand({key:6,area:e,value:t,array:o,r1c1:s})}!this.primary_selection.empty&&e.Contains(this.primary_selection.target)&&this.UpdateFormulaBarFormula()}ApplyStyle(e,t={},r=!0){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}ee.UpdateStyle(t),this.ExecCommand({key:7,area:e,style:t,delta:r}),this.UpdateFormulaBarFormula()}GetSelection(){return this.primary_selection}Update(e=!1,t){this.DelayedRender(e,t)}UpdateAnnotations(){this.active_sheet.annotations.length&&this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)}Indent(e,t=0){if(!e){if(this.primary_selection.empty)return;e=this.active_sheet.RealArea(this.primary_selection.area)}this.ExecCommand({key:9,area:e,delta:t})}ApplyBorders2(e,t="none",r,i=1){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}t==="none"&&(i=0),this.ExecCommand({key:8,color:r,area:e,borders:t,width:i})}Batch(e,t=!0){if(this.batch===0?this.batch_paint=t:this.batch_paint=this.batch_paint||t,this.batch++,e(),this.batch--,this.batch===0){let r=this.batch_events.slice(0);return this.batch_events=[],this.batch_paint&&this.DelayedRender(!1),r}return[]}ScrollTo(e,t=!0,r=!0,i=!1){this.layout.ScrollTo(e,t,r,i)}ScrollIntoView(e,t=!1){this.options.scrollbars&&this.layout.ScrollIntoView(e,t)}GetScrollOffset(){return this.layout.GetScrollOffset()}ScrollOffset(e){if(e)this.layout.scroll_offset=e;else return this.layout.scroll_offset}RenameSheetInternal(e,t){super.RenameSheetInternal(e,t),this.tab_bar?.Update()}StyleDefaultFromTheme(){this.model.theme_style_properties.font_face=this.theme.grid_cell?.font_face||"",this.model.theme_style_properties.font_size=this.theme.grid_cell?.font_size||{unit:"pt",value:10}}AutoSizeRow(e,t,r=!0){if(!this.tile_renderer)return;let i=e.GetRowHeight(t),n=0,o=6;for(let s=0;s<e.cells.columns;s++){let a=e.CellData({row:t,column:s}),{height:c}=this.tile_renderer.MeasureText(a,e.GetColumnWidth(s),1);n=Math.max(n,c+o)}r||(n=Math.max(i,n)),n>o+2&&e.SetRowHeight(t,n)}AutoSizeColumn(e,t,r=!0){if(!this.tile_renderer)return;let i=e.GetColumnWidth(t),n=0,o=14;for(let s=0;s<e.cells.rows;s++){let a=e.CellData({row:s,column:t}),{width:c}=this.tile_renderer.MeasureText(a,i,1);n=Math.max(n,c+o)}r||(n=Math.max(i,n)),n>o+2&&e.SetColumnWidth(t,n)}EnsureActiveSheet(e=!1){for(let t of this.model.sheets.list)if(t===this.active_sheet){e&&this.ActivateSheetInternal({key:22,id:t.id,force:!0});return}this.ActivateSheetInternal({key:22,index:0})}RefreshAnnotations(){this.RemoveAnnotationNodes();for(let e of this.active_sheet.annotations)this.AddAnnotation(e,!0,!0)}ActivateSheetInternal(e){let t=this.SelectingArgument(),r=this.ResolveSheet(e)||this.model.sheets.list[0];if(this.active_sheet===r&&!e.force)return;if(!r.visible)throw new Error("cannot activate hidden sheet");this.HideHoverInfo(),this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;let i=this.active_sheet;this.RemoveAnnotationNodes(),this.active_sheet=r,t?this.RenderSelections():(this.ClearSelection(this.primary_selection),r.selection&&!r.selection.empty&&this.Select(this.primary_selection,new y(r.selection.area.start,r.selection.area.end),r.selection.target));let n=this.active_sheet.annotations;for(let o of n)this.AddAnnotation(o,!0);this.ActivateSheetTasks(),this.QueueLayoutUpdate(),this.pending_layout_update.has(this.active_sheet.id)?(this.Repaint(!0,!0),this.pending_layout_update.delete(this.active_sheet.id)):this.Repaint(!1,!1),this.grid_events.Publish({type:"sheet-change",deactivate:i,activate:this.active_sheet}),this.tab_bar&&this.tab_bar.Update(),this.layout.scroll_offset=this.active_sheet.scroll_offset,this.formula_bar?.selecting&&requestAnimationFrame(()=>this.formula_bar?.FocusEditor())}ActivateSheetTasks(){if(this.active_sheet.Activate(this.DOM),this.active_sheet.image&&!this.active_sheet.image.complete){let e=this.active_sheet.image,t=0,r=()=>{e.complete?this.UpdateLayout():t++<5&&setTimeout(()=>r(),10)};r()}}HighlightFreezeArea(){for(let e of[this.layout.corner_selection,this.layout.row_header_selection,this.layout.column_header_selection])e.classList.add("highlight-area"),setTimeout(()=>{e.classList.remove("highlight-area")},400)}QueueLayoutUpdate(e){this.tile_update_pending=!0,e&&(this.scroll_offset_pending=e)}HandleAddressLabelEvent(e){if(e){let t=(o="")=>{let s=o.toLowerCase();for(let a of this.model.sheets.list)if(a.name.toLowerCase()===s)return a.id;return this.active_sheet.id},r=o=>{for(let s of this.model.sheets.list)if(s.id===o)return s;return this.active_sheet},i,n=this.parser.Parse(e);if(n.expression)switch(n.expression.type){case"address":n.expression.sheet_id=t(n.expression.sheet),i=new y(n.expression);break;case"range":n.expression.start.sheet_id=t(n.expression.start.sheet),i=new y(n.expression.start,n.expression.end);break;case"identifier":{let o=this.model.GetName(n.expression.name,this.active_sheet.id);o?.type==="range"&&(i=o.area),i||this.primary_selection.empty||this.SetName(n.expression.name.toUpperCase(),this.primary_selection.area)}break;default:break}if(i){let o=r(i.start.sheet_id);if(o.columns>=i.end.column&&o.rows>=i.end.row){this.ExecCommand({key:5,area:i});return}else console.warn("address out of range")}}this.UpdateAddressLabel(),this.Focus()}InitFormulaBar(e,t){this.formula_bar=new Ot(e,this.model,this.view,this.options,t),this.formula_bar.autocomplete_matcher=this.autocomplete_matcher,this.formula_bar.Subscribe(r=>{switch(r.type){case"address-label-event":this.HandleAddressLabelEvent(r.text);break;case"stop-editing":this.pending_reset_selection&&this.ShowGridSelection(),this.pending_reset_selection=!1,this.editing_state=0;break;case"start-editing":this.editing_state=2,this.editing_cell={...this.primary_selection.target},this.editing_selection={...this.primary_selection};break;case"toll":this.editing_state=0,this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.DelayedRender();break;case"discard":if(this.editing_state=0,this.editing_annotation){this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection);let i=this.editing_annotation.view[this.view_index]?.node;i&&i.focus(),this.editing_annotation=void 0,this.UpdateFormulaBarFormula(),this.DelayedRender();return}this.container&&this.Focus(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.UpdateFormulaBarFormula(),this.DelayedRender();break;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=0,this.editing_annotation){let i=this.editing_annotation;if(this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),i.data.formula=r.value?this.FixFormula(r.value):"",!this.pending_reset_selection){let n=this.editing_annotation.view[this.view_index]?.node;n&&n.focus()}this.grid_events.Publish({type:"annotation",event:"update",annotation:i}),this.editing_annotation=void 0,this.DelayedRender();return}this.container&&this.Focus(),r.event?this.SetInferredType(this.primary_selection,r.value,r.array):this.editing_selection&&this.SetInferredType(this.editing_selection,r.value,r.array),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.primary_selection.area),r.event&&this.OverlayKeyDown(r.event);break;case"update":r.dependencies&&this.HighlightDependencies(r.dependencies);break}})}InitOverlayEditor(e){this.container&&(this.overlay_editor=new Pt(this.container,this.theme,this.model,this.view,e),this.overlay_editor.UpdateScale(this.layout.scale),this.overlay_editor.autocomplete_matcher=this.autocomplete_matcher,this.overlay_editor.Subscribe(t=>{switch(t.type){case"stop-editing":this.editing_state=0;break;case"start-editing":this.editing_state=1,this.editing_cell={...this.primary_selection.target};break;case"update":t.dependencies&&this.HighlightDependencies(t.dependencies);break;case"end-selection":case"reset-selection":this.ClearSelection(this.active_selection),this.overlay_editor?.target_address?.sheet_id&&this.active_sheet.id!==this.overlay_editor.target_address.sheet_id&&this.ActivateSheetID(this.overlay_editor.target_address.sheet_id),this.DelayedRender();break}}))}DelayedRender(e=!1,t,r=!1){!this.tile_update_pending&&t?this.layout.DirtyArea(t):!this.tile_update_pending&&e&&this.layout.DirtyAll(),this.render_token||(this.render_token=1,Promise.resolve().then(()=>{this.render_token=0,this.Repaint(e,r)}))}Repaint(e=!1,t=!1,r=!1){if(this.headless||!this.tile_renderer)return;if(this.tile_update_pending&&(this.tile_update_pending=!1,this.layout.UpdateTiles(),this.scroll_offset_pending&&(this.layout.scroll_offset=this.scroll_offset_pending,this.scroll_offset_pending=void 0),this.render_tiles=this.layout.VisibleTiles(),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)),this.layout_token=0,this.tile_renderer.OverflowDirty(t),e)for(let a of this.layout.grid_tiles)for(let c of a)c.dirty=!0;let i=this.render_tiles.start,n=this.render_tiles.end,o=[];for(let a=i.row;a<=n.row;a++)o.push(a);let s=[];for(let a=i.column;a<=n.column;a++)s.push(a);i.row>0&&this.active_sheet.freeze.rows&&o.push(0),i.column>0&&this.active_sheet.freeze.columns&&s.push(0);for(let a of s)for(let c of o){let d=this.layout.grid_tiles[a][c];(e||d.dirty||d.needs_full_repaint)&&(this.tile_renderer.Render(d),d.dirty=d.needs_full_repaint=!1)}this.tile_renderer.RenderHeaders(this.render_tiles,r),this.tile_renderer.RenderCorner(),this.RenderSelections()}MouseMove_RowHeader(e){let t=this.layout.CoordinateToRowHeader(e.offsetY),r=this.layout.OffsetCellAddressToRectangle({row:t.row,column:0});this.hover_data.address&&(this.hover_data.address.row!==-1||this.hover_data.address.column!==-1)&&this.HoverCell({row:-1,column:-1});let i=-1;e.offsetY-r.top<=this.RESIZE_PIXEL_BUFFER&&t.row>0?i=t.row-1:r.bottom-e.offsetY<=this.RESIZE_PIXEL_BUFFER&&(i=t.row),i>=0?this.layout.ResizeCursor("row"):this.cell_resize.row&&(this.cell_resize.row=-1,this.layout.ResizeCursor()),this.cell_resize.row=i}MouseMove_ColumnHeader(e){let t=this.layout.CoordinateToColumnHeader(e.offsetX),r=this.layout.OffsetCellAddressToRectangle({row:0,column:t.column});this.hover_data.address&&(this.hover_data.address.row!==-1||this.hover_data.address.column!==-1)&&this.HoverCell({row:-1,column:-1});let i=-1;e.offsetX-r.left<=this.RESIZE_PIXEL_BUFFER&&t.column>0?i=t.column-1:r.right-e.offsetX<=this.RESIZE_PIXEL_BUFFER&&(i=t.column),i>=0?this.layout.ResizeCursor("column"):this.cell_resize.column&&(this.cell_resize.column=-1,this.layout.ResizeCursor()),this.cell_resize.column=i}MouseDown_RowHeader(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToRowHeader(e.offsetY),r=this.layout.row_header_cover.getBoundingClientRect(),i={x:r.left,y:r.top};if(this.cell_resize.row>=0){let n=this.cell_resize.row,o=i.y+e.offsetY;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:n,column:-1})){let m=[n];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(n)){let f=this.active_sheet.RealArea(this.primary_selection.area);m=[];for(let p=f.start.row;p<=f.end.row;p++)m.push(p)}this.ExecCommand({key:3,row:m});return}let s=this.layout.RowHeight(n),a=s,c=this.layout.OffsetCellAddressToRectangle({row:n,column:0}),d=i.y+c.bottom;this.layout.ShowTooltip({left:!0,text:`${a}px`,x:Math.round(r.right+10),y:d});let u=[],h=[];for(let m of this.active_sheet.annotations){let f=c.bottom-1;if(!m.scaled_rect||m.scaled_rect.bottom<f)continue;let p=[...this.layout.GetFrozenAnnotations(m)],b=m.view[this.view_index]?.node;b&&p.push(b),f<=m.scaled_rect.top&&m.data.move_with_cells?u.push({annotation:m,y:m.scaled_rect.top,nodes:p}):f>m.scaled_rect.top&&m.data.resize_with_cells&&h.push({annotation:m,height:m.scaled_rect.height,nodes:p})}Se(this.layout.mask,"row-resize",m=>{let f=Math.max(-s,Math.round(m.offsetY-o));if(f+s!==a){a=f+s,this.layout.SetRowHeight(n,a),this.layout.UpdateTooltip({text:`${a}px`,y:d+f});for(let{annotation:p,y:b}of u)p.scaled_rect&&(p.scaled_rect.top=b+f);for(let{annotation:p,height:b}of h)p.scaled_rect&&(p.scaled_rect.height=b+f);requestAnimationFrame(()=>{for(let{annotation:p,nodes:b}of h)if(p.scaled_rect)for(let g of b)p.scaled_rect.ApplyStyle(g);for(let{annotation:p,nodes:b}of u)if(p.scaled_rect)for(let g of b)p.scaled_rect.ApplyStyle(g);this.layout.UpdateTileHeights(!0,n),this.Repaint(!1,!0),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)})}},()=>{this.layout.HideTooltip(),requestAnimationFrame(()=>{let m=[n];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(n)){let f=this.active_sheet.RealArea(this.primary_selection.area);m=[];for(let p=f.start.row;p<=f.end.row;p++)m.push(p)}this.layout.SetRowHeight(n,s),this.ExecCommand({key:3,row:m,height:a/this.scale});for(let{annotation:f}of u)f.scaled_rect&&(f.data.layout=this.layout.RectToAnnotationLayout(f.scaled_rect));for(let{annotation:f}of h){f.scaled_rect&&(f.data.layout=this.layout.RectToAnnotationLayout(f.scaled_rect));let p=f.view[this.view_index];p&&p.resize_callback&&p.resize_callback.call(void 0)}})})}else{let n=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(void 0,!0),e.shiftKey&&!n.empty){let o=n.target;this.Select(n,new y(n.target,t,!0),void 0,!0),t=o}else this.Select(n,new y(t),{column:0,row:t.row});this.RenderSelections(),Se(this.layout.mask,[],o=>{let s=this.layout.CoordinateToRowHeader(o.offsetY-i.y),a=new y(s,t,!0);(n.empty||!a.Equals(n.area))&&(this.Select(n,a,void 0,!0),this.RenderSelections())},()=>{})}}MouseDown_ColumnHeader(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToColumnHeader(e.offsetX),r=this.layout.column_header_cover.getBoundingClientRect(),i={x:r.left,y:r.top};if(this.cell_resize.column>=0){let n=this.cell_resize.column,o=i.x+e.offsetX;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:-1,column:n})){let m=[n];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(n)){let f=this.active_sheet.RealArea(this.primary_selection.area);m=[];for(let p=f.start.column;p<=f.end.column;p++)m.push(p)}this.ExecCommand({key:4,column:m});return}let s=this.layout.ColumnWidth(n),a=s,c=this.layout.OffsetCellAddressToRectangle({row:0,column:n}),d=i.x+c.right;this.layout.ShowTooltip({up:!0,text:`${a}px`,x:d,y:Math.round(r.bottom+10)});let u=[],h=[];for(let m of this.active_sheet.annotations){let f=c.right-1;if(!m.scaled_rect||m.scaled_rect.right<f)continue;let p=[...this.layout.GetFrozenAnnotations(m)],b=m.view[this.view_index]?.node;b&&p.push(b),f<=m.scaled_rect.left&&m.data.move_with_cells?u.push({annotation:m,x:m.scaled_rect.left,nodes:p}):f>m.scaled_rect.left&&m.data.resize_with_cells&&h.push({annotation:m,width:m.scaled_rect.width,nodes:p})}Se(this.layout.mask,"column-resize",m=>{let f=Math.max(-s,Math.round(m.offsetX-o));if(f+s!==a){a=f+s,this.layout.UpdateTooltip({text:`${a}px`,x:d+f}),this.layout.SetColumnWidth(n,a);for(let{annotation:p,x:b}of u)p.scaled_rect&&(p.scaled_rect.left=b+f);for(let{annotation:p,width:b}of h)p.scaled_rect&&(p.scaled_rect.width=b+f);requestAnimationFrame(()=>{for(let{annotation:p,nodes:b}of h)if(p.scaled_rect)for(let g of b)p.scaled_rect.ApplyStyle(g);for(let{annotation:p,nodes:b}of u)if(p.scaled_rect)for(let g of b)p.scaled_rect.ApplyStyle(g);this.layout.UpdateTileWidths(!0,n),this.Repaint(!1,!0)})}},()=>{this.layout.HideTooltip(),requestAnimationFrame(()=>{let m=[n];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(n)){let f=this.active_sheet.RealArea(this.primary_selection.area);for(let p=f.start.column;p<=f.end.column;p++)m.push(p)}this.ExecCommand({key:4,column:m,width:a});for(let{annotation:f}of u)f.scaled_rect&&(f.data.layout=this.layout.RectToAnnotationLayout(f.scaled_rect));for(let{annotation:f}of h){f.scaled_rect&&(f.data.layout=this.layout.RectToAnnotationLayout(f.scaled_rect));let p=f.view[this.view_index];p&&p.resize_callback&&p.resize_callback.call(void 0)}})})}else{let n=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(void 0,!0),e.shiftKey&&!n.empty){let o=n.target;this.Select(n,new y(n.target,t,!0),void 0,!0),t=o}else this.Select(n,new y(t),{row:0,column:t.column});this.RenderSelections(),Se(this.layout.mask,[],o=>{let s=this.layout.CoordinateToColumnHeader(o.offsetX-i.x),a=new y(s,t,!0);(n.empty||!a.Equals(n.area))&&(this.Select(n,a,void 0,!0),this.RenderSelections())})}}HoverCell(e,t){let r=this.active_sheet.cells.GetCell(e,!1);if(r?.table&&r.table.area.start.row===e.row&&r.table.sortable!==!1?(this.hover_data.table_header=!0,this.layout.ShowTableSortButton(r.table,e.column-r.table.area.start.column,e)):(this.hover_data.table_header&&this.layout.HideTableSortButton(),this.hover_data.table_header=!1),r?.merge_area){let i=r.merge_area;e=i.start,r=this.active_sheet.cells.GetCell(e,!1),e={row:i.start.row,column:i.end.column}}if(r?.note){let i=Ie.instance.Parse(r.note),n=this.options.comment_markdown?Ie.instance.HTML(i,{br:!1}):void 0;this.layout.ShowNote(r.note,e,t,n),this.hover_data.note=!0}else this.hover_data.note&&(this.layout.HideNote(),this.hover_data.note=!1);r?.hyperlink?(this.layout.ShowTitle("Link: "+r.hyperlink,e),this.hover_data.link=!0,this.hover_data.cell=r):this.hover_data.link&&(this.layout.HideTitle(),this.hover_data.cell=void 0),this.hover_data.address={...e}}HideHoverInfo(){this.layout.HideTitle(),this.layout.HideTooltip(),this.hover_data.note=this.hover_data.link=!1,this.hover_data.cell=void 0,this.hover_data.pointer&&this.layout.grid_cover.classList.remove("link-pointer"),this.hover_data.pointer=!1}MouseMove_Grid(e){if(e.stopPropagation(),e.preventDefault(),!this.selection_renderer)return;(this.cell_resize.row>=0||this.cell_resize.column>=0)&&this.layout.ResizeCursor();let t={x:e.offsetX,y:e.offsetY},r;if(this.overlay_editor?.editing||(r=this.layout.PointToAddress_Grid(t),(!this.hover_data.address||this.hover_data.address.row!==r.row||this.hover_data.address.column!==r.column)&&this.HoverCell(r,e)),this.hover_data.link&&r&&(this.hover_data.point=t,this.hover_data.handler||(this.hover_data.handler=requestAnimationFrame(()=>{let n=this.hover_data.address&&this.hover_data.point&&this.hover_data.cell&&this.PointInTextPart(this.hover_data.address,this.hover_data.point,this.hover_data.cell);n!==!!this.hover_data.pointer&&(this.hover_data.pointer=n,n?this.layout.grid_cover.classList.add("link-pointer"):this.layout.grid_cover.classList.remove("link-pointer")),this.hover_data.handler=void 0}))),this.primary_selection.empty||!this.selection_renderer.nub_rectangle){this.nub_select_flag&&(this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=!1);return}let i=this.selection_renderer.nub_rectangle.Contains(e.offsetX,e.offsetY);i!==this.nub_select_flag&&(i?this.layout.grid_cover.classList.add("nub-select"):this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=i)}ClearDoubleClick(){this.double_click_data.address=void 0}IsDoubleClick(e,t=300){if(this.double_click_data.address&&this.double_click_data.address.row===e.row&&this.double_click_data.address.column===e.column)return clearTimeout(this.double_click_data.timeout),this.double_click_data.address=void 0,this.double_click_data.timeout=void 0,!0;this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.address={...e},this.double_click_data.timeout=window.setTimeout(()=>{this.double_click_data.address=void 0,this.double_click_data.timeout=void 0},t)}PointInTextPart(e,t,r){let i=this.layout.CellAddressToRectangle(e);r.merge_area&&(i=i.Combine(this.layout.CellAddressToRectangle(r.merge_area.end)));let n=t.x-i.left,o=t.y-i.top,s=r.renderer_data?.text_data?.strings||[];for(let a of s)for(let c of a)if(typeof c.left=="number"&&typeof c.top=="number"&&typeof c.width=="number"&&typeof c.height=="number"&&n>=c.left&&o>=c.top&&n<=c.left+c.width&&o<=c.top+c.height)return!0;return!1}MouseDown_Grid(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.SelectingArgument();if(!t&&this.additional_selections.length&&this.ClearAdditionalSelections(),(!t||!this.formula_bar?.selecting&&!this.external_editor?.selecting)&&this.Focus(void 0,!0),this.overlay_editor?.editing&&!this.overlay_editor?.selecting){if(this.overlay_editor?.selection){let u=this.overlay_editor?.edit_node.textContent||void 0;this.SetInferredType(this.overlay_editor.selection,u,!1)}this.DismissEditor()}let r={x:e.offsetX,y:e.offsetY},i=this.layout.PointToAddress_Grid(r),n=t?this.active_selection:this.primary_selection;if(!t&&this.IsDoubleClick(i)){q.is_mobile&&this.overlay_editor?.edit_node?.focus(),this.OverlayEditCell({target:i,area:new y(i)},!1);return}let o=this.layout.grid_cover.getBoundingClientRect(),s={x:o.left,y:o.top},a=[],c;if(e.shiftKey&&!n.empty){let u=n.target;this.Select(n,new y(i,n.target,!0),void 0,!0),i=u}else if(this.nub_select_flag)i=n.area.TopLeft(),a.push("nub-select"),c=this.active_sheet.RealArea(n.area);else{let u=i,h=this.active_sheet.CellData(u);if(h.merge_area&&(u=h.merge_area.start,h=this.active_sheet.CellData(h.merge_area.start)),h.hyperlink&&this.PointInTextPart(u,r,h)){let m=h.hyperlink;Promise.resolve().then(()=>{this.grid_events.Publish({type:"cell-event",data:{type:"hyperlink",reference:m}})}),this.ClearDoubleClick();return}if(h.click_function){let m=this.layout.CellAddressToRectangle(u);h.merge_area&&(m=m.Combine(this.layout.CellAddressToRectangle(h.merge_area.end)));let f=h.click_function.call(this,{cell:h,x:r.x-m.left,y:r.y-m.top,width:m.width,height:m.height,scale:this.layout.scale});if(f.value&&this.ExecCommand({key:6,value:f.value,area:u}),f.block_selection){this.ClearDoubleClick(),!this.primary_selection.empty&&this.primary_selection.target.row===u.row&&this.primary_selection.target.column===u.column&&this.UpdateFormulaBarFormula();return}}this.Select(n,new y(i),i)}this.RenderSelections(),t&&this.UpdateSelectedArgument(n);let d=this.layout.CellAddressToRectangle({row:0,column:0}).Combine(this.layout.CellAddressToRectangle({row:this.active_sheet.rows-1,column:this.active_sheet.columns-1})).Expand(-1,-1);Se(this.layout.mask,a,u=>{let h={x:u.offsetX-s.x,y:u.offsetY-s.y},m=d.Clamp(h.x,h.y),f=this.layout.PointToAddress_Grid(m),p=this.layout.scroll_reference_node,b=!1;this.container&&this.options.scrollbars&&(h.x<p.scrollLeft?(p.scrollLeft-=25,b=!0):h.x>p.scrollLeft+this.container.clientWidth&&(p.scrollLeft+=25,b=!0),h.y<p.scrollTop?(p.scrollTop-=25,b=!0):h.y>p.scrollTop+this.container.clientHeight&&(p.scrollTop+=25,b=!0),b&&(o=this.layout.grid_cover.getBoundingClientRect(),s.x=o.left+document.body.scrollLeft,s.y=o.top+document.body.scrollTop));let g=new y(f,i,!0);if(c&&(g=c.Clone(),g.ConsumeAddress(f),g.rows!==c.rows&&g.columns!==c.columns)){let x={rows:f.row>c.end.row?f.row-c.end.row:c.start.row-f.row,columns:f.column>c.end.column?f.column-c.end.column:c.start.column-f.column};x.rows>=x.columns?g=new y({row:g.start.row,column:c.start.column},{row:g.end.row,column:c.end.column}):g=new y({row:c.start.row,column:g.start.column},{row:c.end.row,column:g.end.column})}(n.empty||!g.Equals(n.area))&&(this.Select(n,g,void 0,!0),this.RenderSelections(),t?this.UpdateSelectedArgument(n):!n.empty&&!n.area.entire_sheet&&(n.area.entire_column?this.UpdateAddressLabel(void 0,n.area.columns+"C"):n.area.entire_row?this.UpdateAddressLabel(void 0,n.area.rows+"R"):n.area.count>1?this.UpdateAddressLabel(void 0,n.area.rows+"R x "+n.area.columns+"C"):this.UpdateAddressLabel(n)))},()=>{this.UpdateAddressLabel(),t?this.overlay_editor?.editing||(this.external_editor_config?(this.external_editor?.active&&this.external_editor.FocusEditor(),this.external_editor_config.update):this.formula_bar&&this.formula_bar.FocusEditor()):c&&this.RecycleNubArea(n.area,c)})}Transpose(e){let t=[],r=e.length,i=e[0].length;for(let n=0;n<i;n++){t[n]=[];for(let o=0;o<r;o++)t[n][o]=e[o][n]}return t}RecycleNubArea(e,t){if(e.Equals(t))return;let r=[];for(let u=0;u<t.rows;u++){r[u]=[];for(let h=0;h<t.columns;h++){let m={row:t.start.row+u,column:t.start.column+h};r[u][h]=this.active_sheet.CellData(m)}}if(r[0][0].area&&r[0][0].area.Equals(t)){this.ExecCommand({key:6,value:r[0][0].value,array:!0,area:e});return}if(r[0][0].table&&t.Equals(new y(r[0][0].table.area.start,r[0][0].table.area.end))){let u=r[0][0].table,h=u.sortable,m=u.totals_row,f=u.theme;this.ExecCommand([{key:30,table:u},{key:29,area:e,sortable:h,totals:m,theme:f}]);return}let i=[],n=[],o=t.columns,s=e.rows,a=!1,c=!1;e.columns===t.columns?a=e.start.row<t.start.row:(o=t.rows,s=e.columns,a=e.start.column<t.start.column,r=this.Transpose(r),c=!0);for(let u=0;u<s;u++)i[u]=[],n[u]=[];for(let u=0;u<o;u++){let h=0;if(r.length>1){h=1;let m=[],f=[];for(let p=0;p<r.length;p++){let b=r[p][u];b.ValueIsNumber()&&(f.push(p),m.push(b.value))}if(m.length>1){let p=m.slice(1).map((b,g)=>b-m[g]);p.every(b=>b===p[0])&&(h=p[0])}m.length&&(h+=m[m.length-1]-m[0])}for(let m=0;m<r.length;m++){let f,p=r[m][u];if(p.ValueIsFormula()){let _=this.parser.Parse(p.value);_.expression&&_.full_reference_list?.length&&(f=_.expression)}let b=0,g=m,x=r.length,v=0,w=h;a&&(g=s-r.length+m,x=-r.length,w=-h);for(let _=g;_>=0&&_<s;_+=x,b+=x,v+=w){let C={offset:c?{rows:0,columns:b}:{rows:b,columns:0}};if(f)i[_][u]="="+this.parser.Render(f,C);else{let S=r[m][u];S.ValueIsNumber()?i[_][u]=S.value+v:i[_][u]=S.value}n[_][u]=r[m][u].style||{}}}}let d=[{key:6,value:c?this.Transpose(i):i,array:!1,area:e}];c&&(n=this.Transpose(n));for(let u=0;u<n.length;u++)for(let h=0;h<n[u].length;h++)d.push({key:7,area:{row:u+e.start.row,column:h+e.start.column},style:n[u][h],delta:!1});this.ExecCommand(d)}UpdateSelectedArgument(e){let t=this.active_sheet.CellData(e.area.start),r=new y(t.merge_area?t.merge_area.start:e.target),i=this.model.named.MatchSelection(e.area,r);if(!i&&(i=e.area.spreadsheet_label,t.merge_area&&t.merge_area.Equals(e.area)&&(i=y.CellAddressToLabel(t.merge_area.start)),this.external_editor_config||this.active_sheet.id!==this.editing_cell.sheet_id)){let n=this.active_sheet.name;xe.test(n)?i=`'${n}'!${i}`:i=`${n}!${i}`}if(this.overlay_editor?.editing&&this.overlay_editor.selecting)this.overlay_editor.InsertReference(i);else if(this.formula_bar&&this.formula_bar.selecting)this.formula_bar.InsertReference(i);else if(this.external_editor_config&&(this.external_editor?.active&&(this.external_editor.FocusEditor(),this.external_editor.InsertReference(i)),this.external_editor_config.update)){let n=this.external_editor_config.update.call(0,i);n&&Array.isArray(n)&&this.HighlightDependencies(n.filter(o=>!!o).map(o=>N(o)?new y(o):new y(o.start,o.end)))}}SelectingArgument(){return this.overlay_editor?.editing&&this.overlay_editor?.selecting||this.formula_bar&&this.formula_bar.selecting||!!this.external_editor_config}ReleaseOverlayEditor(){this.editing_state=0,this.DismissEditor(),this.DelayedRender()}RestoreOverlayEditor(){this.overlay_editor?.FocusEditor()}OverlayKeyDown(e){let t=!1;if(this.overlay_editor&&this.overlay_editor.editing)switch(t=!0,this.overlay_editor.HandleKeyDown(e)){case"handled":return;case"discard":this.editing_state=0,this.DismissEditor(),this.DelayedRender();return;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=0,this.overlay_editor?.selection){let c=this.overlay_editor?.edit_node.textContent||void 0,d=e.key==="Enter"&&(e.ctrlKey||q.is_mac&&e.metaKey)&&e.shiftKey;this.SetInferredType(this.overlay_editor.selection,c,d,void 0,this.overlay_editor.edit_style)}this.DismissEditor(),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.overlay_editor?.selection.area||void 0);break}let r=this.SelectingArgument();if(this.formula_bar&&this.formula_bar.focused&&!r||this.selected_annotation&&!r)return;let i=r?this.active_selection:this.primary_selection,n={rows:0,columns:0},o=!1,s=!1;if(e.ctrlKey||q.is_mac&&e.metaKey){switch(e.key){case"ArrowDown":case"Down":n.rows++;break;case"ArrowUp":case"Up":n.rows--;break;case"ArrowLeft":case"Left":n.columns--;break;case"ArrowRight":case"Right":n.columns++;break;case"Backspace":e.metaKey&&q.is_mac&&(i.empty||this.DeleteSelection(i));break;case"Delete":case"Del":{e.stopPropagation(),e.preventDefault();for(let a=0;a<this.model.sheets.length;a++)if(this.model.sheets.list[a]===this.active_sheet){this.DeleteSheet(a);break}return}break;case"/":e.stopPropagation(),e.preventDefault(),this.SelectArrayOrTable();break;default:if(e.shiftKey)return}if(n.columns||n.rows)if(e.stopPropagation(),e.preventDefault(),!i.empty&&(n.columns||n.rows)){if(this.BlockSelection(i,!!e.shiftKey,n.columns,n.rows))return}else return;else{let a={},c=this.primary_selection.empty?{}:this.active_sheet.CellData(this.primary_selection.target).style||{};switch(e.key.toLowerCase()){case"b":a.bold=!c.bold;break;case"i":a.italic=!c.italic;break;case"u":a.underline=!c.underline;break;case"a":this.SelectAll();break;case"0":if(!e.altKey)return;this.ClearSelection(this.primary_selection),this.RenderSelections();break;default:e.key;return}Object.keys(a).length&&this.ApplyStyle(void 0,a)}}else{if(/^F\d+$/.test(e.key))return;switch(e.key){case"Tab":e.shiftKey?n.columns--:n.columns++,o=!0;break;case"Enter":e.shiftKey?n.rows--:n.rows++,o=!0;break;case"ArrowDown":case"Down":n.rows++,s=e.shiftKey;break;case"ArrowUp":case"Up":n.rows--,s=e.shiftKey;break;case"ArrowLeft":case"Left":n.columns--,s=e.shiftKey;break;case"ArrowRight":case"Right":n.columns++,s=e.shiftKey;break;case"Delete":case"Del":i.empty||this.DeleteSelection(i);break;case"PageUp":case"PageDown":if(e.shiftKey){this.NextSheet(e.key==="PageUp"?-1:1);break}return;case"Control":case"Shift":case"Alt":return;default:i.empty||e.key!=="Escape"&&this.OverlayEditCell(i,!0,e);return}}e.stopPropagation(),e.preventDefault(),(n.rows||n.columns)&&this.AdvanceSelection(n,i,o,s,!t)}SelectArrayOrTable(){if(this.primary_selection.empty)return;let e=this.active_sheet.CellData(this.primary_selection.target);if(!(!e||!e.area&&!e.table&&!e.spill)){if(e.area&&this.Select(this.primary_selection,e.area,e.area.start),e.spill&&this.Select(this.primary_selection,e.spill,e.spill.start),e.table){let t=new y(e.table.area.start,e.table.area.end);this.Select(this.primary_selection,t,t.start)}this.RenderSelections()}}RenderSelections(e=!0){let t=this.hide_selection?!1:!this.editing_state||this.editing_cell.sheet_id===this.active_sheet.id,r=this.primary_selection.empty?void 0:this.active_sheet.CellData(this.primary_selection.target);this.layout.ShowSpillBorder(r?.spill),this.selection_renderer?.RenderSelections(t,e)}BlockSelection(e,t,r,i,n=!0){if(e.empty)return!1;let o={...e.target};i>0?o.row=Math.max(o.row,e.area.end.row):i<0&&(o.row=Math.min(o.row,e.area.start.row)),r>0?o.column=Math.max(o.column,e.area.end.column):r<0&&(o.column=Math.min(o.column,e.area.start.column));let s=this.active_sheet.cells,a=s.GetCell(e.target,!1);if(!a||a.type===0&&!a.area&&!a.spill)return!1;let c={...o};for(;;){let d={row:c.row+i,column:c.column+r};if(d.column<0||d.row<0||d.column>=this.active_sheet.columns||d.row>=this.active_sheet.rows)break;let u=!1;if(i)for(let h=e.area.start.column;!u&&h<=e.area.end.column;h++)a=s.GetCell({row:d.row,column:h},!1),u=u||!!a&&(a.type!==0||!!a.area||!!a.spill),!u&&a&&a.merge_area&&(a=s.GetCell(a.merge_area.start,!1),u=u||!!a&&(a.type!==0||!!a.area||!!a.spill));else for(let h=e.area.start.row;!u&&h<=e.area.end.row;h++)a=s.GetCell({row:h,column:d.column},!1),u=u||!!a&&(a.type!==0||!!a.area||!!a.spill),!u&&a&&a.merge_area&&(a=s.GetCell(a.merge_area.start,!1),u=u||!!a&&(a.type!==0||!!a.area||!!a.spill));if(!u)break;c=d}if(t){i?(o.row=e.target.row,o.column=e.area.start.column,c.column=e.area.end.column):(o.column=e.target.column,o.row=e.area.start.row,c.row=e.area.end.row);let d=new y(o,c,!0);this.Select(e,d,e.target,!0)}else this.Select(e,new y(c));return this.ScrollIntoView(c),this.SelectingArgument()&&this.UpdateSelectedArgument(e),n&&this.DelayedRender(),!0}DeleteSelection(e){if(e.empty)return;let t=this.active_sheet.RealArea(e.area);this.ExecCommand({key:12,area:t})}SetInferredType(e,t,r=!1,i=!0,n){let o=e.target||e.area.start,s=this.active_sheet.CellData(o);if(s.area){if(!r&&s.area.count>1||!e.area||!e.area.Equals(s.area)){this.Error(2);return}}else if(r){for(let m of this.active_sheet.cells.Iterate(e.area,!1))if(m.area){this.Error(2);return}}let a=this.active_sheet.GetValidation(o)[0];if(a&&a.error){let m;if(a.type==="list"?m=a.list:a.type==="range"&&(m=this.GetValidationRange(a.area)),m&&m.length){let f=!1;if(t){let p=t.toUpperCase();for(let b of m)if(b&&b.toString().toUpperCase()===p){t=b.toString(),f=!0;break}}if(!f){this.Error(3);return}}}s.merge_area&&(o=s.merge_area.start);let c=[];n&&c.push({key:7,style:n,delta:!0,area:r?e.area:e.target});let d=typeof t=="string"&&t.trim()[0]==="=";if(d&&(t=this.FixFormula(t||""),!this.active_sheet.HasCellStyle(o))){let m=this.parser.Parse(t);if(m){if(m.expression?.type==="call"&&(!s.style||!s.style.number_format||L.Equals(s.style.number_format,"General"))){let f=m.expression.name.toLowerCase(),p;switch(f){case"today":p="Short Date";break;case"now":p="Timestamp";break}p&&c.push({key:7,area:r?e.area:o,style:{number_format:p},delta:!0})}if(m.dependencies){let f,p=m.dependencies;for(let b of Object.keys(p.addresses)){let g=p.addresses[b];if(this.active_sheet.HasCellStyle({...g})){let x=this.active_sheet.CellData({...g});if(x.style&&x.style.number_format&&(!f||/%/.test(f))&&(f=L.Translate(x.style.number_format),!/%/.test(f)))break}}if(f){let b={number_format:L.SymbolicName(f)||f};c.push({key:7,area:r?e.area:o,style:b,delta:!0})}}}}let u=this.parser.Parse(t||"").expression;u?.type==="group"&&u.elements.length===1&&u.elements[0].type==="complex"&&(u=u.elements[0]);let h;if(u?.type==="complex"?h={type:7,value:{real:u.real,imaginary:u.imaginary}}:u?.type==="literal"&&typeof u.value=="boolean"?h={type:4,value:u.value}:h=ge.TryParse(t),!d&&h.type===3){let m="",f=h.hints||{};(!s.style||!s.style.number_format||L.Equals(s.style.number_format,"General"))&&(f.Date?m="Short Date":f.Exponential?m="Exponential":f.Percent?m="Percent":f.Currency?m="Currency":(f.Grouping||f.Parens)&&(m="Accounting")),m&&c.push({key:7,area:r?e.area:o,style:{number_format:m},delta:!0})}if(c.push({key:6,area:r?e.area:o,array:r,value:d?this.model.UntranslateFunction(t||""):h.value}),i)this.ExecCommand(c);else return c}FixFormula(e){if(e.trim()[0]!=="=")return e;e=e.replace(/^\s+/,"");let t=!1,r=!1,i=0,n=!1,o=e.length;for(let s=0;s<o;s++){let a=e[s];if(!n)switch(a){case'"':t?e[s+1]==='"'?s++:t=!1:r||(t=!0);break;case"'":r?r=!1:t||(r=!0);break;case"\\":n=!0;break;case"(":!t&&!r&&i++;break;case")":!t&&!r&&i--;break}}for(t?e+='"':r&&(e+="'");i>0;)e+=")",i--;return e=this.NormalizeFormula(e),e}NormalizeFormula(e){let t=this.parser.Parse(e);return t.error&&console.warn(t.error),t&&t.expression&&(this.parser.Walk(t.expression,r=>{switch(r.type){case"call":r.name=this.autocomplete_matcher.NormalizeIdentifier(r.name)||r.name;break;case"identifier":this.model.GetName(r.name,this.active_sheet.id)?.type==="range"&&(r.name=r.name.toUpperCase());break}return!0}),e="="+this.parser.Render(t.expression,{missing:""})),e}DismissEditor(){this.overlay_editor?.active_cell&&(this.overlay_editor.active_cell.editing=!1,this.overlay_editor.active_cell.render_clean=[],this.DelayedRender(void 0,this.overlay_editor.selection.area)),this.editing_state=0,this.Focus(),this.overlay_editor?.CloseEditor(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection)}NormalizeCellValue(e){let t=e.value;if(e.ValueIsNumber()&&e.style&&e.style.number_format)if(L.Get(e.style.number_format).date_format){let i=Re(e.value),n=i.getUTCHours()||i.getUTCMinutes()||i.getUTCSeconds()?"Timestamp":"Short Date";t=L.Get(n).Format(t)}else if(/(?:%|percent)/i.test(e.style.number_format)){let i=0,n=e.value.toString().match(/\.(.*?)$/);n&&n[1]&&(i=Math.max(0,n[1].length-2)),t=(e.value*100).toFixed(i)+"%",F.decimal_separator===","&&(t=t.replace(/\./,","))}else t&&F.decimal_separator===","&&(t=e.value.toString().replace(/\./,","));else{if(e.ValueIsBoolean())return e.value?this.model.language_model?.boolean_true||"TRUE":this.model.language_model?.boolean_false||"FALSE";e.ValueIsNumber()?t&&F.decimal_separator===","&&(t=e.value.toString().replace(/\./,",")):e.ValueIsComplex()?(e.value.imaginary?e.value.real?t=`${e.value.real.toString()}${e.value.imaginary<0?" - ":" + "}${e.value.imaginary===1||e.value.imaginary===-1?"":Math.abs(e.value.imaginary).toString()}i`:e.value.imaginary===1?t="i":e.value.imaginary===-1?t="-i":t=e.value.imaginary.toString()+"i":t=e.value.real.toString(),F.decimal_separator===","&&(t=t.replace(/\./,","))):e.ValueIsFormula()&&(t=this.model.TranslateFunction(e.value))}return t}IsNumeric(e){return e>=48&&e<=57||e===this.decimal_separator_code||e===45||e===43}OverlayEditCell(e,t=!0,r){if(!this.options.in_cell_editor)return;let i=e.target||e.area.start,n=this.active_sheet.CellData(i),o;if(this.HideHoverInfo(),n.merge_area?(o=this.layout.OffsetCellAddressToRectangle(n.merge_area.start).Combine(this.layout.OffsetCellAddressToRectangle(n.merge_area.end)),i=n.merge_area.start,n=this.active_sheet.CellData(i)):o=this.layout.OffsetCellAddressToRectangle(i),n.style?.locked){console.info("cell is locked for editing");return}o=o.Shift(this.layout.header_size.width,this.layout.header_size.height);let s=n.value,a;typeof s>"u"&&!n.style?.font_face&&(a=this.edit_state),t?(n.type===3||n.rendered_type===3)&&n.style&&n.style.number_format&&/(?:%|percent)/i.test(n.style.number_format)&&(!r||this.IsNumeric(r.key.charCodeAt(0)))?s="%":s=void 0:s=this.NormalizeCellValue(n),this.overlay_editor?.Edit(e,o.Expand(-1,-1),n,s,r,a),n.editing=!0,n.render_clean=[],this.DelayedRender(!1,e.area)}BoundAddressArea(e,t){e.column>t.end.column?(e.row=this.StepVisibleRows(e.row,1),e.row>t.end.row&&(e.row=t.start.row),e.column=t.start.column):e.column<t.start.column?(e.row=this.StepVisibleRows(e.row,-1),e.row<t.start.row&&(e.row=t.end.row),e.column=t.end.column):e.row>t.end.row?(e.column=this.StepVisibleColumns(e.column,1),e.column>t.end.column&&(e.column=t.start.column),e.row=t.start.row):e.row<t.start.row&&(e.column=this.StepVisibleColumns(e.column,-1),e.column<t.start.column&&(e.column=t.end.column),e.row=t.end.row)}StepVisibleRows(e,t){if(t>0)for(let r=0;r<t;r++)this.layout.RowHeight(++e)||r--;else if(t<0)for(let r=0;r>t;r--)--e>=0&&!this.layout.RowHeight(e)&&r++;return e}StepVisibleColumns(e,t){if(t>0)for(let r=0;r<t;r++)this.layout.ColumnWidth(++e)||r--;else if(t<0)for(let r=0;r>t;r--)--e>=0&&!this.layout.ColumnWidth(e)&&r++;return e}EnsureAddress(e,t=8,r=!1){let i=!1;if(this.options.expand){if(e.row!==1/0&&e.row>=this.active_sheet.rows){let n=this.active_sheet.rows;for(;e.row>=n;)n+=t;this.active_sheet.cells.EnsureRow(n),i=!0}if(e.column!==1/0&&e.column>=this.active_sheet.columns){let n=this.active_sheet.columns;for(;e.column>=n;)n+=t;this.active_sheet.cells.EnsureColumn(n),i=!0}i&&!r&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0))}return i}AdvanceSelection(e,t,r=!1,i=!1,n=!0){let o=this.SelectingArgument();if(t.empty)if(o){let s={row:Math.max(0,this.StepVisibleRows(this.primary_selection.target.row,e.rows)),column:Math.max(0,this.StepVisibleColumns(this.primary_selection.target.column,e.columns))};this.Select(t,new y(s))}else this.Select(t,new y({row:0,column:0}));else{let s=this.active_sheet.CellData(t.target);if(s.merge_area&&r&&(r=!s.merge_area.Equals(t.area)),r&&t.area.count>1){let a=this.active_sheet.RealArea(t.area),c=t.target;for(;;){c.row=this.StepVisibleRows(c.row,e.rows),c.column=this.StepVisibleColumns(c.column,e.columns),this.BoundAddressArea(c,a);let d=this.active_sheet.CellData(c);if(!d.merge_area||d.merge_area.start.row===c.row&&d.merge_area.start.column===c.column)break}this.Select(t,a,c)}else if(i&&t&&t.target){let a=t.area,c=t.target,d=a.start,u=a.end,h={row:1/0,column:1/0};if(e.columns&&(a.columns===1?e.columns>0?(u.column=this.StepVisibleColumns(u.column,1),h.column=u.column):(d.column=this.StepVisibleColumns(d.column,-1),h.column=d.column):a.end.column>c.column?(u.column=this.StepVisibleColumns(u.column,e.columns),h.column=u.column):a.start.column<c.column&&(d.column=this.StepVisibleColumns(d.column,e.columns),h.column=d.column),u.column=Math.max(0,u.column),d.column=Math.max(0,d.column)),e.rows&&(a.rows===1?e.rows>0?(u.row=this.StepVisibleRows(u.row,1),h.row=u.row):(d.row=this.StepVisibleRows(d.row,-1),h.row=d.row):a.end.row>c.row?(u.row=this.StepVisibleRows(u.row,e.rows),h.row=u.row):a.start.row<c.row&&(d.row=this.StepVisibleRows(d.row,e.rows),h.row=d.row),u.row=Math.max(0,u.row),d.row=Math.max(0,d.row)),this.options.expand){for(let m of[d,u,h])m.row!==1/0&&(m.row=Math.max(0,m.row)),m.column!==1/0&&(m.column=Math.max(0,m.column));this.EnsureAddress(u)&&(n=!0),this.ScrollIntoView(h),this.Select(t,new y(d,u),void 0,!0)}else{for(let m of[d,u,h])m.row!==1/0&&(m.row=Math.max(0,Math.min(m.row,this.active_sheet.rows-1))),m.column!==1/0&&(m.column=Math.max(0,Math.min(m.column,this.active_sheet.columns-1)));this.ScrollIntoView(h),this.Select(t,new y(d,u),void 0,!0)}}else{let a=t.target;s.merge_area?(e.columns<0?a.column=this.StepVisibleColumns(s.merge_area.start.column,-1):e.columns>0&&(a.column=this.StepVisibleColumns(s.merge_area.end.column,1)),e.rows<0?a.row=this.StepVisibleRows(s.merge_area.start.row,-1):e.rows>0&&(a.row=this.StepVisibleRows(s.merge_area.end.row,1))):(a.row=this.StepVisibleRows(a.row,e.rows),a.column=this.StepVisibleColumns(a.column,e.columns)),this.EnsureAddress(a)&&(n=!0),this.Select(t,new y({row:Math.min(Math.max(0,a.row),this.active_sheet.rows-1),column:Math.min(Math.max(0,a.column),this.active_sheet.columns-1)})),this.RenderSelections(),this.ScrollIntoView(t.target)}}this.SelectingArgument()&&this.UpdateSelectedArgument(t),n&&this.DelayedRender()}HighlightDependencies(e,t=!0){let r=0;e:for(let i of e)if((i.start.row===1/0||i.start.row<this.active_sheet.rows)&&(i.start.column===1/0||i.start.column<this.active_sheet.columns)){if(i.start.spill&&i.end.row===i.start.row&&i.end.column===i.start.column){let s=this.model.sheets.Find(i.start.sheet_id||-1)?.CellData(i.start);s?.spill&&s.spill.start.row===i.start.row&&s.spill.start.column===i.start.column&&i.ConsumeArea(s.spill)}i=this.active_sheet.RealArea(i);let n=i.spreadsheet_label;if(this.additional_selections[r]&&this.additional_selections[r].area.spreadsheet_label===n)r++;else{for(let o=0;o<r;o++)if(this.additional_selections[o].area.spreadsheet_label===n&&this.additional_selections[o].area.start.sheet_id===i.start.sheet_id)continue e;this.additional_selections[r++]={target:i.start,area:i}}}this.additional_selections.splice(r),t&&this.RenderSelections(!1)}ClearAdditionalSelections(){this.additional_selections.splice(0,this.additional_selections.length)}ClearSelection(e){this.Select(e)}HideGridSelection(){this.UpdateAddressLabel(void 0,"");let e=this.selected_annotation&&this.selected_annotation.data.formula?this.selected_annotation.data.formula:"";this.UpdateFormulaBarFormula(e),this.layout.ShowSelections(!1)}ShowGridSelection(){this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.layout.ShowSelections(!0)}Select(e,t,r,i=!1){if(e.empty||i&&(r=e.target),t){let n=this.active_sheet.RealArea(t);r||(r=n.start);e:for(;;){for(let a of this.active_sheet.cells.Iterate(n,!1))if(a.merge_area&&!n.ContainsArea(a.merge_area)){t.ConsumeArea(a.merge_area),n=this.active_sheet.RealArea(t);continue e}break}e.area=new y({...t.start,sheet_id:this.active_sheet.id},t.end),r&&(e.target={...r,sheet_id:this.active_sheet.id}),e.empty=!1;let o=this.active_sheet.CellData(e.target),s="";o.formatted&&(typeof o.formatted=="string"?s=o.formatted:s=o.formatted.map(a=>a.flag===1||a.flag===6?"":a.text).join("")),this.overlay_editor?.UpdateCaption(s)}else e.empty=!0;e===this.primary_selection&&(q.is_edge&&this.Focus(),this.grid_events.Publish({type:"selection",selection:this.primary_selection}),this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.formula_bar&&(this.formula_bar.target_address={...this.primary_selection.target}),this.options.stats&&this.UpdateStats())}UpdateFormulaBarFormula(e){if(this.layout.HideDropdownCaret(),e){this.formula_bar&&(this.formula_bar.shadow=!1,this.formula_bar.formula=e);return}if(this.primary_selection.empty)this.formula_bar&&(this.formula_bar.shadow=!1,this.formula_bar.formula="");else{let t=this.active_sheet.CellData(this.primary_selection.target),r=t.merge_area||t.area||t.spill,i=!1;r&&(r.start.column!==this.primary_selection.target.column||r.start.row!==this.primary_selection.target.row)&&(t=this.active_sheet.CellData(r.start),t.spill&&(i=!0)),this.formula_bar&&(this.formula_bar.editable=!t.style?.locked);let n=this.NormalizeCellValue(t),o=this.active_sheet.GetValidation(this.primary_selection.target)[0];if(o&&!t.style?.locked){let s;o.type==="list"?s=o.list:o.type==="range"&&(s=this.GetValidationRange(o.area)),s&&s.length&&this.layout.ShowDropdownCaret(t.merge_area||new y(this.primary_selection.target),s,t.value)}this.formula_bar&&(this.formula_bar.shadow=i,t.area?this.formula_bar.formula="{"+(n||"")+"}":this.formula_bar.formula=(n??"").toString())}}RenderStats(e){if(!Array.isArray(e))return[];let t=0,r=0,i={real:0,imaginary:0};for(let o of e)for(let s of o)typeof s=="number"?(i.real+=s,r++):ue(s)&&(i.real+=s.real,i.imaginary+=s.imaginary,r++),typeof s<"u"&&t++;let n=o=>{let s=Math.floor(Math.log10(o));return s<-6||s>10?L.Get("Exponential"):s<=-1?L.Get("General"):L.Get("Number")};if(t>1)if(r>0){let o=L.Get("General");if(i.imaginary){let s={real:i.real/r,imaginary:i.imaginary/r};return[{label:"Count",value:t.toString()},{label:"Sum",value:le.FormatPartsAsText(o.FormatComplex(i))},{label:"Average",value:le.FormatPartsAsText(o.FormatComplex(s))}]}else return[{label:"Count",value:t.toString()},{label:"Sum",value:n(i.real).Format(i.real)},{label:"Average",value:n(i.real/r).Format(i.real/r)}]}else return[{label:"Count",value:t.toString()}];return[]}UpdateStats(){if(this.tab_bar){let e=[];typeof this.options.stats=="function"?this.primary_selection.empty||(e=this.options.stats.call(void 0,this.GetRange(this.primary_selection.area))):!this.primary_selection.empty&&this.primary_selection.area.count>1&&(e=this.RenderStats(this.GetRange(this.primary_selection.area))),this.tab_bar.stats_data=e}}UpdateAddressLabel(e=this.primary_selection,t){if(this.formula_bar)if(typeof t<"u")this.formula_bar.label=t;else if(e.empty)this.formula_bar.label="";else{let r=this.active_sheet.CellData(this.primary_selection.target),i=new y(r.merge_area?r.merge_area.start:e.target);this.formula_bar.label=this.model.named.MatchSelection(e.area,i)||y.CellAddressToLabel(i.start)}}OnDropdownSelect(e){if(typeof e<"u"){let i=ge.TryParse(e.toString());i.type===3&&(e=i.value)}let t=this.active_sheet.CellData(this.primary_selection.target),r=t.merge_area?t.merge_area.start:this.primary_selection.target;this.ExecCommand({key:6,area:r,value:e}),this.UpdateFormulaBarFormula()}OnScroll(){let e=this.layout.VisibleTiles();e.Equals(this.render_tiles)||(this.render_tiles=e,this.layout_token||(this.layout_token=requestAnimationFrame(()=>this.Repaint())))}AttachListeners(){if(!this.container)throw new Error("invalid container");this.container.addEventListener("copy",this.HandleCopy.bind(this)),this.container.addEventListener("cut",this.HandleCut.bind(this)),this.container.addEventListener("paste",this.HandlePaste.bind(this)),this.layout.grid_cover.addEventListener("mousedown",e=>this.MouseDown_Grid(e)),this.layout.column_header_cover.addEventListener("mousedown",e=>this.MouseDown_ColumnHeader(e)),this.layout.row_header_cover.addEventListener("mousedown",e=>this.MouseDown_RowHeader(e)),this.layout.column_header_cover.addEventListener("mousemove",e=>this.MouseMove_ColumnHeader(e)),this.layout.row_header_cover.addEventListener("mousemove",e=>this.MouseMove_RowHeader(e)),this.layout.grid_cover.addEventListener("mousemove",e=>this.MouseMove_Grid(e)),this.overlay_editor?.edit_node.addEventListener("keydown",e=>this.OverlayKeyDown(e)),this.layout.corner.addEventListener("dblclick",()=>{this.SelectAll()}),window.addEventListener("resize",()=>{this.layout.UpdateDPR()&&(this.QueueLayoutUpdate(),this.Repaint(!0,!0,!0))})}HandleCopy(e){if(e.stopPropagation(),e.preventDefault(),this.primary_selection.empty){if(e.clipboardData&&e.clipboardData.clearData(),this.selected_annotation&&e.clipboardData){let t=JSON.stringify({data:this.selected_annotation,source:this.active_sheet.id});e.clipboardData.setData("text/x-treb-annotation",t);let r=this.selected_annotation.view[this.view_index];if(r&&r.node){let i=r.node.firstChild?.firstChild;if(i){let n=Ui(i).outerHTML;e.clipboardData.setData("text/uri-list","data:image/svg+xml;base64,"+btoa(n)),e.clipboardData.setData("text/html",n),e.clipboardData.setData("text/plain",n)}}}}else{let t=this.active_sheet.RealArea(this.primary_selection.area),r=[],i=[];if(this.primary_selection.area.entire_column)for(let d=t.start.column;d<=t.end.column;d++){let u=this.active_sheet.GetColumnWidth(d);u!==this.active_sheet.default_column_width&&(r[d-t.start.column]=u)}if(this.primary_selection.area.entire_row)for(let d=t.start.row;d<=t.end.row;d++){let u=this.active_sheet.GetRowHeight(d);u!==this.active_sheet.default_row_height&&(i[d-t.start.row]=u)}let n=t.columns,o=t.rows,s=[],a=[];for(let d=0;d<o;d++){let u=[];for(let h=0;h<n;h++){let m={row:t.start.row+d,column:t.start.column+h},f=this.active_sheet.CellData(m),p="";f.calculated!==void 0?f.calculated_type===7?p=Xe(f.calculated):p=f.calculated.toString():f.type===7?p=Xe(f.value):p=f.value?.toString()||"",u.push(p);let b={address:m,data:f.value,type:f.type,style:this.active_sheet.GetCopyStyle(m)};f.area&&f.area.start.row===m.row&&f.area.start.column===m.column&&(b.array={rows:f.area.rows,columns:f.area.columns}),a.push(JSON.parse(JSON.stringify(b)))}s.push(u)}let c=s.map(d=>d.join("	")).join(`
`);e.clipboardData&&(e.clipboardData.clearData(),e.clipboardData.setData("text/plain",c),e.clipboardData.setData("text/x-treb",JSON.stringify({source:t,data:a,column_width:r,row_height:i})))}}HandleCut(e){if(e.stopPropagation(),e.preventDefault(),this.HandleCopy(e),this.primary_selection.empty)this.selected_annotation&&this.RemoveAnnotation(this.selected_annotation);else{let t=this.active_sheet.RealArea(this.primary_selection.area);this.ExecCommand({key:12,area:t})}}RecyclePasteAreas(e,t){let r=[];if(e.count===1)for(let i=t.start.row;i<=t.end.row;i++)for(let n=t.start.column;n<=t.end.column;n++)r.push(new y({row:i,column:n}));else if(e.columns===t.columns&&t.rows>=e.rows&&t.rows%e.rows===0)for(let i=t.start.row;i<=t.end.row;i+=e.rows)r.push(new y({row:i,column:t.start.column},{row:i+e.rows-1,column:t.end.column}));else if(e.rows===t.rows&&t.columns>=e.columns&&t.columns%e.columns===0)for(let i=t.start.column;i<=t.end.column;i+=e.columns)r.push(new y({column:i,row:t.start.row},{column:i+e.columns-1,row:t.end.row}));else r.push(t.Clone().Resize(e.rows,e.columns));return r}HandlePaste(e){if(this.overlay_editor?.editing||(e.stopPropagation(),e.preventDefault(),!e.clipboardData))return;let t=e.clipboardData.getData("text/x-treb-annotation");if(t){try{let o=JSON.parse(t);if(o.source&&o.source!==this.active_sheet.id&&o.data&&o.data.formula){let s="",a=this.model.sheets.Find(o.source);if(a&&(s=a.name),s){let c=this.parser.Parse(o.data.formula);c.expression&&(this.parser.Walk(c.expression,d=>d.type==="range"?(!d.start.sheet_id&&!d.start.sheet&&(d.start.sheet=s),!1):(d.type==="address"&&!d.sheet_id&&!d.sheet&&(d.sheet=s),!0)),o.data.formula="="+this.parser.Render(c.expression,{missing:""}))}}this.CreateAnnotation(o.data,void 0,!0,!0,void 0,!0)}catch(o){console.error(o)}return}if(this.primary_selection.empty)return;let r=this.active_sheet.RealArea(this.primary_selection.area),i=[],n=e.clipboardData.getData("text/x-treb");if(n)try{let o=JSON.parse(n),s=new y(o.source.start,o.source.end),a=this.RecyclePasteAreas(s,r);if(a.length===1&&r.Resize(a[0].rows,a[0].columns),!this.ValidatePasteAreas(a)){this.Error(5);return}let c=[];for(let d of a){this.active_sheet.cells.EnsureCell(d.end),i.push({key:12,area:d});let u={rows:d.start.row-s.start.row,columns:d.start.column-s.start.column};if(o.data.forEach(h=>{let m=h.data,f={row:h.address.row-s.start.row+d.start.row,column:h.address.column-s.start.column+d.start.column};if(h.type===1){let p=this.parser.Parse(m);p.expression&&(m="="+this.parser.Render(p.expression,{offset:u,missing:""}))}if(h.array){let p={start:{...f},end:{row:f.row+h.array.rows-1,column:f.column+h.array.columns-1}},b={key:6,value:m,array:!0,area:p};c.push(new y(p.start,p.end)),i.push(b)}else{let p=!1;for(let b of c)if(b.Contains(f)){p=!0;break}p||i.push({key:6,value:m,area:f})}i.push({key:7,style:h.style||{},area:f})}),o.column_width?.length){for(let[h,m]of o.column_width.entries())if(typeof m=="number"){let f=h+d.start.column;i.push({key:4,column:f,width:m})}}if(o.row_height?.length){for(let[h,m]of o.row_height.entries())if(typeof m=="number"){let f=h+d.start.row;i.push({key:3,row:f,height:m})}}}}catch(o){console.error("invalid treb data on clipboard"),console.info(o);return}else{let o=e.clipboardData.getData("text/plain");if(!o)return!0;let a=o.trim().split(`
`).map(d=>d.split("	").map(u=>u.trim())),c=this.RecyclePasteAreas(new y({row:0,column:0},{row:a.length-1,column:a[0].length-1}),r);if(c.length===1&&(r.Resize(a.length,a[0].length),r.Resize(c[0].rows,c[0].columns)),!this.ValidatePasteAreas(c)){this.Error(5);return}for(let d of c)for(let u=0;u<a.length;u++)for(let h=0;h<a[0].length;h++){let m=new y({row:u+d.start.row,column:h+d.start.column});if(this.active_sheet.cells.EnsureCell(m.end),a[u][h]){let f=this.SetInferredType({area:m,target:m.start,empty:!1},a[u][h],!1,!1);if(f)for(let p of f)i.push(p)}else{let f=this.active_sheet.cells.GetCell(m.start,!1);f&&f.type!==0&&i.push({key:12,area:m.Clone()})}}}this.ExecCommand(i),this.Select(this.primary_selection,r)}AllSelections(e=!1){let t=[this.primary_selection,this.active_selection].concat(this.additional_selections);return e?t:t.filter(r=>!r.empty)}InsertRowsInternal(e){let t=super.InsertRowsInternal(e);if(t.error)return t;let r=this.FindSheet(e.sheet_id);if(r===this.active_sheet){if(e.count<0)for(let i of this.AllSelections())i.empty=!0;else for(let i of this.AllSelections())i.target.row>=e.before_row&&(i.target.row+=e.count),i.area.entire_column||(i.area.start.row>=e.before_row?i.area.Shift(e.count,0):i.area.end.row>=e.before_row&&i.area.ConsumeAddress({row:i.area.end.row+e.count,column:i.area.end.column}));for(let i of t.delete_annotations_list||[])this.layout.RemoveAnnotation(i);if(this.QueueLayoutUpdate(),this.Repaint(),t.update_annotations_list?.length){this.layout.UpdateAnnotation(t.update_annotations_list,this.theme);for(let i of t.resize_annotations_list||[]){let n=i.view[this.view_index];n?.resize_callback&&n.resize_callback.call(void 0)}}}else this.pending_layout_update.add(r.id);return t}InsertColumnsInternal(e){let t=super.InsertColumnsInternal(e);if(t.error)return t;let r=this.FindSheet(e.sheet_id);if(r===this.active_sheet){if(e.count<0)for(let i of this.AllSelections())i.empty=!0;else for(let i of this.AllSelections())i.target.column>=e.before_column&&(i.target.column+=e.count),i.area.entire_row||(i.area.start.column>=e.before_column?i.area.Shift(0,e.count):i.area.end.column>=e.before_column&&i.area.ConsumeAddress({row:i.area.end.row,column:i.area.end.column+e.count}));for(let i of t.delete_annotations_list||[])this.layout.RemoveAnnotation(i);if(this.tile_renderer?.FlushOverflows(),this.QueueLayoutUpdate(),this.DelayedRender(!0,void 0,!0),t.update_annotations_list?.length){this.layout.UpdateAnnotation(t.update_annotations_list,this.theme);for(let i of t.resize_annotations_list||[]){let n=i.view[this.view_index];n?.resize_callback&&n.resize_callback.call(void 0)}}}else this.pending_layout_update.add(r.id);return t}ResetInternal(){super.ResetInternal(),this.RemoveAnnotationNodes(),this.ClearSelection(this.primary_selection),this.ScrollIntoView({row:0,column:0}),this.QueueLayoutUpdate(),this.layout.HideNote()}ResizeColumnsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.column;if(typeof r>"u"){r=[];for(let o=0;o<t.columns;o++)r.push(o)}typeof r=="number"&&(r=[r]);let i=typeof e.width!="number",n=Math.round((e.width||0)/this.scale);if(i)for(let o of r)this.AutoSizeColumn(t,o,!0);else for(let o of r)t.SetColumnWidth(o,n);t===this.active_sheet?(this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetWidth&&this.layout.container.offsetWidth>this.layout.total_width?this.UpdateLayout():(this.layout.UpdateTileWidths(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.RenderSelections()):this.pending_layout_update.add(t.id)}ResizeRowsInternal(e){let t,r=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,i=e.row;if(typeof i>"u"){i=[];for(let a=0;a<r.rows;a++)i.push(a)}typeof i=="number"&&(i=[i]);let n=typeof e.shrink=="boolean"?e.shrink:!0,o=typeof e.height!="number",s=Math.round(e.height||0/this.scale);if(o)for(let a of i)r.GetRowHeight(a)||(t?t.ConsumeAddress({row:a,column:1}):t=new y({row:a,column:1/0,sheet_id:r.id})),this.AutoSizeRow(r,a,n);else for(let a of i){let c=r.GetRowHeight(a);(!c&&s||c&&!s)&&(t?t.ConsumeAddress({row:a,column:1}):t=new y({row:a,column:1/0,sheet_id:r.id})),r.SetRowHeight(a,s)}return r===this.active_sheet?(this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetHeight&&this.layout.container.offsetHeight>this.layout.total_height?this.UpdateLayout():(this.layout.UpdateTileHeights(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.RenderSelections()):this.pending_layout_update.add(r.id),t?{start:t.start,end:t.end}:void 0}SelectInternal(e){e.area?(e.area.start.sheet_id&&e.area.start.sheet_id!==this.active_sheet.id&&this.ActivateSheetInternal({key:22,id:e.area.start.sheet_id}),this.Select(this.primary_selection,new y(e.area.start,e.area.end)),this.RenderSelections()):this.ClearSelection(this.primary_selection)}FreezeInternal(e){let t=this.FindSheet(e.sheet_id||this.active_sheet.id),r=(typeof e.highlight_transition=="boolean"?e.highlight_transition:!0)&&t===this.active_sheet;if(e.rows===t.freeze.rows&&e.columns===t.freeze.columns){r&&this.HighlightFreezeArea();return}t.freeze.rows=e.rows,t.freeze.columns=e.columns,t===this.active_sheet?(this.QueueLayoutUpdate(),this.Repaint(),r&&this.HighlightFreezeArea(),e.rows||e.columns?this.layout.CloneFrozenAnnotations():this.layout.ClearFrozenAnnotations()):this.pending_layout_update.add(t.id)}ExecCommand(e,t=!0){let r=super.ExecCommand(e,t);this.batch||r.render_area&&this.DelayedRender(!1,r.render_area),r.repaint&&this.Repaint();for(let i of r.pending||[])this.pending_layout_update.add(i);return r.layout&&this.QueueLayoutUpdate(),r.sheets&&this.tab_bar&&this.tab_bar.Update(),r.formula&&this.UpdateFormulaBarFormula(),r}};var Wi=["default","old-style","transitional","handwritten","monospace","industrial","ui"],jt={default:"Sans-serif","old-style":"Old style",transitional:"Serif",handwritten:"Handwritten",monospace:"Monospace",industrial:"Industrial sans",ui:"System UI"},Ji=new Map,qr=(l,e)=>{let t=e.fontFamily,r="",i=t.split(/,/);for(let u of i){u=u.replace(/'"/g,"").trim();let h=u.toLowerCase();if(q.is_firefox&&/sitka text/i.test(h))continue;let m=Ji.get(h);if(typeof m>"u"&&(m=oe.FontLoaded(u),Ji.set(h,m)),m){r=u;break}}r||console.warn("no font found for font stack",l);let n=r.toLowerCase().replace(/['"]/g,"").replace(/\W+/g,"-"),o=e.getPropertyValue("--treb-font-stack-default-size"),s=e.getPropertyValue(`--treb-font-stack-${n}-size`),a=e.getPropertyValue(`--treb-font-stack-${n}-variant`),c=I.ParseFontSize(s||o||"10pt").font_size||{unit:"pt",value:10};return{family:t,font:r,variants:a,size:c}};var $t={grid_color:"#ccc",note_marker_color:"#d2c500",mode:"light",offset_cache:{},offset_light:"#fff",offset_dark:"#000",font_stacks:{},grid_cell_font_size:{value:10,unit:"pt"}},Wo=(l,e)=>{let t=Fr(e),r=e.tint||0;l.mode==="dark"&&(r=-r),l.tint_cache||(l.tint_cache=[]),l.tint_cache[t]||(l.tint_cache[t]={});let i=l.tint_cache[t][r];if(!i){let n=(l.theme_colors_rgb?l.theme_colors_rgb[t]:[0,0,0])||[0,0,0],o;r>0?o=j.Lighten(n[0],n[1],n[2],r*100,!0):o=j.Darken(n[0],n[1],n[2],-r*100,!0),i=`rgb(${o.r},${o.g},${o.b})`,l.tint_cache[t][r]=i}return i},V=(l,e,t)=>{if(e&&e.offset){if(e.offset.offset)return console.warn("invalid offset color"),"";let r="";if(Y(e.offset)){let n=oe.MeasureColor(e.offset.text);r=`rgb(${n[0]}, ${n[1]}, ${n[2]})`}else r=V(l,e.offset,void 0);if(l.offset_cache&&l.offset_cache[r])return l.offset_cache[r];let i=l.offset_light;if(r){let n=r.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(n){let o=[Number(n[1]),Number(n[2]),Number(n[3])],s=Array.from(oe.MeasureColor(l.offset_dark)),a=Array.from(oe.MeasureColor(l.offset_light)),c=j.GetTextColor(o,s,a);i=`rgb(${c[0]}, ${c[1]}, ${c[2]})`}else console.warn("can't offset against color",r,"(1)");l.offset_cache||(l.offset_cache={}),l.offset_cache[r]=i}else console.warn("can't resolve offset color",e.offset,"(2)");return i}return Y(e)?e.text==="none"?"":e.text:Ke(e)?e.tint?Wo(l,e):l.theme_colors?l.theme_colors[Fr(e)]:"":(t||t===0)&&l.theme_colors?l.theme_colors[t]:""},Xo=l=>{let e=10,t="pt",r=l.match(/^([\d.]+)(\D.*)$/);return r&&(e=Number(r[1]),t=r[2]),{value:e,unit:t}},Xi=(l,e=!1)=>{let t={fill:{text:l.backgroundColor},text:{text:l.color},font_size:{unit:"em",value:1}};return e&&(t.font_face=l.fontFamily),/italic/i.test(l.font)&&(t.italic=!0),l.fontWeight==="700"&&(t.bold=!0),t},Ko=(l,e)=>{let t=l.grid_cell?.text,r=l.grid_cell?.fill;e.fillStyle=Y(t)?t.text:"",e.fillRect(0,0,3,3);let i=j.RGBToHSL(...Array.from(e.getImageData(1,1,1,1).data));e.fillStyle=Y(r)?r.text:"",e.fillRect(0,0,3,3);let n=j.RGBToHSL(...Array.from(e.getImageData(1,1,1,1).data));return i.l>n.l?"dark":"light"},qt=(l,e=.7)=>{let t={border_top:1,border_top_fill:{theme:l},border_bottom:1,border_bottom_fill:{theme:l}};return{header:{text:{offset:{theme:l}},fill:{theme:l},bold:!0,...t},odd:{fill:{theme:l,tint:e},...t},even:{...t},total:{...t,border_top:2}}},qi=(l,e=!1)=>{let t=JSON.parse(JSON.stringify($t)),r=H.GetInstance(l.ownerDocument),i=(h,m)=>r.Div(m,h),n=(h,m)=>r.view?.getComputedStyle(i(h,m)),o=i(l,""),s=n.bind(0,o),a=s("grid-cells");if(t.grid_cell=Xi(a,!1),t.grid_color=a.stroke||"",t.grid_cell_font_size=Xo(a.fontSize||""),e)for(let h of Wi)a=s(`treb-font-stack-${h}`),t.font_stacks[h]=qr(h,a);else a=s("treb-font-stack-default"),t.font_stacks.default=qr("default",a);a=s("grid-headers"),t.headers=Xi(a,!0),t.headers_grid_color=a.stroke,(!t.headers_grid_color||t.headers_grid_color==="none")&&(t.headers_grid_color=t.grid_color),a=s("treb-offset-dark"),a.color&&(t.offset_dark=a.color),a=s("treb-offset-light"),a.color&&(t.offset_light=a.color),a=s("note-marker"),t.note_marker_color=a.backgroundColor,o.style.color="rgba(1,2,3,.4)",a=s("");let c=a.color;t.theme_colors=[Y(t.grid_cell.fill)?t.grid_cell.fill.text:"rgb(255, 255, 255)",Y(t.grid_cell.text)?t.grid_cell.text.text:"rgb(51, 51, 51)"];for(let h=1;h<32&&(a=s(`theme-color-${h}`),!(!a.color||a.color===c));h++)t.theme_colors.push(a.color);let d=r.Create("canvas");d.width=3,d.height=3;let u=d.getContext("2d",{willReadFrequently:!0});return u&&(t.mode=Ko(t,u)),u&&(t.theme_colors_rgb=t.theme_colors.map(h=>{u.fillStyle=h,u.fillRect(0,0,3,3);let m=u.getImageData(1,1,1,1);return Array.from(m.data)})),t.table=qt(4),o.parentElement?.removeChild(o),t};var ji={column:0,type:"auto",asc:!0};var Jt=class{constructor(e,t,r="RGB"){this.color_space=r;this.mapped=e.map(i=>{if(i.value<0||i.value>1)throw new Error("invalid stop value");let n=oe.MeasureColor(V(t,i.color)),o=[];if(r==="HSL"){let s=j.RGBToHSL(n[0],n[1],n[2]);o=[s.h,s.s,s.l]}else o=[...n];return{...i,resolved:o}}),this.mapped.sort((i,n)=>i.value-n.value),this.mapped[0].value>0&&this.mapped.unshift({...this.mapped[0],value:0}),this.mapped[this.mapped.length-1].value<1&&this.mapped.push({...this.mapped[this.mapped.length-1],value:1})}mapped;RenderColor(e){return this.color_space==="RGB"?{text:`rgb(${e})`}:{text:`hsl(${e[0]},${e[1]*100}%,${e[2]*100}%)`}}Interpolate(e){e=Math.min(1,Math.max(0,e));for(let[t,r]of this.mapped.entries()){if(e===r.value)return this.RenderColor(r.resolved);if(e<r.value){let i=this.mapped[t-1],n=r,o=n.value-i.value,s=e-i.value,a=[0,1,2].map(c=>i.resolved[c]+(n.resolved[c]-i.resolved[c])/o*s);return this.RenderColor(a)}}return{text:""}}};var Wt={};oo(Wt,{Iterate:()=>Yo});function*Yo(l){if(l.start.row===1/0||l.end.row===1/0)throw new Error("don't iterate infinite area");let e=l.start.sheet_id;for(let t=l.start.row;t<=l.end.row;t++)for(let r=l.start.column;r<=l.end.column;r++)yield{row:t,column:r,sheet_id:e}}var Xt=class{constructor(e){this.parser=e}named=new Map;get list(){return this.named.values()}SetNamedExpression(e,t,r){return this.SetName({type:"expression",name:e,expression:t,scope:r})}SetNamedRange(e,t,r){return this.SetName({type:"range",name:e,area:new y(t.start,t.end),scope:r})}SetName(e){let t=e.name;return this.ValidateNamed(t)?(this.named.set(this.ScopedName(t,e.scope),e),!0):(console.warn("invalid name",{name:t}),!1)}ScopedName(e,t){return typeof t=="number"?t+":"+e.toLowerCase():e.toLowerCase()}ClearName(e,t){typeof t=="number"?this.named.delete(this.ScopedName(e,t)):this.named.delete(e.toLowerCase())}RemoveRangesForSheet(e){let t=[];for(let[r,i]of this.named)(i.type==="range"&&i.area.start.sheet_id===e||i.scope===e)&&t.push(r);for(let r of t)this.named.delete(r)}Reset(){this.named.clear()}Get_(e,t,r=!1){return r?this.named.get(this.ScopedName(e,t)):this.named.get(this.ScopedName(e,t))||this.named.get(e.toLowerCase())}ValidateNamed(e){return e=e.trim().toUpperCase(),!e.length||/[^A-Z\d_.?]/.test(e)||/^[^A-Z_]/.test(e)||e==="R"||e==="C"||/^[A-Z]{1,3}[1-9]\d*$/.test(e)||/^R[[\]\d]+C/.test(e)?!1:e}MatchSelection(e,t){if(!e.start.sheet_id)throw new Error("match selection without sheet id");let r;for(let i of this.named.values())if(i.type==="range"&&i.area.start.sheet_id===e.start.sheet_id&&(e.Equals(i.area)&&(r=i.name),t?.Equals(i.area)))return i.name;return r}PatchNamedRanges(e,t,r,i,n){let o=[...this.list];for(let s of o){if(s.type==="expression")continue;let a=s.name,c=s.area;if(c.start.sheet_id!==e){console.info("skipping name",a);continue}if(r&&t<=c.end.column){if(r>0)t<=c.start.column?c.Shift(0,r):t>c.start.column&&t<=c.end.column?c.ConsumeAddress({row:c.end.row,column:c.end.column+r}):console.warn("PNR X case 1",t,r,JSON.stringify(c));else if(r<0)if(t-r<=c.start.column)c.Shift(0,r);else if(t<=c.start.column&&t-r>c.end.column)this.ClearName(a);else if(t<=c.start.column){let d=t-r-1;this.SetName({type:"range",area:new y({row:c.start.row,column:d+1+r,sheet_id:e},{row:c.end.row,column:c.end.column+r}),name:a})}else t<=c.end.column?t-r-1>=c.end.column?this.SetName({type:"range",area:new y({row:c.start.row,column:c.start.column,sheet_id:e},{row:c.end.row,column:t-1}),name:a}):this.SetName({type:"range",name:a,area:new y({row:c.start.row,column:c.start.column,sheet_id:e},{row:c.end.row,column:c.start.column+c.columns+r-1})}):console.warn("PNR X case 2",t,r,JSON.stringify(c))}if(n&&i<=c.end.row){if(n>0)i<=c.start.row?c.Shift(n,0):i>c.start.row&&i<=c.end.row?c.ConsumeAddress({row:c.end.row+n,column:c.end.column}):console.warn("PNR X case 3",i,n,JSON.stringify(c));else if(n<0)if(i-n<=c.start.row)c.Shift(n,0);else if(i<=c.start.row&&i-n>c.end.row)this.ClearName(a);else if(i<=c.start.row){let d=i-n-1;this.SetNamedRange(a,new y({column:c.start.column,row:d+1+n,sheet_id:e},{column:c.end.column,row:c.end.row+n}))}else i<=c.end.row?i-n-1>=c.end.row?this.SetNamedRange(a,new y({column:c.start.column,row:c.start.row,sheet_id:e},{column:c.end.column,row:i-1})):this.SetNamedRange(a,new y({column:c.start.column,row:c.start.row,sheet_id:e},{column:c.end.column,row:c.start.row+c.rows+n-1})):console.warn("PNR X case 4",i,n,JSON.stringify(c))}}}};var bt=class{parser=new We;language_model;document_name;user_data;sheets=new Ct;named=new Xt(this.parser);macro_functions=new Map;view_count=0;theme_style_properties=JSON.parse(JSON.stringify(I.DefaultProperties));tables=new Map;GetName(e,t){let r=e.split(/!/);if(r.length===1)return this.named.Get_(e,t);let i=r[0];/^'.*?'$/.test(i)&&(i=i.substring(1,i.length-1));let n=this.sheets.ID(i);return this.named.Get_(r[1],n||0,!0)}UnserializeNames(e,t){this.parser.Save(),this.parser.SetLocaleSettings(".",",");for(let r of e){if(!r.expression)continue;let i=this.parser.Parse(r.expression);if(i.expression){let n=typeof r.scope=="string"?this.sheets.ID(r.scope):void 0;if(i.expression.type==="address"||i.expression.type==="range"){let[o,s]=i.expression.type==="range"?[i.expression.start,i.expression.end]:[i.expression,i.expression];if(o.sheet)if(/^\[\d+\]/.test(o.sheet))console.warn("named range refers to an external file");else{let a=new y({...o,sheet_id:this.sheets.ID(o.sheet)},s);a.start.sheet_id?this.named.SetNamedRange(r.name,a,n):console.warn("missing sheet ID?",o)}else console.warn("missing sheet name?",o)}else this.parser.Walk(i.expression,o=>o.type==="address"||o.type==="range"?(o.type==="range"&&(o=o.start),o.sheet_id||o.sheet&&(o.sheet_id=this.sheets.ID(o.sheet)),o.sheet_id||(o.sheet_id=t?.id),!1):!0),this.named.SetNamedExpression(r.name,i.expression,n)}}this.parser.Restore()}SerializeNames(e){let t=[];for(let r of this.named.list){let i={name:r.name,expression:""};if(r.scope&&(i.scope=this.sheets.Name(r.scope)),r.type==="expression")this.parser.Walk(r.expression,n=>{if(n.type==="address"||n.type==="range"){let o=n.type==="range"?n.start:n;return o.absolute_column=o.absolute_row=!0,o.sheet||(o.sheet_id&&(o.sheet=this.sheets.Name(o.sheet_id)),o.sheet||(o.sheet=e?.name)),n.type==="range"&&(n.end.absolute_column=n.end.absolute_row=!0),!1}return!0}),i.expression=this.parser.Render(r.expression,{missing:""});else{let n={start:{...r.area.start,absolute_column:!0,absolute_row:!0},end:{...r.area.end,absolute_column:!0,absolute_row:!0}};i.expression=this.AddressToLabel(n)}t.push(i)}return t}ResolveStructuredReference(e,t){let r;if(e.table?r=this.tables.get(e.table.toLowerCase()):t.sheet_id&&(r=this.sheets.Find(t.sheet_id)?.CellData(t)?.table),!r)return;let i=e.column.toLowerCase(),n=-1;if(r.columns){for(let o=0;o<r.columns.length;o++)if(i===r.columns[o]){n=r.area.start.column+o;break}}if(!(n<0))if(e.scope==="row"){let o=t.row;return o<r.area.start.row||o>r.area.end.row?void 0:{label:e.label,type:"address",row:o,column:n,sheet_id:r.area.start.sheet_id,id:e.id,position:e.position}}else{let o=r.area.start.row,s=r.area.end.row;return e.scope==="column"&&(o++,r.totals_row&&s--),{label:e.label,type:"range",position:e.position,id:e.id,start:{type:"address",row:o,column:n,sheet_id:r.area.start.sheet_id,label:e.label,position:e.position,id:0},end:{type:"address",row:s,column:n,label:e.label,position:e.position,id:0}}}}AddressToLabel(e){let t=N(e)?e:e.start,r=N(e)?[y.CellAddressToLabel(e)]:[y.CellAddressToLabel(e.start),y.CellAddressToLabel(e.end)],i=this.sheets.Find(t.sheet_id||0),n=i?.name?xe.test(i.name)?`'${i.name}'`:i.name:"";return n+(n?"!":"")+(r[0]===r[1]?r[0]:r.join(":"))}ResolveSheetID(e,t,r){let i=e.type==="address"?e:e.start;if(i.sheet_id)return!0;if(i.sheet){let n=this.sheets.Find(i.sheet);if(n)return i.sheet_id=n.id,!0}else{if(t?.sheet_id)return i.sheet_id=t.sheet_id,!0;if(r?.id)return i.sheet_id=r.id,!0}return!1}ResolveArea(e,t,r){let i=this.ResolveAddress(e,t,r);return N(i)?new y(i):new y(i.start,i.end)}ResolveAddress(e,t,r){if(typeof e=="string"){r?.r1c1&&(this.parser.Save(),this.parser.flags.r1c1=!0);let i=this.parser.Parse(e);if(r?.r1c1&&this.parser.Restore(),i.expression&&i.expression.type==="address")return this.ResolveSheetID(i.expression,void 0,t),{row:i.expression.row,column:i.expression.column,sheet_id:i.expression.sheet_id};if(i.expression&&i.expression.type==="range")return this.ResolveSheetID(i.expression,void 0,t),{start:{row:i.expression.start.row,column:i.expression.start.column,sheet_id:i.expression.start.sheet_id},end:{row:i.expression.end.row,column:i.expression.end.column}};if(i.expression&&i.expression.type==="identifier"){let n=this.GetName(i.expression.name,t.id);if(n?.type==="range")return n.area}return{row:0,column:0}}return e}AddConnectedElement(e){let t=this.connected_element_id++;return this.connected_elements.set(t,e),t}RemoveConnectedElement(e){let t=this.connected_elements.get(e);return this.connected_elements.delete(e),t}connected_element_id=100;connected_elements=new Map;language_map;reverse_language_map;SetLanguageMap(e){if(!e)this.language_map=this.reverse_language_map=void 0;else{let t=Object.keys(e);this.language_map={};for(let r of t)this.language_map[r.toUpperCase()]=e[r];this.reverse_language_map={};for(let r of t){let i=e[r];this.reverse_language_map[i.toUpperCase()]=r}}}TranslateFunction(e){return this.language_map?this.TranslateInternal(e,this.language_map,this.language_model?.boolean_true,this.language_model?.boolean_false):e}UntranslateFunction(e){return this.reverse_language_map?this.TranslateInternal(e,this.reverse_language_map,"TRUE","FALSE"):e}UntranslateData(e){return Array.isArray(e)?Et(e)?e.map(t=>t.map(r=>r&&typeof r=="string"&&r[0]==="="?this.UntranslateFunction(r):r)):e.map(t=>t&&typeof t=="string"&&t[0]==="="?this.UntranslateFunction(t):t):(e&&typeof e=="string"&&e[0]==="="&&(e=this.UntranslateFunction(e)),e)}TranslateInternal(e,t,r,i){let n=this.parser.Parse(e);if(n.expression){let o=!1;if(this.parser.Walk(n.expression,s=>{if(s.type==="call"){let a=t[s.name.toUpperCase()];a&&(o=!0,s.name=a)}else s.type==="literal"&&typeof s.value=="boolean"&&(o=!0);return!0}),o)return"="+this.parser.Render(n.expression,{missing:"",boolean_true:r,boolean_false:i})}return e}SetLanguage(e){if(this.language_model=e,!e)this.SetLanguageMap(),this.parser.flags.boolean_true="TRUE",this.parser.flags.boolean_false="FALSE";else{let t={};if(e.functions)for(let r of e.functions||[])t[r.base.toUpperCase()]=r.name;this.SetLanguageMap(t),e.boolean_false||(e.boolean_false=t.FALSE),e.boolean_true||(e.boolean_true=t.TRUE),this.parser.flags.boolean_true=e.boolean_true||"TRUE",this.parser.flags.boolean_false=e.boolean_false||"FALSE"}for(let t of this.sheets.list)t.FlushCellStyles()}};var Ki=()=>({target:{row:0,column:0},area:new y({row:0,column:0}),empty:!0});var Qo=100,Yi={move_with_cells:!0,resize_with_cells:!0,movable:!0,resizable:!0,removable:!0,selectable:!0},Ne=class{data={...Yi};get key(){return this.key_}rect;scaled_rect;temp={};view=[];dirty;key_=Qo++;constructor(e={}){this.data={...Yi,...JSON.parse(JSON.stringify(e))},e.rect&&(this.rect=B.Create(e.rect))}toJSON(){return{...this.data,rect:this.rect}}};var Zo=100,Qi=60,ee=class l{static base_id=100;static default_sheet_name="Sheet1";default_style_properties;annotations=[];freeze={rows:0,columns:0};visible=!0;default_column_width=100;default_row_height=25;cells=new Rt;selection=Ki();scroll_offset={x:0,y:0};name=l.default_sheet_name;tab_color;background_image;_image=void 0;flush_conditional_formats=!1;get image(){return this._image}conditional_formats=[];data_validation=[];outline;id_;row_height_map=new Map;column_width_=[];row_headers=[];column_headers=[];row_header_width=100;column_header_height=25;style_map=[];style_json_map=[];sheet_style={};row_styles={};column_styles={};row_pattern=[];cell_style=[];conditional_format_cache=[];conditional_format_checklist=[];get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(e){this.id_=e,this.id>=l.base_id&&(l.base_id=this.id+1)}constructor(e){this.default_style_properties=e,this.default_column_width=Zo,this.row_header_width=Qi,this.id_=l.base_id++}static Reset(){this.base_id=100}static Blank(e,t,r=30,i=20,n){let o=new l(e);return n&&o.UpdateDefaultRowHeight(n),t&&(o.name=t),r=Math.max(r,1),i=Math.max(i,1),o.cells.EnsureCell({row:r-1,column:i-1}),o}static UpdateStyle(e){if(typeof e.horizontal_align=="number"){let t=["","left","center","right"];e.horizontal_align=t[e.horizontal_align]||void 0}if(typeof e.vertical_align=="number"){let t=["","top","bottom","middle"];e.vertical_align=t[e.vertical_align]||void 0}}static FromJSON(e,t,r){let i=typeof e=="string"?JSON.parse(e):e,n=(c,d)=>{Object.keys(d).forEach(u=>{let h=Number(u)||0;c[h]=d[u]})};r||(r=new l(t)),i.default_column_width&&(r.default_column_width=i.default_column_width),i.default_row_height&&(r.default_row_height=i.default_row_height),i.conditional_formats&&(r.conditional_formats=i.conditional_formats),r.data_validation=(i.data_validations||[]).map(c=>({...c,target:(c.target||[]).map(d=>new y(d.start,d.end))})),i.id&&(r.id=i.id),i.name&&(r.name=i.name),i.tab_color&&(r.tab_color=i.tab_color),i.background_image&&(r.background_image=i.background_image);let o=c=>{let d=c;this.UpdateStyle(d),(d.font_size_value||d.font_size_unit)&&(d.font_size={unit:d.font_size_unit||"pt",value:d.font_size_value||10},d.font_size_unit=void 0,d.font_size_value=void 0),d.font_bold&&(d.bold=!0,d.font_bold=void 0),d.font_italic&&(d.italic=!0,d.font_italic=void 0),d.font_underline&&(d.underline=!0,d.font_underline=void 0),d.font_strike&&(d.strike=!0,d.font_strike=void 0),d.text_color&&(d.text_color!=="none"&&(d.text={text:d.text_color}),d.text_color=void 0),d.background&&(d.background!=="none"&&(d.fill={text:d.background}),d.background=void 0),d.border_top_color&&(d.border_top_color!=="none"&&(d.border_top_fill={text:d.border_top_color}),d.border_top_color=void 0),d.border_left_color&&(d.border_left_color!=="none"&&(d.border_left_fill={text:d.border_left_color}),d.border_left_color=void 0),d.border_bottom_color&&(d.border_bottom_color!=="none"&&(d.border_bottom_fill={text:d.border_bottom_color}),d.border_bottom_color=void 0),d.border_right_color&&(d.border_right_color!=="none"&&(d.border_right_fill={text:d.border_right_color}),d.border_right_color=void 0)},s=i.styles||i.cell_style_refs||[];for(let c of s)o(c);if(r.cell_style=[],s&&(i.cell_styles||[]).forEach(c=>{typeof c.ref=="number"&&(c.style=JSON.parse(JSON.stringify(s[c.ref])))}),r.cells.FromJSON(i.data),i.rows&&r.cells.EnsureRow(i.rows-1),i.columns&&r.cells.EnsureColumn(i.columns-1),i.data)if(dt(i.data))for(let c of i.data)c.style_ref&&(r.cell_style[c.column]||(r.cell_style[c.column]=[]),r.cell_style[c.column][c.row]=JSON.parse(JSON.stringify(s[c.style_ref])));else if(Ir(i.data))for(let c of i.data){let d=c.row;for(let u of c.cells){let h=u.column;u.style_ref&&(r.cell_style[h]||(r.cell_style[h]=[]),r.cell_style[h][d]=JSON.parse(JSON.stringify(s[u.style_ref])))}}else for(let c of i.data){let d=c.column;for(let u of c.cells){let h=u.row;u.style_ref&&(r.cell_style[d]||(r.cell_style[d]=[]),r.cell_style[d][h]=JSON.parse(JSON.stringify(s[u.style_ref])))}}r.freeze.rows=0,r.freeze.columns=0,i.freeze&&(r.freeze.rows=i.freeze.rows||0,r.freeze.columns=i.freeze.columns||0),r.scroll_offset=i.scroll?{...i.scroll}:{x:0,y:0};for(let c of i.cell_styles||[])if(c.style&&(r.cell_style[c.column]||(r.cell_style[c.column]=[]),r.cell_style[c.column][c.row]=c.style,c.rows))for(let d=1;d<c.rows;d++)r.cell_style[c.column][c.row+d]=JSON.parse(JSON.stringify(c.style));r.sheet_style=i.sheet_style||{},r.column_styles={},r.row_styles={};let a=(c,d)=>{for(let u of Object.keys(c)){let h=Number(u),m=c[h];if(typeof m=="number"){let f=s[m];f&&(d[h]=JSON.parse(JSON.stringify(f)),o(d[h]))}else m&&(d[h]=m,o(d[h]))}};a(i.row_style,r.row_styles),a(i.column_style,r.column_styles),r.row_pattern=i.row_pattern||[],o(r.sheet_style||{});for(let c of r.row_pattern)o(c);if(r.row_height_map=new Map,i.row_height)for(let[c,d]of Object.entries(i.row_height))r.row_height_map.set(Number(c),d);if(r.row_height_map.size>0){let c=Math.max(...r.row_height_map.keys());r.cells.EnsureRow(c)}return r.column_width_=[],n(r.column_width_,i.column_width||{}),r.column_width_.length&&r.cells.EnsureColumn(r.column_width_.length-1),r.annotations=(i.annotations||[]).map(c=>new Ne(c)),i.selection&&(r.selection=JSON.parse(JSON.stringify(i.selection))),r.visible=!0,typeof i.visible<"u"&&(r.visible=!!i.visible),r}AddValidation(e){this.data_validation.push({...e,target:(e.target||[]).map(t=>new y(t.start,t.end))})}RemoveValidations(e){let t=new y(e.start,e.end);this.data_validation=this.data_validation.filter(r=>(r.target=r.target.filter(i=>!t.Equals2(i)),r.target.length>0))}GetValidation(e){let t=[];for(let r of this.data_validation)for(let i of r.target)if(i.Contains(e)){t.push(r);break}return t}Activate(e){if(this.background_image){let t=Tt(this.background_image);t&&(this._image=e.Create("img"),this._image.src=t)}}MergeCells(e){e=e.Clone();let t=[...this.cells.Iterate(e,!0)];for(let[r,i]of t.entries())i.merge_area=e,i.render_clean=[],r&&i.Reset()}UnmergeCells(e){for(let t of this.cells.Iterate(e,!1))if(!t.merge_area||!e.Equals(t.merge_area)){console.warn("area mismatch");return}for(let t of this.cells.Iterate(e,!1))t.merge_area=void 0,t.render_clean=[]}UpdateDefaultRowHeight(e,t=1){if(typeof window<"u"){let r=I.Composite([this.default_style_properties,this.sheet_style]),i=I.CompositeFont(e.grid_cell_font_size,r,t,e),o=Ge(i.font,i.variants).height*1.25;this.default_row_height<o&&(this.default_row_height=o)}}SetRowHeaders(e){this.row_headers=e.map(t=>t===void 0?"":t.toString()),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(e){this.column_headers=e.map(t=>t===void 0?"":t.toString()),e&&this.cells.EnsureColumn(e.length-1)}RowHeader(e){return this.row_headers?this.row_headers.length>e?this.row_headers[e]:"":e+1}ColumnHeader(e){let t="";if(this.column_headers)return this.column_headers.length>e?this.column_headers[e]:"";for(;;){let r=e%26;if(t=String.fromCharCode(65+r)+t,e=Math.floor(e/26),e)e--;else break}return t}GetRowHeight(e){let t=this.row_height_map.get(e);return typeof t>"u"?this.default_row_height:t}SetRowHeight(e,t){return this.row_height_map.set(e,t),this.cells.EnsureRow(e),t}GetColumnWidth(e){let t=this.column_width_[e];return typeof t>"u"?this.default_column_width:t}SetColumnWidth(e,t){return this.column_width_[e]=t,this.cells.EnsureColumn(e),t}Delta(e,t){let r={},i=[...Object.keys(e),...Object.keys(t)];for(let n of i){let o=e[n],s=t[n];typeof o=="object"&&typeof s=="object"?JSON.stringify(o)!==JSON.stringify(s)&&(r[n]=s):o!==s&&(r[n]=s)}return r}UpdateCellStyle(e,t,r=!0){let{row:i,column:n}=e;this.cell_style[n]||(this.cell_style[n]=[]);let o=this.CompositeStyleForCell(e,!1,!1,void 0,!1),s=I.Composite([this.default_style_properties,o,I.Merge(this.cell_style[n][i]||{},t,r)]),a=this.Delta(o,s);this.cell_style[n][i]=a,this.BleedFlush({start:e,end:e})}Invalidate(e){for(let t of this.cells.Iterate(this.RealArea(e),!1))t.render_clean=[]}UpdateAreaStyle(e,t={},r=!0){if(e)if(e.entire_sheet)this.UpdateSheetStyle(t,r);else if(e.entire_column)for(let i=e.start.column;i<=e.end.column;i++)this.UpdateColumnStyle(i,t,r);else if(e.entire_row)for(let i=e.start.row;i<=e.end.row;i++)this.UpdateRowStyle(i,t,r);else for(let i of e)this.UpdateCellStyle(i,t,r)}HasCellStyle(e){return!!(this.cell_style[e.column]&&this.cell_style[e.column][e.row]||this.row_styles[e.row]||this.column_styles[e.column]||this.row_pattern.length)}NextVisibleColumn(e){for(++e;this.column_width_[e]===0;e++);return e}PreviousVisibleColumn(e){for(--e;e>=0&&this.column_width_[e]===0;e--);return e}NextVisibleRow(e){for(++e;this.GetRowHeight(e)===0;e++);return e}PreviousVisibleRow(e){for(--e;e>=0&&this.GetRowHeight(e)===0;e--);return e}TableRow(e,t){let r={alternate:!1,header:t===e.area.start.row,last:!1,totals:e.totals_row&&t===e.area.end.row};if(r.header||r.totals)return r;if(!(e.totals_row&&this.GetRowHeight(e.area.end.row)>0)){let s=e.area.end.row;for(;s>=e.area.start.row;s--)if(this.GetRowHeight(s)){r.last=s===t;break}}let n=e.area.start.row+1,o=t-n;for(let[s,a]of this.row_height_map.entries())if(!(s<n)){if(s>e.area.end.row)break;a||o--}return r.alternate=o%2===1,r}SurroundingStyle(e,t){let r=[{},{},{},{},{},{},{},{},{},{}],i=e.column+1,n=e.column-1,o=e.row+1,s=e.row-1;for(;this.column_width_[i]===0;i++);for(;this.GetRowHeight(o)===0;o++);for(;n>=0&&this.column_width_[n]===0;n--);for(;s>=0&&this.GetRowHeight(s)===0;s--);return n>=0&&s>=0&&(r[7]=this.CellStyleData({row:s,column:n},t)||{}),n>=0&&(r[4]=this.CellStyleData({row:e.row,column:n},t)||{},r[1]=this.CellStyleData({row:o,column:n},t)||{}),s>=0&&(r[8]=this.CellStyleData({row:s,column:e.column},t)||{},r[9]=this.CellStyleData({row:s,column:i},t)||{}),r[6]=this.CellStyleData({row:e.row,column:i},t)||{},r[2]=this.CellStyleData({row:o,column:e.column},t)||{},r[3]=this.CellStyleData({row:o,column:i},t)||{},r}CellStyleData(e,t){let r=this.cells.GetCell(e);if(r){if(!r.style){let i=this.GetStyleIndex(this.CompositeStyleForCell(e));r.style=this.style_map[i]}if(r.table){let i=r.table.theme||t;if(i){let n=JSON.parse(JSON.stringify(r.style)),o=this.TableRow(r.table,e.row);return o.header?i.header&&(n=I.Composite([n,i.header])):o.totals?i.total&&(n=I.Composite([n,i.total])):o.alternate?i.odd&&(n=I.Composite([n,i.odd])):i.even&&(n=I.Composite([n,i.even])),n}}return r.style}}GetCopyStyle(e){return this.CompositeStyleForCell(e,!0,!1,void 0,!1)}CellData(e){let t=this.cells.EnsureCell(e);if(t.rendered_type)return t;let r,i;if(t.calculated_type?(i=t.calculated,r=t.calculated_type):(i=t.value,r=t.type),!t.style){let n=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[n]}if(!r||i===null||typeof i>"u")t.formatted="",t.rendered_type=2;else if(r===3)isNaN(i)?t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan:t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=3;else if(r===6)t.formatted="#"+(i||"ERR?"),t.rendered_type=6;else if(r===4)t.formatted=i.toString().toUpperCase(),t.rendered_type=4;else if(r===1&&t.calculated===void 0)t.formatted="",t.rendered_type=2;else if(r===7){let n=i;if(isNaN(n.real)||isNaN(n.imaginary))t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan;else{let o=L.Get(t.style.number_format||"",!0);t.formatted=o.FormatComplex(n)}t.rendered_type=7}else if(r===9){if(isNaN(i.value))t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan,t.formatted+=" "+i.unit;else{let n=L.Get(t.style.number_format||"",!0);t.formatted=n.FormatDimensionedQuantity(i)}t.rendered_type=9}else t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=2;return t}FormatNumber(e,t=""){let r=L.Get(t).FormatParts(e);return r.length?r.length===1&&!r[0].flag?r[0].text||"":r:""}SetHeaderSize(e=Qi,t=this.default_row_height){this.row_header_width=e,this.column_header_height=t}GetStyle(e){return this.style_map[e]}InsertRows(e=0,t=1){if(e)for(let c=0;c<this.cells.columns;c++){let d=this.cells.GetCell({row:e-1,column:c},!1);if(d&&d.area){let u=this.cells.GetCell({row:e,column:c},!1);if(u&&u.area&&u.area.Equals(d.area))return!1}}t<0?this.cells.DeleteRows(e,-t):this.cells.InsertRows(e,t);let r={},i={};for(let c=e;c<this.cells.rows;c++)for(let d=0;d<this.cells.columns;d++){let u=this.cells.GetCell({row:c,column:d},!1);u&&(u.area&&!i[u.area.spreadsheet_label]&&(i[u.area.spreadsheet_label]=u.area),u.merge_area&&!r[u.merge_area.spreadsheet_label]&&(r[u.merge_area.spreadsheet_label]=u.merge_area))}for(let c of Object.keys(i)){let d=i[c],u=new y({row:d.start.row+t,column:d.start.column},{row:d.end.row+t,column:d.end.column});for(let h of u){let m=this.cells.GetCell(h,!0);m.area=u}}for(let c of Object.keys(r)){let d=r[c],u={row:d.start.row,column:d.start.column};d.start.row>=e&&(u.row+=t);let h=new y(u,{row:d.end.row+t,column:d.end.column});for(let m of h){let f=this.cells.GetCell(m,!0);f.merge_area=h}}let n=Object.keys(this.row_styles),o={};n.forEach(c=>{let d=Number(c);d<e?o[d]=this.row_styles[d]:t<0&&d<e-t||(o[d+t]=this.row_styles[d])}),this.row_styles=o;let s=[];if(t<0)s=[e,-t];else{s=[e,0];for(let c=0;c<t;c++)s.push(void 0)}this.cell_style.forEach(c=>{c&&c.length>=e&&c.splice.apply(c,s)});let a=new Map;if(t>0)for(let[c,d]of this.row_height_map)c>=e?a.set(c+t,d):a.set(c,d);else if(t<0)for(let[c,d]of this.row_height_map)c>=e?c>=e-t&&a.set(c+t,d):a.set(c,d);return this.row_height_map=a,this.FlushCellStyles(),!0}InsertColumns(e=0,t=1){if(e)for(let a=0;a<this.cells.rows;a++){let c=this.cells.GetCell({row:a,column:e-1},!1);if(c&&c.area){let d=this.cells.GetCell({row:a,column:e},!1);if(d&&d.area&&d.area.Equals(c.area))return!1}}t<0?this.cells.DeleteColumns(e,-t):this.cells.InsertColumns(e,t);let r={},i={};for(let a=e;a<this.cells.columns;a++)for(let c=0;c<this.cells.rows;c++){let d=this.cells.GetCell({row:c,column:a},!1);d&&(d.area&&!i[d.area.spreadsheet_label]&&(i[d.area.spreadsheet_label]=d.area),d.merge_area&&!r[d.merge_area.spreadsheet_label]&&(r[d.merge_area.spreadsheet_label]=d.merge_area))}for(let a of Object.keys(i)){let c=i[a],d=new y({row:c.start.row,column:c.start.column+t},{row:c.end.row,column:c.end.column+t});for(let u of d){let h=this.cells.GetCell(u,!0);h.area=d}}for(let a of Object.keys(r)){let c=r[a],d={row:c.start.row,column:c.start.column};c.start.column>=e&&(d.column+=t);let u=new y(d,{row:c.end.row,column:c.end.column+t});for(let h of u){let m=this.cells.GetCell(h,!0);m.merge_area=u}}let n=Object.keys(this.column_styles),o={};n.forEach(a=>{let c=Number(a);c<e?o[c]=this.column_styles[c]:t<0&&c<e-t||(o[c+t]=this.column_styles[c])}),this.column_styles=o;let s=[];if(t<0)s=[e,-t];else{s=[e,0];for(let a=0;a<t;a++)s.push(void 0)}return this.cell_style.splice.apply(this.cell_style,s),this.column_width_.splice.apply(this.column_width_,s),this.FlushCellStyles(),!0}ClearArea(e){for(let t of this.cells.Iterate(this.RealArea(e),!1))t.Reset()}SetAreaValues2(e,t){e=this.RealArea(e),this.cells.SetArea(e,t)}SetArrayValue(e,t){e=this.RealArea(e);for(let i of this.cells.Iterate(e,!0))i.SetArray(e);this.cells.GetCell(e.start,!0).SetArrayHead(e,t)}SetCellValue(e,t){this.cells.GetCell(e,!0).Set(t)}TablesFromArea(e,t=!1){if(N(e)){let i=this.cells.GetCell(e,!1);return i?.table&&(!t||e.row===i.table.area.start.row)?[i.table]:[]}let r=new Set;for(let i=e.start.row;i<=e.end.row;i++)for(let n=e.start.column;n<=e.end.column;n++){let o=this.cells.GetCell({row:i,column:n},!1);o?.table&&!r.has(o.table)&&(!t||i===o.table.area.start.row)&&r.add(o.table)}return Array.from(r.values())}RealArea(e,t=!1){let r=e.start,i=e.end;return e.entire_row&&(r.column=0,r.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),e.entire_column&&(r.row=0,r.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),t&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new y(r,i)}GetCellStyle(e,t=!1){if(N(e))return this.CompositeStyleForCell(e,!0,!1,t);if(e.start.row===e.end.row&&e.start.column===e.end.column)return[[this.CompositeStyleForCell(e.start,!0,!1,t)]];let r=[];for(let i=e.start.row;i<=e.end.row;i++){let n=[];for(let o=e.start.column;o<=e.end.column;o++)n.push(this.CompositeStyleForCell({row:i,column:o},!0,!1,t));r.push(n)}return r}FormattedCellValue(e){let t=this.CellData(e);if(t)return typeof t.formatted=="string"?t.formatted:t.formatted?t.formatted.map(r=>{switch(r.flag){case 1:return" ";case 2:return" ";default:return r.text}}).join(""):t.value}GetFormattedRange(e,t=e){if(e.row===t.row&&e.column===t.column)return this.FormattedCellValue(e);let r=[];for(let i=e.row;i<=t.row;i++){let n=[];for(let o=e.column;o<=t.column;o++)n.push(this.FormattedCellValue({row:i,column:o}));r.push(n)}return r}NumberFormatsAndColors(e,t){let r=i=>{i.number_format&&(t[i.number_format]=1),Y(i.text)&&(e[i.text.text]=1),Y(i.fill)&&(e[i.fill.text]=1),Y(i.border_top_fill)&&(e[i.border_top_fill.text]=1),Y(i.border_left_fill)&&(e[i.border_left_fill.text]=1),Y(i.border_right_fill)&&(e[i.border_right_fill.text]=1),Y(i.border_bottom_fill)&&(e[i.border_bottom_fill.text]=1)};r(this.sheet_style);for(let i in this.row_styles)r(this.row_styles[i]);for(let i in this.column_styles)r(this.column_styles[i]);for(let i of this.row_pattern)r(i);for(let i of this.cell_style)if(i)for(let n of i)n&&r(n)}CompressCellStyles(e){let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(i)for(let n=0;n<i.length;n++){let o=i[n];if(o){let s=n+1;for(;s<i.length&&i[s]===o;s++);s>n+1?t.push({row:n,column:r,ref:o,rows:s-n}):t.push({row:n,column:r,ref:o}),n=s-1}}}return t}toJSON(e={}){let t=(S,A)=>{let R={};for(let k=0;k<S.length;k++)typeof S[k]<"u"&&S[k]!==A&&(R[k]=S[k]);if(Object.keys(R).length)return R},r=[{}],i={},n=[],o=JSON.stringify({});for(let S=0;S<this.cell_style.length;S++){let A=this.cell_style[S];if(A){n[S]=[];for(let R=0;R<A.length;R++)if(A[R]){let k=JSON.stringify(A[R]);if(k!==o){let z=i[k];typeof z!="number"&&(i[k]=z=r.length,r.push(A[R])),n[S][R]=z}}}}let s=S=>{let A=JSON.stringify(S);if(A===o)return 0;let R=i[A];return typeof R!="number"&&(i[A]=R=r.length,r.push(S)),R};r=JSON.parse(JSON.stringify(r));let a=JSON.parse(JSON.stringify(this.sheet_style)),c=JSON.parse(JSON.stringify(this.row_pattern)),d={},u={};for(let S of Object.keys(this.column_styles)){let A=Number(S),R=this.column_styles[A];if(R){let k=s(R);k&&(d[A]=k)}}if(this.row_pattern&&this.row_pattern.length&&e.apply_row_pattern){let S=this.rows+1;for(let A of Object.keys(this.row_styles)){let R=Number(A);!isNaN(R)&&R>=S&&(S=R+1)}for(let A=0;A<S;A++){let R=this.row_pattern[A%this.row_pattern.length],k=this.row_styles[A]||{},z=I.Composite([R,k]),W=s(z);W&&(u[A]=W)}}else for(let S of Object.keys(this.row_styles)){let A=Number(S),R=this.row_styles[A];if(R){let k=s(R);k&&(u[A]=k)}}let h=(S={},A={})=>{let R={...A,...S};if(Y(R))return R.text=oe.MeasureColorARGB(R.text),R;if(Ke(R))return R};if(e.export_colors){let S=[];for(let A of[r,[a],c])if(Array.isArray(A))for(let R of A)S.push(R);else for(let R of Object.keys(A))S.push(A[R]);for(let A of S){let R=h(A.border_top_fill,I.DefaultProperties.border_top_fill);R!==void 0&&(A.border_top_fill=R),R=h(A.border_left_fill,I.DefaultProperties.border_left_fill),R!==void 0&&(A.border_left_fill=R),R=h(A.border_right_fill,I.DefaultProperties.border_right_fill),R!==void 0&&(A.border_right_fill=R),R=h(A.border_bottom_fill,I.DefaultProperties.border_bottom_fill),R!==void 0&&(A.border_bottom_fill=R),Y(A.fill)&&(A.fill.text=oe.MeasureColorARGB(A.fill.text)),Y(A.text)&&(A.text.text=oe.MeasureColorARGB(A.text.text))}}let m={calculated_value:!!e.rendered_values,preserve_type:!!e.preserve_type,expand_arrays:!!e.expand_arrays,decorated_cells:!!e.decorated_cells,nested:!0,cell_style_refs:n,tables:!!e.tables},f=this.cells.toJSON(m),p=f.data,{rows:b,columns:g}=f;e.shrink?(b+=2,g+=1):(b=this.rows,g=this.columns);for(let S of this.annotations)S.data.extent||this.CalculateAnnotationExtent(S),S.data.extent&&(b=Math.max(b,S.data.extent.row+1),g=Math.max(g,S.data.extent.column+1));let x=this.CompressCellStyles(n),v=this.conditional_formats.length?JSON.parse(JSON.stringify(this.conditional_formats.map(S=>({...S,internal:void 0})))):void 0,w=this.data_validation.length?JSON.parse(JSON.stringify(this.data_validation)):void 0,_={};for(let[S,A]of this.row_height_map.entries())_[S]=A;let C={id:this.id,name:this.name,tab_color:this.tab_color,data:p,sheet_style:a,rows:b,columns:g,cell_styles:x,styles:r,row_style:u,column_style:d,conditional_formats:v,data_validations:w,row_pattern:c.length?c:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:_,column_width:t(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(C.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(C.scroll=this.scroll_offset),this.background_image&&(C.background_image=this.background_image),(this.freeze.rows||this.freeze.columns)&&(C.freeze=this.freeze),C}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(e){let t=e.styles;e.outline&&(this.outline=e.outline);let r=e.sheet_style;r&&this.UpdateAreaStyle(new y({row:1/0,column:1/0},{row:1/0,column:1/0}),t[r]);let i=e.column_styles;if(i)for(let o=0;o<i.length;o++)i[o]&&this.UpdateAreaStyle(new y({row:1/0,column:o},{row:1/0,column:o}),t[i[o]]);if(e.row_styles)for(let[o,s]of e.row_styles.entries())s&&this.UpdateAreaStyle(new y({row:o,column:1/0}),t[s]);this.cells.FromJSON(e.cells),e.name&&(this.name=e.name||""),e.tab_color&&(this.tab_color=e.tab_color);let n=this.cell_style;for(let o of e.cells)o.style_ref&&(n[o.column]||(n[o.column]=[]),n[o.column][o.row]=t[o.style_ref]);for(let o=0;o<e.column_widths.length;o++)typeof e.column_widths[o]<"u"&&this.SetColumnWidth(o,e.column_widths[o]);for(let o=0;o<e.row_heights.length;o++)typeof e.row_heights[o]<"u"&&this.SetRowHeight(o,e.row_heights[o]);for(let o of e.annotations||[])this.annotations.push(new Ne(o));for(let o of e.conditional_formats||[])this.conditional_formats.push(o);for(let o of e.data_validations||[])this.AddValidation(o);e.hidden&&(this.visible=!1)}CalculateAnnotationExtent(e){if(e.data.layout){e.data.extent={...e.data.layout.br.address};return}let t=1e3;e.data.extent={row:0,column:0};let r=e.rect?.right;if(r&&this.default_column_width){for(let n=0;r>=0&&n<t;n++)if(r-=this.GetColumnWidth(n),r<0){e.data.extent.column=n;break}}let i=e.rect?.bottom;if(i&&this.default_row_height){for(let n=0;i>=0&&n<t;n++)if(i-=this.GetRowHeight(n),i<0){e.data.extent.row=n;break}}}UpdateSheetStyle(e,t=!0){this.sheet_style=I.Merge(this.sheet_style,e,t);let r=Object.keys(e);for(let i of this.cell_style)if(i)for(let n of i)n&&r.forEach(o=>delete n[o]);for(let i of Object.keys(this.row_styles))r.forEach(n=>delete this.row_styles[i][n]);for(let i of Object.keys(this.column_styles))r.forEach(n=>delete this.column_styles[i][n]);this.FlushCellStyles()}UpdateRowStyle(e,t,r=!0){this.row_styles[e]=I.Merge(this.row_styles[e]||{},t,r);let i=Object.keys(t);for(let n of this.cell_style)n&&n[e]&&i.forEach(o=>delete n[e][o]);for(let n=0;n<this.cells.columns;n++)if(this.column_styles[n]){let o=this.column_styles[n],s=this.cell_style[n]?this.cell_style[n][e]||{}:{};for(let a of i)typeof o[a]<"u"&&(s[a]=t[a]);Object.keys(s).length&&(this.cell_style[n]||(this.cell_style[n]=[]),this.cell_style[n][e]=JSON.parse(JSON.stringify(s)))}for(let n of this.cells.Iterate(this.RealArea(y.FromRow(e))))n.FlushStyle()}UpdateColumnStyle(e,t,r=!0){this.column_styles[e]=I.Merge(this.column_styles[e]||{},t,r);let i=Object.keys(t);if(this.cell_style[e])for(let n of this.cell_style[e])n&&i.forEach(o=>delete n[o]);for(let n of this.cells.Iterate(this.RealArea(y.FromColumn(e))))n.FlushStyle()}BleedFlush(e){let t=[Math.max(0,e.start.row-1),e.end.row+1],r=[Math.max(0,e.start.column-1),e.end.column+1];for(let i=t[0];i<=t[1];i++)for(let n=r[0];n<=r[1];n++)this.cells.GetCell({row:i,column:n},!1)?.FlushStyle()}FlushConditionalFormats(){this.flush_conditional_formats=!0}ApplyConditionalFormats(){let e=this.flush_conditional_formats;for(let i of this.conditional_formats)if(i.internal?.vertex?.updated){e=!0;break}if(!e)return;this.flush_conditional_formats=!1;let t=[],r=[...this.conditional_format_checklist];this.conditional_format_checklist=[];for(let i of this.conditional_formats){i.internal?.vertex?.updated&&(i.internal.vertex.updated=!1);let n=JSON.parse(JSON.stringify(i.area));(n.start.row===null||n.end.row===null)&&(n.start.row=0,n.end.row=this.cells.rows-1),(n.start.column===null||n.end.column===null)&&(n.start.column=0,n.end.column=this.cells.columns-1);let o=i.internal?.vertex?.result;if(i.type==="gradient"){if(o&&i.internal?.gradient){let s=i.property??"fill";if(o.type===8)for(let a=n.start.row;a<=n.end.row;a++)for(let c=n.start.column;c<=n.end.column;c++){let d=o.value[c-n.start.column][a-n.start.row];if(d.type===3){t[a]||(t[a]=[]),t[a][c]||(t[a][c]=[]);let u=i.internal.gradient.Interpolate(d.value);t[a][c].push({[s]:u})}}else if(o.type===3){let a=i.internal.gradient.Interpolate(o.value);for(let c=n.start.row;c<=n.end.row;c++){t[c]||(t[c]=[]);for(let d=n.start.column;d<=n.end.column;d++)t[c][d]||(t[c][d]=[]),t[c][d].push({[s]:a})}}r.push(n),this.conditional_format_checklist.push(n)}}else if(o){if(o.type===8)for(let s=n.start.row;s<=n.end.row;s++)for(let a=n.start.column;a<=n.end.column;a++){let c=o.value[a-n.start.column][s-n.start.row];c&&(c.type===4||c.type===3)&&c.value&&(t[s]||(t[s]=[]),t[s][a]||(t[s][a]=[]),t[s][a].push(i.style))}else if((o.type===4||o.type===3)&&o.value)for(let s=n.start.row;s<=n.end.row;s++){t[s]||(t[s]=[]);for(let a=n.start.column;a<=n.end.column;a++)t[s][a]||(t[s][a]=[]),t[s][a].push(i.style)}r.push(n),this.conditional_format_checklist.push(n)}}for(let i of r)this.BleedFlush(i);this.conditional_format_cache=t}ConditionalFormatForCell(e){return this.conditional_format_cache[e.row]?this.conditional_format_cache[e.row][e.column]||[]:[]}CompositeStyleForCell(e,t=!0,r=!0,i=!0,n=!0){let{row:o,column:s}=e,a=[];return i&&a.push(this.default_style_properties),a.push(this.sheet_style),r&&this.row_pattern.length&&a.push(this.row_pattern[o%this.row_pattern.length]),this.row_styles[o]&&a.push(this.row_styles[o]),this.column_styles[s]&&a.push(this.column_styles[s]),t&&this.cell_style[s]&&this.cell_style[s][o]&&a.push(this.cell_style[s][o]),n&&a.push(...this.ConditionalFormatForCell(e)),I.Composite(a)}GetStyleIndex(e){let t=JSON.stringify(e);for(let i=0;i<this.style_json_map.length;i++)if(t===this.style_json_map[i])return i;let r=this.style_map.length;return this.style_map.push(JSON.parse(t)),this.style_json_map.push(t),r}};var Zi={"red-green":{color_space:"RGB",stops:[{value:0,color:{theme:5,tint:.5}},{value:1,color:{theme:9,tint:.5}}]},"red-yellow-green":{color_space:"RGB",stops:[{value:0,color:{theme:5,tint:.5}},{value:.5,color:{theme:7,tint:.5}},{value:1,color:{theme:9,tint:.5}}]},"green-red":{color_space:"RGB",stops:[{value:0,color:{theme:9,tint:.5}},{value:1,color:{theme:5,tint:.5}}]},"green-yellow-red":{color_space:"RGB",stops:[{value:0,color:{theme:9,tint:.5}},{value:.5,color:{theme:7,tint:.5}},{value:1,color:{theme:5,tint:.5}}]}};var Kt=class l{static type="vertex";type=l.type;color=0;edges_in=new Set;edges_out=new Set;get has_inbound_edges(){return this.edges_in.size>0}get has_outbound_edges(){return this.edges_out.size>0}Reset(){for(let e of this.edges_out)e.RemoveDependency(this);for(let e of this.edges_in)e.RemoveDependent(this);this.edges_out.clear(),this.edges_in.clear()}ClearDependencies(){for(let e of this.edges_in)e.RemoveDependent(this);this.edges_in.clear()}AddDependent(e){e!==this&&(this.edges_out.has(e)||this.edges_out.add(e))}RemoveDependent(e){this.edges_out.delete(e)}AddDependency(e){e!==this&&(this.edges_in.has(e)||this.edges_in.add(e))}RemoveDependency(e){this.edges_in.delete(e)}LinkTo(e){this.AddDependent(e),e.AddDependency(this)}DependsOn(e){this.AddDependency(e),e.AddDependent(this)}LoopCheck(){let e=[this];for(;e.length;){let t=e[e.length-1],r=!0;if(t.color!==2){t.color=1;for(let i of t.edges_out){if(i.color===1)return this.color=0,!0;i.color===0&&i.edges_out.size&&(e.push(i),r=!1)}}r&&(t.color=2,e.pop())}return this.color=2,!1}};var Ze=class extends Kt{dirty=!1};var en={error:"NOTIMPL"},ve=()=>({type:6,value:"N/A"}),Ae=()=>({type:6,value:"EXPR"});var _e=()=>({type:6,value:"DIV/0"}),D=()=>({type:6,value:"ARG"}),M=()=>({type:6,value:"VALUE"}),$=()=>({type:6,value:"REF"}),Jr=()=>({type:6,value:"NAME"}),tn=()=>({type:6,value:"SPILL"}),Yt=()=>({type:6,value:"UNK"});var De=class l extends Ze{static type="spreadsheet-vertex";reference;error=0;address;result={type:0};expression={type:"missing",id:-1};expression_error=!1;short_circuit=!1;type=l.type;get array_head(){return this.address?!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row:!1}TakeReferenceValue(){this.reference&&(this.result=X(this.reference.GetValue()))}Calculate(e){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){this.reference&&(this.array_head||this.reference.type===1)&&this.reference.SetCalculationError("LOOP");for(let t of this.edges_out)t.Calculate(e);return}for(let t of this.edges_in)if(t.dirty)return;if(this.reference){if(this.reference.type===1){this.short_circuit=!1;let t=e.CalculationCallback.call(e,this);if(this.result=t.value,this.short_circuit)return;t.volatile&&e.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)e.SpreadCallback.call(e,this,this.result);else if(this.reference.type===1)if(this.result.type===8){let t=e.SpillCallback.call(e,this,this.result);if(t)for(let r of t)for(let i of r.edges_out)i.dirty=!0,i.Calculate(e)}else this.reference.SetCalculatedValue(this.result.value,this.result.type)}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(let t of this.edges_out)t.dirty&&e.calculation_list.push(t)}}};var Be=class l extends Ze{static type="array-vertex";static list=[];type=l.type;area;static GetVertex(e){for(let t of this.list)if(t.area.start.sheet_id===e.start.sheet_id&&t.area.Equals(e))return[t,!1];return[new l(e),!0]}static Clear(){this.list=[]}static GetContainingArrays(e){let t=[];for(let r of this.list)r.area.start.sheet_id===e.sheet_id&&r.area.Contains(e)&&t.push(r);return t}static CreateImplicitEdges(e,t){for(let r of this.list)r.area.start.sheet_id===t.sheet_id&&r.area.Contains(t)&&r.DependsOn(e)}constructor(e){super(),this.area=e.Clone(),l.list.push(this)}RemoveDependent(e){super.RemoveDependent(e),this.edges_out.size||(this.Reset(),l.list=l.list.filter(t=>t!==this))}Calculate(e){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){for(let t of this.edges_out)t.Calculate(e);return}for(let t of this.edges_in)if(t.dirty)return;this.dirty=!1;for(let t of this.edges_out)t.Calculate(e)}}};var Zt=class l extends De{static type="calculation-leaf-vertex";type=l.type;address={row:-1,column:-1};use;updated=!1;color=2;Calculate(e){if(!this.dirty)return;for(let r of this.edges_in)if(r.dirty)return;let t=e.CalculationCallback.call(e,this);this.result=t.value,this.dirty=!1,this.updated=!0}AddDependent(){throw new Error("leaf vertex cannot have dependents")}};var er=class{vertices=[[]];volatile_list=[];calculation_list=[];spill_data=[];loop_hint;leaf_vertices=new Set;dirty_list=[];loop_check_required=!1;IsSpreadsheetVertex(e){return e.type===De.type}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices.clear(),Be.Clear()}ResolveArrayHead(e){if(!e.sheet_id)throw new Error("resolve array head with no sheet id");let t=this.model.sheets.Find(e.sheet_id)?.cells;if(!t)throw new Error("no cells? sheet id "+e.sheet_id);let r=t.data[e.row];if(r){let i=r[e.column];if(i&&i.area){let n={row:i.area.start.row,column:i.area.start.column,sheet_id:e.sheet_id};return console.info("array head",e,n),n}}return e}*IterateVertices(e,t=!1){for(let r of Wt.Iterate(e)){let i=this.GetVertex(r,t);i&&(yield i)}}GetVertex(e,t){if(!e.sheet_id)throw console.info(JSON.stringify({address:e,create:t})),console.trace(),new Error("getvertex with no sheet id");let r=this.model.sheets.Find(e.sheet_id)?.cells;if(!r)throw new Error("no cells? sheet id "+e.sheet_id);if(!this.vertices[e.sheet_id]){if(!t)return;this.vertices[e.sheet_id]=[]}if(this.vertices[e.sheet_id][e.column]){let n=this.vertices[e.sheet_id][e.column][e.row];if(n)return n;if(!t)return}else{if(!t)return;this.vertices[e.sheet_id][e.column]=[]}let i=new De;return i.address={row:e.row,column:e.column,absolute_row:e.absolute_row,absolute_column:e.absolute_column,sheet_id:e.sheet_id},i.reference=r.EnsureCell(e),this.vertices[e.sheet_id][e.column][e.row]=i,Be.CreateImplicitEdges(i,e),i}RemoveVertex(e){if(!e.sheet_id)throw new Error("removevertex with no sheet id");let t=this.GetVertex(e,!1);t&&(t.Reset(),this.vertices[e.sheet_id][e.column][e.row]=void 0)}ResetVertex(e){let t=this.GetVertex(e,!1);t&&t.Reset()}RIBcount=0;ResetInbound(e,t=!1,r=!0,i=!1){this.RIBcount++;let n=this.GetVertex(e,r);if(!n){if(t){let s=Be.GetContainingArrays(e);for(let a of s)this.SetVertexDirty(a)}return}let o=[];if(i&&(o=Array.from(n.edges_in)),n.ClearDependencies(),t&&this.SetVertexDirty(n),i){n.has_outbound_edges||this.RemoveVertex(e);for(let s of o)if(!s.has_inbound_edges&&!s.has_outbound_edges){let a=s;a.address&&this.RemoveVertex(a.address)}}}ResetLoopState(){for(let e of this.vertices)if(e){for(let t of e)if(t)for(let r of t)r&&(r.color=r.edges_out.size?0:2)}for(let e of this.leaf_vertices)e.color=2}LoopCheck(e=!1){if(!this.loop_check_required&&!e)return!1;let t=[];for(let i of this.vertices)if(i){for(let n of i)if(n)for(let o of n)o&&(o.color=o.edges_out.size?0:2,t.push(o))}let r=[];for(let i of t)if(i.color===0){for(i.color=1,r.push(i);r.length;){let n=r[r.length-1],o=!0;if(n.color!==2)for(let s of n.edges_out){if(s.color===1)return this.loop_hint=this.RenderAddress(i.address),console.info("loop detected @",this.loop_hint),!0;s.color===0&&(r.push(s),o=!1)}o&&(r.pop(),n.color=2)}i.color=2}return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(e){if(!e)return"undefined";let t="";if(e.sheet_id){let i=this.model.sheets.Find(e.sheet_id);i&&(t=i.name+"!")}let r=new y(e);return t+r.spreadsheet_label}CompositeAddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let[r,i]=Be.GetVertex(e);if(t.DependsOn(r),this.loop_check_required=!0,!i)return;let n=this.vertices[e.start.sheet_id];if(n){if(e.entire_row){for(let o=0;o<n.length;o++)if(n[o])for(let s=e.start.row;s<=e.end.row;s++){let a=n[o][s];a&&r.DependsOn(a)}}else if(e.entire_column){for(let o=e.start.column;o<=e.end.column;o++)if(n[o])for(let s of n[o])s?.address&&r.DependsOn(s)}else for(let o=e.start.row;o<=e.end.row;o++)for(let s=e.start.column;s<=e.end.column;s++)if(n[s]){let a=n[s][o];a&&r.DependsOn(a)}}}AddLeafVertexArrayEdge(e,t){this.CompositeAddArrayEdge(e,t)}AddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let r=this.GetVertex(t,!0);this.CompositeAddArrayEdge(e,r)}AddEdge(e,t){let r=this.GetVertex(e,!0);this.GetVertex(t,!0).DependsOn(r),r.reference&&r.reference.area&&!r.array_head&&this.AddEdge({...e,row:r.reference.area.start.row,column:r.reference.area.start.column},t),this.loop_check_required=!0}RemoveEdge(e,t){let r=this.GetVertex(e,!1),i=this.GetVertex(t,!1);!r||!i||(r.RemoveDependent(i),i.RemoveDependency(r))}SetAreaDirty(e){if(e.start.column===1/0||e.end.column===1/0||e.start.row===1/0||e.end.row===1/0)throw new Error("don't iterate over infinite area");let t=e.start.sheet_id;if(!t)throw new Error("invalid area, missing sheet id");for(let r=e.start.column;r<=e.end.column;r++)for(let i=e.start.row;i<=e.end.row;i++){let n={row:i,column:r,sheet_id:t};this.GetVertex(n,!1)&&this.SetDirty(n)}}SetVertexDirty(e){if(!e.dirty){this.dirty_list.push(e),e.dirty=!0;for(let t of e.edges_out)this.SetVertexDirty(t)}}SetDirty(e){let t=this.GetVertex(e,!0);this.SetVertexDirty(t)}AddLeafVertex(e){this.leaf_vertices.add(e)}RemoveLeafVertex(e){this.leaf_vertices.delete(e)}AddLeafVertexEdge(e,t){let r=this.GetVertex(e,!0);return t.DependsOn(r),0}RemoveLeafVertexEdge(e,t){let r=this.GetVertex(e,!1);r&&(r.RemoveDependent(t),t.RemoveDependency(r))}InitializeGraph(){for(let e of this.dirty_list)this.IsSpreadsheetVertex(e)&&(e.TakeReferenceValue(),this.CheckVolatile(e)&&this.volatile_list.push(e)),e.dirty=!1;this.dirty_list=[]}Recalculate(){for(let e of this.volatile_list)this.SetVertexDirty(e);this.spill_data=this.spill_data.filter(({area:e,vertex:t})=>{if(t.dirty){t.Reset();let r=e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id)?.cells:void 0;if(r)for(let{cell:i,row:n,column:o}of r.IterateRC(new y(e.start,e.end)))i.spill&&(i.spill=void 0,typeof i.value>"u"&&i.Reset()),this.SetDirty({row:n,column:o,sheet_id:e.start.sheet_id});return!1}return!0}),this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let e=0;e<this.calculation_list.length;e++)this.calculation_list[e].Calculate(this);this.calculation_list=[]}};var es=l=>{let e={m:l,n:l,array:[]};for(let t=0;t<l;t++){let r=[];for(let i=0;i<l;i++)r.push({real:0,imaginary:0});e.array.push(r)}return e};var ts=l=>{let{r:e,theta:t}=l,r=e*Math.cos(t),i=e*Math.sin(t);return{real:r,imaginary:i}},tr=l=>{let e=Math.sqrt(l.real*l.real+l.imaginary*l.imaginary),t=Math.atan2(l.imaginary,l.real);return{r:e,theta:t}},nn=l=>{let e={real:Math.sinh(l.real)*Math.cos(l.imaginary),imaginary:Math.cosh(l.real)*Math.sin(l.imaginary)},t={real:Math.cosh(l.real)*Math.cos(l.imaginary),imaginary:Math.sinh(l.real)*Math.sin(l.imaginary)};return Pe(e,t)},on=l=>Pe({real:Math.tan(l.real),imaginary:Math.tanh(l.imaginary)},{real:1,imaginary:-(Math.tan(l.real)*Math.tanh(l.imaginary))}),sn=l=>({real:Math.cosh(l.real)*Math.cos(l.imaginary),imaginary:Math.sinh(l.real)*Math.sin(l.imaginary)}),an=l=>({real:Math.cos(l.real)*Math.cosh(l.imaginary),imaginary:Math.sin(l.real)*Math.sinh(l.imaginary)}),ln=l=>({real:Math.sinh(l.real)*Math.cos(l.imaginary),imaginary:Math.cosh(l.real)*Math.sin(l.imaginary)}),rr=l=>({real:Math.sin(l.real)*Math.cosh(l.imaginary),imaginary:Math.cos(l.real)*Math.sinh(l.imaginary)}),Xr=l=>{if(l.imaginary===0)return{real:Math.asin(l.real),imaginary:0};let e=Math.hypot(l.real+1,l.imaginary)/2,t=Math.hypot(l.real-1,l.imaginary)/2,r=e+t,i=e-t,n={real:Math.asin(i),imaginary:Math.log(r+Math.sqrt(r*r-1))};return(l.imaginary<0||l.imaginary===0&&l.real>1)&&(n.imaginary=-n.imaginary),n},cn=l=>{if(l.imaginary===0)return{real:Math.acos(l.real),imaginary:0};let e=Xr(l);return{real:Math.PI/2-e.real,imaginary:e.imaginary}},dn=l=>{let{real:e,imaginary:t}=l;if(e===0){if(t>1)return{real:Math.PI/2,imaginary:.5*Math.log((t-1)/(t+1))};if(t<-1)return{real:-Math.PI/2,imaginary:.5*Math.log((1-t)/(-1-t))}}let r=e*e,i=t*t,n=.5*Math.atan2(2*e,1-r-i),o=.25*Math.log((r+(t+1)*(t+1))/(r+(t-1)*(t-1)));return{real:n,imaginary:o}},un=(l,e)=>{if(e.real===0&&e.imaginary===0&&l.real===0&&l.imaginary===0)return!1;let t=e.real*e.real+e.imaginary*e.imaginary,r={real:(l.real*e.real+l.imaginary*e.imaginary)/t,imaginary:(l.imaginary*e.real-l.real*e.imaginary)/t},i=r.real*r.real,n=r.imaginary*r.imaginary,o={real:.5*Math.atan2(2*r.real,1-i-n),imaginary:.25*Math.log((i+(r.imaginary+1)*(r.imaginary+1))/(i+(r.imaginary-1)*(r.imaginary-1)))};return e.real<0&&(o.real+=l.real>=0||l.imaginary>=0?Math.PI:-Math.PI),o},hn=(...l)=>{let e=l.shift();if(!e)return{real:0,imaginary:0};for(let t of l)e=ie(e,t);return e},ie=(l,e)=>({real:l.real*e.real-l.imaginary*e.imaginary,imaginary:l.real*e.imaginary+l.imaginary*e.real}),rs=(l,e)=>{let t=[];for(let r=0;r<l.m;r++){let i=[];for(let n=0;n<l.n;n++)i.push(l.array[r][n]+e.array[r][n]);t.push(i)}return{m:l.m,n:l.n,array:t}},Wr=(l,e)=>{let t=[];for(let r=0;r<l.m;r++){let i=[];for(let n=0;n<e.n;n++){let o=0;for(let s=0;s<l.n;s++)o+=l.array[r][s]*e.array[s][n];i.push(o)}t.push(i)}return{array:t,m:l.m,n:e.n}},mn=(l,e)=>{let t=[];for(let r=0;r<l.m;r++){let i=[];for(let n=0;n<e.n;n++){let o={real:0,imaginary:0};for(let s=0;s<l.n;s++)o.real+=l.array[r][s].real*e.array[s][n].real-l.array[r][s].imaginary*e.array[s][n].imaginary,o.imaginary+=l.array[r][s].real*e.array[s][n].imaginary+l.array[r][s].imaginary*e.array[s][n].real;i.push(o)}t.push(i)}return t},ir=l=>{let e={real:0,imaginary:0},t=l.n;if(t==2){let i=ie(l.array[0][0],l.array[1][1]),n=ie(l.array[1][0],l.array[0][1]);return{real:i.real-n.real,imaginary:i.imaginary-n.imaginary}}let r=es(l.n);for(let i=0;i<t;i++){let n=0;for(let a=1;a<t;a++){let c=0;for(let d=0;d<t;d++)d!=i&&(r.array[n][c]={...l.array[a][d]},c++);n++}r.m=r.n=t-1;let o=Math.pow(-1,i),s=ie({real:l.array[0][i].real*o,imaginary:l.array[0][i].imaginary*o},ir(r));e.real+=s.real,e.imaginary+=s.imaginary}return e};var is=l=>{let e={real_values:!1,imaginary_values:!1,square:l.m===l.n,unit_diagonal:!0},t={m:l.m,n:l.n,array:[]},r={m:l.m,n:l.n,array:[]};for(let i=0;i<l.m;i++){let n=l.array[i],o=[],s=[];for(let a=0;a<l.n;a++)n[a].real&&(e.real_values=!0),n[a].imaginary&&(e.imaginary_values=!0),a===i&&e.unit_diagonal&&(n[a].real!==1||n[a].imaginary!==0)&&(e.unit_diagonal=!1),o.push(n[a].real),s.push(n[a].imaginary);t.array.push(o),r.array.push(s)}return{real:t,imaginary:r,flags:e}},ns=l=>{let e=l.array.map(t=>t.slice(0));return{m:l.m,n:l.n,array:e}},rn=l=>{if(l.m!==l.n)return;let e=ns(l),t=e.array,r=0,i=0,n=0,o=0,s=l.m;for(i=1;i<s;i++)t[0][i]/=t[0][0];for(i=1;i<s;i++){for(n=i;n<s;n++){for(r=0,o=0;o<i;o++)r+=t[n][o]*t[o][i];t[n][i]-=r}if(i!=s-1)for(n=i+1;n<s;n++){for(r=0,o=0;o<i;o++)r+=t[i][o]*t[o][n];t[i][n]=(t[i][n]-r)/t[i][i]}}for(i=0;i<s;i++)for(n=i;n<s;n++){let a=1;if(i!=n)for(a=0,o=i;o<n;o++)a-=t[n][o]*t[o][i];t[n][i]=a/t[n][n]}for(i=0;i<s;i++)for(n=i;n<s;n++)if(i!=n){for(r=0,o=i;o<n;o++)r+=t[o][n]*(i==o?1:t[i][o]);t[i][n]=-r}for(i=0;i<s;i++)for(n=0;n<s;n++){for(r=0,o=i>n?i:n;o<s;o++)r+=(n==o?1:t[n][o])*t[o][i];t[n][i]=r}return e},fn=l=>{let e=[];if(l.m!==l.n)return;let{real:t,imaginary:r,flags:i}=is(l),n=rn(t);if(!n)return;if(!i.imaginary_values){for(let u=0;u<l.m;u++){let h=[];for(let m=0;m<l.n;m++)h.push({real:n.array[u][m],imaginary:0});e.push(h)}return e}let o=Wr(n,r),s=Wr(r,o),a=rs(t,s),c=rn(a);if(!c)return;let d=Wr(o,c);for(let u=0;u<l.m;u++){let h=[];for(let m=0;m<l.n;m++)h.push({real:c.array[u][m],imaginary:-d.array[u][m]});e.push(h)}return e},Pe=(l,e)=>{let t={real:e.real,imaginary:-e.imaginary},r=ie(l,t),i=ie(e,t);return{real:r.real/i.real,imaginary:r.imaginary/i.real}},gt=l=>{let e=l.real||0,t=l.imaginary||0;return ie({real:Math.exp(e),imaginary:0},{real:Math.cos(t),imaginary:Math.sin(t)})},Kr=l=>{let e=tr(l);return{real:Math.log(e.r),imaginary:e.theta}},ye=(l,e)=>{if(e.imaginary)return gt(ie(e,Kr(l)));{let t=tr(l);return ts({r:Math.pow(t.r,e.real),theta:t.theta*e.real})}};var pn=(l,e=0)=>l&&l.type===7?l:{type:7,value:{real:e,imaginary:0}},$e=l=>l.imaginary?{type:7,value:l}:{type:3,value:l.real},je=(l,e)=>{if(l.type===6)return[0,0,l];if(e.type===6)return[0,0,e];let t=[0,0];switch(l.type){case 3:t[0]=l.value;break;case 4:t[0]=l.value?1:0;break;case 0:break;case 7:t[3]=l;break;default:return[0,0,M()]}switch(e.type){case 3:t[1]=e.value;break;case 4:t[1]=e.value?1:0;break;case 0:break;case 7:t[4]=e;break;default:return[0,0,M()]}return(t[3]||t[4])&&(t[3]=pn(t[3],t[0]),t[4]=pn(t[4],t[1])),t},os=(l,e)=>{let[t,r,i,n,o]=je(l,e);return i||(n&&o?$e({real:n.value.real+o.value.real,imaginary:n.value.imaginary+o.value.imaginary}):{value:t+r,type:3})},Zr=(l,e)=>{let[t,r,i,n,o]=je(l,e);return i||(n&&o?$e({real:n.value.real-o.value.real,imaginary:n.value.imaginary-o.value.imaginary}):{value:t-r,type:3})},ss=(l,e)=>{let[t,r,i,n,o]=je(l,e);if(i)return i;if(n&&o)return $e(ye(n.value,o.value));let s=Math.pow(t,r);return isNaN(s)?M():{type:3,value:s}},as=(l,e)=>{let[t,r,i,n,o]=je(l,e);if(i)return i;if(n&&o)return $e(ye(n.value,o.value));if(t<0&&r!==0&&Math.abs(r)<1)return $e(ye({real:t,imaginary:0},{real:r,imaginary:0}));let s=Math.pow(t,r);return isNaN(s)?M():{type:3,value:s}},Yr=ss,ls=(l,e)=>{let[t,r,i,n,o]=je(l,e);return i||(n&&o?$e(ie(n.value,o.value)):{value:t*r,type:3})},cs=(l,e)=>{let[t,r,i,n,o]=je(l,e);return i||(n&&o?o.value.real===0&&o.value.imaginary===0?_e():$e(Pe(n.value,o.value)):r===0?_e():{value:t/r,type:3})},ds=(l,e)=>{let[t,r,i]=je(l,e);return i||(r===0?_e():{value:t%r,type:3})},Qr=(l,e)=>l.type===6?l:e.type===6?e:l.type===0&&(e.value===""||e.value===0||e.type===7&&e.value.real===0&&e.value.imaginary===0)||e.type===0&&(l.value===""||l.value===0||l.type===7&&l.value.real===0&&l.value.imaginary===0)?{type:4,value:!0}:l.type===7?e.type===7?{type:4,value:l.value.imaginary===e.value.imaginary&&l.value.real===e.value.real}:{type:4,value:!l.value.imaginary&&l.value.real===e.value}:e.type===7?{type:4,value:!e.value.imaginary&&l.value===e.value.real}:l.type===2&&e.type===2?{type:4,value:l.value.toLowerCase()===e.value.toLowerCase()}:{type:4,value:l.value==e.value},bn=(l,e)=>{let t=Qr(l,e);return t.type===6?t:{type:4,value:!t.value}},us=(l,e)=>l.type===6?l:e.type===6?e:l.type===7||e.type===7?M():{type:4,value:(l.value||0)>(e.value||0)},ei=(l,e)=>!(l.type===7||l.type===8||l.type===9||l.type===5||e.type===7||e.type===8||e.type===9||e.type===5),hs=(l,e)=>l.type===6?l:e.type===6?e:ei(l,e)?{type:4,value:(l.value||0)>=(e.value||0)}:M(),ms=(l,e)=>l.type===6?l:e.type===6?e:ei(l,e)?{type:4,value:(l.value||0)<(e.value||0)}:M(),fs=(l,e)=>l.type===6?l:e.type===6?e:ei(l,e)?{type:4,value:(l.value||0)<=(e.value||0)}:M(),gn=()=>{Yr=as},_n=l=>{switch(l){case"+":return os;case"-":return Zr;case"*":return ls;case"/":return cs;case"^":return Yr;case"**":return Yr;case"%":return ds;case"=":return Qr;case"==":return Qr;case"!=":return bn;case"<>":return bn;case">":return us;case">=":return hs;case"<":return ms;case"<=":return fs}};var ti=l=>!Array.isArray(l)&&l.type===5&&!!l.value.type,ce=l=>l.type===5&&l.key==="metadata",or=class{constructor(e,t,r){this.data_model=e;this.library=t;this.parser=r}context={address:{row:-1,column:-1},volatile:!1};Calculate(e,t,r,i=!1){return i||(this.context.address=t,this.context.volatile=!1,this.context.area=r),{value:this.CalculateExpression(e),volatile:this.context.volatile}}CellFunction2(e){if(!e.sheet_id)if(e.sheet)e.sheet_id=this.data_model.sheets.ID(e.sheet)||0;else return()=>$();let t=this.data_model.sheets.Find(e.sheet_id)?.cells;if(!t)return console.warn("missing cells reference @ "+e.sheet_id),()=>$();let r=t.GetCell(e);return r?e.spill&&r.spill&&r.spill.start.row===e.row&&r.spill.start.column===e.column?()=>r.spill?t.GetRange4(r.spill.start,r.spill.end,!0)||$():tn():()=>r.GetValue4():()=>({type:3,value:0})}CellFunction4(e,t){return e.sheet_id?this.data_model.sheets.Find(e.sheet_id)?.cells?.GetRange4(e,t,!0)||$():$()}GetMetadata(e,t){let r,i;switch(e.type){case"address":if(e.spill){let n;if(e.sheet_id&&(n=this.data_model.sheets.Find(e.sheet_id)),!n)return console.error("missing sheet [da6]"),$();let o=n.CellData(e);o.spill&&(i=o.spill)}else r=e;break;case"range":i=e;break;case"structured-reference":{let n=this.data_model.ResolveStructuredReference(e,this.context.address);n&&(n.type==="address"?r=n:n.type==="range"&&(i=n))}break;case"identifier":{let n=this.data_model.GetName(e.name,this.context.address.sheet_id||0);n?.type==="range"&&(n.area.count===1?r=n.area.start:i=n.area)}break;case"call":{let n=this.CalculateExpression(e,!0);if(ti(n))if(n.value.type==="address")r=n.value;else if(n.value.type==="range")i=n.value;else return n;else return n}break;default:return this.CalculateExpression(e)}if(r){let n;if(r.sheet_id&&(n=this.data_model.sheets.Find(r.sheet_id)),!n)return console.error("missing sheet [ac8]"),$();let o=n.CellData(r),s=o.calculated_type?o.calculated:o.value,a={type:"metadata",address:{...r,position:0,id:0,type:"address",label:new y(r).spreadsheet_label},value:s,format:o.style?o.style.number_format:void 0,...t(o,r)};return{type:5,value:a,key:"metadata"}}else if(i){if(i.start.row===1/0||i.start.column===1/0)return $();let n;if(i.start.sheet_id&&(n=this.data_model.sheets.Find(i.start.sheet_id)),!n)throw new Error("missing sheet [ac9]");let o=[];for(let s=i.start.column;s<=i.end.column;s++){let a=[];for(let c=i.start.row;c<=i.end.row;c++){let d=n.CellData({row:c,column:s});r={...i.start,row:c,column:s};let u=d.calculated_type?d.calculated:d.value,h={type:"metadata",address:r,value:u,format:d.style?d.style.number_format:void 0,...t(d,r)};a.push({type:5,value:h,key:"metadata"})}o.push(a)}return{type:8,value:o}}return this.CalculateExpression(e)}RewriteMacro(e,t){let r;switch(e.type){case"identifier":if(r=t[e.name.toUpperCase()],r)return JSON.parse(JSON.stringify(r));break;case"binary":e.left=this.RewriteMacro(e.left,t),e.right=this.RewriteMacro(e.right,t);break;case"unary":e.operand=this.RewriteMacro(e.operand,t);break;case"group":e.elements=e.elements.map(i=>this.RewriteMacro(i,t));break;case"call":e.args=e.args.map(i=>this.RewriteMacro(i,t));break}return e}CallMacro(e,t){if(!t.expression)return()=>Ae();let r=JSON.stringify(t.expression),i={},n=t.argument_names?.map(o=>o.toUpperCase())||[];return o=>{let s=JSON.parse(r);for(let a=0;a<n.length;a++)i[n[a]]=o.args[a]||{type:"missing",id:0};return this.CalculateExpression(this.RewriteMacro(s,i))}}CallExpression(e,t=!1){let r=this.library.Get(e.name);return r?i=>{this.context.volatile=this.context.volatile||!!r.volatile;let n=e.name.toLowerCase()==="if",o=-1,s,a=r.arguments||[],c=i.args.map((u,h)=>{if(s)return;let m=a[Math.min(h,a.length-1)]||{};if(h===o)return m.boxed?{type:0}:void 0;if(typeof u>"u")return n&&h===0&&(o=1),m.boxed?{type:0}:void 0;if(m.address)return m.boxed?{type:2,value:this.parser.Render(u).replace(/\$/g,"")}:this.parser.Render(u).replace(/\$/g,"");if(m.metadata)return this.GetMetadata(u,()=>({}));{let f=this.CalculateExpression(u);if(f.type===6){if(m.allow_error)return f;s=f;return}if(n&&h===0&&f.type!==8){let p=!1;if(f.type===2){let b=f.value.toLowerCase().trim();p=b!=="false"&&b!=="f"}else p=!!f.value;o=p?2:1}return m.boxed?f:f.type===8?f.value.map(p=>p.map(b=>b.value)):f.value}});if(s)return s;let d={address:{...this.context.address},area:this.context.area?{start:{...this.context.area.start},end:{...this.context.area.end}}:void 0};if(r.return_type==="reference"){let u=r.fn.apply(d,c);if(t)return u;if(ti(u)){if(u.value.type==="address")return this.CellFunction2(u.value)();if(u.value.type==="range")return this.CellFunction4(u.value.start,u.value.end)}return u}return r.fn.apply(d,c)}:()=>Jr()}ResolveStructuredReference(e){let t=this.data_model.ResolveStructuredReference(e,this.context.address);if(t){if(t.type==="address")return this.CellFunction2(t);if(t.type==="range")return()=>this.CellFunction4(t.start,t.end)}return()=>$()}ResolveDimensionedQuantity(){return e=>{let t=this.CalculateExpression(e.expression);return{type:9,value:{value:t.value,unit:e.unit.name}}}}UnaryExpression(e,t=!1){switch(e.operator){case"+":return r=>this.CalculateExpression(r.operand);case"-":{let r=Zr,i={type:3,value:0};return n=>{let o=this.CalculateExpression(n.operand);return o.type===8?{type:8,value:o.value.map(s=>s.map(a=>r(i,a)))}:r(i,o)}}case"@":return r=>{let i;switch(r.operand.type){case"address":if(r.operand.spill){let o=this.CellFunction2(r.operand)();if(o.type===8){let s=this.context.address.row??-1,a=this.context.address.column??-1;if(s>=r.operand.row&&s<r.operand.row+o.value[0]?.length&&o.value.length===1){if(!t)return o.value[0][s-r.operand.row];i={...r.operand,row:s,spill:!1}}else if(a>=r.operand.column&&a<r.operand.column+o.value.length&&o.value[0]?.length===1){if(!t)return o.value[a-r.operand.column][0];i={...r.operand,column:a,spill:!1}}else return M()}}break;case"range":{let o=this.context.address.row??-1,s=this.context.address.column??-1;if(o>=r.operand.start.row&&o<=r.operand.end.row&&r.operand.start.column===r.operand.end.column)i={...r.operand.start,row:o,spill:!1};else if(s>=r.operand.start.column&&s<=r.operand.end.column&&r.operand.start.row===r.operand.end.row)i={...r.operand.start,column:s,spill:!1};else return M()}}if(i)return t?{type:5,value:i}:this.CellFunction2(i)();let n=this.CalculateExpression(r.operand);return n.type===8?n.value[0][0]:n};default:return()=>(console.warn("unexpected unary operator:",e.operator),Ae())}}RecycleArray(e,t,r){if(e[0].length<r){let i=e[0].length;for(let n of e)for(let o=i;o<r;o++)n[o]=n[o%i]}if(e.length<t){let i=e.length;for(let n=i;n<t;n++)e[n]=e[n%i].slice(0)}return e}ElementwiseBinaryExpression(e,t,r){let i=Math.max(t.value.length,r.value.length),n=Math.max(t.value[0].length,r.value[0].length),o=this.RecycleArray(t.value,i,n),s=this.RecycleArray(r.value,i,n),a=[];for(let c=0;c<i;c++){let d=[];for(let u=0;u<n;u++)d[u]=e(o[c][u]||{type:0},s[c][u]||{type:0});a.push(d)}return{type:8,value:a}}AsReference(e){switch(e.type){case"address":return e;case"range":if(e.start.row===e.end.row&&e.start.column===e.end.column)return e.start;break;default:{let t=this.CalculateExpression(e,!0);if(ti(t)){if(t.value.type==="address")return t.value;if(t.value.type==="range"&&t.value.start.row===t.value.end.row&&t.value.start.column===t.value.end.column)return t.value.start}}break}}BinaryExpression(e){let t=e.operator==="&"?(r,i)=>{if(r.type===6)return r;if(i.type===6)return i;let n=[r,i].map(o=>o.type===0?"":o.type===4?o.value?this.data_model.language_model?.boolean_true||"TRUE":this.data_model.language_model?.boolean_false||"FALSE":o.value);return{type:2,value:`${n[0]}${n[1]}`}}:_n(e.operator);return t?r=>{let i=this.CalculateExpression(r.left),n=this.CalculateExpression(r.right);return i.type===8?n.type===8?this.ElementwiseBinaryExpression(t,i,n):this.ElementwiseBinaryExpression(t,i,{type:8,value:[[n]]}):n.type===8?this.ElementwiseBinaryExpression(t,{type:8,value:[[i]]},n):t(i,n)}:e.operator===":"?r=>{let i=this.AsReference(r.left),n=this.AsReference(r.right);return i&&n?this.CellFunction4(i,n):Ae()}:()=>(console.info(`(unexpected binary operator: ${e.operator})`),Ae())}Identifier(e){let t=e.name;if(t[0]==="#")return()=>$();let r=t.toUpperCase();switch(r){case"FALSE":case"F":return()=>({value:!1,type:4});case"TRUE":case"T":return()=>({value:!0,type:4});case"UNDEFINED":return()=>({value:void 0,type:0})}return()=>{let i=this.data_model.GetName(r,this.context.address.sheet_id||0);switch(i?.type){case"range":return i.area.count===1?this.CellFunction4(i.area.start,i.area.start):this.CellFunction4(i.area.start,i.area.end);case"expression":return this.CalculateExpression(i.expression)}return Jr()}}GroupExpression(e){return!e.elements||e.elements.length!==1?(console.warn("Can't handle group !== 1"),()=>Ae()):t=>this.CalculateExpression(t.elements[0])}CalculateExpression(e,t=!1){if(e.fn)return e.fn(e);switch(e.type){case"call":{let r=this.data_model.macro_functions.get(e.name.toUpperCase());return r?(e.fn=this.CallMacro(e,r))(e):(e.fn=this.CallExpression(e,t))(e)}case"address":return(e.fn=this.CellFunction2(e))();case"range":return(e.fn=r=>this.CellFunction4(r.start,r.end))(e);case"binary":return(e.fn=this.BinaryExpression(e))(e);case"unary":return(e.fn=this.UnaryExpression(e,t))(e);case"identifier":return(e.fn=this.Identifier(e))();case"missing":return(e.fn=()=>({value:void 0,type:0}))();case"dimensioned":return(e.fn=this.ResolveDimensionedQuantity())(e);case"literal":{let r={value:e.value,type:pe(e.value)};return(e.fn=()=>r)()}case"group":return(e.fn=this.GroupExpression(e))(e);case"complex":{let r={value:{real:e.real,imaginary:e.imaginary},type:7};return(e.fn=()=>r)()}case"structured-reference":return(e.fn=this.ResolveStructuredReference(e))();case"array":return(e.fn=()=>({type:8,value:e.values.map(r=>(Array.isArray(r)?r:[r]).map(i=>({type:pe(i),value:i})))}))();default:return console.warn("Unhandled parse expr:",e),Yt()}}};var gu=1e3*60*60*24;var sr=l=>{let e=[],t=l.length,r=l[0].length;for(let i=0;i<r;i++){e[i]=[];for(let n=0;n<t;n++)e[i][n]=l[n][i]}return e},ri=l=>{if(!l)return[];if(typeof l[0]>"u")return[];let e=[],t=l.length,r=l[0].length;for(let i=0;i<r;i++){e[i]=[];for(let n=0;n<t;n++)e[i][n]=l[n][i]}return e};var ne=l=>{let e=[];for(let t of l)if(t?.type===8)for(let r of t.value)e=e.concat(ne(r));else e.push(t);return e},J=(l,e=!1)=>Array.isArray(l)?l.reduce((t,r)=>typeof r>"u"&&!e?t:Array.isArray(r)?t.concat(J(r,e)):r instanceof Float32Array||r instanceof Float64Array?t.concat(Array.from(r)):t.concat([r]),[]):[l],Q=l=>J(l).filter(e=>typeof e=="number"),ii=(l,e=!1)=>e?l.map(t=>{switch(typeof t){case"number":case"undefined":case"string":case"boolean":return t}}):l.filter(t=>{switch(typeof t){case"number":case"undefined":case"string":case"boolean":return!0}return!1}),ps=l=>!!l&&typeof l=="object"&&l.type===8,vn=(l,e)=>(...t)=>{let r=[],i=[];for(let[n,o]of t.entries())if(o&&l[n]){let s=Array.isArray(o)?o:ps(o)?o.value:void 0;s&&(r[n]=s,i.length||(i=s))}return r.length?{type:8,value:i.map((n,o)=>n.map((s,a)=>{let c=t.map((d,u)=>r[u]?r[u][o][a]??{type:0}:d);return e(...c)}))}:e(...t)},_t=l=>{let e=[],t=l.length,r="[\\^$.|?*+()";for(let i=0;i<t;i++){let n=l[i];switch(n){case"*":e.push(".","*");break;case"?":e.push(".");break;case"~":n=l[++i]||"";default:for(let o=0;o<r.length;o++)if(n===r[o]){e.push("\\");break}e.push(n);break}}return e.join("")},wn=l=>({type:2,value:l});var lr=class{functions={};Register(...e){for(let t of e)for(let r of Object.keys(t)){if(/[^a-zA-Z0-9._]/.test(r))throw new Error("invalid function name (invalid character)");if(r.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(r))throw new Error("invalid function name (start with an ascii letter)");let i=r.toLowerCase();if(this.functions[i])throw new Error(`function name (${i}) is already in use`);let n=t[r];if(n.canonical_name=r,!n.unrolled){let o=n.arguments?.map(s=>!!s.unroll);o?.some(s=>!!s)&&(n.fn=vn(o,n.fn),n.unrolled=!0)}this.functions[i]=n}}Get(e){let t=e.toLowerCase();return this.functions[t]}List(e=!0){let t={};for(let r of Object.keys(this.functions))e&&this.functions[r].visibility==="internal"||(t[r]=this.functions[r]);return t}Alias(e,t){let r=this.Get(t);if(!r)throw new Error(`referenced function ${t} does not exist`);this.Register({[e]:{...r}})}};var yt=class{static default_color="#888";static UnpackValues(e){if(Array.isArray(e)){let t=e[0];return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array?e.reduce((r,i)=>r.concat(this.UnpackValues(i)),[]):e.map(r=>isNaN(r)?void 0:r)}else{if(e instanceof Float32Array||e instanceof Float64Array)return Array.prototype.slice.call(e);if(e&&typeof e=="object"){let r=Object.keys(e).length;if(typeof e[0]<"u"&&typeof e[(r-1).toString()]<"u"){let i=[];for(let n=0;n<r;n++)i[n]=e[n.toString()];return i}}}return[]}static SparklineCommon(e,t){let r=[],i=Y(t.text)?t.text.text:this.default_color,n=[i,i];return Array.isArray(e.calculated)&&(r=this.UnpackValues(e.calculated[0]),typeof e.calculated[1]=="string"&&(n[0]=e.calculated[1]),typeof e.calculated[2]=="string"&&(n[1]=e.calculated[2])),{values:r,colors:n}}static RenderLine(e,t,r,i,n){let{values:o,colors:s}=this.SparklineCommon(i,n),a=.05,c=.1,d=1;Array.isArray(i.calculated)&&typeof i.calculated[2]=="number"&&(d=i.calculated[2]);let u=0,h=0,m=-1;for(let f=0;f<o.length;f++){let p=o[f];typeof p=="number"&&(m>=0?(u=Math.min(u,p),h=Math.max(h,p)):(m=f,u=h=p))}if(u===h&&(u&&(u-=1),h+=1),u!==h){let f=e*(1-2*a)/(o.length-1),p=h-u,b=t*(1-2*c),g=t*c;r.strokeStyle=s[0],r.lineWidth=d,r.lineCap="round",r.lineJoin="round",r.beginPath();let x=0;for(let v=m;v<o.length;v++){let w=o[v];if(typeof w=="number"){let _=e*a+f*v,C=t-(w-u)*b/p-g;x===0?(r.moveTo(_,C),x=1):r.lineTo(_,C)}else x=0}r.stroke()}}static RenderColumn(e,t,r,i,n){let{values:o,colors:s}=this.SparklineCommon(i,n),a=3,c=2.5,d=0,u=0,h=!1;for(let m of o)typeof m=="number"&&(h?(d=Math.min(d,m),u=Math.max(u,m)):(h=!0,d=u=m));if(d===u&&(d&&(d-=1),u+=1),o.length){let m=(e-2*a-2)/(o.length-0),f=t-2*c,p=c;if(d!==u)if(d<0&&u>0){let b=u-d,g=p+u/b*f;for(let x=0;x<o.length;x++){let v=o[x];if(typeof v=="number"){let w=a+x*m,_=Math.abs(v)/b*f;if(v>=0){r.fillStyle=s[0];let C=g-_;r.fillRect(w+2,C,m-2,_)}else{r.fillStyle=s[1];let C=g;r.fillRect(w+2,C,m-2,_)}}}}else if(u>0){r.fillStyle=s[0];let b=u-d;for(let g=0;g<o.length;g++){let x=o[g];if(typeof x=="number"){let v=a+g*m,w=Math.max(1,(x-d)/b*f),_=t-p-w;r.fillRect(v+2,_,m-2,w)}}}else{r.fillStyle=s[1];let b=u-d;for(let g=0;g<o.length;g++){let x=o[g];if(typeof x=="number"){let v=a+g*m,w=Math.max(1,Math.abs(u-x)/b*f),_=p;r.fillRect(v+2,_,m-2,w)}}}}}};var xn=l=>{let{x:e,y:t,width:r,height:i,cell:n}=l,o={},s=3,a=Math.round(16*(l.scale||1));if(n&&r&&i&&e&&t){let c={x:s,y:i-s-a};if(n.style){switch(n.style.vertical_align){case"top":c.y=s;break;case"middle":c.y=Math.round((i-a)/2);break}switch(n.style.horizontal_align){case"right":c.x=Math.round(r-s-a);break;case"center":c.x=Math.round((r-a)/2);break}}e>=c.x&&e<=c.x+a&&t>=c.y&&t<=c.y+a&&(o.value=`=Checkbox(${n.calculated?"FALSE":"TRUE"})`,o.block_selection=!0)}return o},Cn=l=>{let{context:e,width:t,height:r,cell:i}=l,n=l.scale||1;e.lineJoin="round",e.lineCap="round";let o=3*n,s=16*n,a=o,c=r-o-s;if(i.style){switch(i.style.vertical_align){case"top":c=o;break;case"middle":c=(r-s)/2;break}switch(i.style.horizontal_align){case"right":a=t-o-s;break;case"center":a=(t-s)/2;break}}a=Math.floor(a)+.5,c=Math.floor(c)+.5;let d=Math.floor(a+s)+.5,u=Math.floor(c+s)+.5;if(i&&i.calculated){e.lineWidth=.5,e.fillStyle=e.strokeStyle,e.beginPath(),e.moveTo(a,c),e.lineTo(a+16*n,c),e.lineTo(a+16*n,c+16*n),e.lineTo(a,c+16*n),e.closePath(),e.moveTo(a+15*n,c+4*n);for(let h of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])e.lineTo(a+h[0]*n,c+h[1]*n);e.closePath(),e.fill()}else e.lineWidth=1,e.lineJoin="round",e.beginPath(),e.moveTo(a,c),e.lineTo(d,c),e.lineTo(d,u),e.lineTo(a,u),e.closePath(),e.stroke();return{handled:!0}};var He=l=>{switch(l.type){case 7:return l.value;case 3:return{real:l.value,imaginary:0};case 4:return{real:l.value?1:0,imaginary:0};case 0:return{real:0,imaginary:0}}return!1};var Sn=(l,e,t)=>{let r=new Date;return r.setMilliseconds(0),r.setSeconds(0),r.setMinutes(0),r.setHours(0),l<0||l>1e4||(l<1899&&(l+=1900),r.setFullYear(l),e<1||e>12)||(r.setMonth(e-1),t<1||t>31)?!1:(r.setDate(t),Ce(r.getTime()))};var An=(l,e)=>{let t=new Date(Re(l)),r=t.getUTCMonth()+e,i=t.getUTCFullYear();for(t.setUTCHours(12),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0);r<0;)r+=12,i--;for(;r>11;)r-=12,i++;if(t.setUTCMonth(r),t.setUTCFullYear(i),t.getUTCMonth()!==r){let o=t.getUTCDate();t=new Date(t.getTime()-o*86400*1e3)}return t},kn=[{name:"Lookup value"},{name:"Table"},{name:"Result index"},{name:"Inexact",default:!0}],Rn=(l,e,t,r=!0,i=!1)=>{if(i&&(e=ri(e)),t=Math.max(0,t-1),r){let n=e[t][0];if(typeof l=="number"){let o=Number(e[0][0]);if(isNaN(o)||o>l)return ve();for(let s=1;s<e[0].length&&(o=Number(e[0][s]),!(isNaN(o)||o>l));s++)n=e[t][s]}else{l=(l||"").toString().toLowerCase();let o=(e[0][0]||"").toString().toLowerCase();if(o.localeCompare(l)>0)return ve();for(let s=1;s<e[0].length&&(o=(e[0][s]||"").toString().toLowerCase(),!(o.localeCompare(l)>0));s++)n=e[t][s]}return X(n)}else{for(let n=0;n<e[0].length;n++)if(e[0][n]==l)return X(e[t][n]);return ve()}},cr=(l,e=!1)=>{if(!l)return e;switch(l.type){case 3:return l.value;case 0:return e}return!1},ze=(l,e,t)=>({description:t,arguments:[{name:"number",boxed:!0,unroll:!0}],fn:r=>r.type===3?{type:3,value:l(r.value)}:r.type===7?{type:7,value:e(r.value)}:D()}),ni={Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:l=>{if(l.type===7){let e=ye(l.value,{real:.5,imaginary:0});return ae(e)}else{if(l.type===0||!l.value)return{type:3,value:0};if(l.type===3&&l.value<0){let e=ye({real:l.value,imaginary:0},{real:.5,imaginary:0});return{type:7,value:e}}else if(l.type===3){let e=Math.sqrt(l.value);return isNaN(e)?M():{type:3,value:e}}else return M()}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(l,e)=>{if(l.type===3&&e.type===3&&(l.value>=0||e.value===0||Math.abs(e.value)>=1)){let i=Math.pow(l.value,e.value);return isNaN(i)?M():{type:3,value:i}}let t=He(l),r=He(e);if(t&&r){let i=ye(t,r);return ae(i)}return M()}}},et={True:{fn:()=>({type:4,value:!0})},False:{fn:()=>({type:4,value:!1})},Int:{fn:l=>({type:3,value:Math.floor(l)})},Rand:{volatile:!0,fn:()=>({type:3,value:Math.random()})},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(l=0,e=1)=>{if(l>e){let t=l;l=e,e=t}return{type:3,value:Math.floor(Math.random()*(e+1-l)+l)}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...l)=>{let e={real:0,imaginary:0},t=ne(l);for(let r of t)switch(r.type){case 3:e.real+=r.value;break;case 4:break;case 7:e.real+=r.value.real,e.imaginary+=r.value.imaginary;break;case 6:return r}return ae(e)}},SumSQ:{description:"Returns the sum of the squares of all arguments",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...l)=>{let e={real:0,imaginary:0},t=ne(l);for(let r of t)switch(r.type){case 3:e.real+=r.value*r.value;break;case 4:break;case 7:{let i=ie(r.value,r.value);e.real+=i.real,e.imaginary+=i.imaginary}break;case 6:return r}return ae(e)}},EDate:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(l,e=0)=>{if(typeof l!="number"||typeof e!="number")return D();let t=An(l,e);return{type:3,value:Ce(t.getTime(),!1)}}},EOMonth:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(l,e=0)=>{if(typeof l!="number"||typeof e!="number")return D();let t=An(l,e);switch(t.getUTCMonth()){case 1:{let i=t.getUTCFullYear();i%4===0&&(i===1900||i%400===0||i%100!==0)?t.setUTCDate(29):t.setUTCDate(28)}break;case 0:case 2:case 4:case 6:case 7:case 9:case 11:t.setUTCDate(31);break;default:t.setUTCDate(30);break}return{type:3,value:Ce(t.getTime(),!1)}}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:3,value:Ce(new Date().getTime())})},YearFrac:{description:"Returns the fraction of a year between two dates",arguments:[{name:"Start"},{name:"End"},{name:"Basis",default:0}],fn:(l,e,t)=>{if(e<l){let n=l;l=e,e=n}let r=Math.max(0,e-l),i=360;if(t&&t<0||t>4)return D();switch(t){case 1:break;case 2:break;case 3:i=365;break}return{type:3,value:r/i}}},Date:{description:"Constructs a date from year/month/day",arguments:[{name:"year",unroll:!0},{name:"month",unroll:!0},{name:"day",unroll:!0}],fn:(l,e,t)=>{let r=Sn(l,e,t);return r===!1?D():{type:3,value:r}}},Today:{description:"Returns current day",volatile:!0,fn:()=>{let l=new Date;return l.setMilliseconds(0),l.setSeconds(0),l.setMinutes(0),l.setHours(12),{type:3,value:Ce(l.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(l,e=0)=>l&&l.type===6?{value:e,type:pe(e)}:l},IsNA:{description:"Checks if another cell contains a #NA error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...l)=>{let e=ne(l);for(let t of e)if(t.type===6&&t.value==="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsErr:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...l)=>{let e=ne(l);for(let t of e)if(t.type===6&&t.value!=="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...l)=>{let e=ne(l);for(let t of e)if(t.type===6)return{type:4,value:!0};return{type:4,value:!1}}},Year:{description:"Returns year from date",arguments:[{name:"date",unroll:!0}],fn:l=>X(new Date(Re(l)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date",unroll:!0}],fn:l=>X(new Date(Re(l)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date",unroll:!0}],fn:l=>X(new Date(Re(l)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees",unroll:!0}],fn:l=>X(l*Math.PI/180)},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians",unroll:!0}],fn:l=>X(l/Math.PI*180)},CountA:{description:"Counts cells that are not empty",fn:(...l)=>X(J(l).reduce((e,t)=>typeof t>"u"?e:e+1,0))},Count:{description:"Counts cells that contain numbers",fn:(...l)=>X(J(l).reduce((e,t)=>typeof t=="number"||ue(t)?e+1:e,0))},Or:{fn:(...l)=>{let e=!1;l=J(l);for(let t of l)e=e||!!t;return X(e)}},And:{fn:(...l)=>{let e=!0;l=J(l);for(let t of l)e=e&&!!t;return X(e)}},Not:{arguments:[{unroll:!0,boxed:!0}],fn:l=>{let e=!1;if(l)switch(l.type){case 0:e=!1;break;case 2:case 4:case 3:e=!!l.value;break;case 6:return l}return X(!e)}},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(l,e={type:4,value:!0},t={type:4,value:!1})=>{let r=e.type===8,i=t.type===8;return l.type===8?{type:8,value:l.value.map((o,s)=>o.map((a,c)=>(a.type===2?a.value.toLowerCase()!=="false"&&a.value.toLowerCase()!=="f":!!a.value)?r?e.value[s][c]:e:i?t.value[s][c]:t))}:(l.type===2?l.value.toLowerCase()!=="false"&&l.value.toLowerCase()!=="f":!!l.value)?e:t}},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number",unroll:!0}],fn:l=>{l=Math.round(l);let e=1;for(;l>1;)e*=l,l--;return{type:3,value:e}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(l,e)=>{let t=He(l),r=He(e);if(!t||!r)return M();if(l.type===7||e.type===7)return ae(ye(t,r));{let i=Math.pow(t.real,r.real);return isNaN(i)?M():{type:3,value:i}}}},Mod:{arguments:[{unroll:!0},{unroll:!0}],fn:(l,e)=>e?X(l%e):_e()},Large:{description:"Returns the nth numeric value from the data, in descending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(l,e)=>{if(e<=0)return D();let t=Q(l);return t.sort((r,i)=>i-r),e<=t.length?{type:3,value:t[e-1]}:D()}},Small:{description:"Returns the nth numeric value from the data, in ascending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(l,e)=>{if(e<=0)return D();let t=Q(l);return t.sort((r,i)=>r-i),e<=t.length?{type:3,value:t[e-1]}:D()}},Filter:{description:"Filter an array using a second array.",arguments:[{name:"source",description:"Source array"},{name:"filter",description:"Filter array"}],fn:(l,e)=>{if(typeof l>"u"||typeof e>"u")return D();Array.isArray(l)||(l=[[l]]),Array.isArray(e)||(e=[[e]]);let t=l.length,r=l[0].length,i=e.length,n=e[0].length;if(r===n){let o=[];for(let s=0;s<t;s++)o.push([]);for(let[s,a]of e[0].entries())if(a)for(let c=0;c<t;c++)o[c].push(X(l[c][s]));return{type:8,value:o}}else if(t===i){let o=[];for(let[s,[a]]of e.entries())a&&o.push(l[s].map(c=>X(c)));return{type:8,value:o}}return D()}},Sort:{arguments:[{name:"values"}],fn:(...l)=>(l=J(l),l.every(e=>typeof e=="number")?l.sort((e,t)=>e-t):l.sort(),{type:8,value:[l.map(e=>X(e))]})},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:l=>l.type===8?{type:8,value:sr(l.value)}:l},Max:{fn:(...l)=>({type:3,value:Math.max.apply(0,Q(l))})},Min:{fn:(...l)=>({type:3,value:Math.min.apply(0,Q(l))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...l)=>{let e=l.map(i=>J(i)),t=Math.max.apply(0,e.map(i=>i.length)),r=0;for(let i=0;i<t;i++)r+=e.reduce((n,o)=>{let s=o[i];return s===!0&&(s=1),typeof s=="number"?n*s:0},1);return{type:3,value:r}}},Row:{arguments:[{name:"reference",metadata:!0}],fn:function(l){if(!l)if(this?.area){let e=[];for(let t=this.area.start.column;t<=this.area.end.column;t++){let r=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)r.push({type:3,value:i+1});e.push(r)}return{type:8,value:e}}else return{type:3,value:this?this.address.row+1:-1};if(l.type===8){let e=l.value,t=e[0][0];if(ce(t))return{type:8,value:[e[0].map((r,i)=>({type:3,value:i+t.value.address.row+1}))]}}else if(ce(l))return{type:3,value:l.value.address.row+1};return D()}},Column:{arguments:[{name:"reference",metadata:!0}],fn:function(l){if(!l)if(this?.area){let e=[];for(let t=this.area.start.column;t<=this.area.end.column;t++){let r=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)r.push({type:3,value:t+1});e.push(r)}return{type:8,value:e}}else return{type:3,value:this?this.address.column+1:-1};if(l.type===8){let e=l.value,t=e[0][0];if(ce(t))return{type:8,value:e.map((r,i)=>[{type:3,value:i+t.value.address.column+1}])}}else if(ce(l))return{type:3,value:l.value.address.row+1};return D()}},Choose:{arguments:[{name:"Selected index"},{name:"Choice 1...",metadata:!0}],return_type:"reference",description:"Returns one of a list of choices",fn:(l,...e)=>{if(l<1||l>e.length)return M();let t=e[l-1];if(ce(t))return{type:5,value:t.value.address};if(t.type===8){let r=t.value,i=r.length,n=r[0].length,o=r[0][0],s=r[i-1][n-1];if(i===1&&n===1){if(ce(o))return{type:5,value:o.value.address}}else if(ce(o)&&ce(s))return{type:5,value:{type:"range",position:0,id:0,label:"",start:o.value.address,end:s.value.address}}}return{...t}}},XLOOKUP:{arguments:[{name:"Lookup value"},{name:"Lookup array"},{name:"Return array",metadata:!0},{name:"Not found",boxed:!0},{name:"Match mode",default:0},{name:"Search mode",default:1}],return_type:"reference",xlfn:!0,fn:(l,e,t,r,i=0,n=1)=>{if(!t)return D();let o;if(t.type===8){let d=t.value,u=d.length,h=d[0].length,m=d[0][0],f=d[u-1][h-1];ce(m)&&ce(f)&&(o=new y(m.value.address,f.value.address))}if(!o)return console.info("invalid range"),$();if(!Array.isArray(e))return console.info("lookup is not an array"),M();let s=e[0];if(!Array.isArray(s))return console.info("lookup is not a 2d array"),M();if(e.length!==1&&s.length!==1)return console.info("lookup array has invalid dimensions"),M();let a=e.length===1;a&&(e=ri(e)),n<0&&e.reverse();let c=(d,u)=>{let h,m;if(a?(n<0&&(u=d.rows-1-u),u>=0&&u<d.rows&&(h={type:"address",position:0,id:1,label:"",row:d.start.row+u,column:d.start.column,sheet_id:d.start.sheet_id},m={type:"address",position:0,id:2,label:"",row:d.start.row+u,column:d.end.column,sheet_id:d.start.sheet_id})):(n<0&&(u=d.columns-1-u),u>=0&&u<d.columns&&(h={type:"address",position:0,id:1,label:"",row:d.start.row,column:d.start.column+u,sheet_id:d.start.sheet_id},m={type:"address",position:0,id:2,label:"",row:d.end.row,column:d.start.column+u,sheet_id:d.start.sheet_id})),h&&m){let f={type:"range",position:0,id:0,label:"",start:h,end:m};return{type:5,value:f}}return{type:0}};if(i===2&&typeof l!="string"&&(i=0),(i===1||i===-1)&&typeof l=="number"){let d=0,u=-1;for(let h=0;h<e.length;h++){let m=e[h][0];if(typeof m=="number"){if(m===l)return c(o,h);let f=Math.abs(m-l);(i===1&&m>l||i===-1&&m<l)&&(u<0||f<d)&&(d=f,u=h)}}if(u>=0)return c(o,u)}switch(i){case 2:{let d=_t(l?.toString()||""),u=new RegExp("^"+d+"$","i");for(let h=0;h<e.length;h++){let m=e[h][0];if(typeof m=="string"&&u.exec(m))return c(o,h)}}break;case 0:typeof l=="string"&&(l=l.toLowerCase());for(let d=0;d<e.length;d++){let u=e[d][0];if(typeof u=="string"&&(u=u.toLowerCase()),u===l)return c(o,d)}break}return r&&r.type!==0?r:ve()}},HLookup:{arguments:[...kn],fn:(l,e,t,r=!0)=>Rn(l,e,t,r,!0)},VLookup:{arguments:[...kn],fn:(l,e,t,r=!0)=>Rn(l,e,t,r,!1)},Product:{arguments:[{boxed:!0}],fn:(...l)=>{let e={real:1,imaginary:0};l=ne(l);for(let t of l)t.type===7?e=ie(e,t.value):t.type===3&&(e.real*=t.value,e.imaginary*=t.value);return ae(e)}},Log:{arguments:[{name:"number",unroll:!0},{name:"base",unroll:!0}],fn:(l,e=10)=>({type:3,value:Math.log(l)/Math.log(e)})},Log10:{arguments:[{name:"number",unroll:!0}],fn:l=>({type:3,value:Math.log(l)/Math.log(10)})},Ln:{arguments:[{name:"number",unroll:!0}],fn:l=>({type:3,value:Math.log(l)})},"Ceiling.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(l,e=1,t)=>{let r=0;return t&&l<0?r=-Math.ceil(-l/e)*e:r=Math.ceil(l/e)*e,{type:3,value:r}}},"Floor.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(l,e=1,t)=>{let r=0;return t&&l<0?r=-Math.floor(-l/e)*e:r=Math.floor(l/e)*e,{type:3,value:r}}},Floor:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(l,e=1)=>({type:3,value:Math.floor(l/e)*e})},Ceiling:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(l,e=1)=>({type:3,value:Math.ceil(l/e)*e})},Round:{arguments:[{unroll:!0},{unroll:!0}],fn:(l,e=0)=>{let t=Math.pow(10,e);return{type:3,value:Math.round(t*l)/t}}},RoundDown:{arguments:[{unroll:!0},{unroll:!0}],fn:(l,e=0)=>{let t=Math.pow(10,e),r=l>=0;return{type:3,value:r?Math.floor(t*l)/t:Math.ceil(t*l)/t}}},RoundUp:{arguments:[{unroll:!0},{unroll:!0}],fn:(l,e=0)=>{let t=Math.pow(10,e),r=l>=0;return{type:3,value:r?Math.ceil(t*l)/t:Math.floor(t*l)/t}}},Reverse:{arguments:[{boxed:!0}],fn:l=>l.type===8?(l.value.length===1?l.value[0].reverse():l.value.reverse(),l):{type:2,value:(l.value??"").toString().split("").reverse().join("")}},Exp:{arguments:[{boxed:!0,unroll:!0}],fn:l=>{if(l.type===7){let e=gt(l.value);return ae(e)}return l.type!==3?M():{type:3,value:Math.exp(l.value)}}},Abs:{arguments:[{boxed:!0,unroll:!0}],fn:l=>l.type===7?{type:3,value:Math.sqrt(l.value.real*l.value.real+l.value.imaginary*l.value.imaginary)}:l.type!==3?M():{type:3,value:Math.abs(l.value||0)}},Simplify:{arguments:[{name:"value",unroll:!0},{name:"significant digits",unroll:!0}],fn:(l,e=2)=>{if(e=e||2,l===0)return{type:3,value:l};let t=l<0?-1:1;l*=t;let r=Math.pow(10,Math.floor(Math.log10(l))+1-e);return{type:3,value:Math.round(l/r)*r*t}}},Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:l=>{if(l.type===7){let e=ye(l.value,{real:.5,imaginary:0});return ae(e)}else{if(l.type===0||!l.value)return{type:3,value:0};if(l.type===3)return{type:3,value:Math.sqrt(l.value)}}return M()}},HexToDec:{arguments:[{description:"hexadecimal string",unroll:!0}],fn:l=>({type:3,value:parseInt(l,16)})},DecToHex:{arguments:[{description:"number",unroll:!0}],fn:l=>({type:2,value:l.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:xn,render:Cn,fn:l=>({value:!!l,type:4})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:l=>(yt.RenderColumn(l.width,l.height,l.context,l.cell,l.style),{handled:!0}),fn:(...l)=>({type:5,value:l,key:"sparkline-data"})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:l=>(yt.RenderLine(l.width,l.height,l.context,l.cell,l.style),{handled:!0}),fn:(...l)=>({type:5,value:l,key:"sparkline-data"})},UniqueValues:{arguments:[{name:"range",boxed:!0}],visibility:"internal",fn:l=>{if(l.type===8){let e=n=>{if(n)switch(n.type){case 2:case 3:case 4:return n.value;case 0:return"";default:return console.info("check",n,n.value),n.value?.toString()||""}else return""},t=new Set,r=new Set;for(let n of l.value)for(let o of n){let s=e(o);t.has(s)?r.add(s):t.add(s)}let i=[];for(let n of l.value){let o=[];for(let s of n){let a=e(s);o.push({type:4,value:!r.has(a)})}i.push(o)}return{type:8,value:i}}return{type:4,value:!0}}},Between:{arguments:[{name:"target",boxed:!0,unroll:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(l,e=0,t=1)=>({type:4,value:l.type===3&&l.value>=e&&l.value<=t})},Gradient:{arguments:[{name:"range",boxed:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(l,e,t)=>{let r=ne([l]),i=0,n=0,o=0;for(let d of r){if(d.type===6)return d;d.type===3&&(i===0?(n=d.value,o=d.value):(n=Math.min(n,d.value),o=Math.max(o,d.value)),i++)}typeof t=="number"&&(o=t),typeof e=="number"&&(n=e);let s=o-n,a=1,c=1;if(l.type===8){a=l.value.length,c=l.value[0]?.length||0;let d=[];for(let u=0;u<a;u++){let h=[];for(let m=0;m<c;m++){let f=l.value[u][m];if(f.type===3){let p=0;o===n?f.value>o?p=1:f.value<o?p=0:p=.5:s>0&&(p=(f.value-n)/s),h.push({type:3,value:p})}else h.push({type:0})}d.push(h)}return{type:8,value:d}}else return D()}},ATan2:{arguments:[{name:"y",boxed:!0,unroll:!0},{name:"x",boxed:!0,unroll:!0}],fn:(l,e)=>{if(l.type===3&&e.type===3)return{type:3,value:Math.atan2(l.value,e.value)};if(l.type===3&&(l={type:7,value:{real:l.value,imaginary:0}}),e.type===3&&(e={type:7,value:{real:e.value,imaginary:0}}),l.type===7&&e.type===7){let t=un(l.value,e.value);return t===!1?D():{type:7,value:t}}return D()}},Sin:ze(Math.sin,rr),SinH:ze(Math.sinh,ln),ASin:ze(Math.asin,Xr),Cos:ze(Math.cos,an),CosH:ze(Math.cosh,sn),ACos:ze(Math.acos,cn),Tan:ze(Math.tan,on),TanH:ze(Math.tanh,nn),ATan:ze(Math.atan,dn),E:{fn:()=>({type:3,value:Math.E})},PI:{fn:()=>({type:3,value:Math.PI})},SQRT2:{fn:()=>({type:3,value:Math.SQRT2})},SQRT1_2:{fn:()=>({type:3,value:Math.SQRT1_2})},Sequence:{arguments:[{name:"rows",boxed:!0},{name:"columns",default:1,boxed:!0},{name:"start",default:1,boxed:!0},{name:"step",default:1,boxed:!0}],fn:(l,e,t,r)=>{let i=cr(l,1),n=cr(e,1),o=cr(r,1),s=cr(t,1);if(i===!1||n===!1||o===!1||s===!1)return D();let a=[];for(let c=0;c<n;c++){let d=[];for(let u=0;u<i;u++)d.push({type:3,value:s+u*o*n+c*o});a.push(d)}return{type:8,value:a}}}},En={};for(let l of Object.keys(et))En[l.toLowerCase()]=l;var bs=["ceil","pow","ln10","ln2","log10","log10e","log1p","log2","log2e","random","imul","clz32","fround"],Tn={};for(let l of bs)Tn[l.toLowerCase()]=l;for(let l of Object.getOwnPropertyNames(Math)){let e=l.toLowerCase();if(En[e]||Tn[e])continue;let t=Object.getOwnPropertyDescriptor(Math,l);if(!t)continue;let r=t.value,i=typeof r;switch(i){case"number":et[l]={fn:()=>({type:3,value:r}),category:["Math Functions"]};break;case"function":et[l]={fn:(...n)=>X(r(...n)),category:["Math Functions"]};break;default:console.info("unexpected type:",i,l);break}}Math.log10||(Math.log10=l=>Math.log(l)/Math.log(10));var vt=(l,e,t=0,r=0,i=0)=>i?-(t*(l/(1-Math.pow(1+l,-e))))/(1+l)-r*(1/((1+l)*((Math.pow(1+l,e)-1)/l))):-(t*l*Math.pow(1+l,e)+r*l)/(Math.pow(1+l,e)-1),Un=(l,e,t,r=0,i=0)=>i?(1+l)*-t/l*(Math.pow(1+l,e)-1)-r*Math.pow(1+l,e):-t/l*(Math.pow(1+l,e)-1)-r*Math.pow(1+l,e),oi=(l,e,t,r=0,i=0,n=0)=>{if(e<1)return NaN;if(e===1&&n)return 0;let o=vt(l,t,r,i,n),s=Un(l,e-1,o,r,n)*l;return n?s/(1+l):s},Mn=(l,e,t,r=0,i=0,n=0)=>vt(l,t,r,i,n)-oi(l,e,t,r,i,n),Vn={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(l=0,...e)=>{let t=0,r=J(e);for(let i=0;i<r.length;i++){let n=r[i];typeof n=="number"&&(t+=Math.pow(1+l,-(i+1))*n)}return{type:3,value:t}}},XNPV:{description:"returns the NPV of a nonperiodic stream of payments at a given rate",arguments:[{name:"Discount rate"},{name:"Values"},{name:"Dates"}],fn:(l,e,t)=>{if(typeof l!="number")return D();if(e=J(e),t=J(t),e.length!==t.length)return D();let r=[];for(let o of e){if(typeof o!="number")return D();r.push(o)}let i=[];for(let o of t){if(typeof o!="number")return D();i.push(Math.floor(o))}let n=0;for(let o=0;o<r.length;o++)n+=(r[o]||0)/Math.pow(1+l,(i[o]-i[0])/365);return{type:3,value:n}}},XIRR:{description:"returns the internal rate of return of a nonperiodic stream of payments",arguments:[{name:"Values"},{name:"Dates"},{name:"Guess",default:.1}],fn:(l,e,t=.1)=>{if(l=J(l),e=J(e),l.length!==e.length)return D();let r=0,i=0,n=[];for(let u of l){if(typeof u!="number")return D();u>0&&r++,u<0&&i++,n.push(u)}if(r<=0||i<=0)return D();let o=[];for(let u of e){if(typeof u!="number")return D();o.push(Math.floor(u))}let s=o[0];for(let u of o)if(u<s)return D();let a=.1,c=[{found:!1,value:0},{found:!1,value:0}],d=n.length;for(let u=0;u<100;u++){let h=0;for(let m=0;m<d;m++)h+=(n[m]||0)/Math.pow(1+t,(o[m]-o[0])/365);if(Math.abs(h)<=1e-6)return{type:3,value:t};if(h>0){if(c[0].value=c[0].found?Math.max(c[0].value,t):t,c[0].found=!0,!c[1].found){t+=a;continue}}else if(c[1].value=c[1].found?Math.min(c[1].value,t):t,c[1].found=!0,!c[0].found){t-=a;continue}t=c[0].value+(c[1].value-c[0].value)/2}return M()}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(l,e=.1)=>{let t=J(l).map(n=>typeof n=="number"?n:0),r=.1,i=[{found:!1,value:0},{found:!1,value:0}];for(let n=0;n<50;n++){let o=0;for(let s=0;s<t.length;s++)o+=Math.pow(1+e,-(s+1))*t[s];if(Math.abs(o)<=.00125)return{type:3,value:e};if(o>0){if(i[0].value=i[0].found?Math.max(i[0].value,e):e,i[0].found=!0,!i[1].found){e+=r;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,e):e,i[1].found=!0,!i[0].found){e-=r;continue}e=i[0].value+(i[1].value-i[0].value)/2}return{type:6,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(l,e,t,r,i,n=0)=>{let o=0;for(let s=r;s<=i;s++)o+=Mn(l,s,e,t,0,n);return{type:3,value:o}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(l,e,t,r,i,n=0)=>{let o=0;for(let s=r;s<=i;s++)o+=oi(l,s,e,t,0,n);return{type:3,value:o}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t,r=0,i=0,n=0)=>({type:3,value:oi(l,e,t,r,i,n)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t,r=0,i=0,n=0)=>({type:3,value:Mn(l,e,t,r,i,n)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t=0,r=0,i=0)=>{let n=.25,o=[-1,1],s=32,a=1e-6;for(let c=0;c<s;c++){let d=vt(n,l,t,r,i);if(Math.abs(d-e)<=a)return{type:3,value:n};let u=vt(o[1],l,t,r,i);e>=d&&e<=u||e>=u&&e<=d?o[0]=n:o[1]=n,n=o[0]+(o[1]-o[0])/2}return{type:3,value:n}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(l,e,t,r=0,i=0)=>({type:3,value:Un(l,e,t,r,i)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t,r=0,i=0)=>i?(t+=r*(1/((1+l)*((Math.pow(1+l,e)-1)/l))),{type:3,value:-(t+t/l*(1-Math.pow(1+l,-(e-1))))}):{type:3,value:-(r+t/l*(Math.pow(1+l,e)-1))/Math.pow(1+l,e)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t=0,r=0,i=0)=>i?{type:3,value:1+(-Math.log(1+l*(1-t/-e))+Math.log(1+r*l/(-e*(1+l))))/Math.log(1+l)}:{type:3,value:(Math.log(Math.pow(1-t*l/-e,-1))+Math.log(1+r*l/-e))/Math.log(1+l)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(l,e,t,r=0,i=0)=>({type:3,value:vt(l,e,t,r,i)})}};var Dn={Char:{arguments:[{name:"number"}],fn:l=>({type:2,value:String.fromCodePoint(l||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:l=>({type:3,value:l.codePointAt(0)||0}),category:["text"]},Value:{arguments:[{name:"text"}],fn:l=>{let e=ge.TryParse(l);return e.type===3?{type:3,value:e.value}:D()},category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(l,e="0.00####")=>({type:2,value:L.Get(e).Format(l||0)}),category:["text"]},WildcardMatch:{visibility:"internal",arguments:[{name:"text",unroll:!0},{name:"text",unroll:!0},{name:"invert"}],fn:(l,e,t=!1)=>{if(typeof l=="string"&&typeof e=="string"){let r=_t(e),i=new RegExp("^"+r+"$","i").exec(l);return{type:4,value:t?!i:!!i}}return{type:4,value:l===e||l?.toString()===e?.toString()}}},Exact:{arguments:[{name:"text",boxed:!0,unroll:!0},{name:"text",boxed:!0,unroll:!0}],category:["text"],fn:(l,e)=>({type:4,value:l?.value?.toString()===e?.value?.toString()})},Len:{arguments:[{name:"string",unroll:!0}],fn:l=>({type:3,value:l.toString().length})},Substitute:{arguments:[{name:"text"},{name:"search"},{name:"replacement"},{name:"index"}],fn:(l,e,t,r)=>{if(typeof r=="number"){if(r<1)return M();let i=1;return{type:2,value:l.replaceAll(e,(...n)=>(console.info(n),i++===r?t:e))}}else return{type:2,value:l.replaceAll(e,t)}}},Left:{arguments:[{name:"string"},{name:"count"}],fn:(l,e=1)=>({type:2,value:l.substr(0,e)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(l,e=1)=>({type:2,value:l.slice(-e)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(l,e=0,t=1)=>({type:2,value:l.substr(Math.max(0,e-1),t)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(l,e,t=1)=>{if(t>=1){if(!l)return{type:3,value:t};let r=_t(l),i=new RegExp(r,"i").exec(e.substr(t-1));if(i)return{type:3,value:i.index+t}}return M()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(l,e,t=1)=>{if(t>=1){if(!l)return{type:3,value:t};l=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");let r=new RegExp(l).exec(e.substr(t-1));if(r)return{type:3,value:r.index+t}}return M()}},Upper:{description:"Converts text to upper case",arguments:[{name:"text",unroll:!0}],fn:l=>l==null?{type:0}:{type:2,value:l.toString().toUpperCase()}},Lower:{description:"Converts text to lower case",arguments:[{name:"text",unroll:!0}],fn:l=>l==null?{type:0}:{type:2,value:l.toString().toLowerCase()}},Concat:{description:"Pastes strings together",fn:(...l)=>{let t=J(l).map(r=>{let i=r?.toString()||"";return typeof r=="number"&&F.decimal_separator===","?i.replace(/\./,","):i}).join("");return{type:2,value:t}}}},si={Concatenate:"Concat"};var dr=(l,e)=>({type:4,value:typeof e.value?.value===l}),ur=[{name:"Reference",metadata:!0,unroll:!0}],zn={IsBlank:{description:"Returns true if the reference is blank",arguments:ur,fn:dr.bind(0,"undefined")},IsNumber:{description:"Returns true if the reference is a number",arguments:ur,fn:dr.bind(0,"number")},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:ur,fn:dr.bind(0,"boolean")},IsText:{description:"Returns true if the reference is text",arguments:ur,fn:dr.bind(0,"string")}};var In=2220446049250313e-31,gs=l=>{let e=1+l;return Math.log(e)-(e-1-l)/e},Ln=(l,e,t,r)=>{let i=2*Number.MIN_VALUE,n=0,o=1,s=1-(l+e)*t/(l+1);Math.abs(s)<i&&(s=Number.NaN),s=1/s,n=s;for(let a=1;a<=512;a++){let c=a*(e-a)*t/((l-1+2*a)*(l+2*a)),d=0;if(s=1+c*s,o=1+c/o,Math.abs(s)<i&&(s=Number.NaN),Math.abs(o)<i&&(o=Number.NaN),s=1/s,d=s*o,n*=d,c=-(l+a)*(l+e+a)*t/((l+2*a)*(l+2*a+1)),s=1+c*s,o=1+c/o,Math.abs(s)<i&&(s=Number.NaN),Math.abs(o)<i&&(o=Number.NaN),s=1/s,d=s*o,n*=d,Math.abs(d-1)<2*In||n*Math.abs(d-1)<r)return n}return Number.NaN},ai=(l,e,t)=>{if(e<0||t<0)return Number.NaN;if(l<=0)return 0;if(l>=1)return 1;if(l>.5)return 1-ai(1-l,t,e);let r=e/(e+t),i=0;if(l<.1){let n=(Math.log(e)+ke(e)+ke(t)-ke(e+t)+Math.log(l))/e;n<=0?(i=Math.exp(n),i*=Math.pow(1-i,-(t-1)/e)):i=r,i>r&&(i=r)}else i=r;for(let n=0;n<64;n++){let o=l-ci(i,e,t),s=li(i,e,t);if(o===0)return i;let a=o/Math.max(2*Math.abs(o/i),s),c=a,d=-((e-1)/i-(t-1)/(1-i))*a*a/2,u=c;if(Math.abs(d)<Math.abs(c)?u+=d:u*=2*Math.abs(c/d),i+u>0&&i+u<1?i+=u:i=Math.sqrt(i)*Math.sqrt(r),Math.abs(c)<=1e-10*i)return i}return i},ke=l=>{let e=l-1,t=e+5.5;t-=(e+.5)*Math.log(t);let r=1,i=[76.18009173,-86.50532033,24.01409822,-1.231739516,.00120858003,-536382e-11];for(let n of i)r+=n/++e;return-t+Math.log(2.50662827465*r)},li=(l,e,t)=>l<0||l>1?0:Math.exp(ke(e+t)-ke(e)-ke(t))*Math.pow(l,e-1)*Math.pow(1-l,t-1),ci=(l,e,t)=>{if(l<=0)return 0;if(l>=1)return 1;let i=-(ke(e)+ke(t)-ke(e+t))+e*Math.log(l)+t*gs(-l),n=Math.exp(i);if(l<(e+1)/(e+t+2)){let o=Ln(e,t,l,0);return n*o/e}else{let o=Math.abs(t/n)*In,s=Ln(t,e,1-l,o);return 1-n*s/t}};var Pn=l=>{let e=.254829592,t=-.284496736,r=1.421413741,i=-1.453152027,n=1.061405429,o=.3275911;l=Math.abs(l);let s=1/(1+o*l);return 1-((((n*s+i)*s+r)*s+t)*s+e)*s*Math.exp(-1*l*l)},_s=Math.sqrt(2*Math.PI),di=(l,e,t,r)=>{let i=0;return r?i=.5*(1+(l<e?-1:1)*Pn(Math.abs(l-e)/(t*Math.sqrt(2)))):i=Math.exp(-1/2*Math.pow((l-e)/t,2))/(t*_s),i},Fn=l=>{if(l===.5)return 0;let e=l<1&&l>.5?1-l:l,t=Math.sqrt(Math.log(1/Math.pow(e,2))),r=t-(2.515517+.802853*t+.010328*Math.pow(t,2))/(1+1.432788*t+.189269*Math.pow(t,2)+.001308*Math.pow(t,3));return l>.5?r:-r},ui=l=>{let e=l.length;return e%2?l[Math.floor(e/2)]:(l[e/2]+l[e/2-1])/2},Nn=(l,e=!0)=>{l.sort((i,n)=>i-n);let t=l.length,r=(i,n,o)=>{let s=n*i+o,a=s%1;if(a){let c=l[Math.floor(s)],d=l[Math.ceil(s)];return c+(d-c)*a}else return l[s]};return e?[l[0],r(.25,t-1,0),ui(l),r(.75,t-1,0),l[t-1]]:t%1?[l[0],r(.25,t-2,0),ui(l),r(.75,t-2,1),l[t-1]]:[l[0],r(.25,t-3,0),ui(l),r(.75,t-3,2),l[t-1]]},hi=l=>{let e=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23],t=Math.PI,r=rr,i=Pe,n=ie,o=f=>({real:f,imaginary:0}),s=(f,p)=>({real:f.real+p.real,imaginary:f.imaginary+p.imaginary}),a=ye,c=gt,d=f=>({real:-f.real,imaginary:-f.imaginary}),u=hn;if(l.real<.5)return i(o(t),n(r(n(o(t),l)),hi({real:1-l.real,imaginary:-l.imaginary})));l.real-=1;let h=o(e[0]);for(let f=1;f<e.length;f++)h=s(h,i(o(e[f]),s(l,o(f))));let m=s(l,o(7.5));return u(o(Math.sqrt(2*t)),a(m,s(l,o(.5))),c(d(m)),h)},Ee=(l,e=!1)=>{let t=l.length,r=0,i=0;for(let n=0;n<t;n++)r+=l[n];r/=t;for(let n=0;n<t;n++){let o=l[n]-r;i+=o*o}return e?i/(t-1):i/t},Hn={Slope:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(l,e)=>{let t=Q(e),r=Q(l);if(t.length!==r.length)return D();let i=0,n=0,o=0,s=0;for(let c=0;c<t.length;c++){let d=t[c],u=r[c];o+=d*u,i+=d,n+=u,s+=d*d}let a=(t.length*o-i*n)/(t.length*s-i*i);return{type:3,value:a}}},Intercept:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(l,e)=>{let t=Q(e),r=Q(l);if(t.length!==r.length)return D();let i=t.length,n=0,o=0,s=0,a=0;for(let d=0;d<i;d++){let u=t[d],h=r[d];s+=u*h,n+=u,o+=h,a+=u*u}let c=i*s-n*o;return c/=i*a-n*n,{type:3,value:(o-c*n)/i}}},Phi:{arguments:[{name:"x",boxed:!0,unroll:!0}],fn:l=>l.type===3?{type:3,value:1/Math.sqrt(Math.PI*2)*Math.exp(-l.value*l.value/2)}:D()},"Z.Test":{arguments:[{name:"Array",boxed:!0},{name:"x",boxed:!0,unroll:!0},{name:"Sigma",boxed:!0,unroll:!0}],fn:(l,e,t)=>{let r=[];if(l.type===8)for(let i of l.value)for(let n of i)n.type===3&&r.push(n.value);else l.type===3&&r.push(l.value);if(r.length&&e.type===3){let i=0,n=r.length;for(let s of r)i+=s;i/=n;let o=t?.type===3?t.value:Math.sqrt(Ee(r,!0));return{type:3,value:1-di((i-e.value)/(o/Math.sqrt(n)),0,1,!0)}}return D()}},"Beta.Dist":{description:"beta distribution",arguments:[{name:"x",unroll:!0},{name:"a"},{name:"b"},{name:"cumulative"}],fn:(l,e,t,r)=>e<0||t<0?D():r?{type:3,value:ci(l,e,t)}:{type:3,value:li(l,e,t)}},"Beta.Inv":{description:"Inverse of the beta distribution",arguments:[{name:"probability",unroll:!0},{name:"a"},{name:"b"}],fn:(l,e,t)=>e<0||t<0?D():{type:3,value:ai(l,e,t)}},Erf:{fn:l=>({type:3,value:Pn(l)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],xlfn:!0,fn:(l,e=0,t=1)=>({type:3,value:Fn(l)*t+e})},"Norm.S.Inv":{description:"Inverse of the standard normal cumulative distribution",arguments:[{name:"probability"}],xlfn:!0,fn:l=>({type:3,value:Fn(l)})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1},{name:"cumulative",default:!0}],xlfn:!0,fn:(l,e=0,t=1,r=!0)=>({type:3,value:di(l,e,t,r)})},"Norm.S.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"cumulative",default:!0}],xlfn:!0,fn:(l,e=!0)=>({type:3,value:di(l,0,1,e)})},"StDev.P":{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...l)=>({type:3,value:Math.sqrt(Ee(Q(l),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...l)=>({type:3,value:Math.sqrt(Ee(Q(l),!0))})},"Var.P":{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...l)=>({type:3,value:Ee(Q(l),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...l)=>({type:3,value:Ee(Q(l),!0)})},Covar:{description:"Returns the covariance between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(l,e)=>{if(!Array.isArray(l)||!Array.isArray(e))return M();if(!Array.isArray(l[0])||!Array.isArray(e[0]))return M();if(l.length!==e.length)return D();let t=0,r=0,i={x:0,y:0},n={x:[],y:[]};for(let o=0;o<l.length;o++){if(!l[o]||!e[o])continue;if(l[o].length!==e[o].length)return D();let s=l[o].length;r+=s;for(let a=0;a<s;a++)i.x+=l[o][a]||0,i.y+=e[o][a]||0,n.x.push(l[o][a]||0),n.y.push(e[o][a]||0)}if(r===0)return ve();i.x/=r,i.y/=r;for(let o=0;o<r;o++)t+=(n.x[o]-i.x)*(n.y[o]-i.y);return{type:3,value:t/r}}},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(l,e)=>{if(!Array.isArray(l)||!Array.isArray(e))return M();if(!Array.isArray(l[0])||!Array.isArray(e[0]))return M();let t=0,r=0,i=0,n=0,o=0,s=0,a=0;for(let c=0;c<l.length;c++){if(!l[c]||!e[c])continue;let d=l[c].length;for(let u=0;u<d;u++){let h=Number(l[c][u]),m=Number(e[c][u]);isNaN(h)||isNaN(m)||(r+=h*m,i+=h,n+=m,o+=h*h,s+=m*m,a++)}}return t=a*r-i*n,t&&(t/=Math.sqrt((a*o-i*i)*(a*s-n*n))),{type:3,value:t}}},GeoMean:{description:"Returns the geometric mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...l)=>{l=ne(l);let e=0,t={real:1,imaginary:0},r=!1,i=!1;for(let n of l)n.type===7?(r=!0,t=ie(t,n.value),e++):n.type===3&&(n.value<0&&(i=!0),e++,t.real*=n.value,t.imaginary*=n.value);if(r){let n=ye(t,{real:1/e,imaginary:0});return n.imaginary?{type:7,value:n}:{type:3,value:n.real}}else return i?M():{type:3,value:Math.pow(t.real,1/e)}}},LCM:{description:"Retuns the least common mulitple of the arguments",arguments:[{boxed:!0}],fn:(...l)=>{l=ne(l);let e=[];for(let i of l){if(i.type===6)return i;if(i.type===3)e.push(i.value);else if(i.type!==0)return console.info("RT",i.type),D()}let t=(i,n)=>i%n==0?n:t(n,i%n);if(e.length===0)return{type:3,value:0};let r=e[0];for(let i=1;i<e.length;i++)r=r*e[i]/t(r,e[i]);return{type:3,value:r}}},GammaLn:{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:l=>l.type===3?{type:3,value:ke(l.value)}:D()},"GammaLn.Precise":{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:l=>{let e;if(l.type===3?e={real:l.value,imaginary:0}:l.type===7&&(e=l.value),e){let t=hi(e);return ae(Kr(t))}return D()}},Gamma:{description:"Returns the gamma function for the given value",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:l=>{let e={real:0,imaginary:0};if(l.type===7)e={...l.value};else if(l.type===3)e.real=l.value;else return D();if(e.imaginary===0&&e.real%1===0&&e.real<=0)return M();let t=hi(e);return Math.abs(t.imaginary)<=1e-7?{type:3,value:t.real}:{type:7,value:t}}},Delta:{arguments:[{name:"number"},{name:"number",default:0}],fn:(l,e=0)=>typeof l!="number"||typeof e!="number"?M():{type:3,value:l===e?1:0}},GCD:{description:"Finds the greatest common divisor of the arguments",arguments:[{boxed:!0}],fn:(...l)=>{l=ne(l);let e=[];for(let i of l){if(i.type===6)return i;if(i.type===3)e.push(i.value);else if(i.type!==0)return console.info("RT",i.type),D()}let t=(i,n)=>i%n==0?n:t(n,i%n);if(e.length===0)return M();if(e.length===1)return{type:3,value:e[0]};let r=e[0];for(let i=1;i<e.length;i++)r=t(r,e[i]);return{type:3,value:r}}},HarMean:{description:"Returns the harmonic mean of the arguments",arguments:[{boxed:!0}],fn:(...l)=>{l=ne(l);let e={real:0,imaginary:0},t=0;for(let r of l){if(r.type===6)return r;if(r.type===3&&(e.real+=1/r.value,t++),r.type===7){let i=Pe({real:1,imaginary:0},r.value);e.real+=i.real,e.imaginary+=i.imaginary,t++}}return e.imaginary?{type:7,value:Pe({real:t,imaginary:0},e)}:{type:3,value:t/e.real}}},Average:{description:"Returns the arithmetic mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...l)=>{l=ne(l);let e={real:0,imaginary:0},t=0;for(let r of l){if(r.type===6)return r;r.type===3&&(e.real+=r.value,t++),r.type===7&&(e.real+=r.value.real,e.imaginary+=r.value.imaginary,t++)}return e.real/=t,e.imaginary/=t,e.imaginary?{type:7,value:e}:{type:3,value:e.real}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(l,e)=>{let t=Q(l);t.sort((a,c)=>a-c);let r=t.length,i=Math.pow(10,8),n=Math.round((1+(r-1)*e)*i)/i,o=Math.floor(n),s=Math.ceil(n);return{type:3,value:(t[o-1]+t[s-1])/2}}},"Quartile.Inc":{description:"Returns the interpolated quartile of the data set (including median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(l,e)=>{if(typeof e!="number"||e<0||e>4||e%1)return D();let t=Q(l),r=Nn(t,!0);return{type:3,value:r[e]}}},"Quartile.Exc":{description:"Returns the interpolated quartile of the data set (excluding median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(l,e)=>{if(typeof e!="number"||e<1||e>3||e%1)return D();let t=Q(l),r=Nn(t,!1);return{type:3,value:r[e]}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...l)=>{let e=Q(l);e.sort((o,s)=>o-s);let r=1+(e.length-1)*.5,i=Math.floor(r),n=Math.ceil(r);return{type:3,value:(e[i-1]+e[n-1])/2}}},Rank:{arguments:[{name:"Value"},{name:"Source"},{name:"Order"}],fn:(l,e,t=0)=>{if(typeof l!="number")return D();let r=Q(e);r.sort(t?(i,n)=>i-n:(i,n)=>n-i);for(let i=0;i<r.length;i++)if(r[i]===l)return{type:3,value:i+1};return M()}}},mi={Mean:"Average",StDev:"StDev.S",StDevA:"StDev.S",StDevPA:"StDev.P",Var:"Var.S",Quartile:"Quartile.Inc",NormSInv:"Norm.S.Inv",NormSDist:"Norm.S.Dist",NormDist:"Norm.Dist"};var On={IsComplex:{description:"Returns true if the reference is a complex number",arguments:[{name:"Reference",metadata:!0,unroll:!0}],fn:l=>({type:4,value:!!l?.value&&ue(l.value.value)})},Real:{description:"Returns the real part of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:l=>l.type===3?{...l}:l.type===7?{type:3,value:l.value.real||0}:l.type===0||l.type===2&&l.value===""?{type:3,value:0}:M()},Imaginary:{description:"Returns the imaginary part of a complex number (as real)",arguments:[{boxed:!0,unroll:!0}],fn:l=>l.type===7?{type:3,value:l.value.imaginary||0}:l.type===3||l.type===0||l.type===2&&l.value===""?{type:3,value:0}:M()},Conjugate:{description:"Returns the conjugate of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:l=>{let e=He(l);return e?e.imaginary?{type:7,value:{real:e.real,imaginary:-e.imaginary}}:{type:3,value:e.real}:M()}},Arg:{description:"Returns the principal argument of a complex number (in radians)",arguments:[{boxed:!0,unroll:!0}],fn:l=>l.type===7?{type:3,value:Math.atan2(l.value.imaginary,l.value.real)}:l.type===3||l.type===0||l.type===2&&l.value===""?{type:3,value:Math.atan2(0,l.value||0)}:M()},Rectangular:{description:"Converts a complex number in polar form to rectangular form",arguments:[{name:"r"},{name:"\u03B8 in radians"}],fn:(l=0,e=0)=>({type:7,value:{real:l*Math.cos(e),imaginary:l*Math.sin(e)}})},Complex:{description:"Ensures that the given value will be treated as a complex number",arguments:[{boxed:!0,unroll:!0}],fn:l=>{let e=He(l);return e?{type:7,value:e}:M()}},ComplexLog:{description:"Returns the principal value Log(z) of a complex number z",arguments:[{boxed:!0,unroll:!0}],fn:l=>{if(l.type===3){if(!l.value)return M();l={type:7,value:{real:l.value,imaginary:0}}}else if(l.type===0||l.type===2&&l.value==="")return M();if(l.type===7){let e=tr(l.value),t={real:Math.log(e.r),imaginary:e.theta};return t.imaginary?{type:7,value:t}:{type:3,value:t.real}}return M()}}};var hr=l=>{let e=[];l.type===8?e=l.value:e=[[l]];let t=e.length,r=t?e[0].length:0,i=[];if(!t||!r)return{m:t,n:r,array:i};for(let n=0;n<t;n++){let o=[];for(let s=0;s<r;s++){let a=e[n][s];if(a.type===7)o.push({...a.value});else if(a.type===3)o.push({real:a.value,imaginary:0});else if(a.type===0||a.value==="")o.push({real:0,imaginary:0});else return{m:t,n:r,error:!0,array:[]}}i.push(o)}return{m:t,n:r,array:i}},Gn={MDeterm:{description:"Returns the determinant of a matrix",arguments:[{name:"matrix",boxed:!0}],fn:l=>{let e=hr(l);if(!e.array||!e.m||!e.n||e.m!==e.n||e.error)return M();let t=ir(e);return t?ae(t):M()}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"matrix",boxed:!0}],fn:l=>{let e=hr(l);if(!e.array||!e.m||!e.n||e.m!==e.n||e.error)return M();let t=ir(e);if(t&&t.real===0&&t?.imaginary===0)return M();let r=fn(e);return r?{type:8,value:r.map(i=>i.map(n=>ae(n)))}:M()}},MMult:{description:"Returns the dot product A \u22C5 B",arguments:[{name:"A",boxed:!0},{name:"B",boxed:!0}],fn:(l,e)=>{let t=hr(l),r=hr(e);if(!t.array||t.error||!r.array||r.error)return M();if(t.m!==r.n)return M();let i=mn(r,t);return{type:8,value:i.map(n=>n.map(o=>ae(o)))}}}};var Bn={RegexExtract:{description:"Extract text using a regular expression",arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"return mode",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],fn:(l,e,t=0,r=!1)=>{let i=[];r&&i.push("i"),t===1&&i.push("g");let n=new RegExp(e,i.length?i.join(""):void 0);switch(t){case 0:{let o=l.match(n);return{type:2,value:o===null?"":o[0]??""}}case 1:{let o=Array.from(l.matchAll(n));return console.info({result:o}),{type:8,value:[o.map(s=>({type:2,value:s[0]||""}))]}}case 2:{let o=l.match(n);if(o===null)return{type:2,value:""};let s=Array.from(o).slice(1);return{type:8,value:[s.map(a=>({type:2,value:a}))]}}default:return D()}}},RegexReplace:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"replacement",unroll:!0},{name:"occurrence",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],description:"Replace text in a string using a regex",fn:(l,e,t,r=0,i=!1)=>{let n=["g"];i&&n.push("i");let o=new RegExp(e,n.length?n.join(""):void 0);if(r===0)return{type:2,value:l.replaceAll(o,t)};if(r<0){let a=Array.from(l.matchAll(o)).length;r+=a+1}let s=l.replace(o,a=>--r===0?t:a);return{type:2,value:s}}},RegexTest:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"case insensitive",unroll:!0,default:!1}],description:"Match text against a regular expression",fn:(l,e,t=!1)=>{let r=new RegExp(e,t?"i":void 0);return{type:4,value:r.test(l)}}}};var tt=class l extends De{static type="state-leaf-vertex";state_id=0;type=l.type;color=2;Calculate(){if(this.dirty){for(let e of this.edges_in)if(e.dirty)return;this.state_id++,this.dirty=!1}}AddDependent(){throw new Error("leaf vertex cannot have dependents")}};var ys=l=>{if(typeof l=="string")switch(l=l.toUpperCase(),l){case"AVERAGE":case"MEAN":l=101;break;case"COUNT":l=102;break;case"COUNTA":l=103;break;case"MAX":l=104;break;case"MIN":l=105;break;case"PRODUCT":l=106;break;case"STDEV":l=107;break;case"STDEVP":l=108;break;case"SUM":l=109;break;case"VAR":l=110;break;case"VARP":l=111;break;default:l=0;break}return l},vs={complex_numbers:"off",spill:!1},mr=class extends er{constructor(t,r={}){super();this.model=t;if(this.expression_calculator=new or(this.model,this.library,this.parser),this.options={...vs,...r},this.options.complex_numbers==="on"){for(let o of Object.keys(ni))et[o]=ni[o];gn()}this.UpdateLocale(),this.library.Register(et,Dn,Hn,Vn,zn,On,Gn,Bn);for(let o of Object.keys(mi))this.library.Alias(o,mi[o]);for(let o of Object.keys(si))this.library.Alias(o,si[o]);let i=(o,s,...a)=>{let c=[];for(let m=0;m<a.length;m+=2)if(Array.isArray(a[m])){let f=n(a[m],a[m+1]);if(f.type!==8)return f;for(let[p,b]of f.value[0].entries())c[p]=!!b.value&&c[p]!==!1}let d=J(s,!0),u=0,h=0;for(let[m,f]of c.entries())if(f){u++;let p=d[m];typeof p=="number"&&(h+=p)}switch(o){case"count":return{type:3,value:u};case"sum":return{type:3,value:h};case"average":return u===0?_e():{type:3,value:h/u}}},n=(o,s)=>{let a=J(o,!0),c,d,u="=";if(typeof s=="string"){s=s.trim();let m=s.match(/^([=<>]+)/);m&&(u=m[1],s=s.substring(u.length));let f=ge.TryParse(s);if(f?.type===2?s=`"${f.value}"`:s=f?.value?.toString()||"",/[?*]/.test(s)){let p=this.parser.argument_separator;if(u==="="||u==="<>"){if(c=this.parser.Parse(`=WildcardMatch({}${p} ${s}${p} ${u==="<>"})`),d=c.expression,c.error||!d)return Ae();d?.type==="call"&&d.args[0]?.type==="array"&&(d.args[0].values=[ii(a,!0)])}}}else s=(s||0).toString();if(!c){if(c=this.parser.Parse("{}"+u+s),d=c.expression,c.error||!d)return Ae();if(d.type!=="binary")return console.warn("invalid expression [1]",d),Ae();if(d.left.type!=="array")return console.warn("invalid expression [1]",d),Ae();d.right.type==="identifier"&&(console.warn("will never happen"),d.right={...d.right,type:"literal",value:d.right.name}),d.left.values=[ii(a,!0)]}return d?this.CalculateExpression(d):M()};this.library.Register({Subtotal:{arguments:[{name:"type"},{name:"range",metadata:!0}],fn:(o,...s)=>{if(o=ys(o),o>100&&(o-=100),o<1||o>11)return D();let a=ne(s),c=[],d=0,u=0,h;for(let f of a){let p=f.value?.address;if(!p)return $();if(!h||h.id!==p.sheet_id){if(!p.sheet_id)return console.warn("invalid reference in metadata"),$();if(h=this.model.sheets.Find(p.sheet_id),!h)return console.warn("invalid sheet in metadata"),$()}if(!h.GetRowHeight(p.row))continue;let g=f.value?.value;typeof g>"u"||(d++,typeof g=="number"&&(u+=g,c.push(g)))}let m=0;switch(o){case 1:if(c.length===0)return _e();m=u/c.length;break;case 2:m=c.length;break;case 3:m=d;break;case 4:if(c.length===0)return M();m=Math.max.apply(0,c);break;case 5:if(c.length===0)return M();m=Math.min.apply(0,c);break;case 6:if(c.length===0)return M();m=1;for(let f of c)m*=f;break;case 7:if(c.length<2)return _e();m=Math.sqrt(Ee(c,!0));break;case 8:if(c.length===0)return _e();m=Math.sqrt(Ee(c,!1));break;case 9:m=u;break;case 10:if(c.length<2)return _e();m=Ee(c,!0);break;case 11:if(c.length===0)return _e();m=Ee(c,!1);break}return{type:3,value:m}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return",unroll:!0},{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:(o,s)=>{if(!ce(s))return $();if(o)switch(o.toString().toLowerCase()){case"format":return s.value.format?{type:2,value:s.value.format}:$();case"address":{let a="";return s.value.address.sheet_id&&(a=this.model.sheets.Find(s.value.address.sheet_id)?.name||""),a&&(xe.test(a)&&(a=`'${a}'`),a+="!"),{type:2,value:"[]"+a+s.value.address.label.replace(/\$/g,"")}}}return{type:6,value:en.error}}},Address:{arguments:[{name:"row"},{name:"column"},{name:"absolute"},{name:"a1"},{name:"sheet name"}],fn:(o=1,s=1,a=1,c=!0,d)=>{let u={type:"address",id:0,position:0,label:"",row:o-1,column:s-1};switch(a){case 2:u.absolute_row=!0;break;case 3:u.absolute_column=!0;break;case 4:break;default:u.absolute_column=!0,u.absolute_row=!0}return d&&(u.sheet=d),wn(this.parser.Render(u,{r1c1:!c}))}},CountIfs:{arguments:[{name:"range"},{name:"criteria"},{name:"range"},{name:"criteria"}],fn:(...o)=>i("count",o[0],...o)},AverageIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(o,s,a)=>i("average",a||o,o,s)},AverageIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(o,...s)=>i("average",o,...s)},SumIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(o,s,a)=>i("sum",a||o,o,s)},SumIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(o,...s)=>i("sum",o,...s)},CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(o,s)=>i("count",o,o,s)},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"},{name:"height"},{name:"width"}],return_type:"reference",volatile:!0,fn:((o,s=0,a=0,c,d)=>{if(!o)return D();if(o.type===8){let h=typeof c=="number"?s+c:void 0,m=typeof d=="number"?a+d:void 0;return{type:8,value:o.value.slice(s,h).map(p=>p.slice(a,m))}}if(!ce(o))return console.info("e2",{reference:o}),$();let u=this.DynamicDependencies(o.value.address,this.expression_calculator.context.address,!0,s,a,d,c);if(!u)return console.info("e1",{check_result:u}),$();if(u.dirty){let h=this.GetVertex(this.expression_calculator.context.address,!0);return h.short_circuit=!0,{type:0,value:void 0}}if(u.area){let h={type:"address",...u.area.start,label:"",position:0,id:0},m={type:"address",...u.area.end,label:"",position:0,id:0},f=u.area.count===1?h:{type:"range",start:h,end:m,label:"",position:0,id:0};return{type:5,value:f}}return M()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:"reference",volatile:!0,fn:(o=>{if(!o||typeof o!="string")return D();let s=this.parser.Parse(o);if(s.error||!s.expression||s.expression.type!=="address"&&s.expression.type!=="range")return $();let a=this.DynamicDependencies(s.expression,this.expression_calculator.context.address);if(!a)return $();if(a.dirty){let c=this.GetVertex(this.expression_calculator.context.address,!0);return c.short_circuit=!0,{type:0,value:void 0}}return{type:5,value:s.expression}}).bind(this)},Match:{arguments:[{name:"value",boxed:!0},{name:"range",boxed:!0},{name:"type"}],fn:(o,s,a=0)=>{if(a)return console.warn("inexact match not supported",{value:o,range:s,type:a}),ve();if(s.type===8){if(s.value.length===1){let c=s.value[0];for(let d=0;d<c.length;d++)if(o.type==c[d].type&&o.value===c[d].value)return{type:3,value:d+1}}else for(let c=0;c<s.value.length;c++){let d=s.value[c];if(d.length!==1)return ve();if(o.type==d[0].type&&o.value===d[0].value)return{type:3,value:c+1}}return ve()}else return o.type===s.type&&o.value===s.value?{type:3,value:1}:ve();return D()}},Index:{arguments:[{name:"range",boxed:!0},{name:"row"},{name:"column"}],volatile:!1,fn:(o,s,a)=>{if(o&&o.type!==8&&(o={type:8,value:[[o]]}),s&&a){let c=o.value[a-1];if(c){let d=c[s-1];if(d)return d}}else if(s){let c=[];for(let d of o.value){if(!d[s-1])return D();c.push([d[s-1]])}return{type:8,value:c}}else if(a){let c=o.value[a-1];if(c)return{type:8,value:[c]}}return D()}},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:o=>{if(!o)return D();if(Array.isArray(o)){let s=o[0];return Array.isArray(s)?{type:3,value:s.length}:M()}return{type:3,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:o=>o?Array.isArray(o)?{type:3,value:o.length}:{type:3,value:1}:D()},FormulaText:{description:"Returns a formula as a string",arguments:[{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:o=>{if(!ce(o))return $();let s=this.model.sheets.Find(o.value?.address?.sheet_id||0);if(s){let a=s.cells.GetCell(o.value.address,!1);return{type:2,value:a?.value?.toString()||""}}return $()}},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",unroll:!0,metadata:!0}],fn:o=>{let s=o?.value?.address,a=this.model.sheets.Find(s?.sheet_id||0);if(s&&a){let c=a.cells.GetCell(s,!1);return{type:4,value:c?.type===1}}return{type:4,value:!1}}}})}get parser(){return this.model.parser}library=new lr;registered_libraries={};expression_calculator;full_rebuild_required=!1;options;grid_expanded=!1;ExportCalculatedValues(){let t={};for(let r of this.model.sheets.list){let i=r.cells.toJSON({calculated_value:!0}).data;t[r.id]=i.filter(n=>n.calculated!==void 0)}return t}ApplyCalculatedValues(t){for(let r of this.model.sheets.list){let i=t[r.id];if(!i)console.info("mismatch",r.id);else for(let n of i)r.cells.data[n.row][n.column].SetCalculatedValue(n.calculated)}}AttachSpillData(t,r){if(r||(r=(t.start.sheet_id?this.model.sheets.Find(t.start.sheet_id):void 0)?.cells),!r)throw new Error("invalid sheet ID in attach spill data");let i=new tt,n=0,o=!1;for(let{cell:s,row:a,column:c}of r.IterateRC(t,!0))n++&&(s.type!==0||s.area||s.merge_area||s.table)&&(o=!0),this.AddLeafVertexEdge({row:a,column:c,sheet_id:t.start.sheet_id},i);return this.spill_data.push({area:t,vertex:i}),{vertex:i,area:t,error:o}}SpillCallback(t,r){let{reference:i,address:n}=t,{value:o}=r,s=[];if(!i)return console.error("invalid reference in spill callback"),s;if(!n||!n.sheet_id)return console.error("invalid address in spill callback"),s;if(o.length===1&&o[0].length===1||!this.options.spill)return i.SetCalculatedValue(o[0][0].value),s;let a=this.model.sheets.Find(n.sheet_id),c=a?.cells;if(c){let d=r.value.length,u=r.value[0].length,h=new y(n).Reshape(u,d),{error:m}=this.AttachSpillData(h,c);if(m)return i.SetCalculationError("SPILL"),s;a.rows<h.end.row+1&&(a.cells.EnsureRow(h.end.row+1),this.grid_expanded=!0),a.columns<h.end.column+1&&(a.cells.EnsureColumn(h.end.column+1),this.grid_expanded=!0);let f=n.sheet_id;for(let{row:p,column:b}of c.IterateRC(h)){if(p===n.row&&b===n.column)continue;let g=this.GetVertex({sheet_id:f,row:p,column:b},!1);g&&(g.dirty||s.push(g))}for(let{cell:p,row:b,column:g}of c.IterateRC(h)){p.spill=h,b-=n.row,g-=n.column;let x=r.value[g][b];switch(x.type){case 5:case 8:break;default:p.SetCalculatedValue(x.value,x.type);break}}return s}return console.error("invalid cell reference in spill callback"),i.SetCalculationError("SPILL"),[]}SpreadCallback(t,r){if(!t.address||!t.address.sheet_id)throw new Error("spread callback called without sheet id");let i=this.model.sheets.Find(t.address.sheet_id)?.cells;if(!i)throw new Error("spread callback called without cells");if(!t||!t.reference)return;let n=t.reference.area;if(n){let o=n.rows,s=n.columns;if(r.type===8){let a=sr(r.value);for(let c=0;c<o;c++)if(a[c]){let d=0;for(;d<s&&d<a[c].length;d++){let u=a[c][d];switch(u.type===8&&(u=u.value[0][0]),u.type){case 8:case 5:i.data[c+n.start.row][d+n.start.column].SetCalculatedValue(void 0);break;default:i.data[c+n.start.row][d+n.start.column].SetCalculatedValue(u.value,u.type)}}for(;d<s;d++)i.data[c+n.start.row][d+n.start.column].SetCalculatedValue(void 0,0)}else for(let d=0;d<s;d++)i.data[c+n.start.row][d+n.start.column].SetCalculatedValue(void 0,0)}else{let a={...r};a.type===5&&(a={type:0,value:void 0});for(let c=0;c<o;c++)for(let d=0;d<s;d++)i.data[c+n.start.row][d+n.start.column].SetCalculatedValue(a.value,a.type)}}}CalculationCallback(t){if(!t.address)throw new Error("vertex missing address");return t.expression_error?{value:Yt()}:this.expression_calculator.Calculate(t.expression,t.address,t.reference?.area)}DynamicDependencies(t,r,i=!1,n=0,o=0,s=1,a=1){let c=this.ResolveExpressionAddress(t,r);if(!c)return;let d=!1,u;if(t.type==="address"||t.type==="range"){let m=t.type==="range"?t.start:t;m.sheet_id?u=this.model.sheets.Find(m.sheet_id):m.sheet&&(u=this.model.sheets.Find(m.sheet))}if(!u&&r?.sheet_id&&(u=this.model.sheets.Find(r.sheet_id)),!u)throw new Error("missing sheet in dynamic dependencies [b21]");c=u.RealArea(c);let h=c.start.sheet_id;i&&(c=new y({column:c.start.column+o,row:c.start.row+n,sheet_id:c.start.sheet_id},{column:c.start.column+o+s-1,row:c.start.row+n+a-1,sheet_id:c.end.sheet_id}));for(let m=c.start.row;m<=c.end.row;m++)for(let f=c.start.column;f<=c.end.column;f++){let p=this.GetVertex({row:m,column:f,sheet_id:h},!1);p&&p.dirty&&(this.AddEdge({row:m,column:f,sheet_id:h},this.expression_calculator.context.address),d=!0)}return{dirty:d,area:c}}UpdateLocale(){F.decimal_separator===","?this.parser.SetLocaleSettings(","):this.parser.SetLocaleSettings(".")}SupportedFunctions(){let t=this.library.List(),r=Object.keys(t).map(i=>{let n=t[i].canonical_name;return n||(n=i.replace(/_/g,".")),{name:n,description:t[i].description,arguments:(t[i].arguments||[]).map(o=>({name:o.name||""})),type:"function"}});for(let i of this.model.macro_functions.values())r.push({name:i.name,description:i.description,arguments:(i.argument_names||[]).map(n=>({name:n})),type:"function"});return r}RegisterLibrary(t,r){return this.registered_libraries[t]?!1:(this.RegisterFunction(r),this.registered_libraries[t]=!0,!0)}RegisterFunction(t){for(let r of Object.keys(t)){let i=t[r];this.library.Register({[r]:i})}}Calculate(t){if(t&&!t.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(t=void 0,this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.full_rebuild_required=!1),this.RebuildGraph(t),this.grid_expanded=!1;try{this.Recalculate()}catch(r){console.error(r),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.full_rebuild_required=!0}DecoratedFunctionList(){let t={},r=this.library.List();for(let i of Object.keys(r)){let n=r[i];n.xlfn?t[i]="_xlfn":n.extension&&(t[i]="_xll")}return t}Evaluate(t,r,i={},n=!1){let o=i?.preparsed;if(!o){this.parser.Save(),i.argument_separator&&(i.argument_separator===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(",")),i.r1c1&&(this.parser.flags.r1c1=i.r1c1);let s=this.parser.Parse(t);if(this.parser.Restore(),o=s.expression,s.error)throw new Error(s.error)}if(o){this.parser.Walk(o,a=>{if(a.type==="address"||a.type==="range"){if(a.type==="address"){if(a.offset_column||a.offset_row)throw new Error("Evaluate does not support offset references")}else if(a.start.offset_column||a.start.offset_row||a.end.offset_column||a.end.offset_row)throw new Error("Evaluate does not support offset references");this.model.ResolveSheetID(a,void 0,r)}return!0});let s=this.CalculateExpression(o,i.address);return n?s:s.type===8?s.value.map(a=>a.map(c=>c.value)):s.value}throw new Error("invalid expression")}CalculateExpression(t,r={row:-1,column:-1},i=!1){return this.expression_calculator.Calculate(t,r,void 0,i).value}RebuildClean(t=!1){this.full_rebuild_required=!1,this.RebuildGraph(),this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.InitializeGraph(),t&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(t){let r={},i=[];for(let n of t){let o={column:n.column,row:n.row,sheet_id:n.sheet_id},s=y.CellAddressToLabel(o,!0);r[s]||(r[s]=s,i.push(o))}return i}Unresolve(t,r,i=!0,n=!0){let o="",s=N(t)?new y(t):new y(t.start,t.end);if(n){let d=this.model.named.MatchSelection(s);if(d)return d}if(o=s.spreadsheet_label,!i)return o;let a=s.start.sheet_id||r?.id,c=this.ResolveSheetName(a,!0);return c?c+"!"+o:o}ResolveSheetName(t,r=!1){let i=this.model.sheets.Find(t);if(i)return r&&xe.test(i.name)?`'${i.name}'`:i.name}RemoveConditional(t){if(t.type==="expression"){let r=t.internal?.vertex;r&&(r.Reset(),this.RemoveLeafVertex(r))}}RemoveConnectedELement(t){let r=t.internal;return r?.vertex?(this.RemoveLeafVertex(r.vertex),!0):!1}UpdateConnectedElements(t,r){if(t||(t=this.model.sheets.list[0]),r){let n=r.internal;n?.vertex&&this.RemoveLeafVertex(n.vertex)}let i=r?[r]:this.model.connected_elements.values();for(let n of i){let o=n.internal;o||(o={vertex:new tt},n.internal=o);let s=o.vertex;this.AddLeafVertex(s),this.UpdateLeafVertex(s,n.formula,t)}}UpdateConditionals(t,r){if(!t){for(let i of this.model.sheets.list)i.conditional_formats?.length&&this.UpdateConditionals(i.conditional_formats,i);return}if(!r)throw new Error("invalid call to update conditionals without context");t&&!Array.isArray(t)&&(t=[t]);for(let i of t){let n="";switch(i.type){case"cell-match":i.between?n=`BETWEEN(${[this.Unresolve(i.area,r,!0,!1),...i.between].join(", ")})`:n=this.Unresolve(i.area,r,!0,!1)+" "+i.expression;break;case"expression":n=i.expression;break;case"duplicate-values":n=`UniqueValues(${this.Unresolve(i.area,r,!0,!1)})`,i.unique||(n=`NOT(${n})`);break;case"gradient":n=`=Gradient(${[this.Unresolve(i.area,r,!0,!1),i.min??"",i.max??""].join(",")})`;break;default:continue}if(!n)continue;if(i.internal||(i.internal={}),!i.internal.vertex){let s=new Zt;s.use="conditional",i.internal.vertex=s;let a={argument_separator:","};i.type!=="gradient"&&i.type!=="duplicate-values"&&(a={...i.options,...a});let c=this.Evaluate(n,r,a,!0);i.internal.vertex.result=c,i.internal.vertex.updated=!0}let o=i.internal.vertex;this.AddLeafVertex(o),this.UpdateLeafVertex(o,n,r,".")}}RemoveAnnotation(t){let r=t.temp;r.vertex&&(r.vertex.Reset(),this.RemoveLeafVertex(r.vertex))}UpdateAnnotations(t,r){if(!t){for(let i of this.model.sheets.list)this.UpdateAnnotations(i.annotations,i);return}if(!r)throw new Error("invalid call to UpdateAnnotations with list but no sheet");typeof t<"u"&&!Array.isArray(t)&&(t=[t]);for(let i of t)if(i.data.formula){let n=i.temp;n.vertex||(n.vertex=new tt),this.AddLeafVertex(n.vertex),this.UpdateLeafVertex(n.vertex,i.data.formula,r)}}ResolveExpressionAddress(t,r){switch(t.type){case"address":if(this.model.ResolveSheetID(t,r))return new y(t);break;case"range":if(this.model.ResolveSheetID(t,r))return new y(t.start,t.end);break;case"identifier":{let i=this.model.GetName(t.name,r?.sheet_id||0);if(i&&i.type==="range")return new y(i.area.start,i.area.end)}break}}NamedRangeToAddressUnit(t,r){let i=t.name.toUpperCase(),n=this.model.GetName(i,r.sheet_id||0);if(n&&n.type==="range")return n.area.count===1?this.ConstructAddressUnit(n.area.start,i,t.id,t.position):{type:"range",start:this.ConstructAddressUnit(n.area.start,i,t.id,t.position),end:this.ConstructAddressUnit(n.area.end,i,t.id,t.position),label:i,id:t.id,position:t.position}}ConstructAddressUnit(t,r,i,n){return{type:"address",row:t.row,column:t.column,sheet_id:t.sheet_id,label:r,id:i,position:n}}RebuildDependencies(t,r,i,n={addresses:{},ranges:{}},o){if(!i){let s=this.model.sheets.Find(r);s&&(i=s.name)}switch(t.type){case"literal":case"missing":case"operator":break;case"identifier":{let s=this.model.GetName(t.name,o.sheet_id||0);if(s?.type==="expression")this.RebuildDependencies(s.expression,r,i,n,o);else{let a=this.NamedRangeToAddressUnit(t,o);a&&(a.type==="address"?n.addresses[a.label]=a:n.ranges[a.label]=a)}}break;case"structured-reference":{let s=this.model.ResolveStructuredReference(t,o);s&&(s.type==="address"?n.addresses[s.sheet_id+"!"+s.label]=s:n.ranges[s.label]=s);let a=this.model.tables.get(t.table.toLowerCase());if(a){let c=o.row;if(c<a.area.start.row||c>a.area.end.row)break;let d=t.column.toLowerCase(),u=-1;if(a.columns){for(let h=0;h<a.columns.length;h++)if(d===a.columns[h]){u=a.area.start.column+h;break}}if(u>=0){let h={label:t.label,type:"address",row:c,column:u,sheet_id:a.area.start.sheet_id,id:t.id,position:t.position};n.addresses[h.sheet_id+"!"+h.label]=h}}}break;case"address":if(!t.sheet_id)if(t.sheet){let s=this.model.sheets.Find(t.sheet);s&&(t.sheet_id=s.id)}else t.sheet_id=r,t.sheet=i;t.sheet_id?n.addresses[t.sheet_id+"!"+t.label]=t:console.warn("invalid address in range [9d]");break;case"range":if(!t.start.sheet_id)if(t.start.sheet){let s=this.model.sheets.Find(t.start.sheet);s&&(t.start.sheet_id=s.id)}else t.start.sheet_id=r,t.start.sheet=i;t.start.sheet_id?n.ranges[t.start.sheet_id+"!"+t.start.label+":"+t.end.label]=t:console.warn("invalid sheet in range",t);break;case"unary":this.RebuildDependencies(t.operand,r,i,n,o);break;case"binary":this.RebuildDependencies(t.left,r,i,n,o),this.RebuildDependencies(t.right,r,i,n,o);break;case"group":t.elements.forEach(s=>this.RebuildDependencies(s,r,i,n,o));break;case"call":{let s=t.args.slice(0),a=this.library.Get(t.name);a&&a.arguments&&a.arguments.forEach((c,d)=>{c&&c.address&&(this.RebuildDependencies(s[d],r,i,void 0,o),s[d]={type:"missing",id:-1})}),s.forEach(c=>this.RebuildDependencies(c,r,i,n,o))}break}return n}UpdateLeafVertex(t,r,i,n){t.Reset(),n&&(this.parser.Save(),this.parser.SetLocaleSettings(n));let o=this.parser.Parse(r);if(o.expression){let s=this.RebuildDependencies(o.expression,i.id,i.name,void 0,{row:0,column:0});for(let a of Object.keys(s.ranges)){let c=s.ranges[a],d=new y(c.start,c.end);d.entire_column||d.entire_row||d.count>1?this.AddLeafVertexArrayEdge(d,t):this.AddLeafVertexEdge(d.start,t)}for(let a of Object.keys(s.addresses)){let c=s.addresses[a];this.AddLeafVertexEdge(c,t)}}t.expression=o.expression||{type:"missing",id:-1},t.expression_error=!o.valid,n&&this.parser.Restore()}RebuildGraphCell(t,r){if(t.spill&&this.options.spill&&(t.spill.start.row===r.row&&t.spill.start.column===r.column?this.AttachSpillData(new y(t.spill.start,t.spill.end)):this.AddEdge(t.spill.start,r)),t.area&&t.area.start.column===r.column&&t.area.start.row===r.row){let{start:i,end:n}=t.area,o=i.sheet_id||r.sheet_id;i.sheet_id||(i.sheet_id=o);for(let s=i.column;s<=n.column;s++)for(let a=i.row;a<=n.row;a++)this.ResetInbound({column:s,row:a,sheet_id:o},!0,!1);this.SetDirty(r);for(let s=i.column;s<=n.column;s++)for(let a=i.row;a<=n.row;a++)a===i.row&&s===i.column||this.AddEdge(i,{...i,row:a,column:s})}if(t.type===1){this.ResetInbound(r,!0);let i=this.parser.Parse(t.value);if(i.expression){if(i.expression.type==="call"){let s=this.library.Get(i.expression.name);s&&(s.render||s.click)&&(t.render_function=s.render,t.click_function=s.click)}let o=this.RebuildDependencies(i.expression,r.sheet_id,"",void 0,r);for(let s of Object.keys(o.ranges)){let a=o.ranges[s],c=new y(a.start,a.end);if(c.entire_row||c.entire_column)this.AddArrayEdge(c,r);else for(let d of c)this.AddEdge(d,r)}for(let s of Object.keys(o.addresses)){let a=o.addresses[s];this.AddEdge(a,r)}}let n=this.GetVertex(r,!0);n&&(n.expression=i.expression||{type:"missing",id:-1},n.expression_error=!i.valid)}else t.value!==t.calculated?this.ResetInbound(r,!0,!1):t.type===0&&this.ResetInbound(r,!0,!1,!0)}RebuildGraph(t){if(t){if(!t.start.sheet_id)throw new Error("subset missing sheet id");let r=this.model.sheets.Find(t.start.sheet_id)?.cells;if(r)for(let i=t.start.row;i<=t.end.row;i++){let n=r.data[i];if(n)for(let o=t.start.column;o<=t.end.column;o++){let s=n[o];s&&this.RebuildGraphCell(s,{row:i,column:o,sheet_id:t.start.sheet_id})}}}else for(let r of this.model.sheets.list||[]){let i=r.cells.data.length;for(let n=0;n<i;n++){let o=r.cells.data[n];if(o){let s=o.length;for(let a=0;a<s;a++){let c=o[a];c&&this.RebuildGraphCell(c,{row:n,column:a,sheet_id:r.id})}}}}}CheckVolatile(t){if(!t.expression||t.expression_error)return!1;let r=!1;return this.parser.Walk(t.expression,i=>{if(i.type==="call"){let n=this.library.Get(i.name);n&&n.volatile&&(r=!0)}return!r}),r}};var fr=class{model={};layout_element;visible_=!1;timeout=0;pending_dialog_resoltion=[];options_={type:"initial"};set options(e){if(e.type==="about"&&(e.close_box=!0,e.icon=!0),this.options_.icon!==e.icon&&(this.model.left.style.display=e.icon?"block":"none"),this.options_.close_box!==e.close_box&&(this.model.close.style.display=e.close_box?"block":"none"),this.options_.message!==e.message&&(this.model.message.textContent=e.message||"",this.model.message.style.display=e.message?"block":"none"),this.options_.title!==e.title&&(this.model.title.textContent=e.title||"",this.model.title.style.display=e.title?"block":"none"),this.options_.type!==e.type){let t=this.model.dialog.className.replace(/dialog-type-\S+/g,"").trim();e.type&&(t+=` dialog-type-${e.type}`),this.model.dialog.className=t,e.type==="about"?this.model.about.style.display="block":this.model.about.style.display="none"}this.options_=e}event_handler=e=>{(e.key==="Escape"||e.key==="Esc")&&(e.stopPropagation(),e.preventDefault(),this.visible=!1)};get visible(){return this.visible_}set visible(e){if(e!==this.visible_)if(this.visible_=e,e)this.layout_element?.setAttribute("dialog",""),window.addEventListener("keydown",this.event_handler);else{this.layout_element?.removeAttribute("dialog"),window.removeEventListener("keydown",this.event_handler);let t=this.pending_dialog_resoltion.slice(0);this.pending_dialog_resoltion=[],Promise.resolve().then(()=>{for(let r of t)r()})}}constructor(e){this.layout_element=e.parentElement;let t=this.layout_element?.querySelector(".treb-dialog-mask");if(t){let r=t.querySelectorAll("[data-bind]");for(let i of Array.from(r)){let n=i.dataset.bind;n&&(this.model[n]=i)}}if(this.model.about){let r=["<div>TREB version 31.9.1"];r.push("<small><a target=_blank href='https://treb.app'>http://treb.app</a></small>"),this.model.about.innerHTML=r.join(`
`)}this.model.close?.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),this.HideDialog()})}Node(e){return this.model[e]}Update(e,t=!0){t&&(e={...this.options_,...e}),this.options=e}HideDialog(){this.visible=!1}ShowDialog(e){return new Promise(t=>{this.pending_dialog_resoltion.push(t),this.options=e,this.visible=!0,this.timeout&&(window.clearTimeout(this.timeout),this.timeout=0),e.timeout&&(this.timeout=window.setTimeout(()=>this.HideDialog(),e.timeout))})}};var pr=class{constructor(e){this.container=e;let t=H.GetInstance(e.ownerDocument);this.node=t.Div("treb-spinner",e,{html:"<div><div></div><div></div><div></div><div></div></div>"})}node;visible=!1;Show(){this.node.classList.add("visible")}Hide(){this.node.classList.remove("visible")}};var $n={formula_bar:!0,in_cell_editor:!0,undo:!0,scrollbars:!0,headers:!0,export:!0,tab_bar:"auto",resizable:!0,hyperlinks:"_blank",max_file_size:94208,tint_theme_colors:!0,dnd:!1,add_tab:!1,expand_formula_button:!1,expand:!0,markdown:!1,spinner:!1,complex:"off",spill:!0};var we=l=>!!l&&typeof l=="object"&&l.key==="metadata"&&!!l.value&&l.value.type==="metadata",fi=l=>!!l&&typeof l=="object"&&l.key==="series"&&typeof l.value=="object",jn=l=>!!l&&typeof l=="object"&&l.type===8&&Array.isArray(l.value);var G=class{static Scale(e,t,r=6.5,i,n){return Vi(e,t,r,i,n)}static Range(e){let t,r;for(let n of e)typeof n>"u"||((typeof t>"u"||t>n)&&(t=n),(typeof r>"u"||r<n)&&(r=n));let i=typeof t>"u"||typeof r>"u"?0:r-t;return{min:t,max:r,range:i}}static ApplyScale(e,t,r){return t*(e-r.min)/(r.max-r.min)}static Flatten(e){let t=[];if(Array.isArray(e))for(let r of e)Array.isArray(r)?t=t.concat(this.Flatten(r)):t.push(r);else typeof e<"u"&&t.push(e);return t}};var Jn=l=>{pi(l,0,l.length)},ws=(l,e,t)=>{let r=l[t-1],i=e;for(let n=e;n<t-1;n+=1)l[n]<=r&&(qn(l,n,i),i+=1);return qn(l,i,t-1),i},qn=(l,e,t)=>{let r=l[e];l[e]=l[t],l[t]=r},pi=(l,e,t)=>{if(e<t){let r=ws(l,e,t);pi(l,e,r),pi(l,r+1,t)}};var bi="#,##0.00",br=l=>{let e=l[0],t=l[0];for(let r of l)r<e&&(e=r),r>t&&(t=r);return{min:e,max:t}},Wn=l=>{let{label:e,x:t,y:r,z:i,index:n,subtype:o,data_labels:s,axis:a}=l,c={x:{data:[]},y:{data:[]}};if(typeof a=="number"&&(c.axis=a),typeof n=="number"&&(c.index=n),o&&(c.subtype=o.toString()),s){let h=G.Flatten(Array.isArray(s)?s:[s]);c.labels=h.map(m=>typeof m>"u"?"":m.toString())}e&&(c.label=e.toString());let d=(h,m=!1)=>{let f;if(we(h)&&(h={type:8,value:[[h]]}),jn(h)){f={data:[]};let p=G.Flatten(h.value);if(f.data=p.map(b=>{if(we(b)){if(typeof b.value.value=="number")return b.value.value}else if(b.type===3)return b.value}),we(p[0])&&p[0].value?.format&&(f.format=p[0].value.format,m)){let b=L.Get(f.format);f.labels=f.data.map(g=>g===void 0?void 0:b.Format(g))}}return f};c.y=d(r,!0)||{data:[]},c.x=d(t)||{data:[]},c.z=d(i);let u=[c.x,c.y];for(let h of u)if(h.data.length){let m=h.data.filter(f=>f||f===0);h.range=br(m)}return c},Xn=l=>{let e={x:{data:[]},y:{data:[]}},t=G.Flatten(l.value),r=[];for(let[n,o]of t.entries()){let s=0;if(typeof o.value=="number")s=o.value,r.push(o.value);else if(we(o))if(ue(o.value.value))e.x.data[n]=o.value.value.real,s=o.value.value.imaginary;else if(typeof o.value.value=="number")s=o.value.value;else continue;else continue;e.y.data[n]=s,r.push(s)}let i="";if(we(t[0])&&(i=t[0].value.format||""),i){e.y.format=i;let n=L.Get(e.y.format||"");e.y.labels=e.y.data.map(o=>o===void 0?void 0:n.Format(o))}if(e.y.range=br(r),e.x.data.length){let n=e.x.data.filter(o=>typeof o=="number");if(e.x.range=br(n),i){e.x.format=i;let o=L.Get(e.x.format||"");e.x.labels=e.x.data.map(s=>s===void 0?void 0:o.Format(s))}}return e},wt=(l,e)=>{if(!l)return[];let t=[];if(l.type===5){if(l.key==="group"){if(Array.isArray(l.value)){for(let[n,o]of l.value.entries())if(o&&typeof o=="object")if(fi(o)){let s=Wn(o.value);typeof s.index>"u"&&(s.index=n+1),t.push(s)}else o.type===8&&t.push(Xn(o))}}else if(fi(l)){let n=Wn(l.value);t.push(n)}}else l.type===8&&t.push(Xn(l));let r,i=0;if(e?.type===8){let n=G.Flatten(e.value),o="0.00###";we(n[0])&&n[0].value.format&&(o=n[0].value.format);let s=n.map(c=>{if(c.type===3)return c.value;if(we(c)&&typeof c.value.value=="number")return c.value.value}),a=s.filter(c=>typeof c=="number");r={data:s,format:o,range:br(a)}}for(let n of t)i=Math.max(i,n.y.data.length),n.x.data.length&&(r||(r=n.x));if(!r){r={data:[],range:{min:0,max:Math.max(0,i-1)}};for(let n=0;n<i;n++)r.data.push(n)}for(let n of t)n.x.data.length||(n.x=r);return t},Kn=l=>{let e=Math.abs(l.step)%1;if(e){if(Math.log10(Math.abs(e))<-4)return"Scientific";let r=0;for(let n=0;n<l.count;n++){let o=((l.min+l.step*n)%1).toFixed(6).replace(/0+$/,"");r=Math.max(r,o.length-2)}let i="#,##0.";for(let n=0;n<r;n++)i+="0";return i}else return Math.log10(Math.abs(l.step))>=5?"Scientific":"#,##0"},xt=(l,e,t,r,i,n)=>{let o="",s="",a="";for(let k of l)k.axis?k.y.format&&!a&&(a=k.y.format):k.y.format&&!s&&(s=k.y.format),k.x.format&&!o&&(o=k.x.format);let c;l.some(k=>k.label&&k.label.length>0)&&(c=l.map((k,z)=>({label:k.label||`Series ${z+1}`,index:typeof k.index=="number"?k.index:z+1})));let d=l.filter(k=>k.x.range),u=Math.min.apply(0,d.map(k=>k.x.range?.min||0)),h=Math.max.apply(0,d.map(k=>k.x.range?.max||0)),m=d.filter(k=>!k.axis),f=d.filter(k=>k.axis),p=Math.min.apply(0,m.map(k=>k.y.range?.min||0)),b=Math.max.apply(0,m.map(k=>k.y.range?.max||0)),g=-1,x=-1;f.length&&(g=Math.min.apply(0,f.map(k=>k.y.range?.min||0)),x=Math.max.apply(0,f.map(k=>k.y.range?.max||0)));for(let k of l)if(k.z){for(let[z,W]of k.z.data.entries())if(typeof W<"u"){let te=k.x.data[z],he=Math.max(0,W/2);typeof te<"u"&&(u=Math.min(u,te-he),h=Math.max(h,te+he));let T=k.y.data[z];typeof T<"u"&&(p=Math.min(p,T-he),b=Math.max(b,T+he))}}typeof r<"u"&&(u=Math.min(u,r)),typeof i<"u"&&(u=Math.max(u,i)),typeof e<"u"&&(p=Math.min(p,e)),typeof t<"u"&&(b=Math.max(b,t));let v=G.Scale(u,h,7),w=G.Scale(p,b,7),_=G.Scale(g,x,7);if(g!==x&&w&&_&&w.count!==_.count){let k=Math.max(w.count,_.count),z=w.count<k?w:_;for(let W=z.count;W<k;W+=2)z.max+=z.step,z.count++,z.count<k&&(z.min-=z.step,z.count++)}let C,S,A;if(o){C=[];let k=L.Get(o);for(let z=0;z<=v.count;z++)C.push(k.Format(v.min+z*v.step))}if(!s&&n&&(s=Kn(w)),!a&&n&&(a=Kn(_)),s){S=[];let k=L.Get(s);for(let z=0;z<=w.count;z++)S.push(k.Format(w.min+z*w.step))}if(a){A=[];let k=L.Get(a);for(let z=0;z<=_.count;z++)A.push(k.Format(_.min+z*_.step))}let R={x:{format:o,scale:v,labels:C},y:{format:s,scale:w,labels:S},legend:c};return g!==x&&(R.y2={format:a,scale:_,labels:A}),R},gr=(l,e,t)=>{for(let r of l){let i={x:L.Get(r.x.format||""),y:L.Get(r.y.format||"")};r.y.labels=[];for(let n=0;n<r.y.data.length;n++){let o=t?t[n]:typeof r.x.data[n]=="number"?i.x.Format(r.x.data[n]):"",s=typeof r.y.data[n]=="number"?i.y.Format(r.y.data[n]):"";r.y.labels[n]=e.replace(/\bx\b/g,o).replace(/\by\b/g,s)}}},Cs=l=>{let e=(s,a=0,c=s.length)=>c%2?s[Math.floor(c/2)+a]:(s[c/2+a]+s[c/2-1+a])/2,t=l.length,r=[0,e(l),0];if(t%2){let s=Math.floor(t/2);r[0]=e(l,0,Math.ceil(t/2)),r[2]=e(l,s,l.length-s)}else r[0]=e(l,0,t/2),r[2]=e(l,t/2,l.length-t/2);let i=r[2]-r[0],n=[0,0],o=0;for(let s=0;s<t;s++)o+=l[s];for(let s=0;s<t;s++){let a=l[s];if(a>=r[0]-i*1.5){n[0]=a;break}}for(let s=t-1;s>=0;s--){let a=l[s];if(a<=r[2]+i*1.5){n[1]=a;break}}return{data:l,quartiles:r,whiskers:n,iqr:i,n:t,mean:t?o/t:0,min:l[0],max:l[t-1]}},Yn=l=>{let e=wt(l[0]),t=xt(e,void 0,void 0,void 0,void 0,!0),r=0,i=!!l[2],n=e.map(u=>{let h=[];for(let f of u.y.data)f!==void 0&&h.push(f);Jn(h);let m=Cs(h);return r=Math.max(r,m.n),i&&(m.whiskers[0]=m.min,m.whiskers[1]=m.max),m}),o=l[1]?.toString()||void 0,s=[],a=[],c=L.Get("#,##0");for(let[u,h]of n.entries()){s.push(c.Format(h.n));let m=e[u];a.push(m.label||`Series ${u+1}`)}return{type:"box",series:e,title:o,max_n:r,data:n,x_labels:s,series_names:e.some(u=>!!u.label)?a:void 0,scale:t.y.scale,y_labels:t.y.labels}},Qn=l=>{let e=wt(l[0]),t,r;for(let s of e)typeof s.x.range?.min=="number"&&s.x.range.min>0&&s.x.range.min<50&&(r=0),typeof s.y.range?.min=="number"&&s.y.range.min>0&&s.y.range.min<50&&(t=0);let i=xt(e,t,void 0,r),n=l[1]?.toString()||void 0;return{legend:i.legend,legend_style:2,type:"bubble",series:e,title:n,x_scale:i.x.scale,x_labels:i.x.labels,y_scale:i.y.scale,y_labels:i.y.labels}},gi=(l,e="plot")=>{let t=wt(l[0]),r=xt(t),i=l[1]?.toString()||void 0,n=l[2]?.toString()||void 0,o={legend:r.legend,style:e,type:"scatter2",series:t,title:i,x_scale:r.x.scale,x_labels:r.x.labels,y_scale:r.y.scale,y_labels:r.y.labels,y2_scale:r.y2?.scale,y2_labels:r.y2?.labels,lines:e==="line",points:e==="plot"};if(n){o.markers=/marker/i.test(n),o.smooth=/smooth/i.test(n),o.data_labels=/labels/i.test(n);let s=n.match(/labels="(.*?)"/);s&&o.series?gr(o.series,s[1]):(s=n.match(/labels=([^\s\r\n,]+)(?:\W|$)/),s&&o.series&&gr(o.series,s[1])),s=n.match(/class=([\w_-]+)(?:\W|$)/),s&&(o.class_name=s[1])}return o},_i=(l,e)=>{let[t,r,i,n]=l,o=wt(t),s=xt(o),a;if(r){a=(r.type===8?G.Flatten(r.value):G.Flatten(r)).map(f=>!f||!f.value?"":we(f)?typeof f.value.value=="number"?L.Get(f.value.format||bi).Format(f.value.value):f.value.value?.toString()||"":typeof f.value=="number"?L.Get(bi).Format(f.value):f.value.toString());let m=o.reduce((f,p)=>Math.max(f,p.y.data.length),0);for(m<a.length&&(a=a.slice(0,m));m>a.length;)a.push("")}let c=i?.toString()||void 0,d=n?.toString()||void 0,u={type:e,legend:s.legend,legend_style:1,series2:o,scale:s.y.scale,title:c,y_labels:e==="bar"?a:s.y.labels,x_labels:e==="bar"?s.y.labels:a};if(d){u.round=/round/i.test(d),u.data_labels=/labels/i.test(d);let h=d.match(/labels="(.*?)"/);h&&o?gr(o,h[1],a):(h=d.match(/labels=([^\s\r\n,]+)(?:\W|$)/),h&&o&&gr(o,h[1],a)),h=d.match(/class=([\w_-]+)(?:\W|$)/),h&&(u.class_name=h[1])}return u},yi=(l,e)=>{let t=wt(l[0],l[1]),r=xt(t,0,0),i=l[2]?.toString()||void 0,n=l[3]?.toString()||void 0,o={legend:r.legend,type:"scatter2",series:t,title:i,x_scale:r.x.scale,x_labels:r.x.labels,y_scale:r.y.scale,y_labels:r.y.labels,lines:!0,filled:e==="area"};if(n){o.smooth=/smooth/i.test(n);let s=n.match(/class=([\w_-]+)(?:\W|$)/);s&&(o.class_name=s[1])}return o},Zn=(l,e=!1)=>{let[t,r,i,n,o]=l,s=l[0]?.type===8?l[0].value:l[0],a=s?G.Flatten(s):[],c=a.map(_=>{if(we(_)&&typeof _.value.value=="number")return _.value.value}),d=l[1]?.type===8?l[1].value:l[1],u=G.Flatten(d||[]).map(_=>we(_)?typeof _.value.value=="number"&&_.value.format?L.Get(_.value.format).Format(_.value.value):_.value.value?.toString()||"":_.value?.toString()||""),h=!1;c=c.map(_=>_&&_<0?(h||(console.warn("pie/donut chart does not support negative values (omitted)"),h=!0),0):_);let m=0,f=c.map((_,C)=>(typeof _<"u"&&(m+=_),{value:_||0,label:u[C]||"",index:C+1,percent:0}));if(m)for(let _ of f)_.percent=(_.value||0)/m;let p="";for(let _ of a)if(we(_)){p=_.value.format||"";break}let b=L.Get(p||bi),g=L.Get("percent");typeof l[4]>"u"&&l[1]&&(l[4]="label");let x=l[4]||"";if(x)for(let _ of f){let C=b.Format(_.value||0),S=g.Format(_.percent);_.title=x.replace(/value%/ig,g.Format(_.value||0)).replace(/value/ig,C).replace(/percent/ig,S).replace(/label/ig,_.label||"").trim()}let v=(n||"").toUpperCase();if(v==="ASC"||v==="ASCENDING"||v==="INC")f.sort((_,C)=>(_.value||0)-(C.value||0));else if(v==="DESC"||v==="DESCENDING"||v==="DEC")f.sort((_,C)=>(C.value||0)-(_.value||0));else{let _=(n||"").match(/sort=([\w]+)(?:\W|$)/i);_&&(v=_[1],/^(asc|inc)/i.test(v)?f.sort((C,S)=>(C.value||0)-(S.value||0)):/^(desc|dec)/i.test(v)&&f.sort((C,S)=>(S.value||0)-(C.value||0)))}let w={type:e?"pie":"donut",slices:f,title:i||""};if(n){let _=n.match(/class=([_-\w]+)(?:\W|$)/);_&&(w.class_name=_[1])}return w};var Le=class{constructor(e=0,t=0,r=100,i=100){this.left=e;this.top=t;this.right=r;this.bottom=i}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return{x:this.left+this.width/2,y:this.top+this.height/2}}};var Rs="http://www.w3.org/2000/svg",U=(l,e={},t)=>{let r=document.createElementNS(Rs,l);for(let i of Object.keys(e))if(e[i]!==void 0){let n=e[i]??"";r.setAttribute(i,Array.isArray(n)?n.join(" "):n.toString())}return t&&(r.textContent=t),r},_r=class{parent;svg_node;text_measurement_node;container_group;group;axis_group;label_group;size={width:0,height:0};bounds=new Le;constructor(){this.container_group=U("g"),this.group=U("g"),this.axis_group=U("g",{class:"axis-group"}),this.label_group=U("g",{class:"label-group"}),this.container_group.appendChild(this.axis_group),this.container_group.appendChild(this.group),this.container_group.appendChild(this.label_group)}Initialize(e){this.parent=e,this.svg_node=U("svg",{class:"treb-chart"}),this.svg_node.style.overflow="hidden",this.svg_node.style.position="relative",this.svg_node.style.width="100%",this.svg_node.style.height="100%",this.svg_node.appendChild(this.container_group),this.parent.appendChild(this.svg_node),this.Resize()}Legend(e){let t=U("g");this.group.appendChild(t);let r=U("text");t.appendChild(r),t.setAttribute("class","legend");let i=[[]],n=10,o=e.area.width,s=0,a=0,c=e.area.width,d=e.style===1?14:26,u=e.labels.map((b,g)=>{r.textContent=b.label;let x=r.getBoundingClientRect(),v={width:x.width,height:x.height},w=v.width+d+n;return a=Math.max(a,v.height),e.layout===1?i[g]=[g]:w>o?i[s].length===0?(i[s].push(g),s++,i[s]=[],o=c):(s++,i[s]=[g],o=c-w):(i[s].push(g),o-=w),v});t.removeChild(r);let h=a,m=e.layout||0;m===0&&i.every(b=>b.length<=1)&&(m=0);for(let b=0;b<i.length;b++){let g=i[b].reduce((w,_)=>w+u[_].width+d,(i[b].length-1)*n),x=0,v=m===0?Math.round((c-g)/2):Math.round(n/2);for(let w=0;w<i[b].length;w++){let _=i[b][w],C=u[_],S=e.labels[_],A=h-1,R=!1;typeof navigator<"u"&&(R=/trident/i.test(navigator?.userAgent||""));let k=typeof S.index=="number"?S.index:_+1;switch(t.appendChild(U("text",{"dominant-baseline":"middle",x:v+d,y:h,dy:R?".3em":void 0},S.label)),e.style){case 1:t.appendChild(U("rect",{class:`series-${k}`,x:v,y:A-4,width:8,height:8}));break;case 2:t.appendChild(U("circle",{class:`series-${k}`,cx:v+d-11,cy:A-4+3}));break;default:t.appendChild(U("rect",{class:`series-${k}`,x:v,y:A-1,width:d-3,height:2}));break}x=Math.max(x,C.height),v+=C.width+d+n}h=Math.round(h+x*1.1)}let f=t.getBoundingClientRect(),p={width:f.width,height:f.height+a};switch(e.position){case 1:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.bottom-p.height})`);break;case 2:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`);break;case 3:t.setAttribute("transform",`translate(${e.area.right-p.width}, ${e.area.top})`);break;case 0:default:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`)}e.position===0?e.area.top+=p.height||0:e.position===3?e.area.right-=(p.width||0)+8:e.position===2?e.area.left+=(p.width||0)+8:e.area.bottom-=p.height||0}Clear(e){this.group.textContent="",this.axis_group.textContent="",this.label_group.textContent="",e="treb-chart"+(e?" "+e:""),this.svg_node.setAttribute("class",e)}Resize(){let e=this.svg_node.getBoundingClientRect();this.svg_node.setAttribute("width",e.width.toString()),this.svg_node.setAttribute("height",e.height.toString()),this.size={width:e.width,height:e.height}}Prerender(){let e=this.svg_node.getBoundingClientRect();this.bounds.top=e.top,this.bounds.left=e.left,this.bounds.right=e.right,this.bounds.bottom=e.bottom}RenderTitle(e,t,r,i){let n=U("text",{class:"chart-title",x:Math.round(t.width/2)},e);n.style.textAnchor="middle",this.group.appendChild(n);let o=n.getBoundingClientRect();switch(i){case"bottom":n.setAttribute("y",Math.round(t.bottom-o.height).toString()),t.bottom-=o.height+r;break;default:n.setAttribute("y",Math.round(t.top+r+o.height).toString()),t.top+=o.height+r;break}}MeasureText(e,t,r=!1){this.text_measurement_node||(this.text_measurement_node=U("text",{x:"-100px",y:"-100px"}),this.svg_node.appendChild(this.text_measurement_node)),typeof t<"u"?(typeof t=="string"&&(t=[t]),this.text_measurement_node.setAttribute("class",t.join(" "))):this.text_measurement_node.setAttribute("class",""),this.text_measurement_node.textContent=e;let i=this.text_measurement_node.getBoundingClientRect(),n={width:i.width,height:i.height,y_offset:i.height-(this.bounds.top-i.top-100)};return r&&(n.width=Math.ceil(n.width),n.height=Math.ceil(n.height),n.y_offset=Math.ceil(n.y_offset)),n}RenderTicks(e,t,r,i,n){let o=[],s=e.width/i;for(let a=0;a<i;a++){let c=Math.round(e.left+s/2+s*a)-.5;o.push(`M${c} ${t} L${c} ${r}`)}this.group.appendChild(U("path",{d:o,class:n}))}RenderXAxisBar(e,t,r,i,n){let o=r.length;if(!o)return;let s=4,a=t?e.width/o:e.width/(o-1),c=t?a/2:0,d=1,u=!0;for(;u;){u=!1;let h=0;for(let m=0;m<o;m+=d){let f=Math.round(e.left+c+a*m),p=f-i[m].width/2;if(h&&p<=h){d++,u=!0;break}h=f+i[m].width/2+s}}for(let h=0;h<o;h+=d){let m=Math.round(e.left+c+a*h);this.RenderText(this.axis_group,r[h],"center",{x:m,y:e.bottom},n)}}RenderXAxisTicks(e,t,r){let i=t?e.width/r:e.width/(r-1),n=t?i/2:0,o=[];for(let s=0;s<r;s++){let a=Math.round(e.left+n+i*s)+.5;o.push(`M${a},${e.bottom+.5} v6`)}this.axis_group.appendChild(U("path",{d:o.join(" "),class:"x-axis-tick axis-tick"}))}RenderXAxis(e,t,r,i,n){let o=r.length;if(!o)return;let s=4,a=t?e.width/o:e.width/(o-1),c=t?a/2:0,d=1,u=!0,h=(r.length-1)%2===0,m=(r.length-1)%3===0;for(;u;){u=!1;let f=0;for(let p=0;p<o;p+=d){let b=Math.round(e.left+c+a*p),g=b-i[p].width/2;if(f&&g<=f){d++,u=!0;break}f=b+i[p].width/2+s}}d===3&&!m&&h&&d++;for(let f=0;f<o;f+=d){let p=Math.round(e.left+c+a*f);this.RenderText(this.axis_group,r[f],"center",{x:p,y:e.bottom},n)}}RenderYAxisBar(e,t,r,i){r=r.slice(0),r.reverse();let n=r.length;if(!n)return;let o=e.height/n,s=1,a=!0;for(;a;){a=!1;let c=0;for(let d=0;d<n;d+=s){let u=r[d],h=Math.round(e.bottom-o*(d+.5)+u.metrics.height/4);if(c&&h>=c){s++,a=!0;break}c=h-u.metrics.height}}for(let c=0;c<n;c+=s){let d=r[c],u=Math.round(e.bottom-o*(c+.5)+d.metrics.height/4);this.RenderText(this.axis_group,d.label,"right",{x:t,y:u},i)}}RenderYAxis(e,t,r,i,n="right"){let o=r.length;if(!o)return;let s=e.height/(o-1),a=1,c=!0;for(;c;){c=!1;let d=0;for(let u=0;u<o;u+=a){let h=r[u],m=Math.round(e.bottom-s*u+h.metrics.height/4);if(d&&m>=d){a++,c=!0;break}d=m-h.metrics.height}}for(let d=0;d<o;d+=a){let u=r[d],h=Math.round(e.bottom-s*d+u.metrics.height/4);this.RenderText(this.axis_group,u.label,n,{x:t,y:h},i)}}LineProperties(e,t){let r=t.x-e.x,i=t.y-e.y;return{length:Math.sqrt(r*r+i*i),angle:Math.atan2(i,r)}}RenderSmoothLine(e,t,r=!1,i,n){let o=U("g"),s=[],a=[],c=t.length,d=c-1,u=e.width/c/2,h=[],m=t.map((b,g)=>{if(!(typeof b>"u"))return{x:Math.round(e.left+e.width/d*g),y:e.bottom-b}}),f=[],p=()=>{if(f.length<2)return;let b="",g=f[0],x=f[f.length-1];f.length===2?b=`${f[0].x},${f[0].y} L${f[1].x},${f[1].y}`:f.length>2&&(b=""+this.CatmullRomChain(f).map(w=>`${w.x},${w.y}`).join(" L")),b&&(s.push("M"+b),r&&(a.push(`M ${g.x},${e.bottom} L ${g.x},${g.y}`),a.push("L"+b),a.push(`L ${x.x},${e.bottom}`)))};for(let b of m)b?f.push(b):(p(),f=[]);if(f.length&&p(),r&&o.appendChild(U("path",{class:"fill",d:a})),o.appendChild(U("path",{class:"line",d:s})),typeof n<"u"&&(typeof n=="string"&&(n=[n]),o.setAttribute("class",n.join(" "))),this.group.appendChild(o),i&&h.length){let b=U("g");for(let g of h){let x=U("circle",{cx:g.x,cy:g.y,r:u});x.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",i[g.i]||"")}),x.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")}),b.appendChild(x)}b.setAttribute("class","mouse-layer"),this.group.appendChild(b)}}RenderLine(e,t,r=!1,i,n){let o=U("g"),s=[],a=[],c=t.length,d=c-1,u=e.width/c/2,h=[],m=0,f=!0,p;for(;m<c;m++){let b=t[m];if(typeof b>"u"){f=!0,r&&typeof p<"u"&&a.push(`L${p} ${e.bottom}Z`),p=void 0;continue}let g=Math.round(+e.left+e.width/d*m);f?(r&&a.push(`M${g} ${e.bottom} L${g} ${e.bottom-b}`),s.push(`M${g} ${e.bottom-b}`)):(s.push(`L${g} ${e.bottom-b}`),a.push(`L${g} ${e.bottom-b}`)),h.push({x:g,y:e.bottom-b,i:m}),p=g,f=!1}if(r&&typeof p<"u"&&a.push(`L${p} ${e.bottom}Z`),r&&o.appendChild(U("path",{class:"fill",d:a})),o.appendChild(U("path",{class:"line",d:s})),typeof n<"u"&&(typeof n=="string"&&(n=[n]),o.setAttribute("class",n.join(" "))),this.group.appendChild(o),i&&h.length){let b=U("g");for(let g of h){let x=U("circle",{cx:g.x,cy:g.y,r:u});x.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",i[g.i]||"")}),x.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")}),b.appendChild(x)}b.setAttribute("class","mouse-layer"),this.group.appendChild(b)}}RenderBarGrid(e,t,r){let i=[],n=e.width/t;for(let o=0;o<=t;o++){let s=Math.round(e.left+n*o)-.5;i.push(`M${s} ${e.top} L${s} ${e.bottom}`)}this.group.appendChild(U("path",{d:i,class:r}))}RenderGrid(e,t,r=0,i,n){let o=[],s=[],a=e.height/t;for(let c=0;c<=t;c++){let d=Math.round(e.top+a*c)-.5;n&&n[1]===c?s.push(`M${e.left} ${d} L${e.right} ${d}`):o.push(`M${e.left} ${d} L${e.right} ${d}`)}a=e.width/(r-1);for(let c=0;c<r;c++){let d=Math.round(e.left+a*c)-.5;n&&n[0]===c?s.push(`M${d} ${e.top} L${d} ${e.bottom}`):o.push(`M${d} ${e.top} L${d} ${e.bottom}`)}this.group.appendChild(U("path",{d:o,class:i})),s.length&&(i?Array.isArray(i)?i.push("zero"):i=i+" zero":i="zero",this.group.appendChild(U("path",{d:s,class:i})))}MultiplyPoint(e,t){return{x:e.x*t,y:e.y*t}}AddPoints(e,t){return{x:e.x+t.x,y:e.y+t.y}}CatmullRomSpline(e,t){let r=.5;r=r/2;let i=(u,h,m)=>{let{x:f,y:p}=h,{x:b,y:g}=m;return((b-f)**2+(g-p)**2)**r+u},n=0,o=i(n,e[0],e[1]),s=i(o,e[1],e[2]),a=i(s,e[2],e[3]),c=(s-o)/t,d=[];for(let u=0;u<t;u++){let h=o+c*u,m=this.AddPoints(this.MultiplyPoint(e[0],(o-h)/(o-n)),this.MultiplyPoint(e[1],(h-n)/(o-n))),f=this.AddPoints(this.MultiplyPoint(e[1],(s-h)/(s-o)),this.MultiplyPoint(e[2],(h-o)/(s-o))),p=this.AddPoints(this.MultiplyPoint(e[2],(a-h)/(a-s)),this.MultiplyPoint(e[3],(h-s)/(a-s))),b=this.AddPoints(this.MultiplyPoint(m,(s-h)/(s-n)),this.MultiplyPoint(f,(h-n)/(s-n))),g=this.AddPoints(this.MultiplyPoint(f,(a-h)/(a-o)),this.MultiplyPoint(p,(h-o)/(a-o))),x=this.AddPoints(this.MultiplyPoint(b,(s-h)/(s-o)),this.MultiplyPoint(g,(h-o)/(s-o)));d.push(x)}return d}CatmullRomChain(e,t=30){let r=e.slice(0),i=[],n=r.length;if(n){let o=r[n-1].x-r[n-2].x,s=r[n-1].y-r[n-2].y;r.push({x:r[n-1].x+o,y:r[n-1].y+s}),r.push({x:r[n-1].x+o,y:r[n-1].y+s}),o=r[1].x-r[0].x,s=r[1].y-r[0].y,r.unshift({x:r[0].x-o,y:r[0].y-s});for(let a=0;a<r.length-4;a++){let c=r.slice(a,a+4),d=this.CatmullRomSpline(c,t);i.push(...d)}}return i}RenderDataLabels(e,t,r,i,n,o,s){let a=Math.max(t.length,r.length),c=i.max-i.min||1,d=n.max-n.min||1;for(let u=0;u<a;u++){let h=t[u],m=r[u];if(h!==void 0&&m!==void 0){let f={x:e.left+(h-i.min)/c*e.width,y:e.bottom-(m-n.min)/d*e.height},p=o[u];if(p){this.label_group.appendChild(U("circle",{class:"label-target",cx:f.x,cy:f.y,r:10}));let b=U("g",{class:"data-label",transform:`translate(${f.x+10},${f.y})`});this.label_group.appendChild(b);let g=U("circle",{cx:-10,y:0,r:5,class:`marker-highlight series-${s}`});b.appendChild(g);let x=U("text",{x:4,y:0},p);b.appendChild(x);let v=x.getBoundingClientRect(),w=v.height,_=v.width+8;_+15+f.x>=e.right&&(b.setAttribute("transform",`translate(${f.x-_-15},${f.y})`),g.setAttribute("cx",(_+15).toString()));let C=U("path",{d:`M0,5 h${_} v-${w} h-${_} Z`});b.insertBefore(C,x)}}}}RenderBoxAndWhisker(e,t,r,i,n,o,s){let a=U("g",{class:s});this.group.appendChild(a);let c=e.width/o,d=c*.2,h=Math.min(c-2*d,90);i>0&&(h=h*Math.sqrt(t.n)/Math.sqrt(i));let m=g=>e.top+e.height-(g-n.min)/(n.max-n.min)*e.height,f=e.left+r*c+c/2,p=m(t.quartiles[0]),b=m(t.quartiles[2]);a.appendChild(U("rect",{class:"iqr",x:e.left+r*c+(c-h)/2,y:b,width:h,height:p-b})),a.appendChild(U("line",{class:"median",x1:f-h*.5,x2:f+h*.5,y1:m(t.quartiles[1]),y2:m(t.quartiles[1])})),a.appendChild(U("line",{class:"whisker",x1:f-h*.25,x2:f+h*.25,y1:m(t.whiskers[0]),y2:m(t.whiskers[0])})),a.appendChild(U("line",{class:"whisker-extent",x1:f,x2:f,y1:m(t.whiskers[0])-2,y2:m(t.quartiles[0])+2})),a.appendChild(U("line",{class:"whisker",x1:f-h*.25,x2:f+h*.25,y1:m(t.whiskers[1]),y2:m(t.whiskers[1])})),a.appendChild(U("line",{class:"whisker-extent",x1:f,x2:f,y1:m(t.whiskers[1])+2,y2:m(t.quartiles[2])-2}));for(let g of t.data)(g<t.whiskers[0]||g>t.whiskers[1])&&a.appendChild(U("circle",{class:"outlier",cx:f,cy:m(g),r:3}))}RenderBubbleSeries(e,t,r,i,n){let o=r.max-r.min||1,s=i.max-i.min||1,a=[],c=[],d=U("g",{class:n});if(this.group.appendChild(d),t.z)for(let[u,h]of t.z.data.entries()){let m=t.x.data[u],f=t.y.data[u];if(typeof m<"u"&&typeof f<"u"&&typeof h<"u"&&h>0){let p=h/o*e.width,b=h/s*e.height,g=Math.max(p,b),x={x:e.left+(m-r.min)/o*e.width,y:e.bottom-(f-i.min)/s*e.height,z:g};if(a.push(x),t.labels?.[u]){let v=x.z/2;c.push({x:x.x,y:x.y,text:t.labels?.[u]||"",offset:Math.cos(Math.PI/4)*v})}}}for(let u of a)u&&d.appendChild(U("circle",{cx:u.x,cy:u.y,r:u.z/2,class:"point"}));if(c.length){let u=this.label_group.getBoundingClientRect();for(let h of c)if(h.text){let m=this.label_group.appendChild(U("g",{class:"bubble-label"})),f=m.appendChild(U("rect",{x:h.x,y:h.y,class:"label-background"})),b=m.appendChild(U("text",{x:h.x,y:h.y,offset:h.offset,class:"label-text","text-anchor":"middle","alignment-baseline":"middle",style:`--translate-offset: ${Math.round(h.offset)}px`},h.text)).getBoundingClientRect();f.setAttribute("x",(b.left-u.left-2).toString()),f.setAttribute("y",(b.top-u.top-1).toString()),f.style.height=b.height+2+"px",f.style.width=b.width+4+"px"}}}RenderScatterSeries(e,t,r,i,n,o=!0,s=!1,a=!1,c=!1,d=!1,u){let h=Math.max(t.length,r.length),m=i.max-i.min||1,f=n.max-n.min||1,p=[],b=[],g=[],x=U("g",{class:u});this.group.appendChild(x);for(let v=0;v<h;v++){let w=t[v],_=r[v];typeof w>"u"||typeof _>"u"?p.push(void 0):p.push({x:e.left+(w-i.min)/m*e.width,y:e.bottom-(_-n.min)/f*e.height})}if(o){let v=[],w=d?()=>v.length===2?`${v[0].x},${v[0].y} L${v[1].x},${v[1].y}`:v.length>2?this.CatmullRomChain(v).map(C=>`${C.x},${C.y}`).join(" L"):"":()=>v.map(_=>`${_.x},${_.y}`).join(" L");for(let _ of p)if(_)v.push(_);else{if(v.length>=2){let C=w();b.push("M"+C),g.push(`M${v[0].x},${e.bottom}L`+C+`L${v[v.length-1].x},${e.bottom}Z`)}v=[]}if(v.length>=2){let _=w();b.push("M"+_),g.push(`M${v[0].x},${e.bottom}L`+_+`L${v[v.length-1].x},${e.bottom}Z`)}}if(a&&x.appendChild(U("path",{d:g,class:"fill"})),o&&x.appendChild(U("path",{d:b,class:"line"})),s)for(let v of p)v&&x.appendChild(U("circle",{cx:v.x,cy:v.y,r:1,class:"point"}));if(c)for(let v of p)v&&x.appendChild(U("circle",{cx:v.x,cy:v.y,r:3,class:"marker"}))}RenderPoints(e,t,r,i){let n=[];for(let o=0;o<t.length;o++){let s=t[o]*e.width+e.left,a=e.bottom-r[o]*e.height;n.push(`M${s-1},${a-1} L${s+1},${a+1}`),n.push(`M${s-1},${a+1} L${s+1},${a-1}`)}this.group.appendChild(U("path",{d:n,class:i}))}RenderPoint(e,t,r){this.group.appendChild(U("circle",{cx:e,cy:t,r:1,class:r}))}RenderCalloutLines(e){let t=U("g",{class:"callouts"});this.label_group.appendChild(t);for(let r of e)t.appendChild(U("path",{d:`M${r.x1},${r.y1} L${r.x2},${r.y2}`,class:"callout "+(r.classes||"").trim()}))}RenderRectangle(e,t,r,i,n,o){let s="";if(t)if(t[0]&&t[0]===t[1]&&t[0]>=e.height){let c=t[0],d=t[0]-e.height,u=Math.sqrt(c*c-d*d);s=`M${e.left+e.width/2-u},${e.bottom} a${c},${c} 0 0 1 ${u*2},0 z`}else if(t[1]&&t[1]===t[2]&&t[1]>=e.width){let c=t[1],d=t[1]-e.width,u=Math.sqrt(c*c-d*d);s=`M${e.left},${e.top+e.height/2-u} a${c},${c} 0 0 1 0,${u*2} z`}else s=`M${e.left},${e.top+t[0]} a${t[0]},${t[0]} 0 0 1 ${t[0]},${-t[0]} h${e.width-t[0]-t[1]} a${t[1]},${t[1]} 0 0 1 ${t[1]},${t[1]} v${e.height-t[1]-t[2]} a${t[2]},${t[2]} 0 0 1 ${-t[2]},${t[2]} h${-e.width+t[2]+t[3]} a${t[3]},${t[3]} 0 0 1 ${-t[3]},${-t[3]} v${-e.height+t[3]+t[0]} `;else s=`M${e.left},${e.top} h${e.width} v${e.height} h${-e.width} v${-e.height} `;let a=U("path",{d:s,class:r});if(i&&(a.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",i)}),a.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")})),this.group.appendChild(a),n){this.label_group.appendChild(U("path",{class:"label-target",d:s}));let c=o||{x:Math.round(e.left+e.width/2),y:Math.round(e.top-10)},d=U("g",{class:"data-label",transform:`translate(${c.x},${c.y})`});this.label_group.appendChild(d);let u=U("text",{x:0,y:0},n);d.appendChild(u);let h=u.getBoundingClientRect(),m=h.height,f=h.width+8;c.y-h.height<4&&(c.y-=c.y-h.height-4,d.setAttribute("transform",`translate(${c.x},${c.y})`)),u.setAttribute("x",Math.floor(-h.width/2).toString());let p=Math.ceil(m*.125),b=U("rect",{rx:3,x:-f/2,y:Math.round(-m+p*2/3),width:f,height:m+p});d.insertBefore(b,u)}}RenderText(e,t,r,i,n){let o=U("text",{x:i.x,y:i.y,class:n},t);switch(r){case"right":o.style.textAnchor="end";break;case"center":o.style.textAnchor="middle";break;default:o.style.textAnchor="start";break}(e||this.group).appendChild(o)}RenderDonut(e,t,r,i,n,o,s){let a=-Math.PI/2,c=0;o&&(r*=.8,i*=.7);let d=(u,h,m)=>[Math.cos(m)*h+u.x,Math.sin(m)*h+u.y];for(let u of e){let h=u.title||"",m=u.percent,f=u.index,p=[],b=0,g=d.bind(0,t,r),x=d.bind(0,t,i);if(m>.5){b=a+m/2*Math.PI*2,c=a+m*Math.PI*2;let _=b-a,C=c-b;p.push(`M${g(a)}`,`A${r},${r},${_},0,1,${g(b)}`,`A${r},${r},${C},0,1,${g(c)}`,`L${x(c)}`,`A${i},${i},${C},0,0,${x(b)}`,`A${i},${i},${_},0,0,${x(a)}`,"Z")}else{c=a+m*Math.PI*2,b=(c-a)/2+a;let _=c-a;p.push(`M${g(a)}`,`A${r},${r},${_},0,1,${g(c)}`,`L${x(c)}`,`A${i},${i},${_},0,0,${x(a)}`,"Z")}let v=U("path",{d:p,class:typeof f>"u"?void 0:`series-${f}`});typeof f<"u"&&v.setAttribute("data-index",f.toString());let w=U("g",{class:s});if(w.appendChild(v),this.group.appendChild(w),m>=.05&&h){let _=r-i;p=[];let C=d(t,i+(r-i)/2+_,b);p.push(`M${d(t,i+(r-i)/2,b)}`),p.push(`L${C}`),w.appendChild(U("path",{d:p,class:"callout"}));let S=[],A=U("text",{class:"callout-label"});w.appendChild(A);let R=b+Math.PI/2,k=h;A.textContent=k;let z=A.getBoundingClientRect(),W={width:z.width,height:z.height},[te,he]=C;te+=W.height/2*Math.cos(b),he+=W.height/4+W.height/2*Math.sin(b);let T=!1;R>Math.PI?te-W.width<=n.left&&(T=!0):te+W.width>n.right&&(T=!0);let de=/[\s-]/;if(T&&de.test(k)){let Z=-1,re=1;for(let E=0;E<k.length;E++)if(de.test(k[E])){let P=Math.abs(.5-E/k.length);P<re&&(re=P,Z=E)}Z>0&&(S.push(k.substr(0,Z+1).trim()),S.push(k.substr(Z+1).trim()))}if(S.length){let Z=0,re=0,E=S.map(P=>{A.textContent=P,z=A.getBoundingClientRect();let K={width:z.width,height:z.height};return re=Math.max(re,K.width),{text:P,metrics:K}});A.textContent="";for(let P of E){let K=U("tspan");K.textContent=P.text;let fe=R>Math.PI?te-(re-P.metrics.width)/2:te+(re-P.metrics.width)/2;K.setAttribute("x",fe.toString()),K.setAttribute("dy",Z.toString()),A.appendChild(K),Z=P.metrics.height}}let me=R>Math.PI?"end":"start";A.setAttribute("text-anchor",me),A.setAttribute("x",te.toString()),A.setAttribute("y",he.toString()),typeof f<"u"&&A.setAttribute("data-index",f.toString())}a=c}}};var yr=class{renderer=new _r;margin={top:.025,left:.05,bottom:.025,right:.075};Resize(e,t){this.renderer.Resize()}Initialize(e){this.renderer.Initialize(e)}Update(e,t){this.renderer.Resize(),this.renderer.Prerender(),this.renderer.Clear(t.class_name);let r=new Le(0,0,this.renderer.size.width,this.renderer.size.height),i={top:Math.round(r.height)*this.margin.top,bottom:Math.round(r.height)*this.margin.bottom,left:Math.round(r.width)*this.margin.left,right:Math.round(r.width)*this.margin.right},n=t.title;if(n&&this.renderer.RenderTitle(n,r,i.top,t.title_layout||"top"),r.top+=i.top,r.left+=i.left,r.bottom-=i.bottom,r.right-=i.right,t.legend&&t.legend.length){let s=0;t.title&&(!t.title_layout||t.title_layout==="top")&&(s=1);let a=t.legend_position||s;this.renderer.Legend({labels:t.legend,position:a,style:t.legend_style,layout:a===0||a===1?0:1,area:r})}if(t.type==="histogram"||t.type==="line"||t.type==="area"||t.type==="column"||t.type==="histogram2"||t.type==="bar"||t.type==="scatter2"||t.type==="bubble"||t.type==="box"){let s=[],a=0;t.x_labels&&t.x_labels.length&&(s=t.x_labels.map(h=>{let m=this.renderer.MeasureText(h,["axis-label","x-axis-label"],!0);return a=Math.max(a,m.height),m}));let c=[],d=0;t.type==="box"&&t.series_names?.length&&(c=t.series_names.map(h=>{let m=this.renderer.MeasureText(h,["axis-label","x-axis-label","series-name"],!0);return d=Math.max(d,m.height),m}));let u=a&&d?4:0;if(t.y_labels&&t.y_labels.length){let h=[],m=0,f=0,p=t.type==="scatter2"||t.type==="bubble"?t.y_scale:t.scale,b=t.type==="bar"?t.y_labels.length:p.count+1;for(let g=0;g<b;g++){let x=this.renderer.MeasureText(t.y_labels[g],["axis-label","y-axis-label"]);h.push({label:t.y_labels[g],metrics:x}),m=Math.max(m,x.width),f=Math.max(f,x.height)}r.bottom=Math.round(r.bottom-f/2),r.top=Math.round(r.top+f/2),s.length&&(r.bottom-=a+i.bottom),c.length&&(r.bottom-=d+i.bottom),u&&(r.bottom-=u),t.type==="bar"?this.renderer.RenderYAxisBar(r,r.left+m,h,["axis-label","y-axis-label"]):this.renderer.RenderYAxis(r,r.left+m,h,["axis-label","y-axis-label"]),r.left+=m+i.left}if(t.type==="scatter2"&&t.y2_labels&&t.y2_labels.length&&t.y2_scale){let h=[],m=0,f=0,b=t.y2_scale.count+1;for(let g=0;g<b;g++){let x=this.renderer.MeasureText(t.y2_labels[g],["axis-label","y-axis-label"]);h.push({label:t.y2_labels[g],metrics:x}),m=Math.max(m,x.width),f=Math.max(f,x.height)}this.renderer.RenderYAxis(r,r.right-m,h,["axis-label","y-axis-label"],"left"),r.right-=m+i.left}if(s.length&&t.x_labels?.length){let h=t.type==="histogram2",m=t.type!=="line"&&t.type!=="area"&&t.type!=="bar"&&t.type!=="scatter2"&&t.type!=="bubble"&&t.type!=="histogram2";h&&this.renderer.RenderXAxisTicks(r,m,t.x_labels.length),t.y_labels&&(r.bottom+=a+i.bottom),this.renderer.RenderXAxis(r,m,t.x_labels,s,["axis-label","x-axis-label"]),r.bottom-=a+i.bottom}u&&(r.bottom+=u),t.type==="box"&&c.length&&t.series_names?.length&&(t.y_labels&&(r.bottom+=a+d+u+i.bottom),this.renderer.RenderXAxis(r,!0,t.series_names,c,["axis-label","x-axis-label","series-name"]),r.bottom-=a+d+i.bottom+i.bottom)}let o=[];switch(t.type){case"scatter":this.renderer.RenderPoints(r,t.x,t.y,"mc mc-correlation series-1");break;case"box":this.renderer.RenderGrid(r,t.scale.count,void 0,"chart-grid",o);for(let[s,a]of t.data.entries())a.iqr>0&&this.renderer.RenderBoxAndWhisker(r,a,s,t.max_n,t.scale,t.data.length,`box-plot series-${s}`);break;case"bubble":t.x_scale.min<=0&&t.x_scale.max>=0&&(o[0]=Math.round(Math.abs(t.x_scale.min/t.x_scale.step))),t.y_scale.min<=0&&t.y_scale.max>=0&&(o[1]=Math.round(Math.abs(t.y_scale.max/t.y_scale.step))),this.renderer.RenderGrid(r,t.y_scale.count,t.x_scale.count+1,"chart-grid",o);for(let[s,a]of t.series.entries()){let c=typeof a.index=="number"?a.index:s+1;this.renderer.RenderBubbleSeries(r,a,t.x_scale,t.y_scale,`bubble-chart series-${c}`)}break;case"scatter2":if(this.renderer.RenderGrid(r,t.y_scale.count,t.x_scale.count+1,"chart-grid"),t.series){for(let s=0;s<t.series.length;s++){let a=t.series[s],c=!!t.lines,d=!!t.points;a.subtype==="plot"?(d=!0,c=!1):a.subtype==="line"&&(d=!1,c=!0);let u=typeof a.index=="number"?a.index:s+1;this.renderer.RenderScatterSeries(r,a.x.data,a.y.data,t.x_scale,a.axis&&t.y2_scale?t.y2_scale:t.y_scale,c,d,!!t.filled,!!t.markers,!!t.smooth,`scatter-plot series-${u}`)}if(t.data_labels)for(let s=0;s<t.series.length;s++){let a=t.series[s];a.y.labels&&this.renderer.RenderDataLabels(r,a.x.data,a.y.data,t.x_scale,t.y_scale,a.y.labels,s+1)}}break;case"pie":case"donut":{let s=Math.min(r.height,r.width)/2*.9,a=t.type==="pie"?0:s*.8;this.renderer.RenderDonut(t.slices,r.center,s,a,r,!0,"donut")}break;case"line":case"area":{let s=t.scale;if(t.series){let a=t.x_scale?t.x_scale.max:Math.max.apply(0,t.series.map(u=>u.length)),c=t.smooth?this.renderer.RenderSmoothLine:this.renderer.RenderLine;this.renderer.RenderGrid(r,t.scale.count,t.x_scale?t.x_scale.count+1:a,"chart-grid");let d=0;for(let u of t.series){let h=u.map(f=>{if(!(typeof f>"u"))return G.ApplyScale(f,r.height,s)});if(h.length<a)for(let f=h.length;f<a;f++)h.push(void 0);let m=[t.type==="area"?"chart-area":"chart-line",`series-${d+1}`];c.call(this.renderer,r,h,t.type==="area",t.titles,m),d++}}}break;case"bar":{let s;if(this.renderer.RenderBarGrid(r,t.scale.count,"chart-grid"),t.series2){let a=0,c=t.series2.length;for(let p of t.series2)a=Math.max(a,p.y.data.length);let d=r.height/a,u=.7;typeof t.space=="number"&&(u=Math.max(0,Math.min(1,1-t.space)));let h=d*(1-u)/2,m=(d-h*2)/c,f=0;if(t.scale.min<0&&(f=G.ApplyScale(0,r.width,t.scale)),t.round){let p=Math.floor(m/2);s=[0,p,p,0]}for(let p=0;p<c;p++){let b=t.series2[p],g=typeof b.index=="number"?b.index:p+1;for(let x=0;x<b.y.data.length;x++){let v=b.y.data[x];if(typeof v=="number"){let w=Math.round(r.top+x*d+h)+p*m,_=0,C=0;f?v>0?(C=G.ApplyScale(v+t.scale.min,r.width,t.scale),_=r.left+f):(C=G.ApplyScale(t.scale.min-v,r.width,t.scale),_=r.left+f-C):(C=G.ApplyScale(v,r.width,t.scale),_=r.left),C&&this.renderer.RenderRectangle(new Le(_,w,_+C,w+m),s,["chart-column",`series-${g}`],void 0||void 0)}}}}}break;case"column":case"histogram2":if(this.renderer.RenderGrid(r,t.scale.count,0,"chart-grid"),t.series2){let s=0,a=t.series2.length;for(let p of t.series2)s=Math.max(s,p.y.data.length);let c=r.width/s,d=.7;typeof t.space=="number"&&(d=Math.max(0,Math.min(1,1-t.space)));let u=c*(1-d)/2,h=(c-u*2)/a,m=0;if(t.scale.min<0&&(m=G.ApplyScale(0,r.height,t.scale)),t.callouts&&t.x_scale){let p=t.x_scale,b=t.callouts.map((g,x)=>{let v=Math.round(r.left+G.ApplyScale(g.value,r.width,p))+.5;return{x1:v,y1:r.bottom-r.height,x2:v,y2:r.bottom,classes:`callout-${x+1}`}});this.renderer.RenderCalloutLines(b)}let f;if(t.round){let p=Math.floor(h/2);f=[p,p,0,0]}for(let p=0;p<a;p++){let b=t.series2[p],g=typeof b.index=="number"?b.index:p+1;for(let x=0;x<b.y.data.length;x++){let v=b.y.data[x];if(typeof v=="number"){let w=r.left+x*c+u+p*h,_=0,C=0;m?v>0?(_=G.ApplyScale(v+t.scale.min,r.height,t.scale),C=r.bottom-_-m):(_=G.ApplyScale(t.scale.min-v,r.height,t.scale),C=r.bottom-m):(_=G.ApplyScale(v,r.height,t.scale),C=r.bottom-_);let S=void 0;if(_){let A=t.data_labels&&b.y.labels?b.y.labels[x]:"",R={x:Math.round(w+h/2),y:Math.round(C-10)};this.renderer.RenderRectangle(new Le(w,C,w+h,C+_),f,["chart-column",`series-${g}`],S||void 0,A,R)}}}}}break;case"histogram":{this.renderer.RenderGrid(r,t.scale.count,0,"chart-grid");let s=r.width/t.count,a=t.column_width,c=s*(1-a)/2;for(let d=0;d<t.count;d++){let u=Math.round(r.left+d*s+c),h=s-c*2,m=G.ApplyScale(t.bins[d],r.height,t.scale),f=r.bottom-m,p=t.titles?t.titles[d]:void 0;this.renderer.RenderRectangle(new Le(u,f,u+h,f+m),void 0,"chart-column series-1",p||void 0)}}break}}};var qe=class{constructor(e=new yr){this.renderer=e}static functions_registered=!1;chart_data={type:"null"};node;Initialize(e){this.node=e,this.renderer.Initialize(e)}Exec(e,t){let r=t?.value||[];switch(e.toLowerCase()){case"column.chart":this.chart_data=_i(r,"column");break;case"bar.chart":this.chart_data=_i(r,"bar");break;case"line.chart":this.chart_data=yi(r,"line");break;case"area.chart":this.chart_data=yi(r,"area");break;case"donut.chart":case"pie.chart":this.chart_data=Zn(r,e.toLowerCase()==="pie.chart");break;case"scatter.plot":this.chart_data=gi(r,"plot");break;case"scatter.line":this.chart_data=gi(r,"line");break;case"bubble.chart":this.chart_data=Qn(r);break;case"box.plot":this.chart_data=Yn(r);break;default:this.Clear();break}}Clear(){this.chart_data={type:"null"}}Resize(){this.node&&this.renderer.Resize(this.node,this.chart_data)}Update(){this.node&&this.renderer.Update(this.node,this.chart_data)}};var Te=(...l)=>({type:5,value:l,key:"arguments"}),vi={Group:{arguments:[{name:"Array...",metadata:!0}],fn:(...l)=>({type:5,value:l,key:"group"}),category:["grouping"]},Series:{arguments:[{name:"Label"},{name:"X",metadata:!0},{name:"Y",metadata:!0},{name:"Z",metadata:!0},{name:"Index"},{name:"Subtype"},{name:"Labels",description:"Labels for bubble charts only (atm)"},{name:"Axis",description:"Series axis (scatter plot only)"}],fn:(...l)=>({type:5,value:{label:l[0],x:l[1],y:l[2],z:l[3],index:l[4],subtype:l[5],data_labels:l[6],axis:l[7]},key:"series"}),category:["chart functions"]},"Bar.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"ChartTitle"}],fn:Te,category:["chart functions"]},"Line.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:Te,category:["chart functions"]},"Area.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:Te,category:["chart functions"]},"Pie.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels"},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:Te,category:["chart functions"]},"Donut.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels",metadata:!0},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:Te,category:["chart functions"]},"Scatter.Line":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:Te,category:["chart functions"]},"Scatter.Plot":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:Te,category:["chart functions"]},"Column.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"Chart Title"}],fn:Te,category:["chart functions"]},"Bubble.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Chart Title"}],fn:Te,category:["chart functions"]},"Box.Plot":{arguments:[{name:"Data",metadata:!0},{name:"Chart Title"},{name:"Min/Max Style"}],fn:Te,category:["chart functions"]}};var vr=class l{static treb_base_path="";static failed_dynamic_modules=[];static one_time_warnings={};static clipboard;DOM=H.GetInstance();loaded=!1;document_styles={number_formats:[],colors:[],theme_colors:[]};selection_state={};options;get Localization(){return F}events=new be;calculation=0;file_version=0;last_save_version=0;initial_load_source=void 0;calculator;grid;model;dialog;spinner;file_chooser;file_chooser_operation=0;get parser(){return this.model.parser}view_node;key_listener;views=[];focus_target=this;parent_view;export_worker;undo_pointer=0;undo_stack=[];last_selection;get active_sheet(){let e=this.grid.active_sheet.name;return xe.test(e)?`'${e}'`:e}get modified(){return this.undo_stack.length!==1}get document_name(){return this.grid.model.document_name}set document_name(e){this.grid.model.document_name=e,this.DocumentChange()}get user_data(){return this.grid.model.user_data}set user_data(e){this.grid.model.user_data=e,this.DocumentChange()}get scale(){return this.grid.scale}set scale(e){this.grid.scale=e}get headless(){return this.grid.headless}set headless(e){this.grid.headless!==e&&(this.grid.headless=e,e||(this.grid.Update(!0),this.RebuildAllAnnotations()))}get state(){return this.file_version}get can_revert(){return!this.options.inline_document&&!this.options.document?!1:this.initial_load_source==="local-storage"?!0:this.dirty}get dirty(){return this.file_version!==this.last_save_version}set dirty(e){e?this.file_version++:this.last_save_version=this.file_version}get sheet_names(){return this.model.sheets.list.map(e=>e.name)}constructor(e){e.storage_key&&!e.local_storage&&(e.local_storage=e.storage_key),this.options={...$n,...e,local_storage:this.ResolveStorageKey(e.local_storage,"document")},typeof this.options.imaginary_value=="string"&&(le.imaginary_character=this.options.imaginary_value),this.options.network_document&&(console.warn("the option `network_document` is deprecated. please use `document` instead."),this.options.document||(this.options.document=this.options.network_document)),this.options.document&&this.options.inline_document&&console.warn("both document and inline-document are provided");let t=this.options.document,r,i;this.options.local_storage&&!this.options.toll_initial_load&&!e.model&&(r=localStorage.getItem(this.options.local_storage)||void 0,r&&(i="local-storage")),!r&&!this.options.toll_initial_load&&!e.model&&e.inline_document&&(r=e.inline_document,i="inline-document"),this.options.local_storage&&!e.model&&window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.options.local_storage&&this.dirty&&this.SaveLocalStorage(this.options.local_storage)});let n;typeof this.options.container=="string"?n=document.querySelector(this.options.container):this.options.container&&(n=this.options.container);let o={in_cell_editor:!0,repaint_on_cell_change:!1,scrollbars:this.options.scrollbars,markdown:!!this.options.markdown,formula_bar:this.options.formula_bar,expand_formula_button:this.options.expand_formula_button,tab_bar:this.options.tab_bar,add_tab:this.options.add_tab,expand:this.options.expand,support_font_stacks:!!this.options.font_stack};if(this.options.scale&&(o.initial_scale=this.options.scale),this.options.stats&&(o.stats=this.options.stats,o.tab_bar=!0),this.options.scale_control&&(o.scale_control=!0,o.tab_bar=!0,this.options.persist_scale&&(o.persist_scale_key=this.ResolveStorageKey(this.options.persist_scale,"scale"),o.persist_scale_key))){let s=localStorage.getItem(o.persist_scale_key);if(s)try{let a=JSON.parse(s);o.initial_scale=a.scale||1}catch{console.warn("parsing persisted scale failed")}}if(e.model?(this.model=e.model.model,this.calculator=e.model.calculator,this.DOM=e.model.DOM):(this.model=new bt,this.model.sheets.Add(ee.Blank(this.model.theme_style_properties)),this.calculator=this.CreateCalculator(this.model,this.options)),n&&(this.DOM=H.GetInstance(n.ownerDocument)),this.grid=new pt(o,this.model,void 0,!!n,this.DOM),this.options.headless&&(this.grid.headless=!0),this.LoadLanguage(e.language),n){this.DOM=H.GetInstance(n.ownerDocument),this.parent_view||(q.is_windows?n.parentElement?.classList.add("treb-ua-windows"):q.is_mac&&n.parentElement?.classList.add("treb-ua-osx"));let s=n.querySelector(".treb-view-template");this.view_node=s.content.firstElementChild?.cloneNode(!0),n.prepend(this.view_node),this.view_node.addEventListener("focusin",()=>{this.focus_target!==this&&(this.Publish({type:"focus-view"}),this.focus_target=this)}),this.key_listener=c=>this.HandleKeyDown(c),n.addEventListener("keydown",this.key_listener);let a=!!(r||this.options.document);this.grid.Initialize(this.view_node,a),this.options.dnd&&(this.view_node.addEventListener("dragenter",c=>this.HandleDrag(c)),this.view_node.addEventListener("dragover",c=>this.HandleDrag(c)),this.view_node.addEventListener("drop",c=>this.HandleDrop(c))),this.grid.grid_events.Subscribe(c=>{switch(c.type){case"error":this.dialog?.ShowDialog({type:"error",...this.TranslateGridError(c.code),timeout:3e3,close_box:!0});break;case"selection":this.UpdateSelection(c.selection),this.UpdateSelectionStyle(c.selection);break;case"sheet-change":this.OnSheetChange(c),this.UpdateSelectionStyle();break;case"scale":this.RebuildAllAnnotations(),this.Publish({type:"view-change"});break;case"cell-event":this.HandleCellEvent(c);break;case"composite":{let d=this.last_selection;this.calculation===0&&this.Recalculate(c),this.DocumentChange(d),this.UpdateDocumentStyles(),this.UpdateSelectionStyle()}break;case"data":{let d=this.last_selection;this.calculation===0&&this.Recalculate(c),this.DocumentChange(d)}break;case"style":this.DocumentChange(),this.UpdateDocumentStyles(),this.UpdateSelectionStyle();break;case"annotation":if(c.annotation){let d=c.annotation.view[this.grid.view_index]||{},u=!1;if(c.event==="select")u=!0;else switch(this.DocumentChange(),c.event){case"create":this.InflateAnnotation(c.annotation),this.calculator.UpdateAnnotations(c.annotation,this.grid.active_sheet),this.grid.AnnotationUpdated(c.annotation),u=c.annotation===this.grid.selected_annotation;break;case"delete":this.calculator.RemoveAnnotation(c.annotation);break;case"update":d.update_callback?(d.update_callback(),this.grid.AnnotationUpdated(c.annotation)):console.info("annotation update event without update callback"),this.calculator.UpdateAnnotations(c.annotation,this.grid.active_sheet),u=c.annotation===this.grid.selected_annotation;break;case"resize":d.resize_callback&&(d.resize_callback(),this.grid.AnnotationUpdated(c.annotation));break}if(u){this.UpdateSelectionStyleAnnotation(c.annotation),this.Publish({type:"annotation-selection"});break}}else console.info("annotation event without annotation");break;case"structure":{let d=this.last_selection;c.conditional_format&&(this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1)),c.rebuild_required?(this.calculator.Reset(),this.calculation===0&&this.Recalculate(c),this.DocumentChange(d)):this.DocumentChange(d)}this.UpdateSelectionStyle();break}}),this.options.prompt_save&&window.addEventListener("beforeunload",c=>{this.last_save_version!==this.file_version&&(c.preventDefault(),c.returnValue="")})}else l.one_time_warnings.headless||(l.one_time_warnings.headless=!0,console.info("not initializing layout; don't call UI functions"));if(e.preload&&e.preload.call(0,this),r?(typeof r=="string"&&(r=JSON.parse(r)),r?this.LoadDocument(r,{recalculate:!!this.options.recalculate,source:i}):this.UpdateDocumentStyles()):t||(this.calculator.RebuildClean(!0),this.UpdateDocumentStyles()),this.FlushUndo(),this.grid.ShowHeaders(this.options.headers),this.options.scroll&&!this.options.document){let s=this.options.scroll;requestAnimationFrame(()=>{this.ScrollTo(s)})}this.UpdateAC(),this.options.global_name&&(self[this.options.global_name]=this),n&&this.options.spinner&&(this.spinner=new pr(n)),t&&!e.model&&!r&&this.LoadNetworkDocument(t,this.options),n&&(this.dialog=new fr(n))}UpdateAC(){let e=this.calculator.SupportedFunctions();if(this.model.language_model?.functions){let t={};for(let r of this.model.language_model.functions||[])t[r.base.toUpperCase()]=r;e=e.map(r=>{let i=t[r.name.toUpperCase()];if(i){let n=JSON.parse(JSON.stringify({...r,name:i.name}));if(i.description&&(n.description=i.description),i.arguments&&n.arguments)for(let[o,s]of i.arguments.entries())n.arguments[o]&&(n.arguments[o].name=s);return n}return r})}this.grid.SetAutocompleteFunctions(e)}CreateCalculator(e,t){return new mr(e,{complex_numbers:t.complex,spill:t.spill})}TranslateGridError(e){switch(e){case 0:return{message:"No error"};case 2:return{message:"You can't change part of an array"};case 5:return{message:"Invalid area for paste"};case 4:return{message:"Invalid area for table"};case 3:return{message:"Invalid value (data validation)"};default:return{message:`Unknown error (${e})`}}}CreateView(){let e=new l({...this.options,global_name:void 0,model:this});return e.parent_view=this,e}Unsplit(){let e=this.views.pop();if(e){let t=e.view;t.grid.grid_events.CancelAll(),t.events.CancelAll(),t.view_node?.parentElement&&(t.key_listener&&t.view_node.parentElement.removeEventListener("keydown",t.key_listener),t.view_node.parentElement.removeChild(t.view_node)),this.view_node?.focus(),this.Resize()}}ExternalEditor(e){this.grid.ExternalEditor(e)}Split(){let e=this.CreateView();e.grid.EnsureActiveSheet(!0),e.view_node?.addEventListener("focusin",()=>{this.focus_target!==e&&(this.Publish({type:"focus-view"}),this.focus_target=e)}),e.grid.grid_events.Subscribe(r=>{r.type==="structure"&&(this.grid.EnsureActiveSheet(),this.grid.UpdateLayout(),this.grid.UpdateTabBar(),r.update_annotations&&(this.grid.RefreshAnnotations(),this.InflateAnnotations()))}),e.Subscribe(r=>{switch(r.type){case"selection":break;default:e.UpdateAnnotations(),this.grid.Update(!0),this.grid.UpdateAnnotations()}}),this.grid.grid_events.Subscribe(r=>{r.type==="structure"&&(e.grid.EnsureActiveSheet(),e.grid.UpdateLayout(),e.grid.UpdateTabBar(),r.update_annotations&&(e.grid.RefreshAnnotations(),e.InflateAnnotations()))});let t=this.Subscribe(r=>{switch(r.type){case"selection":break;case"load":case"reset":e.grid.EnsureActiveSheet(!0),e.UpdateAnnotations(),e.grid.UpdateAnnotations(),e.grid.Update(!0);break;default:e.UpdateAnnotations(),e.grid.Update(!0),e.grid.UpdateAnnotations()}});this.views.push({view:e,subscription:t})}ListConditionalFormats(e){return(typeof e>"u"?this.grid.active_sheet:this.model.sheets.Find(e))?.conditional_formats||[]}ConditionalFormatDuplicateValues(e,t){return this.AddConditionalFormat({type:"duplicate-values",area:this.RangeOrSelection(e,"invalid range (no selection)"),...t})}ConditionalFormatGradient(e,t){let r=this.RangeOrSelection(e,"invalid range (no selection)"),i=typeof t=="object"?{type:"gradient",area:r,...t}:{type:"gradient",area:r,...Zi[t]};return this.AddConditionalFormat(i),i}ConditionalFormatCellMatch(e,t){let r={type:"cell-match",area:this.RangeOrSelection(e,"invalid range (no selection)"),...t};return this.AddConditionalFormat(r),r}ConditionalFormatExpression(e,t){let r={type:"expression",area:this.RangeOrSelection(e,"invalid range (no selection)"),...t};return this.AddConditionalFormat(r),r}AddConditionalFormat(e){return this.grid.AddConditionalFormat(e),e}RemoveConditionalFormat(e){this.grid.RemoveConditionalFormat({format:e})}RemoveConditionalFormats(e){let t=this.RangeOrSelection(e);t&&this.grid.RemoveConditionalFormat({area:t})}HandleToolbarMessage(e){if(this.focus_target!==this){this.focus_target.HandleToolbarMessage(e);return}let t={};if(this.grid.AnnotationSelected()){switch(e.command){case"adjust-font-scale":{let i=Number(e.delta||0),n=this.grid.GetAnnotationStyle()?.font_size;(!n||n.unit!=="em")&&(n={unit:"em",value:1}),n&&(n.value+=i,t.font_size=n,this.grid.ApplyAnnotationStyle(t))}break;case"font-scale":{let i=Number(e.scale||1);i&&!isNaN(i)&&(t.font_size={unit:"em",value:i},this.grid.ApplyAnnotationStyle(t))}break;case"font-stack":e.font_stack&&(t.font_face="stack:"+e.font_stack),this.grid.ApplyAnnotationStyle(t);break}this.Focus();return}let r=i=>{let n=this.grid.GetSelection();if(n&&!n.empty){let o=n.area.spreadsheet_label;i==="Scatter.Plot"||i==="Scatter.Line"||i==="Box.Plot"?this.InsertAnnotation(`=${i}(Series(,,${o}),"${o}")`,void 0,void 0,","):this.InsertAnnotation(`=${i}(${o},,"${o}")`,void 0,void 0,",")}};if(/^border-/.test(e.command))if(e.command==="border-color")try{t.border_top_fill=t.border_bottom_fill=t.border_left_fill=t.border_right_fill=e.color||{}}catch(i){console.error(i)}else{let i=1,n=e.command.substring(7);e.command==="border-double-bottom"&&(n="bottom",i=2),this.grid.ApplyBorders2(void 0,n,e.color||{},i)}else switch(e.command){case"about":this.About();break;case"number-format":t.number_format=e.format||"General";break;case"font-stack":e.font_stack&&(t.font_face="stack:"+e.font_stack);break;case"adjust-font-scale":{let i=this.selection_state.style?.font_size,n=this.grid.GetSelection(),o=this.grid.active_sheet.RealArea(n.area),s=Number(e.delta||0);if((!i||i.unit!=="em")&&(i={unit:"em",value:1}),i&&s&&!isNaN(s)){i.value+=s,this.grid.ApplyStyle(void 0,{font_size:i},!0);let a=[];for(let c=o.start.row;c<=o.end.row;c++)a.push(c);this.selection_state?.merge||this.grid.SetRowHeight(a,void 0,!1)}}break;case"font-scale":{let i=this.grid.GetSelection(),n=this.grid.active_sheet.RealArea(i.area),o=Number(e.scale||1);if(o&&!isNaN(o)){this.grid.ApplyStyle(void 0,{font_size:{unit:"em",value:o}},!0);let s=[];for(let a=n.start.row;a<=n.end.row;a++)s.push(a);this.selection_state?.merge||this.grid.SetRowHeight(s,void 0,!1)}}break;case"update-comment":this.SetNote(void 0,e.comment||"");break;case"clear-comment":this.SetNote(void 0,"");break;case"text-color":case"fill-color":try{let i=e.color||{};e.command==="text-color"?t.text=i:e.command==="fill-color"&&(t.fill=i)}catch(i){console.error(i)}break;case"insert-table":this.InsertTable();break;case"remove-table":this.RemoveTable();break;case"insert-row":this.InsertRows();break;case"insert-column":this.InsertColumns();break;case"delete-row":this.DeleteRows();break;case"delete-column":this.DeleteColumns();break;case"insert-sheet":this.grid.InsertSheet();break;case"delete-sheet":this.grid.DeleteSheet();break;case"freeze-panes":{let i=this.grid.GetFreeze();i.rows||i.columns?this.Freeze(0,0):this.FreezeSelection()}break;case"insert-image":this.InsertImage();break;case"insert-donut-chart":r("Donut.Chart");break;case"insert-column-chart":r("Column.Chart");break;case"insert-bar-chart":r("Bar.Chart");break;case"insert-line-chart":r("Line.Chart");break;case"insert-scatter-plot":r("Scatter.Plot");break;case"insert-box-plot":r("Box.Plot");break;case"increase-precision":case"decrease-precision":if(this.selection_state?.style){let i=L.Get(this.selection_state.style.number_format||"General");if(i.date_format)break;let n=new le(i.pattern);if(i.magic_decimal){let o=0,s=this.GetRange();Array.isArray(s)||(s=[[s]]);e:for(let a=0;a<s.length;a++)for(let c=0;c<s[a].length;c++){let d=s[a][c];if(typeof d<"u"&&ue(d)){let u=L.Get(this.selection_state.style.number_format||"General",!0),h=u.BaseFormat(d.real),m=u.BaseFormat(d.imaginary);h.parts&&typeof h.parts[1]=="string"&&(o=h.parts[1].length),m.parts&&typeof m.parts[1]=="string"&&(o=Math.max(o,m.parts[1].length));break e}else if(typeof d=="number"){let u=i.BaseFormat(d);u.parts&&typeof u.parts[1]=="string"&&(o=u.parts[1].length);break e}}e.command==="increase-precision"?n.SetDecimal(o+1):n.SetDecimal(Math.max(0,o-1))}else e.command==="increase-precision"?n.IncreaseDecimal():n.DecreaseDecimal();t.number_format=n.toString()}break;case"merge-cells":this.grid.MergeCells();break;case"unmerge-cells":this.grid.UnmergeCells();break;case"lock-cells":t={locked:this.selection_state?.style?!this.selection_state.style.locked:!0};break;case"wrap-text":t={wrap:this.selection_state?.style?!this.selection_state?.style.wrap:!0};break;case"justify-left":t={horizontal_align:"left"};break;case"justify-center":t={horizontal_align:"center"};break;case"justify-right":t={horizontal_align:"right"};break;case"align-top":t={vertical_align:"top"};break;case"align-middle":t={vertical_align:"middle"};break;case"align-bottom":t={vertical_align:"bottom"};break;case"reset":this.Reset();break;case"import-file":this.LoadLocalFile();break;case"save-json":this.SaveToDesktop();break;case"save-csv":this.SaveToDesktop("csv");break;case"export-xlsx":this.Export();break;case"revert":this.Revert();break;case"recalculate":this.Recalculate();break;case"toggle-toolbar":case"show-toolbar":case"hide-toolbar":this.ShowToolbar(e.command==="toggle-toolbar"?void 0:e.command==="show-toolbar");break;case"toggle-sidebar":case"show-sidebar":case"hide-sidebar":this.ShowSidebar(e.command==="toggle-sidebar"?void 0:e.command==="show-sidebar");break;case"revert-indicator":this.dialog?.ShowDialog({title:`This is a modified version of the document.
You can revert to the original or save your
changes in the sidebar.`,close_box:!0,timeout:5e3,type:"info"});break;case"indent":case"outdent":this.grid.Indent(void 0,e.command==="indent"?1:-1);break;default:console.info("unhandled",e.command);break}Object.keys(t).length&&this.grid.ApplyStyle(void 0,t,!0),this.Focus()}ShowToolbar(e){if(this.options.toolbar&&this.options.container instanceof HTMLElement){let t=this.options.container.parentElement;t&&(e===void 0&&(e=!t.hasAttribute("toolbar")),e?t.setAttribute("toolbar",""):t.removeAttribute("toolbar"))}}ShowSidebar(e){if(this.options.toolbar&&this.options.container instanceof HTMLElement){let t=this.options.container.parentElement;t&&(e===void 0&&(e=t.hasAttribute("collapsed")),e?t.removeAttribute("collapsed"):t.setAttribute("collapsed",""))}}CreateChart(){return this.calculator.RegisterLibrary("treb-charts",vi)&&this.UpdateAC(),this.options.chart_renderer?typeof this.options.chart_renderer=="function"?new qe(this.options.chart_renderer()):new qe(this.options.chart_renderer):new qe}async LoadLanguage(e=""){(!e||e==="locale")&&(e=(F.locale||"").split(/-/).map(o=>o.toLowerCase())[0]),e=e.toLowerCase();let t;if(e&&["es","fr","pt","nl","de","pl","sv","no","da","it"].includes(e))try{t=await import(`./languages/treb-i18n-${e}.mjs`)}catch(i){console.error(i)}t?this.model.SetLanguage(t.LanguageMap):this.model.SetLanguage(),this.grid.Reselect(),this.grid.Update(!0),this.UpdateAC()}Batch(e,t=!1){let r=this.last_selection,i=this.grid.Batch(e,t),n=!1,o=!1;for(let s of i)switch(s.type){case"data":n=!0;break;case"structure":s.rebuild_required&&(o=!0);break;default:}o&&this.calculator.Reset(),(n||o)&&(this.Recalculate(),this.DocumentChange(r))}Freeze(e=0,t=0){this.grid.Freeze(e,t,!0)}FreezeSelection(){let e=this.grid.GetSelection();if(e.empty)this.grid.Freeze(0,0);else{let t=e.area;t.entire_sheet||(t.entire_row?this.grid.Freeze(t.end.row+1,0):t.entire_column?this.grid.Freeze(0,t.end.column+1):this.grid.Freeze(t.end.row+1,t.end.column+1))}}GetFreeze(){return this.grid.GetFreeze()}UpdateTheme(){this.grid.UpdateTheme(void 0),this.UpdateDocumentStyles();for(let e of this.model.sheets.list){for(let t of e.conditional_formats)t.internal=void 0;for(let t of e.annotations)if(t.view&&t.data.type==="textbox"){let r=t.view[this.grid.view_index]||{};r.update_callback&&r.update_callback()}}this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update(!0),this.Publish({type:"theme-change"})}GetSheetID(e){if(typeof e=="number"){let t=this.grid.model.sheets.list[e];if(t)return t.id}else{let t=this.model.sheets.Find(e);if(t)return t.id}}InsertTable(e,t={}){let r=e?this.model.ResolveArea(e,this.grid.active_sheet):this.GetSelectionReference().area,i=t.theme;typeof i=="number"&&(i=qt(i)),this.grid.InsertTable(r,t.totals_row,t.sortable,i)}RemoveTable(e){let t=this.ResolveTable(e||this.GetSelectionReference().target);t&&this.grid.RemoveTable(t)}UpdateTableStyle(e,t=4){let r=this.ResolveTable(e||this.GetSelectionReference().target);r&&(typeof t=="number"&&(t=qt(t)),r.theme=t,this.grid.active_sheet.FlushCellStyles(),this.grid.Update(!0),this.PushUndo())}SetTabColor(e,t){let r=typeof e>"u"?this.grid.active_sheet:this.model.sheets.Find(e);r&&this.grid.TabColor(r,t)}AddSheet(e){this.grid.AddSheet(e);let t=this.model.sheets.list[this.model.sheets.list.length-1];return this.calculator.Reset(),t.id}RemoveConnectedChart(e){let t=this.model.RemoveConnectedElement(e);if(t){let r=this.calculator.RemoveConnectedELement(t)}}UpdateConnectedChart(e,t){let r=this.model.connected_elements.get(e);if(r){r.formula=t;let i=r.internal;i?.state&&(i.state=void 0),this.calculator.UpdateConnectedElements(this.grid.active_sheet,r),r.update&&r.update.call(0,r)}}CreateConnectedFormula(e,t,r={}){let i=r?.r1c1||!1,n=r?.argument_separator||this.parser.argument_separator;this.parser.Save(),this.parser.flags.r1c1=i,n===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(",");let o=this.parser.Parse(e);if(this.parser.Restore(),o.expression)e="="+this.parser.Render(o.expression,{missing:""});else throw console.warn("invalid formula",o.error),new Error("invalid formula");let s=this.model.AddConnectedElement({formula:e,update:t?a=>{t.call(0,a)}:void 0});return this.calculator.UpdateConnectedElements(this.grid.active_sheet),this.UpdateConnectedElements(),s}CreateConnectedChart(e,t,r){let i=this.CreateChart();i.Initialize(t);let n=o=>{let s=this.parser.Parse(o.formula);if(s&&s.expression&&s.expression.type==="call"){this.parser.Walk(s.expression,d=>((d.type==="address"||d.type==="range")&&this.model.ResolveSheetID(d,void 0,this.grid.active_sheet),!0));let a=s.expression.name.toLowerCase(),c=this.calculator.CalculateExpression(s.expression);i.Exec(a,c)}i.Update()};return this.CreateConnectedFormula(e,n,r)}InsertAnnotation(e,t="treb-chart",r,i){let n,o,s=!1;if(typeof i=="object"?(o=i.argument_separator,s=!!i.r1c1):(i===","||i===";")&&(o=i),r&&(n=B.IsRectangle(r)?r:this.model.ResolveArea(r,this.grid.active_sheet)),o&&o!==this.parser.argument_separator||s){this.parser.Save(),o===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(","),this.parser.flags.r1c1=!!s;let h=this.parser.Parse(e);this.parser.Restore(),h.expression&&(e="="+this.parser.Render(h.expression,{missing:""}))}let{x:a,y:c}=this.grid.GetScrollOffset(),d=this.grid.scale||1,u={width:301,height:301};this.grid.CreateAnnotation({type:t,formula:e},void 0,void 0,void 0,n||{top:c/d+30,left:a/d+30,...u})}InsertImage(){this.SelectFile2(".png, .jpg, .jpeg, .gif, .svg",2)}RenameSheet(e,t){let r;typeof e=="number"?r=this.grid.model.sheets.list[e]:typeof e=="string"?r=this.model.sheets.Find(e):r=this.grid.active_sheet,r&&this.grid.RenameSheet(r,t)}DeleteSheet(e){if(typeof e=="string"){let t=this.model.sheets.Find(e);t&&this.grid.DeleteSheetID(t.id)}else this.grid.DeleteSheet(e);this.calculator.Reset()}HideSheet(e=0,t=!0){this.grid.ShowSheet(e,!t)}ListSheets(){return this.model.sheets.list.map(e=>{let t={name:e.name};return e.visible||(t.hidden=!0),t})}ShowSheet(e=0,t=!0){this.grid.ShowSheet(e,t)}ActivateSheet(e){this.grid.ActivateSheet(e)}SetColumnWidth(e,t){this.grid.SetColumnWidth(e,t)}SetRowHeight(e,t){this.grid.SetRowHeight(e,t)}InsertRows(e,t=1){if(typeof e>"u"){let r=this.grid.GetSelection();if(r.empty)return;let i=r.area;e=i.entire_column?0:i.start.row}this.grid.InsertRows(e,t)}InsertColumns(e,t=1){if(typeof e>"u"){let r=this.grid.GetSelection();if(r.empty)return;let i=r.area;e=i.entire_row?0:i.start.column}this.grid.InsertColumns(e,t)}DeleteRows(e,t=1){if(typeof e>"u"){let r=this.grid.GetSelection();if(r.empty)return;let i=r.area;e=i.entire_column?0:i.start.row,t=i.rows}this.grid.InsertRows(e,-t)}DeleteColumns(e,t=1){if(typeof e>"u"){let r=this.grid.GetSelection();if(r.empty)return;let i=r.area;e=i.entire_row?0:i.start.column,t=i.columns}this.grid.InsertColumns(e,-t)}FilterTable(e,t=0,r){let i=this.ResolveTable(e);if(!i)throw new Error("invalid table reference");r?this.grid.FilterTable(i,t,n=>r.call(0,n.value,n.calculated||void 0,JSON.parse(JSON.stringify(n.style||{})))):this.grid.FilterTable(i,0,()=>!0)}SortTable(e,t={}){let r=this.ResolveTable(e);if(!r)throw new Error("invalid table reference");this.grid.SortTable(r,t)}MergeCells(e){this.grid.MergeCells(e?this.model.ResolveArea(e,this.grid.active_sheet):void 0)}UnmergeCells(e){this.grid.UnmergeCells(e?this.model.ResolveArea(e,this.grid.active_sheet):void 0)}async ExportBlob(e){return this.export_worker||(this.export_worker=await this.LoadWorker()),new Promise((t,r)=>{this.export_worker?(this.export_worker.onmessage=i=>{t(i.data?i.data.blob:void 0)},this.export_worker.onerror=i=>{console.error("export worker error"),console.info(i),r(i)},e||(e=this.Serialize({rendered_values:!0,expand_arrays:!0,export_colors:!0,decorated_cells:!0,tables:!0,share_resources:!1,export_functions:!0,apply_row_pattern:!0})),e.decimal_mark=F.decimal_separator,this.export_worker.postMessage({command:"export",sheet:e,decorated:this.calculator.DecoratedFunctionList()})):r("worker failed")})}Revert(){if(this.options.inline_document){this.LoadDocument(this.options.inline_document),this.initial_load_source="inline-document",this.options.local_storage&&(this.SaveLocalStorage("reverted_backup"),localStorage.removeItem(this.options.local_storage));return}let e=this.options.document;if(e){this.LoadNetworkDocument(e),this.initial_load_source="network-file",this.options.local_storage&&(this.SaveLocalStorage("reverted_backup"),localStorage.removeItem(this.options.local_storage));return}console.warn("to revert, there must be a document set in options"),this.dialog?.ShowDialog({title:"Can't revert -- no document is set in options",close_box:!0,timeout:3e3,type:"error"})}Export(){this.ExportBlob().then(e=>{let t="export";this.grid.model.document_name&&(t=this.grid.model.document_name.toLowerCase().replace(/\s+/g,"-")),e&&(this.SaveAs(e,t+".xlsx"),this.last_save_version=this.file_version)}).catch(e=>{throw/invalid uri/i.test(e.message)&&this.dialog?.ShowDialog({title:"Error exporting file",close_box:!0,message:"The worker cannot run from the filesystem, please use a web server.",timeout:3e3,type:"error"}),e})}GetSelectionReference(){return this.grid.GetSelection()}Focus(){this.grid.Focus()}Resize(){this.grid.UpdateLayout();for(let e of this.views)e.view.grid.UpdateLayout();this.Publish({type:"resize"})}Reset(){if(this.parent_view)return this.parent_view.Reset();this.grid.Reset(),this.ResetInternal(),this.UpdateAC(),this.Publish({type:"reset"})}LoadFromLocalStorage(e){this.options.local_storage=e;let t=localStorage.getItem(e);if(t)try{let r=JSON.parse(t);return this.LoadDocument(r,{source:"local-storage"}),!0}catch(r){console.error(r)}return!1}async LoadNetworkDocument(e,t){let r=t?t.scroll:void 0,i=t?!!t.recalculate:!1,n=t?t.sheet:void 0,o=/csv(?:$|\?|&)/i.test(e),s=/tsv(?:$|\?|&)/i.test(e);try{this.spinner?.Show();let a=await fetch(e);if(this.spinner?.Hide(),!a.ok)throw new Error("network error");let c=await a.text();if(typeof c=="string")if(o)this.LoadCSV(c,"network-file");else{if(s)throw new Error("tsv not supported (TODO)");{c.substr(0,11)==="&&&START&&&"?c=c.substr(11):c.substr(0,8)==="for(;;);"&&(c=c.substr(8));let d=JSON.parse(c);this.LoadDocument(d,{scroll:r,recalculate:i,override_sheet:n,source:"network-file"})}}}catch(a){console.info("error loading network document",e),console.error(a),this.dialog?.ShowDialog({title:"Error loading file",close_box:!0,message:"The network document returned an error",type:"error",timeout:3e3}),this.Reset()}}async LoadLocalFile(){this.SelectFile2(".treb, .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json",1)}ExportDelimited(e={}){if(e={delimiter:",",...e},!e.delimiter||e.delimiter!==","&&e.delimiter!=="	")throw new Error("invalid delimiter");let t=this.grid.active_sheet;switch(typeof e.sheet){case"undefined":break;case"string":t=this.model.sheets.Find(e.sheet);break;case"number":t=this.grid.model.sheets.list[e.sheet];break;default:t=void 0;break}if(!t)throw new Error("invalid sheet identifier");let r=t.cells.toJSON({nested:!1,expand_arrays:!0,calculated_value:!0}),i=[];for(let s=0;s<r.columns;s++)i.push("");let n=[];for(let s=0;s<r.rows;s++)n.push(i.slice(0));let o=new RegExp(`[	
\r"${e.delimiter}]`);if(dt(r.data))for(let s of r.data){let a="";!e.formulas&&typeof s.calculated<"u"?a=ue(s.calculated)?Xe(s.calculated):s.calculated.toString():typeof s.value=="string"&&s.value[0]==="'"?a=s.value.substr(1):typeof s.value<"u"&&(a=ue(s.value)?Xe(s.value):s.value.toString()),o.test(a)&&(a=a.replace(/"/g,'""'),a='"'+a+'"'),n[s.row][s.column]=a}return n.map(s=>s.join(e.delimiter)).join(`\r
`)}SaveLocalFile(e="treb.json",t={}){this.SaveToDesktop(e,t)}SaveToDesktop(e="treb.json",t={}){let r=this.grid.model.document_name||"document",i,n,o=e.split(/\./).filter(a=>a.trim().length),s=o.length?o[o.length-1].toLowerCase():"treb";if(o.length<=1||e==="treb.json")if(e==="treb.json"&&(s=e),(s==="csv"||s==="tsv")&&this.grid.model.sheets.length>1){let a=this.grid.active_sheet.name;e=(r+"-"+a).toLowerCase().replace(/\W+/g,"-")+"."+s}else e=r.toLowerCase().replace(/\W+/g,"-")+"."+s;switch(s){case"csv":n=this.ExportDelimited({delimiter:","});break;case"tsv":n=this.ExportDelimited({delimiter:"	"});break;case"treb":case"json":case"treb.json":i=this.SerializeDocument({...t}),n=JSON.stringify(i,void 0,t.pretty?2:void 0),this.last_save_version=this.file_version;break;default:throw new Error("invalid file type")}if(n&&e){let a=new Blob([n],{type:"text/plain;charset=utf-8"});this.SaveAs(a,e)}}LoadCSV(e,t){if(this.parent_view)return this.parent_view.LoadCSV(e,t);this.grid.FromCSV(e),this.ResetInternal(),this.grid.Update(!0),this.Publish({type:"load",source:t}),this.UpdateDocumentStyles()}ScrollOffset(e){return this.grid.ScrollOffset(e)}LoadDocument(e,t={}){if(this.parent_view)return this.parent_view.LoadDocument(e,t);if(this.initial_load_source||(this.initial_load_source=t.source),t={flush:!0,recalculate:!1,...t},t.override_selection&&e.sheet_data){let r=Array.isArray(e.sheet_data)?e.sheet_data:[e.sheet_data];for(let i of r)if(i.id===t.override_selection.target.sheet_id){i.selection=t.override_selection;break}}if(this.ImportDocumentData(e,t.override_sheet),this.calculator.Reset(),e.rendered_values&&!t.recalculate?(this.calculator.RebuildClean(!0),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update()):this.Recalculate(),this.InflateAnnotations(),t.flush&&this.FlushUndo(),this.Publish({type:"load",source:t.source}),this.UpdateDocumentStyles(),this.loaded=!0,t.scroll){let r=t.scroll;Promise.resolve().then(()=>this.ScrollTo(r))}}SetNote(e,t){if(typeof e=="string"){let r=this.model.ResolveAddress(e,this.grid.active_sheet);e=N(r)?r:r.start}this.grid.SetNote(e,t)}SetValidation(e,t,r){if(typeof e=="string"){let i=this.model.ResolveAddress(e,this.grid.active_sheet);e=ct(i)?new y(i.start,i.end):new y(i)}if(N(e)&&(e=new y(e)),typeof t>"u"||Array.isArray(t))this.grid.SetValidation(e,t,r);else{let i=this.model.ResolveArea(t,this.grid.active_sheet);this.grid.SetValidation(e,i,r)}}RemoveFunction(e){let t=e.toUpperCase();this.model.macro_functions.delete(t),this.UpdateAC()}DefineFunction(e,t="",r="0"){if(!e.length||/^[^A-Za-z]/.test(e)||/[^\w_.]/.test(e))throw new Error("invalid function name");typeof t=="string"&&(t=t?t.split(this.parser.argument_separator).map(i=>i.trim()):[]);for(let i of t)if(!i.length||/^[^A-Za-z]/.test(i)||/[^\w_.]/.test(i))throw new Error("invalid argument name");this.RemoveFunction(e),this.grid.model.macro_functions.set(e.toUpperCase(),{name:e,function_def:r,argument_names:t,expression:this.parser.Parse(r).expression}),this.UpdateAC()}SerializeDocument(e={}){e={share_resources:!0,shrink:!0,...e};let t=this.Serialize(e),r={app:"@trebco/treb",version:"31.9.1",revision:this.file_version,name:this.grid.model.document_name,user_data:this.grid.model.user_data,decimal_mark:F.decimal_separator,...t};if(e.share_resources){let i=1,n=new Map,o=Array.isArray(r.sheet_data)?r.sheet_data:[r.sheet_data],s=c=>{let d=n.get(c);return d||(d=(i++).toString(),n.set(c,d)),`resource:${d}`};for(let c of o)if(c){c.background_image&&(c.background_image=s(c.background_image));for(let d of c.annotations||[])d.type==="image"&&d.data?.src&&(d.data.src=s(d.data.src))}let a={};for(let[c,d]of n.entries())a[d]=c;r.shared_resources=a}return e.rendered_values&&(r.rendered_values=!0),r}Recalculate(e){let t;e&&e.type==="data"&&e.area&&(t=e.area),this.calculator.Calculate(t),this.calculator.grid_expanded&&this.grid.UpdateLayout(),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update(!0),this.UpdateAnnotations(),this.Publish({type:"data"}),this.grid.UpdateStats()}SaveLocalStorage(e=this.options.local_storage){if(!e){console.warn("not saving, no key");return}let t=JSON.stringify(this.SerializeDocument({rendered_values:!0,expand_arrays:!0}));localStorage.setItem(e,t)}Undo(){if(this.parent_view)return this.parent_view.Undo();if(this.undo_pointer<=1){console.warn("nothing to undo");return}let e=this.undo_stack[--this.undo_pointer-1],t=e.selection?JSON.parse(e.selection):void 0;this.LoadDocument(JSON.parse(e.data),{flush:!1,override_selection:t,source:"undo"})}About(){this.dialog?.ShowDialog({type:"about"})}ScrollIntoView(e,t=!1){if(typeof e=="string"){let r=this.model.ResolveAddress(e,this.grid.active_sheet);e=N(r)?r:r.start}this.grid.ScrollIntoView(e,t)}ScrollTo(e,t={}){if(typeof e=="string"){let r=this.model.ResolveAddress(e,this.grid.active_sheet);e=N(r)?r:r.start}t={x:!0,y:!0,smooth:!1,...t},this.grid.ScrollTo(e,t.x,t.y,t.smooth)}Resolve(e){let t=this.model.ResolveAddress(e,this.grid.active_sheet);return N(t)?t.sheet_id?t:void 0:t.start.sheet_id?t:void 0}Unresolve(e,t=!0,r=!0){if(typeof e=="string"){let i=this.Resolve(e);if(!i)throw new Error("invalid reference");e=i}return this.calculator.Unresolve(e,this.grid.active_sheet,t,r)}Evaluate(e,t={}){return this.calculator.Evaluate(e,this.grid.active_sheet,t)}GetSelection(e=!0){let t=this.grid.GetSelection();if(t.empty)return"";let r="";if(t.area.count>1?r=y.CellAddressToLabel(t.area.start)+":"+y.CellAddressToLabel(t.area.end):r=y.CellAddressToLabel(t.area.start),!e)return r;let i=t.area.start.sheet_id||this.grid.active_sheet.id,n=this.calculator.ResolveSheetName(i,!0);return n?n+"!"+r:r}ParseNumber(e){return ge.TryParse(e).value}FormatNumber(e,t="General"){return ue(e)?le.FormatPartsAsText(L.Get(t).FormatComplex(e)):L.Get(t).Format(e)}SpreadsheetDate(e){return e instanceof Date&&(e=e.getTime()),Ce(e,!0)}JavascriptDate(e){return Re(e).getTime()}ApplyBorders(e,t,r=1){this.grid.ApplyBorders2(e?this.model.ResolveArea(e,this.grid.active_sheet):void 0,t,{},r)}ApplyStyle(e,t={},r=!0){this.grid.ApplyStyle(e?this.model.ResolveArea(e,this.grid.active_sheet):void 0,t,r)}ClearName(e){this.grid.SetName(e)}DefineName(e,t,r,i=!1){if(typeof t>"u"||t===null)throw new Error("invalid value (null or undefined)");if(typeof r=="string"){let n=this.model.sheets.ID(r);if(typeof n=="number")r=n;else throw new Error("invalid scope; use a sheet name or sheet id")}if(typeof t=="object"&&(N(t)||ct(t))){this.grid.SetName(e,this.model.ResolveArea(t,this.grid.active_sheet),void 0,r,i);return}if(typeof t=="string"){let n=this.parser.Parse(t);if(!n.expression)throw new Error("invalid expression");switch(n.expression.type){case"address":case"range":this.grid.SetName(e,this.model.ResolveArea(n.expression,this.grid.active_sheet),void 0,r,i);return}this.grid.SetName(e,void 0,t,r,i)}else this.grid.SetName(e,void 0,t.toString(),r,i)}SetLink(e,t=""){if(typeof e=="string"){let r=this.model.ResolveAddress(e,this.grid.active_sheet);e=N(r)?r:r.start}if(!e){let r=this.GetSelectionReference();if(r.empty)return;e=r.target}this.grid.SetLink(e,t)}Select(e){let t;e&&(t=this.model.ResolveArea(e,this.grid.active_sheet),t.start.sheet_id&&t.start.sheet_id!==this.grid.active_sheet.id&&this.grid.ActivateSheetID(t.start.sheet_id)),this.grid.SelectRange(t)}Paste(e,...t){let r=l.clipboard,i={};switch(t.length){case 1:Array.isArray(t[0])?r=t[0]:typeof t[0]=="object"&&(i=t[0]);break;case 2:t[0]&&Array.isArray(t[0])&&(r=t[0]),t[1]&&typeof t[1]=="object"&&(i=t[1]);break}if(!r)throw new Error("no clipboad data");this.grid.PasteArea(this.RangeOrSelection(e,"no range and no selection"),r,i)}Copy(e){let t=this.RangeOrSelection(e),r=t?this.grid.CopyArea(t,"copy"):[];return l.clipboard=structuredClone(r),r}Cut(e){let t=this.RangeOrSelection(e),r=t?this.grid.CopyArea(t,"cut"):[];return l.clipboard=structuredClone(r),r}GetRange(e,t={}){let r=this.RangeOrSelection(e);if(!r)return;let i=t.type;return i||(t.formatted&&(i="formatted"),t.formula&&(i="A1")),i==="formula"&&(i="A1"),this.grid.GetRange(r,i)}GetStyle(e,t=!1){let r=this.RangeOrSelection(e);if(r)return this.grid.GetRangeStyle(r,t)}SetRange(e,t=void 0,r={}){let i=this.RangeOrSelection(e);if(i){if(r.spill&&Array.isArray(t)){let n=t.length,o=Math.max(0,...t.map(a=>a.length)),s={row:i.start.row+n+1,column:i.start.column+o+1};i.ConsumeAddress(s)}return this.grid.SetRange(i,t,r)}}Subscribe(e){return this.events.Subscribe(e)}Cancel(e){this.events.Cancel(e)}RangeOrSelection(e,t){if(!e){let r=this.GetSelectionReference();if(r.empty){if(t)throw t;return}else return r.area.Clone()}return this.model.ResolveArea(e,this.grid.active_sheet)}Serialize(e={}){let t=this.grid.active_sheet;t.selection=JSON.parse(JSON.stringify(this.grid.GetSelection()));let r=this.grid.ScrollOffset();r&&(t.scroll_offset=r);let i=this.model.sheets.list.map(a=>a.toJSON(e)),n;this.model.tables.size>0&&(n=Array.from(this.model.tables.values()));let o;if(this.model.macro_functions.size){o=[];for(let a of this.model.macro_functions.values())o.push({...a,expression:void 0})}let s=this.model.SerializeNames(t);return{sheet_data:i,active_sheet:t.id,named:s.length?s:void 0,macro_functions:o,tables:n}}ApplyConditionalFormats(e,t){let r=[];if(e.conditional_formats.length||e.flush_conditional_formats){for(let i of e.conditional_formats)r.push(i.area),i.type==="gradient"&&(i.internal||(i.internal={}),i.internal.gradient||(i.internal.gradient=new Jt(i.stops,this.grid.theme,i.color_space)));e.ApplyConditionalFormats()}t&&this.grid.Update(!0,r)}ResolveTable(e){let t;if(typeof e=="string"){let r=e.toLowerCase();this.model.tables.has(r)&&(t=this.model.tables.get(r))}if(!t){let r=this.model.ResolveAddress(e,this.grid.active_sheet);N(r)||(r=r.start),t=this.grid.GetTableReference(r)}return t}SaveAs(e,t){let r=this.DOM.Create("a");r.href=URL.createObjectURL(e),r.download=t,r.click(),URL.revokeObjectURL(r.href)}Publish(e){this.events.Publish(e)}async ImportXLSX(e,t){return this.parent_view?this.parent_view.ImportXLSX(e,t):(this.export_worker||(this.export_worker=await this.LoadWorker()),new Promise((r,i)=>{this.export_worker?(this.dialog?.ShowDialog({message:"Importing XLSX..."}),this.export_worker.onmessage=n=>{if(n.data){if(n.data.status==="error")return i(n.data.error||"unknown error");if(this.parser.decimal_mark!=="."){let o=this.parser.decimal_mark,s=this.parser.argument_separator;this.parser.Save(),this.parser.SetLocaleSettings(".");let a=c=>{let d=this.parser.Parse(c);if(d.expression)return"="+this.parser.Render(d.expression,{missing:"",convert_decimal:o,convert_argument_separator:s})};for(let c of n.data.results)c.expression=a(c.expression);for(let c of n.data.results.sheets||[]){for(let d of c.cells||[])d.type==="formula"&&d.value&&(d.value=a(d.value));if(c.annotations)for(let d of c.annotations)d.formula&&(d.formula=a(d.formula))}this.parser.Restore()}this.grid.FromImportData(n.data.results),this.ResetInternal(),this.grid.Update(),this.UpdateAC(),this.Publish({type:"load",source:t}),this.UpdateDocumentStyles(),this.InflateAnnotations(),this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1)}else return i("unknown error (missing data)");this.dialog?.HideDialog(),r()},this.export_worker.onerror=n=>{console.error("import worker error"),console.info(n),i(n)},this.export_worker.postMessage({command:"import",data:e})):i("worker failed")}))}ResetInternal(){this.calculator.Reset(),this.FlushUndo(),this.file_version=this.last_save_version=0}HandleCellEvent(e){if(e.data?.type==="hyperlink"){let t="hyperlink invalid target",r=e.data.reference||"";if(typeof r=="string"){if(/^https{0,1}:\/\//i.test(r)){if(!this.options.hyperlinks){console.warn("hyperlinks are disabled");return}let i=this.DOM.Create("a");i.setAttribute("target",this.options.hyperlinks),i.setAttribute("href",r),i.setAttribute("noreferrer","true"),i.setAttribute("nofollow","true"),i.click();return}else{let i=this.parser.Parse(r);if(i.expression){if(i.expression.type==="address"){(i.expression.sheet||i.expression.sheet_id)&&this.ActivateSheet(i.expression.sheet||i.expression.sheet_id),this.Select(r);return}else if(i.expression.type==="range"){(i.expression.start.sheet||i.expression.start.sheet_id)&&this.ActivateSheet(i.expression.start.sheet||i.expression.start.sheet_id),this.Select(r);return}}}console.warn(t,2);return}}}OnSheetChange(e){for(let t of e.activate.annotations)this.InflateAnnotation(t),this.calculator.UpdateAnnotations(t,e.activate);this.UpdateAnnotations(),this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(e.activate,!0)}HandleDrag(e){if(e.dataTransfer&&e.dataTransfer.types){if(e.dataTransfer.types.some&&e.dataTransfer.types.some(t=>t==="Files"))e.preventDefault();else for(let t=0;t<e.dataTransfer.types.length;t++)if(e.dataTransfer.types[t]==="files"){e.preventDefault();return}}}HandleDrop(e){if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length){e.preventDefault();let t=e.dataTransfer.files[0];/^image/.test(t.type)?this.InsertImageInternal(t):this.LoadFileInternal(t,"drag-and-drop").catch(()=>{})}}SelectFile2(e,t){if(!this.file_chooser){let r=this.DOM.Create("input",void 0,void 0,{attrs:{type:"file"},events:{change:()=>{if(r.files&&r.files[0]){let i=r.files[0];switch(r.value="",this.file_chooser_operation){case 2:this.InsertImageInternal(i);break;case 1:this.LoadFileInternal(i,"local-file",!0);break;default:console.warn("file chooser: no operation");break}}}}});this.file_chooser=r}if(!this.file_chooser)throw new Error("could not create file chooser");this.file_chooser_operation=t,this.file_chooser.accept=e||"",this.file_chooser.click()}async InsertImageInternal(e){if(this.options.max_file_size&&e.size>this.options.max_file_size){this.dialog?.ShowDialog({type:"error",message:"This file exceeds the allowed image size. Please try a smaller image.",title:"Error adding image",timeout:3e3,close_box:!0});return}let t=e;await new Promise((r,i)=>{let n=new FileReader;n.onload=async()=>{try{if(n.result){let o;if(typeof n.result=="string")o=n.result;else{o="";let a=new Uint8Array(n.result);for(let c=0;c<a.byteLength;c++)o+=String.fromCharCode(a[c])}let s=this.DOM.Create("img");s.src=o,await Promise.resolve(),this.grid.CreateAnnotation({type:"image",formula:"",data:{scale:"",src:o,original_size:{width:s.width||300,height:s.height||300}}},void 0,void 0,void 0,{top:30,left:30,width:s.width||300,height:s.height||300})}r()}catch(o){i(o)}},n.onabort=()=>{i("Aborted")},n.onerror=()=>{i("File error")},setTimeout(()=>{n.readAsDataURL(t)},100)})}LoadFileInternal(e,t,r=!0){if(!e)return Promise.resolve();let i=new FileReader;return new Promise((n,o)=>{let s=a=>{i.onload=null,i.onabort=null,i.onerror=null,a?(r&&(this.dialog?.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:"error",timeout:3e3}),console.error(a)),o(a)):n()};i.onload=()=>{try{if(i.result)if(/\.csv$/i.test(e.name))this.LoadCSV(i.result,t);else if(/\.xls[xm]$/i.test(e.name)){typeof i.result=="string"?s("Unsupported file"):this.ImportXLSX(i.result,t).then(()=>s()).catch(a=>s(a));return}else{let a=JSON.parse(i.result);this.LoadDocument(a,{source:t})}s()}catch(a){s(a?.toString())}},i.onabort=()=>{s("Aborted")},i.onerror=()=>{s("File error")},setTimeout(()=>{/\.xls[xm]$/i.test(e.name)?i.readAsArrayBuffer(e):i.readAsText(e)},100)})}UpdateAnnotations(){for(let e of this.grid.active_sheet.annotations){let t=e.temp;if(t.vertex&&t.vertex.state_id!==t.state){t.state=t.vertex.state_id;for(let i of e.view)i&&(i.dirty=!0)}let r=e.view[this.grid.view_index]||{};r.dirty&&(r.dirty=!1,r.update_callback&&r.update_callback(),this.grid.AnnotationUpdated(e))}this.UpdateConnectedElements()}UpdateConnectedElements(){for(let e of this.model.connected_elements.values()){let t=e.internal;if(t?.vertex&&t.vertex.state_id!==t.state){t.state=t.vertex.state_id;let r=e.update;r&&Promise.resolve().then(()=>r.call(0,e))}}}RebuildAllAnnotations(){for(let e of this.grid.active_sheet.annotations){this.InflateAnnotation(e);let t=e.view[this.grid.view_index]||{};t.resize_callback&&t.resize_callback(),t.update_callback&&t.update_callback()}}InflateAnnotations(){for(let e of this.grid.active_sheet.annotations)this.InflateAnnotation(e)}InflateAnnotation(e){if(this.grid.headless)return;let t=e.view[this.grid.view_index]||{};if(t.inflated){e.dirty&&(t.resize_callback&&t.resize_callback(),e.dirty=!1);return}if(t.inflated=!0,e.dirty&&(e.dirty=!1),t.content_node){if(e.data.type==="treb-chart"){let r=this.CreateChart();r.Initialize(t.content_node);let i=()=>{if(e.data.formula){let n=this.parser.Parse(e.data.formula);if(n&&n.expression&&n.expression.type==="call"){this.parser.Walk(n.expression,a=>((a.type==="address"||a.type==="range")&&this.model.ResolveSheetID(a,void 0,this.grid.active_sheet),!0));let o=n.expression.name.toLowerCase(),s=this.calculator.CalculateExpression(n.expression);r.Exec(o,s)}}r.Update()};t.resize_callback=()=>{this.grid.headless||(r.Resize(),r.Update())},t.update_callback=()=>{this.grid.headless||i()},t.node?.parentElement&&(this.grid.headless||i())}else if(e.data.type==="image"){if(typeof e.data.data?.src=="string"){let r=Tt(e.data.data.src);if(r){let i=this.DOM.Create("img");i.src=r,e.data.data.scale==="fixed"?(i.style.position="relative",i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)"):(i.style.width="100%",i.style.height="100%"),t.content_node.appendChild(i)}}}else if(e.data.type==="textbox"&&e.data.data){let r,i=document.createElement("div");i.classList.add("treb-annotation-textbox");for(let n of e.data.data.paragraphs){let o=document.createElement("p");n.style&&(n.style.horizontal_align==="right"||n.style.horizontal_align==="center")&&(o.style.textAlign=n.style.horizontal_align);for(let s of n.content){let a=document.createElement("span");if(r||(r=a),e.data.formula||(a.textContent=s.text||""),s.style?.bold&&(a.style.fontWeight="600"),s.style?.italic&&(a.style.fontStyle="italic"),o.appendChild(a),e.data.formula)break}if(i.append(o),e.data.formula)break}if(t.content_node.append(i),e.data.data.style){let n=e.data.data.style,o=()=>{if(n.fill){let s=V(this.grid.theme,n.fill);i.style.background=s}};t.update_callback=()=>{if(this.grid.headless||o(),r&&e.data.formula){let s=this.parser.Parse(e.data.formula);if(s&&s.expression){this.parser.Walk(s.expression,u=>((u.type==="address"||u.type==="range")&&this.model.ResolveSheetID(u,void 0,this.grid.active_sheet),!0));let a=this.calculator.CalculateExpression(s.expression),c=L.Get("General"),d;switch(s.expression.type){case"address":d=s.expression;break;case"range":d=s.expression.start;break}if(d){let h=(d.sheet_id?this.model.sheets.Find(d.sheet_id):this.grid.active_sheet)?.CellStyleData(d);h?.number_format&&(c=L.Get(h.number_format))}switch(a.type){case 3:case 2:case 7:r.textContent=c.Format(a.value);break;default:r.textContent=a.value?.toString()||""}}}},t.update_callback()}}}}DocumentChange(e){Promise.resolve().then(()=>{this.file_version++,this.file_version>=65536&&(this.file_version=1);let t=JSON.stringify(this.SerializeDocument({optimize:"size",rendered_values:!0,expand_arrays:!0}));this.options.undo&&this.PushUndo(t,e,!1),this.Publish({type:"document-change"})})}ResolveStorageKey(e,t=""){if(e){if(e===!0){let r=0,i=document.location.href;for(let o=0,s=i.length;o<s;o++)r=(r<<5)-r+i.charCodeAt(o),r|=0;let n=Math.abs(r).toString(16);return t?t+"-"+n:n}return e}}PushUndo(e,t,r=!0){let i=t||this.last_selection;this.undo_stack[this.undo_pointer-1]&&(this.undo_stack[this.undo_pointer-1].selection=i),r&&(this.file_version++,this.file_version>=65536&&(this.file_version=1)),e||(e=JSON.stringify(this.SerializeDocument({optimize:"size",rendered_values:!0,expand_arrays:!0}))),this.undo_stack[this.undo_pointer++]={data:e,selection:void 0};let n=this.undo_stack.length;if(n>16){let o=n-16;this.undo_stack=this.undo_stack.slice(o),this.undo_pointer-=o}}FlushUndo(e=!0){this.undo_stack=[],this.undo_pointer=0,this.last_save_version=this.file_version,e&&this.PushUndo(void 0,void 0,!1)}UpdateSelection(e){this.last_selection=JSON.stringify(e),this.Publish({type:"selection"})}UpdateSelectionStyleAnnotation(e){let t={style:JSON.parse(JSON.stringify(e.data.style||{}))};t.style&&(t.style.font_face||(t.style.font_face="stack:ui"),t.style.font_size||(t.style.font_size={unit:"em",value:1})),t.relative_font_size=I.RelativeFontSize(t.style||{},this.grid.theme.grid_cell||{}),this.selection_state=t}UpdateSelectionStyle(e){let t=this.grid.GetFreeze(),r={frozen:!!t.rows||!!t.columns};if(e||(e=this.grid.GetSelection()),e&&!e.empty){r.selection=e;let i=this.grid.active_sheet.CellData(e.target);r.table=!!i.table,r.merge=!!i.merge_area,r.merge&&i.merge_area&&(i.merge_area.start.row!==e.target.row||i.merge_area.start.column!==e.target.column)&&(i=this.grid.active_sheet.CellData(i.merge_area.start)),r.comment=i.note,r.style=i.style?{...i.style}:void 0,r.relative_font_size=I.RelativeFontSize(r.style||{},this.grid.theme.grid_cell||{}),r.empty=typeof i.value>"u"&&!i.style?.font_face}this.grid?.edit_state&&(this.grid.edit_state.font_face=r.style?.font_face||void 0),this.selection_state=r}UpdateDocumentStyles(){let e={},t={};for(let i of this.grid.model.sheets.list)i.NumberFormatsAndColors(t,e);this.document_styles.colors=Object.keys(t),this.document_styles.number_formats=Object.keys(e),this.document_styles.theme_colors=[];let r=[.5,.25,0,-.25,-.5];for(let i=0;i<10;i++)this.document_styles.theme_colors.push(r.map(n=>{let o={theme:i,tint:n},s=V(this.grid.theme,o);return{color:o,resolved:s}}))}ConvertLocale(e){let t=new We;t.flags={...this.parser.flags};let r,i;e.decimal_mark==="."?(t.SetLocaleSettings("."),r=",",i=";"):(t.SetLocaleSettings(","),r=".",i=",");let n=o=>{let s=t.Parse(o);if(s.expression)return"="+t.Render(s.expression,{missing:"",convert_decimal:r,convert_argument_separator:i})};if(e.macro_functions)for(let o of e.macro_functions){let s=n(o.function_def);s&&(o.function_def=s)}if(e.named)for(let o of e.named){let s=n(o.expression);s&&(o.expression=s)}if(e.sheet_data){let o=Array.isArray(e.sheet_data)?e.sheet_data:[e.sheet_data];for(let s of o){if(s.annotations){for(let a of s.annotations)if(a.formula){let c=n(a.formula);c&&(a.formula=c)}}if(s.data?.length)for(let a of s.data){let c=Lr(a)?[a]:a.cells;for(let d of c)if(d.value&&typeof d.value=="string"&&d.value[0]==="="){let u=n(d.value.slice(1));u&&(d.value=u)}}}}}CompareVersions(e="",t=""){let r=e.split(".").map(s=>Number(s)||0).concat([0,0,0]),i=t.split(".").map(s=>Number(s)||0).concat([0,0,0]),n=[0,1,2],o={match:0};for(let s=0;s<3;s++)if(r[s]!==i[s]){o.match=r[s]>i[s]?1:-1,o.level=n[s];break}return o}ImportDocumentData(e,t){this.file_version=e.revision||0;let r=[],i=this.CompareVersions(e.version,"31.9.1");if(i.match>0&&(i.level===0||i.level===1)&&console.warn(`The file you are opening was created with a newer version of TREB (${e.version} vs 31.9.1).
You may encounter compatibility errors.`),e.sheet_data&&(Array.isArray(e.sheet_data)?r=e.sheet_data:r.push(e.sheet_data)),e.shared_resources){let o=e.shared_resources,s=a=>/^resource:/.test(a)?o[a.substring(9)]||"":a;for(let a of r){a.background_image&&(a.background_image=s(a.background_image));for(let c of a.annotations||[])c.type==="image"&&c.data?.src&&(c.data.src=s(c.data.src))}}e.decimal_mark&&e.decimal_mark!==F.decimal_separator&&this.ConvertLocale(e);let n=this.grid.model;if(n.tables.clear(),e.tables)for(let o of e.tables)n.tables.set(o.name.toLowerCase(),o);this.grid.UpdateSheets(r,void 0,t||e.active_sheet);for(let o of this.model.tables.values())if(o.area.start.sheet_id){let s=n.sheets.Find(o.area.start.sheet_id);if(s)for(let a=o.area.start.row;a<=o.area.end.row;a++)for(let c=o.area.start.column;c<=o.area.end.column;c++){let d=s.cells.GetCell({row:a,column:c},!0);d.table=o}}if(n.document_name=e.name,n.user_data=e.user_data,n.named.Reset(),e.named)this.model.UnserializeNames(e.named,this.grid.active_sheet);else{let o=e.named_ranges;if(!o&&r[0]&&r[0].named_ranges&&(o=r[0].named_ranges),o)for(let[s,a]of Object.entries(o))n.named.SetNamedRange(s,new y(a.start,a.end));if(e.named_expressions)for(let s of e.named_expressions)this.model.UnserializeNames([{name:s.name,expression:s.expression}],this.grid.active_sheet)}if(n.macro_functions.clear(),e.macro_functions)for(let o of e.macro_functions)n.macro_functions.set(o.name.toUpperCase(),{...o,expression:this.parser.Parse(o.function_def||"").expression});this.UpdateAC()}async LoadWorker(){try{return await(await import("./treb-export-worker.mjs")).CreateWorker()}catch(e){throw console.error(e),e}}HandleKeyDown(e){e.key==="z"?(q.is_mac&&e.metaKey||e.ctrlKey)&&(e.stopPropagation(),e.preventDefault(),this.Undo()):e.key==="F9"&&this.options.recalculate_on_f9&&(e.stopPropagation(),e.preventDefault(),this.Recalculate())}};var eo=`@charset "UTF-8";.treb-main.treb-main .treb-mouse-mask{background:transparent;bottom:0;display:none;left:0;position:fixed;right:0;top:0;z-index:9999}.treb-main.treb-main .treb-mouse-mask.column-resize{cursor:col-resize}.treb-main.treb-main .treb-mouse-mask.row-resize{cursor:row-resize}.treb-main.treb-main .treb-mouse-mask.nub-select{cursor:crosshair}.treb-main.treb-main .treb-mouse-mask.move{cursor:move}.treb-main.treb-main .treb-mouse-mask.nw-resize{cursor:nw-resize}.treb-main.treb-main .treb-note{max-width:15em;min-width:15em}.treb-main.treb-main .treb-hover-title,.treb-main.treb-main .treb-note{background:var(--treb-note-background,#fff);border:1px solid var(--treb-note-border-color,var(--treb-ui-border-color,#ddd));border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);color:var(--treb-note-color,#333);font-family:BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif";font-size:10.5pt;left:100px;line-height:normal;opacity:0;padding:7px 10px;position:fixed;top:100px;transition:opacity .2s;white-space:pre-line;z-index:39}.treb-main.treb-main .treb-hover-title{min-width:10em;pointer-events:none}.treb-main.treb-main .treb-sort-button{background:#fff;border:1px solid #ccc;border-radius:2px;height:1em;left:100px;opacity:0;pointer-events:none;position:absolute;top:100px;transition:opacity .1s ease;width:1em;z-index:39}.treb-main.treb-main .treb-sort-button:after{box-sizing:border-box}.treb-main.treb-main .treb-sort-button.asc:after{border:.4em solid transparent;border-top-color:currentcolor;content:"";height:.8em;left:50%;opacity:.5;position:absolute;top:50%;transform:translate(-50%,-25%);width:.8em}.treb-main.treb-main .treb-sort-button.desc:after{border:.4em solid transparent;border-bottom-color:currentcolor;content:"";height:.8em;left:50%;opacity:.5;position:absolute;top:50%;transform:translate(-50%,-80%);width:.8em}.treb-main.treb-main .treb-tooltip{border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);display:none;line-height:normal;padding:2px 10px;pointer-events:none;position:fixed;z-index:39}.treb-main.treb-main .treb-tooltip.arrow-up:after{border:4px solid transparent;border-bottom-color:inherit;box-sizing:border-box;content:" ";height:8px;left:calc(50% - 4px);overflow:hidden;position:absolute;top:-8px;width:8px}.treb-main.treb-main .treb-tooltip.arrow-left:after{border:4px solid transparent;border-right-color:inherit;box-sizing:border-box;content:" ";height:8px;left:-8px;overflow:hidden;position:absolute;top:calc(50% - 4px);width:8px}.treb-main.treb-main .treb-dropdown-caret{background:var(--treb-dropdown-caret-background,#fff);border:1px solid var(--treb-dropdown-caret-border-color,#ccc);border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);display:none;height:20px;position:absolute;width:20px;z-index:39}.treb-main.treb-main .treb-dropdown-caret path{fill:none;stroke:var(--treb-dropdown-caret-color,#444);stroke-linecap:round;stroke-linejoin:round;stroke-width:2}.treb-main.treb-main .treb-dropdown-list{background:var(--treb-dropdown-background,#fff);border:1px solid var(--treb-dropdown-border-color,unset);box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);color:var(--treb-dropdown-color,inherit);display:none;font-size:10pt;max-height:10em;outline:none;overflow-y:auto;position:absolute;text-align:left;z-index:39}.treb-main.treb-main .treb-dropdown-list div{cursor:default;padding:2px}.treb-main.treb-main .treb-dropdown-list div.selected{background:var(--treb-dropdown-selected-background,#555);color:var(--treb-dropdown-selected-color,#fff)}.treb-main.treb-main .treb-dropdown-caret.active{background:var(--treb-dropdown-caret-active-background,#eee)}.treb-main.treb-main .treb-dropdown-caret.active+.treb-dropdown-list{display:block}.treb-main.treb-main .treb-error-highlight{background:rgba(255,0,0,.25);opacity:0;pointer-events:none;position:absolute;transition:opacity .15s ease-in-out;z-index:40}.treb-main.treb-main .treb-autocomplete{box-sizing:border-box;font-size:inherit;font-weight:400;line-height:normal;max-height:10em;overflow-y:auto;position:fixed;text-align:left;top:-1000px;z-index:39}.treb-main.treb-main .treb-autocomplete *{box-sizing:border-box}.treb-main.treb-main .treb-autocomplete ul{list-style-type:none}.treb-main.treb-main .treb-autocomplete ul,.treb-main.treb-main .treb-autocomplete ul li{font-size:inherit;font-weight:inherit;margin:0;padding:0}.treb-main.treb-main .treb-autocomplete ul li a{color:inherit;cursor:default;display:inline-block;font-size:inherit;font-weight:inherit;padding:3px 6px;text-decoration:none;width:100%}.treb-main.treb-main .treb-autocomplete-tooltip{position:fixed;top:-1000px;white-space:pre;z-index:39}.treb-main.treb-main .treb-formula-bar{display:flex;flex-direction:row;gap:.5em;grid-area:1/1/2/2;max-width:100%;overflow-x:hidden;padding:0 2px 12px;text-align:left}.treb-main.treb-main .treb-formula-bar[hidden]{display:none}.treb-main.treb-main .treb-formula-bar .treb-address-label{border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;display:flex;flex-direction:column;height:1.75em;justify-content:center;min-height:1.5em;min-width:95px;padding-left:3px;width:95px}.treb-main.treb-main .treb-formula-bar .treb-address-label>div{outline:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.treb-main.treb-main .treb-formula-bar .treb-insert-function-button{background:transparent;border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;height:1.75em;min-height:1.5em}.treb-main.treb-main .treb-formula-bar .treb-insert-function-button[hidden]{display:none}.treb-main.treb-main .treb-formula-bar .expand-button{background:transparent;border:0;border-radius:2px;height:1.75em;margin-left:2px;outline:none;padding:1px}.treb-main.treb-main .treb-formula-bar .expand-button:after{border:5px solid transparent;border-top-color:#999;content:" ";display:inline-block;margin:0;padding:0;position:relative;top:-6px;transition:transform .15s ease}.treb-main.treb-main .treb-formula-bar[expanded] .expand-button:after{transform:rotate(180deg) translateY(6px)}.treb-main.treb-main .treb-formula-bar .treb-editor-container{border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;display:flex;flex-direction:column;flex-grow:1;height:1.75em;justify-content:center;min-width:0}.treb-main.treb-main .treb-formula-bar .treb-editor-container>.treb-editor-shadow{opacity:.4}.treb-main.treb-main .treb-formula-bar[expanded] .treb-editor-container{height:4.5em;transition:height .1s ease-in-out}.treb-main.treb-main .treb-formula-bar[expanded] .treb-editor-container>div{overflow-y:auto}.treb-main.treb-main .treb-formula-bar .treb-editor-container>div{flex-grow:1;line-height:1.35;margin:2px;min-height:1em;outline:none;overflow-x:hidden;overflow-y:hidden;white-space:pre-wrap;width:100%}.treb-main.treb-main .treb-mouse-mask .ghost-tab{position:fixed}.treb-main.treb-main .treb-spreadsheet-footer{align-items:center;grid-area:3/1/4/2}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tab-container{align-self:flex-start;height:2.2em;overflow:hidden}.treb-main.treb-main .treb-spreadsheet-footer,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs{color:var(--treb-ui-color,inherit);display:flex;flex-direction:row;height:2.2em;list-style-type:none;max-width:100%;padding-inline-start:0;z-index:2}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs{height:auto;margin-block-start:0;margin:0;overflow-x:scroll;overflow-y:hidden}.treb-main.treb-main .treb-spreadsheet-footer[hidden]{display:none}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{display:inline-block;position:relative}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{align-items:center;border-bottom-left-radius:5px;border-bottom-right-radius:5px;border-top-width:1px;border:1px solid var(--treb-tab-bar-tab-border-color,var(--treb-ui-border-color,#ccc));border-top:0 solid var(--treb-tab-bar-tab-border-color,var(--treb-ui-border-color,#ccc));color:var(--treb-tab-bar-tab-color,var(--treb-ui-color,#fff));cursor:default;display:inline-flex;font-size:inherit;height:100%;justify-content:center;margin-right:-2px;overflow:hidden;padding:0 .75em;z-index:1}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:focus{z-index:3}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{height:2.2em;overflow:visible;overflow-x:visible}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:last-of-type{margin-right:0}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab{margin-left:-1px}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{white-space:nowrap}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li[selected]{z-index:2}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control{align-items:center;display:flex;flex-direction:row;font-size:inherit;height:2.2em;justify-content:center;position:relative;width:5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input{background:transparent;border:1px solid transparent;border-radius:2px;color:inherit;font-family:inherit;font-size:inherit;padding:initial;text-align:center;transition:border-color .25s ease,background-color .25s ease;width:4em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container{accent-color:var(--treb-scale-slider-accent-color,undefined);align-items:center;background:var(--treb-scale-slider-background,#fff);border:1px solid var(--treb-scale-slider-border-color,var(--treb-ui-border-color,#ccc));display:flex;flex-direction:row;height:4em;justify-content:center;left:.5em;opacity:0;pointer-events:none;position:absolute;top:0;transform:rotate(-90deg);transform-origin:left top;transition:opacity .25s ease;width:10em;z-index:40}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control:hover .treb-scale-input{border-color:var(--treb-ui-border-color,#ccc)}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container>input[type=range]{width:8.5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input:focus+.treb-slider-container,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container:focus-within,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control:hover .treb-slider-container{opacity:.85;pointer-events:auto}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab{align-items:center;background:transparent;border:none;border-bottom-left-radius:5px;border-bottom-right-radius:5px;border-top:0;color:currentColor;cursor:default;display:inline-flex;flex-direction:row;font-size:inherit;margin-right:-2px;min-width:2.5em;padding:.25em .75em;z-index:1}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab svg{height:1em;opacity:.75;pointer-events:none;transition:opacity .125s ease-in-out;width:1em}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:hover svg{opacity:.75}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab path{stroke:currentColor;stroke-width:1.5px;stroke-linecap:round}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:focus{z-index:3}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel{flex:1 1;overflow:hidden;text-align:end;text-overflow:ellipsis;white-space:nowrap}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel>*{margin-left:.5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel .treb-stats-value{background:var(--treb-stats-value-background,#f8f8ff);border:1px solid var(--treb-stats-value-border-color,var(--treb-ui-border-color,#ddd));border-radius:3px;padding:0 .3em}.treb-main.treb-main .treb-grid .treb-overlay-container{margin:0;opacity:0;outline:none;padding:0;position:absolute;z-index:24}.treb-main.treb-main .treb-grid .treb-overlay-container.align-right .treb-overlay-inset{padding-right:3px;right:0;text-align:right}.treb-main.treb-main .treb-grid .treb-overlay-container.align-center .treb-overlay-inset{left:50%;text-align:center;transform:translateX(-50%)}.treb-main.treb-main .treb-grid .treb-overlay-inset{display:flex;flex-direction:column;height:100%;justify-content:flex-end;margin:0;min-width:100%;padding:0 4px;position:absolute}.treb-main.treb-main .treb-grid .treb-overlay-editor{outline:none;position:relative;white-space:nowrap;white-space:pre}.treb-main.treb-main .treb-grid .treb-overlay-editor.firefox:before{content:"\u200B"}.treb-main.treb-main .treb-spill-border{pointer-events:none;position:absolute}.treb-main.treb-main .treb-spill-border rect{stroke:var(--treb-spill-border-color,#5c5ce0);stroke-dasharray:var(--treb-spill-border-dasharray,0);fill:none;stroke-width:var(--treb-spill-border-width,1px);filter:var(--treb-spill-border-filter,drop-shadow(3px 3px 2px rgba(0,0,0,.5)));z-index:35}.treb-main.treb-main .treb-buffer-canvas{display:none;position:absolute}.treb-main.treb-main .treb-spreadsheet-body{grid-area:2/1/3/2;-webkit-overflow-scrolling:touch;-webkit-tap-highlight-color:transparent;display:flex;overflow:hidden;position:relative;z-index:1}.treb-main.treb-main .treb-grid{flex-grow:1;order:2;overflow:scroll;position:relative;-webkit-overflow-scrolling:touch;-webkit-tap-highlight-color:transparent;display:grid;grid-template-columns:100px auto;grid-template-rows:20px auto;outline:none;overscroll-behavior:none}.treb-main.treb-main .treb-grid .tile-cover.grid-cover{grid-area:2/2/3/3}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover{grid-area:1/2/2/3;position:-webkit-sticky;position:sticky;top:0}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover{grid-area:2/1/3/2;left:0;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-grid-selection{grid-area:1/1/2/2}.treb-main.treb-main .treb-grid .treb-corner{grid-area:1/1/2/2;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-left-header{display:grid;grid-area:2/1/3/2;grid-template-columns:auto;grid-template-rows:auto;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-top-header{display:grid;grid-area:1/2/2/3;grid-template-columns:auto;grid-template-rows:auto;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-contents{display:grid;grid-area:2/2/3/3;grid-template-columns:auto;grid-template-rows:auto}.treb-main.treb-main .treb-grid.safari::-webkit-scrollbar{-webkit-appearance:none;height:7px;width:7px}.treb-main.treb-main .treb-grid.safari::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.25);border-radius:4px;-webkit-box-shadow:0 0 1px hsla(0,0%,100%,.5)}.treb-main.treb-main .treb-grid canvas{background:transparent;border:0;margin:0;padding:0}.treb-main.treb-main .treb-grid .nub-select{cursor:crosshair}.treb-main.treb-main .treb-grid .link-pointer{cursor:pointer}.treb-main.treb-main .treb-grid .mock-selection-node{background:red;left:-100px;position:fixed;top:-100px}.treb-main.treb-main .treb-grid .tile-cover{background:transparent;position:relative;z-index:14}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover{z-index:22}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover.resize{cursor:col-resize}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover{z-index:22}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover.resize{cursor:row-resize}.treb-main.treb-main .treb-grid .frozen-annotation-container,.treb-main.treb-main .treb-grid .treb-annotation-container{left:0;pointer-events:none;position:absolute;top:0;z-index:16}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation{background:hsla(0,0%,100%,.5);border:1px solid #999;overflow:hidden;pointer-events:auto;position:absolute;z-index:1}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-content,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-content{font-family:inherit;font-size:inherit;height:100%;left:0;position:absolute;top:0;width:100%;z-index:1}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-move-target,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-move-target{cursor:move;height:10%;left:0;min-height:14px;position:absolute;top:0;width:100%;z-index:2}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-resize-target,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-resize-target{bottom:0;cursor:nwse-resize;height:10%;min-height:14px;min-width:14px;position:absolute;right:0;width:10%;z-index:3}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation.clone-focus,.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation.retain-focus,.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation:focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation.clone-focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation.retain-focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation:focus{box-shadow:0 0 0 3px rgba(14,165,233,.33)}.treb-main.treb-main .treb-grid .frozen-annotation-container .move-buffer,.treb-main.treb-main .treb-grid .treb-annotation-container .move-buffer{border:1px solid red;cursor:move;height:10%;left:0;position:absolute;top:0;width:100%}.treb-main.treb-main .treb-grid .treb-grid-selection{background:transparent;position:absolute;-moz-transform:scale(1);z-index:10}.treb-main.treb-main .treb-grid .frozen-selection{overflow:hidden;pointer-events:none;position:absolute;-moz-transform:scale(1);transition:background .33s;z-index:12}.treb-main.treb-main .treb-grid .frozen-selection.frozen-selection-rows{border-bottom:1px solid transparent}.treb-main.treb-main .treb-grid .frozen-selection.frozen-selection-columns{border-right:1px solid transparent}.treb-main.treb-main .treb-grid .frozen-annotation-container{height:100%;left:0;overflow:hidden;position:absolute;top:0;width:100%}.treb-main.treb-main .treb-grid .treb-corner{left:0;top:0;z-index:20}.treb-main.treb-main .treb-grid .treb-corner canvas{left:0;pointer-events:none;position:absolute;top:0}.treb-main.treb-main .treb-grid .treb-left-header{left:0;pointer-events:none;z-index:18}.treb-main.treb-main .treb-grid .treb-top-header{pointer-events:none;top:0;z-index:18}.treb-main.treb-main .treb-grid .treb-contents{height:2000px;width:2000px}.treb-main.treb-main{--alternate-selection-color-1:#fbb13c;--alternate-selection-color-2:#40c040;--alternate-selection-color-3:#b66d0d;--alternate-selection-color-4:#2176ae;--alternate-selection-color-5:#fe6847;--text-reference-color-1:#e08a00;--text-reference-color-2:#3aad3a;--text-reference-color-3:#b66d0d;--text-reference-color-4:#2176ae;--text-reference-color-5:#fe2f01}.treb-main.treb-main:focus-within .treb-grid-selection .primary-selection,.treb-main.treb-main:focus-within .treb-header-overlay{color:var(--treb-selection-color,#4caaf1)}.treb-main.treb-main .theme-color-1{color:var(--treb-theme-color-1,#e7e6e6)}.treb-main.treb-main .theme-color-2{color:var(--treb-theme-color-2,#44546a)}.treb-main.treb-main .theme-color-3{color:var(--treb-theme-color-3,#4472c4)}.treb-main.treb-main .theme-color-4{color:var(--treb-theme-color-4,#ed7d31)}.treb-main.treb-main .theme-color-5{color:var(--treb-theme-color-5,#a5a5a5)}.treb-main.treb-main .theme-color-6{color:var(--treb-theme-color-6,#ffc000)}.treb-main.treb-main .theme-color-7{color:var(--treb-theme-color-7,#5b9bd5)}.treb-main.treb-main .theme-color-8{color:var(--treb-theme-color-8,#70ad47)}.treb-main.treb-main .theme-color-9{color:var(--treb-theme-color-9,#0563c1)}.treb-main.treb-main .theme-color-10{color:var(--treb-theme-color-10,#954f72)}.treb-main.treb-main .treb-offset-dark{color:#000}.treb-main.treb-main .treb-offset-light{color:#fff}.treb-main.treb-main .note-marker{background:var(--treb-note-marker-color,#6fab20)}.treb-main.treb-main .grid-headers{background:var(--treb-grid-header-background,#eeeef2);color:var(--treb-grid-header-color,var(--treb-grid-default-color,#666));font-family:var(--treb-grid-header-font-family,inherit);font-size:var(--treb-grid-header-font-size,10pt);font-style:var(--treb-grid-header-font-style,normal);font-weight:var(--treb-grid-header-font-weight,normal);stroke:var(--treb-grid-header-grid-color,var(--treb-grid-grid-color,#ccccd4))}.treb-main.treb-main .grid-cells{color:var(--treb-grid-default-color,inherit);font-family:var(--treb-grid-font-family,inherit);font-size:var(--treb-grid-font-size,14px);stroke:var(--treb-grid-grid-color,#ccccd4);background:var(--treb-grid-background,#fff)}.treb-main.treb-main .frozen-selection.highlight-area{background:rgba(87,184,255,.25);border-bottom-color:#2176ae;border-left-color:#2176ae}.treb-main.treb-main .treb-autocomplete-tooltip{background:var(--treb-autocomplete-tooltip-background,#fffbb5);border:1px solid var(--treb-autocomplete-tooltip-border-color,unset);border-radius:2px;color:var(--treb-autocomplete-tooltip-color,inherit);font-size:14px;line-height:normal;margin:4px 0;padding:3px 8px}.treb-main.treb-main .treb-autocomplete-tooltip .active-argument{font-weight:700}.treb-main.treb-main .treb-autocomplete-tooltip .function-description{font-style:italic}.treb-main.treb-main .treb-autocomplete{background:var(--treb-autocomplete-background,#fff);border:1px solid var(--treb-autocomplete-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);font-size:14px}.treb-main.treb-main .treb-autocomplete li{color:var(--treb-autocomplete-entry-color,#333)}.treb-main.treb-main .treb-autocomplete li a.selected{background:var(--treb-autocomplete-selected-entry-background,#2e8dd6);color:var(--treb-autocomplete-selected-entry-color,#fff)}.treb-main.treb-main .treb-header-overlay{stroke:none;color:var(--treb-selection-color-unfocused,var(--treb-selection-color,#4caaf1))}.treb-main.treb-main .treb-header-overlay .treb-overlay{fill:#000;stroke:none;opacity:.05}.treb-main.treb-main .treb-header-overlay .treb-highlight{fill:currentColor}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="1"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="1"]{color:var(--text-reference-color-1)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="2"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="2"]{color:var(--text-reference-color-2)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="3"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="3"]{color:var(--text-reference-color-3)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="4"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="4"]{color:var(--text-reference-color-4)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="5"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="5"]{color:var(--text-reference-color-5)}.treb-main.treb-main .treb-editor-container>div span.highlight-1,.treb-main.treb-main .treb-overlay-editor span.highlight-1{color:var(--text-reference-color-1)}.treb-main.treb-main .treb-editor-container>div span.highlight-2,.treb-main.treb-main .treb-overlay-editor span.highlight-2{color:var(--text-reference-color-2)}.treb-main.treb-main .treb-editor-container>div span.highlight-3,.treb-main.treb-main .treb-overlay-editor span.highlight-3{color:var(--text-reference-color-3)}.treb-main.treb-main .treb-editor-container>div span.highlight-4,.treb-main.treb-main .treb-overlay-editor span.highlight-4{color:var(--text-reference-color-4)}.treb-main.treb-main .treb-editor-container>div span.highlight-5,.treb-main.treb-main .treb-overlay-editor span.highlight-5{color:var(--text-reference-color-5)}.treb-main.treb-main .frozen-selection .selection,.treb-main.treb-main .treb-grid-selection .selection{stroke-width:var(--treb-selection-stroke-width,2px)}.treb-main.treb-main .frozen-selection .selection .treb-selection-outline,.treb-main.treb-main .treb-grid-selection .selection .treb-selection-outline{stroke:currentColor;fill:none}.treb-main.treb-main .frozen-selection .selection .treb-selection-fill,.treb-main.treb-main .treb-grid-selection .selection .treb-selection-fill{stroke:none;fill:currentColor;opacity:var(--treb-selection-fill-opacity,.1)}.treb-main.treb-main .frozen-selection .alternate-selection,.treb-main.treb-main .treb-grid-selection .alternate-selection{stroke-dasharray:var(--treb-alternate-selection-dasharray,3 2)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(1n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(1n){color:var(--alternate-selection-color-1)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(2n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(2n){color:var(--alternate-selection-color-2)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(3n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(3n){color:var(--alternate-selection-color-3)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(4n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(4n){color:var(--alternate-selection-color-4)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(5n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(5n){color:var(--alternate-selection-color-5)}.treb-main.treb-main .frozen-selection .primary-selection,.treb-main.treb-main .treb-grid-selection .primary-selection{color:var(--treb-selection-color-unfocused,var(--treb-selection-color,#4caaf1))}.treb-main.treb-main .frozen-selection .primary-selection .treb-selection-nub,.treb-main.treb-main .treb-grid-selection .primary-selection .treb-selection-nub{stroke:#fff;fill:currentColor;stroke-width:1px}.treb-main.treb-main .treb-tooltip{background:var(--treb-resize-tooltip-background,rgba(0,0,0,.8));border-color:var(--treb-resize-tooltip-background,rgba(0,0,0,.8));color:var(--treb-resize-tooltip-color,#fff);font-size:11pt}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{background:var(--treb-tab-bar-tab-background,#eeeef2);color:var(--treb-tab-bar-tab-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab[selected],.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li[selected]{background:var(--treb-tab-bar-active-tab-background,#fff);border-bottom-color:var(--treb-tab-bar-active-tab-border-color,currentColor);color:var(--treb-tab-bar-active-tab-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-formula-bar .treb-address-label,.treb-main.treb-main .treb-formula-bar .treb-editor-container{background:var(--treb-formula-bar-background,transparent);color:var(--treb-formula-bar-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-formula-bar .treb-address-label[locked],.treb-main.treb-main .treb-formula-bar .treb-editor-container[locked]{background:var(--treb-formula-bar-locked-background,#eef4fc);position:relative}.treb-main.treb-main .treb-formula-bar .treb-address-label[locked]:after,.treb-main.treb-main .treb-formula-bar .treb-editor-container[locked]:after{content:"";height:12px;opacity:.4;position:absolute;right:2px;top:2px;width:12px;--icon:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='currentColor' d='M416 224h-16v-80C400 65 335 0 256 0S112 65 112 144v80H96c-35 0-64 29-64 64v160c0 35 29 64 64 64h320c35 0 64-29 64-64V288c0-35-29-64-64-64m-240-80c0-44 36-80 80-80s80 36 80 80v80H176z'/%3E%3C/svg%3E");background:var(--treb-formula-bar-lock-icon-color,currentColor);mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:12px 12px;-webkit-mask-size:12px 12px}.treb-main.treb-main .treb-annotation-textbox{background:Canvas;height:100%;left:0;overflow:hidden;padding:.5em;position:relative;top:0;width:100%}.treb-main.treb-main .treb-annotation-textbox p{margin-block-end:0;margin-block-start:0}.treb-dark-theme{--treb-autocomplete-background:#333;--treb-autocomplete-border-color:#fff;--treb-autocomplete-entry-color:#fff;--treb-autocomplete-selected-entry-background:darkred;--treb-autocomplete-tooltip-background:darkred;--treb-autocomplete-tooltip-border-color:#fff;--treb-autocomplete-tooltip-color:#fff;--treb-chart-background:#000;--treb-chart-grid-color:#976;--treb-chart-grid-zero-color:#fdd;--treb-chart-text-color:#fff;--treb-dialog-background:#000;--treb-dialog-color:#fff;--treb-dropdown-background:#000;--treb-dropdown-border-color:#fff;--treb-dropdown-caret-active-background:darkred;--treb-dropdown-caret-background:#444;--treb-dropdown-caret-border-color:#fff;--treb-dropdown-caret-color:#fff;--treb-dropdown-color:#fff;--treb-dropdown-selected-background:darkred;--treb-grid-background:#000;--treb-grid-default-color:#fff;--treb-grid-grid-color:#444;--treb-grid-header-background:#444;--treb-grid-header-grid-color:#000;--treb-note-background:#333;--treb-note-border-color:#aaa;--treb-note-color:#fff;--treb-note-marker-color:pink;--treb-resize-tooltip-background:#fff;--treb-resize-tooltip-color:#000;--treb-scale-slider-accent-color:#fff;--treb-scale-slider-background:#333;--treb-scale-slider-border-color:#aaa;--treb-selection-color:#ff0;--treb-selection-fill-opacity:.2;--treb-sidebar-button-background:#000;--treb-sidebar-button-border-color:#888;--treb-stats-value-background:#223;--treb-tab-bar-tab-background:#000;--treb-tab-bar-tab-color:#fff;--treb-theme-color-1:#222;--treb-theme-color-2:#ddd;--treb-toolbar-active-button-background:#555;--treb-toolbar-button-background:#000;--treb-toolbar-hover-button-background:#444;--treb-ui-color:#fff;--treb-table-header-background:#334;--treb-table-odd-background:#122;--treb-table-header-font-weight:700;--treb-table-header-border-top:#889;--treb-table-header-border-bottom:#889;--treb-table-footer-border-bottom:#889;--treb-table-odd-border-top:#889;--treb-table-odd-border-bottom:#889;--treb-table-even-border-top:#889;--treb-table-even-border-bottom:#889;--treb-table-total-border-top:#889;--treb-table-total-border-bottom:#889;--treb-table-total-background:#334;--treb-table-total-font-weight:700;--treb-color-scheme:dark;--treb-resize-handle-color:#add8e6;--treb-resize-frame-color:#add8e6;--treb-formula-bar-locked-background:#234;--treb-grid-background:#1e1e1e;--treb-grid-header-background:#565656;--treb-grid-header-color:#ddd;--treb-tab-bar-active-tab-background:#444;--treb-tab-bar-tab-background:transparent;--treb-tab-bar-tab-border-color:#444;--treb-ui-border-color:#aaa;--treb-toolbar-button-background:#565656;--treb-toolbar-button-background:#212121;--treb-toolbar-border-color:#434343;--treb-toolbar-color:#ddd;--treb-spill-border-color:pink;--treb-spill-border-filter:drop-shadow(3px 3px 2px hsla(0,0%,100%,.95))}@media (prefers-color-scheme:dark){.treb-light-dark-theme{--treb-autocomplete-background:#333;--treb-autocomplete-border-color:#fff;--treb-autocomplete-entry-color:#fff;--treb-autocomplete-selected-entry-background:darkred;--treb-autocomplete-tooltip-background:darkred;--treb-autocomplete-tooltip-border-color:#fff;--treb-autocomplete-tooltip-color:#fff;--treb-chart-background:#000;--treb-chart-grid-color:#976;--treb-chart-grid-zero-color:#fdd;--treb-chart-text-color:#fff;--treb-dialog-background:#000;--treb-dialog-color:#fff;--treb-dropdown-background:#000;--treb-dropdown-border-color:#fff;--treb-dropdown-caret-active-background:darkred;--treb-dropdown-caret-background:#444;--treb-dropdown-caret-border-color:#fff;--treb-dropdown-caret-color:#fff;--treb-dropdown-color:#fff;--treb-dropdown-selected-background:darkred;--treb-grid-background:#000;--treb-grid-default-color:#fff;--treb-grid-grid-color:#444;--treb-grid-header-background:#444;--treb-grid-header-grid-color:#000;--treb-note-background:#333;--treb-note-border-color:#aaa;--treb-note-color:#fff;--treb-note-marker-color:pink;--treb-resize-tooltip-background:#fff;--treb-resize-tooltip-color:#000;--treb-scale-slider-accent-color:#fff;--treb-scale-slider-background:#333;--treb-scale-slider-border-color:#aaa;--treb-selection-color:#ff0;--treb-selection-fill-opacity:.2;--treb-sidebar-button-background:#000;--treb-sidebar-button-border-color:#888;--treb-stats-value-background:#223;--treb-tab-bar-tab-background:#000;--treb-tab-bar-tab-color:#fff;--treb-theme-color-1:#222;--treb-theme-color-2:#ddd;--treb-toolbar-active-button-background:#555;--treb-toolbar-button-background:#000;--treb-toolbar-hover-button-background:#444;--treb-ui-color:#fff;--treb-table-header-background:#334;--treb-table-odd-background:#122;--treb-table-header-font-weight:700;--treb-table-header-border-top:#889;--treb-table-header-border-bottom:#889;--treb-table-footer-border-bottom:#889;--treb-table-odd-border-top:#889;--treb-table-odd-border-bottom:#889;--treb-table-even-border-top:#889;--treb-table-even-border-bottom:#889;--treb-table-total-border-top:#889;--treb-table-total-border-bottom:#889;--treb-table-total-background:#334;--treb-table-total-font-weight:700;--treb-color-scheme:dark;--treb-resize-handle-color:#add8e6;--treb-resize-frame-color:#add8e6;--treb-formula-bar-locked-background:#234;--treb-grid-background:#1e1e1e;--treb-grid-header-background:#565656;--treb-grid-header-color:#ddd;--treb-tab-bar-active-tab-background:#444;--treb-tab-bar-tab-background:transparent;--treb-tab-bar-tab-border-color:#444;--treb-ui-border-color:#aaa;--treb-toolbar-button-background:#565656;--treb-toolbar-button-background:#212121;--treb-toolbar-border-color:#434343;--treb-toolbar-color:#ddd;--treb-spill-border-color:pink;--treb-spill-border-filter:drop-shadow(3px 3px 2px hsla(0,0%,100%,.95))}}.treb-chart,.treb-main.treb-main .treb-chart{background:var(--treb-chart-background,#fff)}.treb-main.treb-main .treb-inherit-font .treb-chart{font-family:inherit}.treb-chart{--segment-2-offset:-20;--segment-3-offset:10;--segment-4-offset:-10;--segment-5-offset:20;--segment-6-offset:-25}.treb-chart .series-1{color:var(--treb-applied-theme-color-1)}.treb-chart .series-2{color:var(--treb-applied-theme-color-2)}.treb-chart .series-3{color:var(--treb-applied-theme-color-3)}.treb-chart .series-4{color:var(--treb-applied-theme-color-4)}.treb-chart .series-5{color:var(--treb-applied-theme-color-5)}.treb-chart .series-6{color:var(--treb-applied-theme-color-6)}.treb-chart .series-7{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-8{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-9{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-10{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-11{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-12{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-13{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-14{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-15{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-16{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-17{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-18{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-19{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-20{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-21{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-22{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-23{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-24{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-25{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-26{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-27{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-28{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-29{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-30{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-31{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-32{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-33{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-34{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-35{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-36{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-6-offset)) c h)}.treb-chart .chart-title{font-size:1.4em}.treb-chart .axis-group{font-size:.9em}.treb-chart .axis-group .series-name{font-size:1.3em}.treb-chart text{fill:var(--treb-chart-text-color,#000);stroke:none}.treb-chart .legend{font-size:1.05em}.treb-chart .legend rect{fill:currentColor}.treb-chart .legend circle{fill:currentColor;fill-opacity:.5;stroke:currentColor;stroke-width:2px;r:.25em}.treb-chart .chart-grid,.treb-chart .chart-ticks{stroke:var(--treb-chart-grid-color,#ddd)}.treb-chart .chart-grid.zero,.treb-chart .chart-ticks.zero{stroke:var(--treb-chart-grid-zero-color,var(--treb-chart-grid-color,#999))}.treb-chart .label-target{stroke:none;fill:transparent}.treb-chart path.label-target{transition:fill .2s}.treb-chart path.label-target:hover{fill:rgba(0,0,0,.15)}.treb-chart .data-label{opacity:0;pointer-events:none;transition:opacity .2s ease-in-out}.treb-chart .data-label text{fill:#fff}.treb-chart .data-label path{fill:#000}.treb-chart .data-label .marker-highlight{fill:currentColor;stroke:none}.treb-chart .label-target:hover+.data-label{opacity:1}.treb-chart .chart-line{stroke:currentColor;fill:none;stroke-width:2}.treb-chart .chart-area .line{stroke:currentColor;stroke-width:2px;fill:none}.treb-chart .chart-area .fill{fill:currentColor;opacity:.5}.treb-chart .box-plot .iqr{fill:none;stroke:CanvasText;stroke-width:1px}.treb-chart .box-plot .median{stroke-width:3px;stroke:CanvasText;fill:none}.treb-chart .box-plot .outlier{r:3}.treb-chart .box-plot .outlier,.treb-chart .box-plot .whisker,.treb-chart .box-plot .whisker-extent{stroke-width:1px;stroke:CanvasText;fill:none}.treb-chart .box-plot .whisker-extent{stroke-dasharray:3 3}.treb-chart .bubble-chart{stroke-width:3;fill:color-mix(in srgb,currentColor 75%,transparent);stroke:currentColor}.treb-chart .bubble-label .label-background{stroke:none;fill:none}.treb-chart .bubble-label .label-text{transform:translate(var(--translate-offset),var(--translate-offset))}.treb-chart .scatter-plot{stroke-width:3;fill:none;stroke:currentColor}.treb-chart .scatter-plot .fill{fill:currentColor;opacity:.5;stroke:none}.treb-chart .scatter-plot .marker{stroke-width:2.5px;fill:#fff;transition:stroke-width .15s ease-in}.treb-chart .scatter-plot .marker:hover{stroke-width:5px}.treb-chart .donut path{fill:currentColor}.treb-chart .donut path.callout{fill:none;stroke:#999;stroke-dasharray:2 2}.treb-chart .donut text.callout-label{font-size:1em}.treb-chart .chart-column{fill:currentColor;stroke:none}.treb-chart .mc-correlation{stroke:currentColor;stroke-width:1}.treb-main.treb-main{--treb-icon-svg:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='153.073' height='133.742' viewBox='0.673 4.629 153.073 133.742'%3E%3ClinearGradient id='a' x1='.673' x2='153.746' y1='71.5' y2='71.5' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' style='stop-color:%235cb5ff'/%3E%3Cstop offset='1' style='stop-color:%230059b9'/%3E%3C/linearGradient%3E%3Cpath fill='url(%23a)' d='M91.656 28.313c-4.989 0-17.266 6.249-21.305 8.504-2.344-2.473-2.603-6.162-3.036-10.933-2.344 2.429-.824 9.806 0 12.496-10.238 7.635-18.83 15.531-27.597 24.471-2.992-4.729-5.031-8.593-5.726-17.183-3.038 6.509.867 15.057 3.121 19.784-9.674 12.193-19.263 25.297-27.03 37.834-35.488-74.973 72.853-119.534 143.663-88.855-43.867 29.199-55.192 121.353-132.248 96.843-5.423 7.809-9.069 18.006-13.538 27.072-3.73.263-6.334-1.646-7.288-3.12 7.506-18.181 17.183-34.192 27.075-49.984 10.718.306 21.346.478 30.198-1.04-7.681-2.038-16.877-.78-26.032-3.123C37.51 70.361 45.667 62.203 53.78 54.004c8.808.782 17.746 3.21 27.074 1.041-8.111-1.431-15.966-1.952-22.909-4.165 7.594-8.378 22.777-17.491 33.711-22.567'/%3E%3C/svg%3E")}.treb-main.treb-main .treb-icon-64{background:no-repeat 50%/100% var(--treb-icon-svg);height:64px;width:64px}.treb-main.treb-main .treb-dialog-mask{align-items:center;display:flex;height:100%;justify-content:center;left:0;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .2s;width:100%;z-index:1000}.treb-main.treb-main .treb-embed-dialog{align-items:center;background:var(--treb-dialog-background,#fff);border:1px solid var(--treb-dialog-border-color,var(--treb-ui-border-color,#999));border-radius:3px;border-top:3px solid #999;box-shadow:0 4px 6px -4px rgba(0,0,0,.3);color:var(--treb-dialog-color,#000);display:flex;flex-direction:row;font-size:var(--treb-dialog-font-size,16px);line-height:1.6em;padding:1rem;position:relative;text-align:left}.treb-main.treb-main .treb-embed-dialog>*{display:none}.treb-main.treb-main .treb-embed-dialog>div{position:relative}.treb-main.treb-main .treb-embed-dialog>:nth-child(2){display:block;flex-grow:1;padding:2px 20px 2px 12px}.treb-main.treb-main .treb-embed-dialog>.treb-close-box{background:transparent;border:0;padding:4px;position:absolute;right:0;top:0}.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg{fill:#73828c;cursor:default;height:20px;width:20px}.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg:active,.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg:hover{fill:#049cfb}.treb-main.treb-main .treb-embed-dialog small{display:block;font-size:.9em}.treb-main.treb-main .treb-embed-dialog a{color:inherit;text-decoration:none}.treb-main.treb-main .treb-embed-dialog a:active,.treb-main.treb-main .treb-embed-dialog a:hover{color:#049cfb}.treb-main.treb-main .treb-embed-dialog.dialog-type-success{border-top-color:#44d926;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-about{border-top-color:#009dff;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-error{border-top-color:#f92f06;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-info{border-top-color:#009dff;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog .treb-embed-dialog-message,.treb-main.treb-main .treb-embed-dialog .treb-embed-dialog-title{white-space:pre}.treb-main.treb-main .treb-embed-dialog .treb-embed-progress-container{border:1px solid #ddd;height:6px;margin:1rem auto .5rem;position:relative;width:100%}.treb-main.treb-main .treb-embed-dialog .treb-embed-progress-bar{background:#52880b;height:100%;left:0;position:relative;top:0}.treb-main.treb-main .treb-spinner{align-items:center;background:transparent;display:flex;height:100%;justify-content:center;left:0;opacity:0;position:absolute;top:0;transition:visibility .25s,opacity .25s ease;visibility:collapse;width:100%;z-index:1000}.treb-main.treb-main .treb-spinner.visible{opacity:1;transition:visibility 0s,opacity 1s ease;visibility:visible}.treb-main.treb-main .treb-spinner>div{display:inline-block;height:80px;position:relative;width:80px}.treb-main.treb-main .treb-spinner>div div{animation:treb-spinner 1.2s cubic-bezier(.5,0,.5,1) infinite;border:8px solid #fff;border-color:var(--treb-spinner-color,currentColor) transparent transparent transparent;border-radius:50%;box-sizing:border-box;display:block;height:64px;margin:8px;position:absolute;width:64px}.treb-main.treb-main .treb-spinner>div div:first-child{animation-delay:-.45s}.treb-main.treb-main .treb-spinner>div div:nth-child(2){animation-delay:-.3s}.treb-main.treb-main .treb-spinner>div div:nth-child(3){animation-delay:-.15s}@keyframes treb-spinner{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.treb-main.treb-main{--icon-x:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg>');--icon-popout:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28"><path fill="currentColor" d="M22 14.5v5c0 2.484-2.016 4.5-4.5 4.5h-13A4.5 4.5 0 0 1 0 19.5v-13C0 4.016 2.016 2 4.5 2h11c.281 0 .5.219.5.5v1c0 .281-.219.5-.5.5h-11A2.507 2.507 0 0 0 2 6.5v13C2 20.875 3.125 22 4.5 22h13c1.375 0 2.5-1.125 2.5-2.5v-5c0-.281.219-.5.5-.5h1c.281 0 .5.219.5.5M28 1v8c0 .547-.453 1-1 1a1 1 0 0 1-.703-.297l-2.75-2.75L13.36 17.14c-.094.094-.234.156-.359.156s-.266-.063-.359-.156l-1.781-1.781c-.094-.094-.156-.234-.156-.359s.063-.266.156-.359L21.048 4.454l-2.75-2.75a1 1 0 0 1-.297-.703c0-.547.453-1 1-1h8c.547 0 1 .453 1 1z"/></svg>');--icon-toolbar:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M5.5 22v2H0v-2zm5.5-2c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1H7c-.547 0-1-.453-1-1v-4c0-.547.453-1 1-1zm2.5-6v2H0v-2zm-10-8v2H0V6zM24 22v2H12.5v-2zM9 4c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1H5c-.547 0-1-.453-1-1V5c0-.547.453-1 1-1zm10 8c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1h-4c-.547 0-1-.453-1-1v-4c0-.547.453-1 1-1zm5 2v2h-3.5v-2zm0-8v2H10.5V6z"/></svg>');--icon-export:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 28"><path fill="currentColor" d="M20 21c0-.547-.453-1-1-1s-1 .453-1 1 .453 1 1 1 1-.453 1-1m4 0c0-.547-.453-1-1-1s-1 .453-1 1 .453 1 1 1 1-.453 1-1m2-3.5v5a1.5 1.5 0 0 1-1.5 1.5h-23A1.5 1.5 0 0 1 0 22.5v-5A1.5 1.5 0 0 1 1.5 16h7.266l2.109 2.125c.578.562 1.328.875 2.125.875s1.547-.313 2.125-.875L17.25 16h7.25a1.5 1.5 0 0 1 1.5 1.5m-5.078-8.891a.98.98 0 0 1-.219 1.094l-7 7c-.187.203-.453.297-.703.297s-.516-.094-.703-.297l-7-7a.98.98 0 0 1-.219-1.094C5.234 8.25 5.594 8 6 8h4V1c0-.547.453-1 1-1h4c.547 0 1 .453 1 1v7h4c.406 0 .766.25.922.609"/></svg>');--icon-reset:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M23.609 16.5c0 .031 0 .078-.016.109C22.265 22.14 17.702 26 11.937 26c-3.047 0-6-1.203-8.219-3.313l-2.016 2.016A1 1 0 0 1 .999 25c-.547 0-1-.453-1-1v-7c0-.547.453-1 1-1h7c.547 0 1 .453 1 1a1 1 0 0 1-.297.703l-2.141 2.141A7.99 7.99 0 0 0 11.998 22a7.98 7.98 0 0 0 6.813-3.813c.375-.609.562-1.203.828-1.828.078-.219.234-.359.469-.359h3c.281 0 .5.234.5.5zM24 4v7c0 .547-.453 1-1 1h-7c-.547 0-1-.453-1-1a1 1 0 0 1 .297-.703l2.156-2.156A8.04 8.04 0 0 0 12 6a7.98 7.98 0 0 0-6.813 3.813c-.375.609-.562 1.203-.828 1.828-.078.219-.234.359-.469.359H.781a.503.503 0 0 1-.5-.5v-.109C1.625 5.844 6.234 2 12 2c3.063 0 6.047 1.219 8.266 3.313l2.031-2.016A1 1 0 0 1 23 3c.547 0 1 .453 1 1"/></svg>');--icon-about:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M14 21.5v-3c0-.281-.219-.5-.5-.5h-3c-.281 0-.5.219-.5.5v3c0 .281.219.5.5.5h3c.281 0 .5-.219.5-.5M18 11c0-2.859-3-5-5.688-5-2.547 0-4.453 1.094-5.797 3.328a.49.49 0 0 0 .125.656l2.063 1.563a.48.48 0 0 0 .297.094.5.5 0 0 0 .391-.187c.734-.938 1.047-1.219 1.344-1.437.266-.187.781-.375 1.344-.375 1 0 1.922.641 1.922 1.328 0 .812-.422 1.219-1.375 1.656-1.109.5-2.625 1.797-2.625 3.313v.562c0 .281.219.5.5.5h3c.281 0 .5-.219.5-.5 0-.359.453-1.125 1.188-1.547 1.188-.672 2.812-1.578 2.812-3.953zm6 3c0 6.625-5.375 12-12 12S0 20.625 0 14 5.375 2 12 2s12 5.375 12 12"/></svg>');--icon-chevron-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 28"><path fill="currentColor" d="M18.297 4.703 10 13l8.297 8.297a.99.99 0 0 1 0 1.406l-2.594 2.594a.99.99 0 0 1-1.406 0L2.703 13.703a.99.99 0 0 1 0-1.406L14.297.703a.99.99 0 0 1 1.406 0l2.594 2.594a.99.99 0 0 1 0 1.406"/></svg>');--icon-chevron-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 28"><path fill="currentColor" d="M17.297 13.703 5.703 25.297a.99.99 0 0 1-1.406 0l-2.594-2.594a.99.99 0 0 1 0-1.406L10 13 1.703 4.703a.99.99 0 0 1 0-1.406L4.297.703a.99.99 0 0 1 1.406 0l11.594 11.594a.99.99 0 0 1 0 1.406"/></svg>');--icon-revert:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M24 14c0 6.609-5.391 12-12 12a11.97 11.97 0 0 1-9.234-4.328.52.52 0 0 1 .031-.672l2.141-2.156a.6.6 0 0 1 .391-.141.5.5 0 0 1 .359.187A7.91 7.91 0 0 0 12 21.999c4.406 0 8-3.594 8-8s-3.594-8-8-8A7.95 7.95 0 0 0 6.563 8.14l2.141 2.156a.96.96 0 0 1 .219 1.078 1 1 0 0 1-.922.625h-7c-.547 0-1-.453-1-1v-7c0-.406.25-.766.625-.922a.96.96 0 0 1 1.078.219l2.031 2.016c2.203-2.078 5.187-3.313 8.266-3.313 6.609 0 12 5.391 12 12zM14 9.5v7c0 .281-.219.5-.5.5h-5a.494.494 0 0 1-.5-.5v-1c0-.281.219-.5.5-.5H12V9.5c0-.281.219-.5.5-.5h1c.281 0 .5.219.5.5"/></svg>');--icon-text-indent:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-text-indent-left" viewBox="0 0 16 16"><path d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m.646 2.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L4.293 8 2.646 6.354a.5.5 0 0 1 0-.708M7 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m-5 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-outdent:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-text-indent-right" viewBox="0 0 16 16"><path d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m10.646 2.146a.5.5 0 0 1 .708.708L11.707 8l1.647 1.646a.5.5 0 0 1-.708.708l-2-2a.5.5 0 0 1 0-.708zM2 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-center:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m4-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-top:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 15a.5.5 0 0 0 .5-.5V5.707l3.146 3.146a.5.5 0 0 0 .707-.707l-4-4a.5.5 0 0 0-.706-.001l-.001.001-4 4a.5.5 0 0 0 .708.707L7.5 5.707V14.5a.5.5 0 0 0 .5.5'/%3E%3Cpath fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' d='M3 1.5h10'/%3E%3C/svg%3E");--icon-text-align-middle:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8m7-8a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0m-.5 11.707-1.146 1.147a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 11.707V15.5a.5.5 0 0 1-1 0z"/></svg>');--icon-text-align-bottom:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 1a.5.5 0 0 0-.5.5v8.793L4.354 7.146a.5.5 0 0 0-.707.707l4 4a.5.5 0 0 0 .707.001l.001-.001 4-4a.5.5 0 0 0-.708-.707L8.5 10.293V1.5A.5.5 0 0 0 8 1'/%3E%3Cpath fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' d='M13 14.5H3'/%3E%3C/svg%3E");--icon-file-menu:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/></svg>');--icon-wrap-text:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 5h8a.5.5 0 0 0 0-1H4a.5.5 0 0 0 0 1M10 8H4a.5.5 0 0 0 0 1h6a1.5 1.5 0 0 1 0 3v-1.203l-2.953 1.707L10 14.203V13a2.5 2.5 0 1 0 0-5M3.75 12.5a.5.5 0 0 0 .5.5H6v-1H4.25a.5.5 0 0 0-.5.5"/></svg>');--icon-unmerge-cells:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5"/></svg>');--icon-merge-cells:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5m5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5M0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5m10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0z"/></svg>');--icon-lock:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1"/></svg>');--icon-comment:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>');--icon-fill-color:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.192 2.78c-.458-.677-.927-1.248-1.35-1.643a3 3 0 0 0-.71-.515c-.217-.104-.56-.205-.882-.02-.367.213-.427.63-.43.896-.003.304.064.664.173 1.044.196.687.556 1.528 1.035 2.402L.752 8.22c-.277.277-.269.656-.218.918.055.283.187.593.36.903.348.627.92 1.361 1.626 2.068.707.707 1.441 1.278 2.068 1.626.31.173.62.305.903.36.262.05.64.059.918-.218l5.615-5.615c.118.257.092.512.05.939-.03.292-.068.665-.073 1.176v.123h.003a1 1 0 0 0 1.993 0H14v-.057a1 1 0 0 0-.004-.117c-.055-1.25-.7-2.738-1.86-3.494a4 4 0 0 0-.211-.434c-.349-.626-.92-1.36-1.627-2.067S8.857 3.052 8.23 2.704c-.31-.172-.62-.304-.903-.36-.262-.05-.64-.058-.918.219l-.217.216zM4.16 1.867c.381.356.844.922 1.311 1.632l-.704.705c-.382-.727-.66-1.402-.813-1.938a3.3 3.3 0 0 1-.131-.673q.137.09.337.274m.394 3.965c.54.852 1.107 1.567 1.607 2.033a.5.5 0 1 0 .682-.732c-.453-.422-1.017-1.136-1.564-2.027l1.088-1.088q.081.181.183.365c.349.627.92 1.361 1.627 2.068.706.707 1.44 1.278 2.068 1.626q.183.103.365.183l-4.861 4.862a1 1 0 0 1-.068-.01c-.137-.027-.342-.104-.608-.252-.524-.292-1.186-.8-1.846-1.46s-1.168-1.32-1.46-1.846c-.147-.265-.225-.47-.251-.607a1 1 0 0 1-.01-.068zm2.87-1.935a2.4 2.4 0 0 1-.241-.561c.135.033.324.11.562.241.524.292 1.186.8 1.846 1.46.45.45.83.901 1.118 1.31a3.5 3.5 0 0 0-1.066.091 11 11 0 0 1-.76-.694c-.66-.66-1.167-1.322-1.458-1.847z"/></svg>');--icon-text-color:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="16" height="16" viewBox="0 0 16 16"><path d="m12.259 14.001-1.389-3.727H5.465l-1.354 3.727h-1.3L7.609 1.397h1.178l4.772 12.604zM8.418 3.604a6 6 0 0 1-.127-.387 4 4 0 0 1-.11-.501h-.035a5.5 5.5 0 0 1-.247.888L5.86 9.211h4.614z"/></svg>');--icon-border-bottom:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 15h16v1H0z"/></svg>');--icon-border-top:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0v1h16V0zm1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 16h.969v-.5H1v-.469H.969V15H.5v.031H0zm1.906 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875-.5v.5H16v-.969h-.5V15h-.469v.031H15v.469z"/></svg>');--icon-border-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0v16h1V0zm1.906 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM7.5 1.906v.938h1v-.938zm7.5 0v.938h1v-.938zM7.5 3.781v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM7.5 5.656v.938h1v-.938zm7.5 0v.938h1v-.938zM1.906 8.5h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM7.5 9.406v.938h1v-.938zm8.5.938v-.938h-1v.938zm-8.5.937v.938h1v-.938zm8.5.938v-.938h-1v.938zm-8.5.937v.938h1v-.938zm8.5.938v-.938h-1v.938zM1.906 16h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875-.5v.5H16v-.969h-.5V15h-.469v.031H15v.469z"/></svg>');--icon-border-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zM16 0h-1v16h1zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zM0 11.281v.938h1v-.938zm7.5 0v.938h1v-.938zM0 13.156v.938h1v-.938zm7.5 0v.938h1v-.938zM0 16h.969v-.5H1v-.469H.969V15H.5v.031H0zm1.906 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938z"/></svg>');--icon-border-double-bottom:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 15h16v1H0zm0-2h16v1H0z"/></svg>');--icon-border-all:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0h16v16H0zm1 1v6.5h6.5V1zm7.5 0v6.5H15V1zM15 8.5H8.5V15H15zM7.5 15V8.5H1V15z"/></svg>');--icon-border-outer:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.5 1.906v.938h1v-.938zm0 1.875v.938h1V3.78h-1zm0 1.875v.938h1v-.938zM1.906 8.5h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zM7.5 9.406v.938h1v-.938zm0 1.875v.938h1v-.938zm0 1.875v.938h1v-.938z"/><path d="M0 0v16h16V0zm1 1h14v14H1z"/></svg>');--icon-border-none:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0h.969v.5H1v.469H.969V1H.5V.969H0zm2.844 1h-.938V0h.938zm1.875 0H3.78V0h.938v1zm1.875 0h-.938V0h.938zm.937 0V.969H7.5V.5h.031V0h.938v.5H8.5v.469h-.031V1zm2.813 0h-.938V0h.938zm1.875 0h-.938V0h.938zm1.875 0h-.938V0h.938zM15.5 1h-.469V.969H15V.5h.031V0H16v.969h-.5zM1 1.906v.938H0v-.938zm6.5.938v-.938h1v.938zm7.5 0v-.938h1v.938zM1 3.78v.938H0V3.78zm6.5.938V3.78h1v.938zm7.5 0V3.78h1v.938zM1 5.656v.938H0v-.938zm6.5.938v-.938h1v.938zm7.5 0v-.938h1v.938zM.969 8.5H.5v-.031H0V7.53h.5V7.5h.469v.031H1v.938H.969zm1.875 0h-.938v-1h.938zm1.875 0H3.78v-1h.938v1zm1.875 0h-.938v-1h.938zm1.875-.031V8.5H7.53v-.031H7.5V7.53h.031V7.5h.938v.031H8.5v.938zm1.875.031h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.406 0h-.469v-.031H15V7.53h.031V7.5h.469v.031h.5v.938h-.5zM0 10.344v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM0 12.22v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM0 14.094v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM.969 16H0v-.969h.5V15h.469v.031H1v.469H.969zm1.875 0h-.938v-1h.938zm1.875 0H3.78v-1h.938v1zm1.875 0h-.938v-1h.938zm.937 0v-.5H7.5v-.469h.031V15h.938v.031H8.5v.469h-.031v.5zm2.813 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm.937 0v-.5H15v-.469h.031V15h.469v.031h.5V16z"/></svg>');--icon-palette:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h5a.5.5 0 0 1 .5.5v5.277l4.147-4.131a.5.5 0 0 1 .707 0l3.535 3.536a.5.5 0 0 1 0 .708L10.261 10H15.5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5.5H3a3 3 0 0 1-2.121-.879A3 3 0 0 1 0 13.044m6-.21 7.328-7.3-2.829-2.828L6 7.188zM4.5 13a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0M15 15v-4H9.258l-4.015 4zM0 .5v12.495zM0 12.995V13z"/></svg>');--icon-layout:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="m3 0 17 17.156v-.114z"/><path d="M3 0H0v16h1V1h1.585L19 17.455V19H4v1h16v-2.844z"/><path d="M6.886 3.922 5.343 5.465a.5.5 0 0 0 .708.707l1.539-1.54zM9.702 6.763l-1.53 1.53A.5.5 0 0 0 8.879 9l1.526-1.526zM12.517 9.604 11 11.121a.5.5 0 0 0 .707.707l1.514-1.514zM15.332 12.445l-1.504 1.504a.5.5 0 0 0 .707.707l1.501-1.5zM1 16H0a4 4 0 0 0 4 4v-1c-1.654 0-3-1.346-3-3M5 9v6h6zm1 2.414L8.586 14H6z"/></svg>');--icon-freeze:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a.5.5 0 0 1-.5-.5v-1.293l-.646.647a.5.5 0 0 1-.707-.708L7.5 12.793V8.866l-3.4 1.963-.496 1.85a.5.5 0 1 1-.966-.26l.237-.882-1.12.646a.5.5 0 0 1-.5-.866l1.12-.646-.884-.237a.5.5 0 1 1 .26-.966l1.848.495L7 8 3.6 6.037l-1.85.495a.5.5 0 0 1-.258-.966l.883-.237-1.12-.646a.5.5 0 1 1 .5-.866l1.12.646-.237-.883a.5.5 0 1 1 .966-.258l.495 1.849L7.5 7.134V3.207L6.147 1.854a.5.5 0 1 1 .707-.708l.646.647V.5a.5.5 0 1 1 1 0v1.293l.647-.647a.5.5 0 1 1 .707.708L8.5 3.207v3.927l3.4-1.963.496-1.85a.5.5 0 1 1 .966.26l-.236.882 1.12-.646a.5.5 0 0 1 .5.866l-1.12.646.883.237a.5.5 0 1 1-.26.966l-1.848-.495L9 8l3.4 1.963 1.849-.495a.5.5 0 0 1 .259.966l-.883.237 1.12.646a.5.5 0 0 1-.5.866l-1.12-.646.236.883a.5.5 0 1 1-.966.258l-.495-1.849-3.4-1.963v3.927l1.353 1.353a.5.5 0 0 1-.707.708l-.647-.647V15.5a.5.5 0 0 1-.5.5z"/></svg>');--icon-column-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M4.5 17.5a.5.5 0 0 1-1 0v-5a.5.5 0 0 1 1 0zM12.5 17.5a.5.5 0 0 1-1 0v-9a.5.5 0 0 1 1 0zM16.5 17.5a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 1 0zM8.5 17.5a.5.5 0 0 1-1 0v-14a.5.5 0 0 1 1 0z"/></svg>');--icon-donut-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M12 1.23v1.548c2.526.701 4.5 2.699 5.203 5.222h1.565A9.01 9.01 0 0 0 12 1.23M2.5 10c0-3.51 2.426-6.456 5.688-7.27V1.183A9 9 0 0 0 1 10c0 1.761.513 3.397 1.387 4.784l1.093-1.093A7.43 7.43 0 0 1 2.5 10M17.221 12c-.878 3.166-3.778 5.5-7.221 5.5a7.45 7.45 0 0 1-3.692-.979l-1.093 1.093A8.96 8.96 0 0 0 10 19c4.282 0 7.859-2.993 8.77-7z"/></svg>');--icon-bar-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M2.5 4.5a.5.5 0 0 1 0-1h5a.5.5 0 0 1 0 1zM2.5 12.5a.5.5 0 0 1 0-1h9a.5.5 0 0 1 0 1zM2.5 16.5a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1zM2.5 8.5a.5.5 0 0 1 0-1h14a.5.5 0 0 1 0 1z"/></svg>');--icon-line-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="m1 8 3-3 7 5 8-8v2l-8 8-7-5-3 3z"/></svg>');--icon-image:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/></svg>');--icon-recalculate:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M9.478 4.022c2.402-.209 4.583 1.047 5.711 3.014l1.083-.095c-1.233-2.528-3.912-4.175-6.881-3.916-2.97.26-5.321 2.347-6.098 5.051l1.083-.095c.768-2.132 2.698-3.748 5.102-3.959M10.523 15.977c-2.403.211-4.585-1.047-5.712-3.013l-1.08.095c1.234 2.527 3.91 4.175 6.879 3.914 2.971-.259 5.32-2.347 6.095-5.05l-1.08.095c-.769 2.132-2.699 3.749-5.102 3.959"/><path d="m2.272 15.616 5.197-3-4.098-1.097zM17.728 4.384l-5.197 3 4.098 1.098z"/></svg>');--icon-check:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>');--icon-table:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z"/></svg>')}.treb-main.treb-main .treb-layout-header{overflow:hidden;overflow-x:scroll;position:relative;-ms-overflow-style:none;scrollbar-width:none}.treb-main.treb-main .treb-layout-header::-webkit-scrollbar{display:none}.treb-main.treb-main .treb-toolbar{color:var(--treb-toolbar-color,var(--treb-ui-color,#333));display:flex;flex-direction:row;font-size:var(--treb-toolbar-font-size,inherit);gap:.5rem}.treb-main.treb-main .treb-toolbar>div{display:flex;flex-direction:row}.treb-main.treb-main .treb-toolbar>div>input,.treb-main.treb-main .treb-toolbar>input{background-color:var(--treb-toolbar-button-background,transparent);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));height:32px;overflow:hidden;padding-left:.5em;padding-right:.5em;text-overflow:ellipsis}.treb-main.treb-main .treb-toolbar>.treb-menu>button{border-radius:3px}.treb-main.treb-main .treb-toolbar>.group>.treb-menu+button,.treb-main.treb-main .treb-toolbar>.group>button+.treb-menu>button,.treb-main.treb-main .treb-toolbar>.group>button+button,.treb-main.treb-main .treb-toolbar>.group>input+.treb-menu>button,.treb-main.treb-main .treb-toolbar>.group>input+button,.treb-main.treb-main .treb-toolbar>[composite]>.treb-menu+button,.treb-main.treb-main .treb-toolbar>[composite]>button+.treb-menu>button,.treb-main.treb-main .treb-toolbar>[composite]>button+button,.treb-main.treb-main .treb-toolbar>[composite]>input+.treb-menu>button,.treb-main.treb-main .treb-toolbar>[composite]>input+button{border-left-width:0}.treb-main.treb-main .treb-toolbar>.group>button:first-child,.treb-main.treb-main .treb-toolbar>.group>input:first-child,.treb-main.treb-main .treb-toolbar>[composite]>button:first-child,.treb-main.treb-main .treb-toolbar>[composite]>input:first-child{border-bottom-left-radius:3px;border-top-left-radius:3px}.treb-main.treb-main .treb-toolbar>.group>.treb-menu:last-child>button,.treb-main.treb-main .treb-toolbar>.group>button:last-child,.treb-main.treb-main .treb-toolbar>[composite]>.treb-menu:last-child>button,.treb-main.treb-main .treb-toolbar>[composite]>button:last-child{border-bottom-right-radius:3px;border-top-right-radius:3px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button,.treb-main.treb-main .treb-toolbar .treb-menu>button,.treb-main.treb-main .treb-toolbar button[data-icon],.treb-main.treb-main .treb-toolbar>button,.treb-main.treb-main .treb-toolbar>div>button{align-items:center;background-color:var(--treb-toolbar-button-background,transparent);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));display:flex;flex-direction:column;height:32px;justify-content:center;position:relative;width:32px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[dropdown],.treb-main.treb-main .treb-toolbar .treb-menu>button[dropdown],.treb-main.treb-main .treb-toolbar button[data-icon][dropdown],.treb-main.treb-main .treb-toolbar>button[dropdown],.treb-main.treb-main .treb-toolbar>div>button[dropdown]{width:16px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[dropdown]:after,.treb-main.treb-main .treb-toolbar .treb-menu>button[dropdown]:after,.treb-main.treb-main .treb-toolbar button[data-icon][dropdown]:after,.treb-main.treb-main .treb-toolbar>button[dropdown]:after,.treb-main.treb-main .treb-toolbar>div>button[dropdown]:after{border:5px solid transparent;border-top-color:currentcolor;box-sizing:content-box;content:"";height:0;left:50%;position:absolute;top:18px;transform:translate(-50%,-50%);width:0}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button:hover,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[active],.treb-main.treb-main .treb-toolbar .treb-menu>button:hover,.treb-main.treb-main .treb-toolbar .treb-menu>button[active],.treb-main.treb-main .treb-toolbar button[data-icon]:hover,.treb-main.treb-main .treb-toolbar button[data-icon][active],.treb-main.treb-main .treb-toolbar>button:hover,.treb-main.treb-main .treb-toolbar>button[active],.treb-main.treb-main .treb-toolbar>div>button:hover,.treb-main.treb-main .treb-toolbar>div>button[active]{background-color:var(--treb-toolbar-hover-button-background,#f3f4f6)}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar button[data-icon][data-color-bar]:after,.treb-main.treb-main .treb-toolbar>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar>div>button[data-color-bar]:after{background:var(--treb-color-bar-color,var(--treb-default-color,unset));border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));box-sizing:border-box;content:"";display:block;height:6px;position:relative;width:20px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-command]:before,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-icon]:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-command]:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-icon]:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-command]:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-icon]:before,.treb-main.treb-main .treb-toolbar>button[data-command]:before,.treb-main.treb-main .treb-toolbar>button[data-icon]:before,.treb-main.treb-main .treb-toolbar>div>button[data-command]:before,.treb-main.treb-main .treb-toolbar>div>button[data-icon]:before{background:currentColor;content:"";display:block;height:20px;mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:var(--icon-size,16px 16px);-webkit-mask-size:var(--icon-size,16px 16px);position:relative;width:20px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>div>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>div>button[data-icon].treb-font-stack:before{display:none}.treb-main.treb-main .treb-toolbar .treb-split{display:flex;flex-direction:column;gap:0}.treb-main.treb-main .treb-toolbar .treb-split button[data-command]{font-size:10px}.treb-main.treb-main .treb-toolbar .treb-split button[data-command]:before{display:none}.treb-main.treb-main .treb-toolbar .treb-split>button{align-items:center;display:flex;height:16px;justify-content:center}.treb-main.treb-main .treb-toolbar .treb-split>button:first-child{border-top-left-radius:3px;border-top-right-radius:3px}.treb-main.treb-main .treb-toolbar .treb-split>button:last-child{border-bottom-left-radius:3px;border-bottom-right-radius:3px;border-top:0}.treb-main.treb-main .treb-toolbar .treb-font-stack{align-items:flex-start;overflow:hidden;width:8em}.treb-main.treb-main .treb-toolbar .treb-font-stack:before{display:none}.treb-main.treb-main .treb-toolbar .treb-menu{outline:none}.treb-main.treb-main .treb-toolbar .treb-menu>div{background:var(--treb-toolbar-button-background,#fff);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px;box-shadow:0 4px 6px -4px rgba(0,0,0,.4);display:none;flex-direction:column;margin-top:.5rem;position:fixed;top:48px;z-index:20}.treb-main.treb-main .treb-toolbar .treb-menu>div button{background:transparent;border:0;margin:3px 0;padding:.4rem 1rem;text-align:left;transition:background-color .125s ease;white-space:nowrap}.treb-main.treb-main .treb-toolbar .treb-menu>div button:hover{background:var(--treb-toolbar-hover-button-background,#f3f4f6)}.treb-main.treb-main .treb-toolbar .treb-menu>div.treb-icon-buttons>.treb-menu>button,.treb-main.treb-main .treb-toolbar .treb-menu>div.treb-icon-buttons>button{padding:0}.treb-main.treb-main .treb-toolbar .treb-menu>div>[separator]{background:var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));height:1px;margin:2px 0}.treb-main.treb-main .treb-toolbar .treb-menu.visible>div,.treb-main.treb-main .treb-toolbar .treb-menu:focus-within>div{display:flex}.treb-main.treb-main .treb-toolbar [data-icon=file-menu]{--icon:var(--icon-file-menu)}.treb-main.treb-main .treb-toolbar [data-command=justify-left]{--icon:var(--icon-text-align-left)}.treb-main.treb-main .treb-toolbar [data-command=justify-right]{--icon:var(--icon-text-align-right)}.treb-main.treb-main .treb-toolbar [data-command=justify-center]{--icon:var(--icon-text-align-center)}.treb-main.treb-main .treb-toolbar [data-command=indent]{--icon:var(--icon-text-indent)}.treb-main.treb-main .treb-toolbar [data-command=outdent]{--icon:var(--icon-text-outdent)}.treb-main.treb-main .treb-toolbar [data-command=align-top]{--icon:var(--icon-text-align-top)}.treb-main.treb-main .treb-toolbar [data-command=align-middle]{--icon:var(--icon-text-align-middle)}.treb-main.treb-main .treb-toolbar [data-command=align-bottom]{--icon:var(--icon-text-align-bottom)}.treb-main.treb-main .treb-toolbar [data-command=merge-cells]{--icon:var(--icon-merge-cells)}.treb-main.treb-main .treb-toolbar [data-command=unmerge-cells]{--icon:var(--icon-unmerge-cells)}.treb-main.treb-main .treb-toolbar [data-command=fill-color]{--icon:var(--icon-fill-color)}.treb-main.treb-main .treb-toolbar [data-command=text-color]{--icon:var(--icon-text-color)}.treb-main.treb-main .treb-toolbar [data-command=lock-cells]{--icon:var(--icon-lock)}.treb-main.treb-main .treb-toolbar [data-command=wrap-text]{--icon:var(--icon-wrap-text)}.treb-main.treb-main .treb-toolbar [data-icon=comment]{--icon:var(--icon-comment)}.treb-main.treb-main .treb-toolbar [data-icon=table]{--icon:var(--icon-table)}.treb-main.treb-main .treb-toolbar [data-icon=layout]{--icon:var(--icon-layout)}.treb-main.treb-main .treb-toolbar [data-command=freeze-panes]{--icon:var(--icon-freeze)}.treb-main.treb-main .treb-toolbar [data-command=insert-column-chart]{--icon:var(--icon-column-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-donut-chart]{--icon:var(--icon-donut-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-bar-chart]{--icon:var(--icon-bar-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-line-chart]{--icon:var(--icon-line-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-image]{--icon:var(--icon-image)}.treb-main.treb-main .treb-toolbar [data-command=border-bottom]{--icon:var(--icon-border-bottom)}.treb-main.treb-main .treb-toolbar [data-command=border-left]{--icon:var(--icon-border-left)}.treb-main.treb-main .treb-toolbar [data-command=border-right]{--icon:var(--icon-border-right)}.treb-main.treb-main .treb-toolbar [data-command=border-top]{--icon:var(--icon-border-top)}.treb-main.treb-main .treb-toolbar [data-command=border-outside]{--icon:var(--icon-border-outer)}.treb-main.treb-main .treb-toolbar [data-command=border-all]{--icon:var(--icon-border-all)}.treb-main.treb-main .treb-toolbar [data-command=border-none]{--icon:var(--icon-border-none)}.treb-main.treb-main .treb-toolbar [data-command=border-double-bottom]{--icon:var(--icon-border-double-bottom)}.treb-main.treb-main .treb-toolbar [data-icon=palette]{--icon:var(--icon-palette)}.treb-main.treb-main .treb-toolbar [data-command=recalculate]{--icon:var(--icon-recalculate);--icon-size:20px 20px}.treb-main.treb-main .treb-toolbar .treb-font-scale{width:4em}.treb-main.treb-main .treb-toolbar .treb-number-format{width:8em}.treb-main.treb-main .treb-toolbar .treb-color-chooser button[data-command=set-color]{align-items:center;display:flex;justify-content:center;padding:0;width:32px}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div{padding:.75rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div+div{padding-top:0}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child{align-items:center;display:flex;flex-direction:row;gap:.5rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child input{flex-grow:1;padding:0 .5rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child button,.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child input{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px;height:32px}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch button,.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches button{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:2px;height:18px;margin:0;padding:0;width:18px}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch .treb-default-color:before,.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches .treb-default-color:before{background:currentColor;content:"";display:block;height:100%;mask-image:var(--icon-x);-webkit-mask-image:var(--icon-x);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:24px 24px;-webkit-mask-size:24px 24px;opacity:.7;position:relative;width:100%}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch{align-items:center;display:grid;gap:.5rem;grid-template-columns:auto 1fr}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches{display:grid;gap:.5rem;grid-template-columns:repeat(10,1fr)}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));font:inherit;height:10rem;line-height:1.5;margin:.5rem;padding:.25rem;resize:both}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea+div{align-items:center;display:flex;flex-direction:row;gap:.5rem;justify-content:center;padding:0 0 .5rem}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea+div button{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px}.treb-main.treb-main .treb-toolbar .treb-font-scale{padding-left:2em;text-align:right;width:5em}.treb-main.treb-main .treb-toolbar [composite][font-scale]{position:relative}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon{border-radius:3px;left:.5em;line-height:1;opacity:.9;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%)}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:after,.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:before{content:"A";position:relative}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:before{font-size:1.2em}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:after{font-size:.9em;left:-.125em}.treb-main.treb-main{--treb-font-stack-default-size:14px;--treb-font-stack-calibri-size:16px;--treb-font-stack-tscu-comic-size:16px;--treb-font-stack-helvetica-neue-size:13px;--treb-font-stack-cambria-size:16px;--treb-font-stack-sitka-text-variant:lining-nums tabular-nums}.treb-main.treb-main.treb-ua-osx{--treb-font-stack-system-ui-size:10pt}.treb-main.treb-main .treb-font-stack-default{font-family:calibri,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif"}.treb-main.treb-main .treb-font-stack-transitional{font-family:Charter,Bitstream Charter,Cambria,serif}.treb-main.treb-main .treb-font-stack-old-style{font-family:Iowan Old Style,Palatino Linotype,URW Palladio L,P052,serif}.treb-main.treb-main .treb-font-stack-handwritten{font-family:Segoe Print,Bradley Hand,Chilanka,TSCu_Comic,casual,cursive}.treb-main.treb-main .treb-font-stack-industrial{font-family:Bahnschrift,DIN Alternate,Franklin Gothic Medium,Nimbus Sans Narrow,sans-serif-condensed,sans-serif}.treb-main.treb-main .treb-font-stack-monospace{font-family:ui-monospace,Cascadia Code,Source Code Pro,Menlo,Consolas,DejaVu Sans Mono,monospace}.treb-main.treb-main .treb-font-stack-ui{font-family:system-ui,sans-serif}.treb-main.treb-main{all:revert;box-sizing:border-box;color:inherit;color-scheme:var(--treb-color-scheme,unset);display:grid;font-family:var(--treb-default-font,system-ui,"BlinkMacSystemFont","Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue","sans-serif");font-family:BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif";font-size:14px;font-style:normal;font-weight:400;grid-template-columns:minmax(0,1fr) auto;grid-template-rows:auto minmax(0,1fr);height:100%;line-height:normal;position:relative;text-align:start;width:100%}.treb-main.treb-main a,.treb-main.treb-main button,.treb-main.treb-main div,.treb-main.treb-main input,.treb-main.treb-main li,.treb-main.treb-main ol,.treb-main.treb-main svg,.treb-main.treb-main textarea,.treb-main.treb-main ul{all:revert;box-sizing:border-box;font-family:var(--treb-default-font,system-ui,"BlinkMacSystemFont","Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue","sans-serif")}.treb-main.treb-main button,.treb-main.treb-main input{color:inherit;font:inherit}.treb-main.treb-main *{box-sizing:border-box}.treb-main.treb-main [contenteditable]{-webkit-user-modify:read-write;-moz-user-modify:read-write}.treb-main.treb-main[animate] .treb-layout-header{transition:height var(--treb-sidebar-transition,.2s ease),opacity var(--treb-sidebar-transition,.2s ease)}.treb-main.treb-main .treb-layout-header{grid-column:1/3;grid-row:1;height:1px;opacity:0}.treb-main.treb-main[toolbar] .treb-layout-header{height:42px;opacity:1}.treb-main.treb-main[dialog] .treb-layout-header,.treb-main.treb-main[dialog]>*{opacity:.6}.treb-main.treb-main[dialog] .treb-dialog-mask{opacity:1;pointer-events:auto}.treb-main.treb-main .treb-layout-spreadsheet{display:flex;flex-direction:row;gap:1em;grid-column:1;grid-row:2;position:relative;transition:opacity .2s ease;z-index:5}.treb-main.treb-main .treb-views.treb-can-revert .treb-view .treb-revert-indicator{opacity:1;pointer-events:auto}.treb-main.treb-main .treb-view{display:grid;flex:1 1 0px;grid-template-columns:minmax(0,1fr);grid-template-rows:auto minmax(0,1fr) auto;position:relative}.treb-main.treb-main .treb-view .treb-spreadsheet-backdrop{box-shadow:0 4px 6px -4px rgba(0,0,0,.4);grid-column:1;grid-row:2;z-index:2}.treb-main.treb-main .treb-view .treb-spreadsheet-body{position:relative;z-index:4}.treb-main.treb-main .treb-view .treb-spreadsheet-footer{position:relative;z-index:5}.treb-main.treb-main .treb-view .treb-layout-resize-handle,.treb-main.treb-main .treb-view .treb-revert-indicator{display:none}.treb-main.treb-main .treb-view:first-of-type .treb-revert-indicator{align-self:start;border-color:orange transparent transparent orange;border-style:solid;border-width:.5em;display:block;grid-area:2/1/3/2;height:1rem;justify-self:start;opacity:0;overflow:hidden;pointer-events:none;position:relative;transition:opacity .125s ease;width:1rem;z-index:20}.treb-main.treb-main .treb-view:last-of-type .treb-layout-resize-handle{align-self:end;border-bottom:.5rem solid var(--treb-resize-handle-color,#0059b9);border-left:.5rem solid transparent;border-right:.5rem solid var(--treb-resize-handle-color,#0059b9);border-top:.5rem solid transparent;cursor:nw-resize;display:block;grid-area:2/1/3/2;height:1rem;justify-self:end;width:1rem;z-index:20}.treb-main.treb-main[animate] .treb-layout-sidebar{transition:width var(--treb-sidebar-transition,.2s ease),opacity var(--treb-sidebar-transition,.2s ease)}.treb-main.treb-main .treb-layout-sidebar{align-items:center;display:flex;flex-direction:column;gap:.75rem;grid-column:2;grid-row:2;justify-content:flex-start;overflow:hidden;padding-top:3rem;width:2.5rem;width:3rem}.treb-main.treb-main[collapsed] .treb-layout-sidebar{opacity:0;width:0}.treb-main.treb-main[collapsed] .treb-toggle-sidebar-button{background:var(--treb-toolbar-button-background,#fff);border-bottom-right-radius:0;border-color:var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-right-color:var(--treb-toolbar-button-background,transparent);border-top-right-radius:0;right:0}.treb-main.treb-main[collapsed] .treb-toggle-sidebar-button:after{mask-image:var(--icon-chevron-left);-webkit-mask-image:var(--icon-chevron-left)}.treb-main.treb-main .treb-layout-sidebar>button,.treb-main.treb-main .treb-toggle-sidebar-button{background:transparent;border:0;margin:0;padding:0}.treb-main.treb-main .treb-layout-sidebar>button:after,.treb-main.treb-main .treb-toggle-sidebar-button:after{background:#ccc;content:"";display:block;height:24px;mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;transition:background-color .1s ease;width:24px}.treb-main.treb-main .treb-layout-sidebar>button[data-can-revert=false],.treb-main.treb-main .treb-toggle-sidebar-button[data-can-revert=false]{display:none}.treb-main.treb-main .treb-layout-sidebar>button:hover:after,.treb-main.treb-main .treb-toggle-sidebar-button:hover:after{background:#666}.treb-main.treb-main .treb-layout-sidebar>button[data-command=recalculate],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=recalculate]{--icon:var(--icon-reset)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=toggle-toolbar],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=toggle-toolbar]{--icon:var(--icon-toolbar)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=revert],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=revert]{--icon:var(--icon-revert)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=export-xlsx],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=export-xlsx]{--icon:var(--icon-export)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=about],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=about]{--icon:var(--icon-about)}.treb-main.treb-main .treb-toggle-sidebar-button{align-items:center;background:transparent;border:1px solid transparent;border-radius:12px;bottom:6rem;display:flex;height:24px;justify-content:center;margin:0;padding:0;position:absolute;right:.5rem;right:calc(1.5rem - 12px);width:24px;z-index:39}.treb-main.treb-main .treb-toggle-sidebar-button:after{height:12px;mask-image:var(--icon-chevron-right);-webkit-mask-image:var(--icon-chevron-right);width:12px}.treb-main.treb-main .treb-resize-rect{border:1px dotted var(--treb-resize-frame-color,blue);display:block;height:100%;left:0;position:fixed;top:0;width:100%;z-index:9998}.treb-main.treb-main .treb-resize-mask{height:100vh;left:0;position:fixed;top:0;width:100vw;z-index:9999}treb-spreadsheet{display:block;overflow:hidden;position:relative}.treb-default-size{height:550px;width:800px}`;var to='<div class="treb-main treb-theme"><div class="treb-layout-header treb-animate"><div class="treb-toolbar"></div></div><div class="treb-dialog-mask"><div data-bind="dialog" class="treb-embed-dialog"><div data-bind="left"><a href="https://treb.app" target="_blank"><div class="treb-icon-64"></div></a></div><div data-bind="middle"><div data-bind="title" class="treb-embed-dialog-title"></div><div data-bind="message" class="treb-embed-dialog-message"></div><div data-bind="about" class="treb-embed-dialog-body"></div></div><button type="button" data-title="close_dialog" data-bind="close" class="treb-close-box"><svg viewBox="0 0 16 16"><path d="M11.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708-.708l7-7a.5.5 0 0 1 .708 0z"/><path d="M4.146 4.146a.5.5 0 0 0 0 .708l7 7a.5.5 0 0 0 .708-.708l-7-7a.5.5 0 0 0-.708 0z"/></svg></button></div></div><div class="treb-layout-spreadsheet treb-views"><template class="treb-view-template"><div class="treb-view"><div class="treb-formula-bar notranslate" hidden><div class="treb-address-label"><div></div></div><button class="treb-insert-function-button" data-title="insert_function" data-conditional="insert-function">\u{1D453}<small>(x)</small></button><div class="treb-editor-container"><div contenteditable="true"></div></div></div><div class="treb-spreadsheet-backdrop"></div><div class="treb-spreadsheet-body" role="grid"><div class="treb-grid" tabindex="-1"><div class="treb-overlay-container notranslate" translate="no"><div class="treb-overlay-inset"><div class="treb-overlay-editor" contenteditable tabindex="-1" spellcheck="true" role="gridcell"></div></div></div></div></div><div class="treb-spreadsheet-footer" hidden><button class="treb-delete-tab" data-title="delete_sheet" data-command="delete-tab" data-conditional="delete-tab"><svg tabindex="-1" viewbox="0 0 16 16"><path d="M4,4 L12,12 M12,4 L4,12"/></svg></button><div class="treb-spreadsheet-tab-container"><ol class="treb-spreadsheet-tabs" role="tablist"></ol></div><button class="treb-add-tab" data-command="add-tab" data-conditional="add-tab" data-title="add_sheet">+</button><div class="treb-stats-panel"></div><div class="treb-scale-control" data-conditional="scale-control"></div></div><div class="treb-layout-resize-handle" data-conditional="resize"></div><div class="treb-revert-indicator" data-command="revert-indicator" data-title="document_modified"></div></div></template></div><div class="treb-layout-sidebar treb-animate"><button data-command="recalculate" data-title="recalculate"></button> <button data-command="toggle-toolbar" data-conditional="toolbar" data-title="toggle_toolbar"></button> <button data-command="export-xlsx" data-conditional="export" data-title="export"></button> <button data-command="revert" data-conditional="revert" data-title="revert"></button> <button data-command="about" data-title="about"></button></div><button class="treb-toggle-sidebar-button" data-title="toggle_sidebar"></button></div>';var ro='<div class="treb-menu" title="File menu" file-menu><button data-icon="file-menu" menu-target></button><div><button data-command="reset">New document</button><div separator></div><button data-command="import-file">Open file...</button> <button data-command="save-json">Save JSON</button><div separator xlsx-support></div><button data-command="export-xlsx" xlsx-support>Export XLSX</button></div></div><div composite narrow><button data-command="justify-left" data-target="justify" title="Left-align text"></button><div class="treb-menu"><button dropdown title="Text justify options"></button><div class="treb-icon-buttons" data-replace="justify"><button data-command="justify-left" title="Left-align text"></button> <button data-command="justify-center" title="Center-align text"></button> <button data-command="justify-right" title="Right-align text"></button></div></div></div><div composite narrow><button data-command="align-top" data-target="align" title="Align to top"></button><div class="treb-menu"><button dropdown title="Text align options"></button><div class="treb-icon-buttons" data-replace="align"><button data-command="align-top" title="Align to top"></button> <button data-command="align-middle" title="Align to middle"></button> <button data-command="align-bottom" title="Align to bottom"></button></div></div></div><div class="group" wide><button data-command="justify-left" title="Left-align text"></button> <button data-command="justify-center" title="Center-align text"></button> <button data-command="justify-right" title="Right-align text"></button></div><div class="group" wide><button data-command="align-top" title="Align to top"></button> <button data-command="align-middle" title="Align to middle"></button> <button data-command="align-bottom" title="Align to bottom"></button></div><div class="group" wide indent-group><button data-command="outdent" title="Decrease indent"></button> <button data-command="indent" title="Incrase indent"></button></div><div class="group"><button data-command="wrap-text" title="Wrap text"></button> <button data-command="merge-cells" data-id="merge" data-inactive-title="Merge cells" data-active-title="Unmerge cells"></button> <button data-command="lock-cells" data-inactive-title="Lock cells" data-active-title="Unlock cells"></button> <button data-command="freeze-panes" data-inactive-title="Freeze panes" data-active-title="Unfreeze panes" freeze-button></button> <button data-command="insert-table" data-icon="table" data-inactive-title="Insert table" data-active-title="Remove table" table-button></button><div class="treb-menu"><button data-icon="comment" data-inactive-title="Comment" data-active-title="Update comment"></button><div class="treb-comment-box"><textarea></textarea><div><button data-command="clear-comment">Clear</button> <button data-command="update-comment">Save</button></div></div></div></div><div composite><button data-command="border-bottom" data-target="border" title="Bottom border"></button><div class="treb-menu"><button dropdown title="Border options"></button><div class="treb-icon-buttons" data-replace="border"><button data-command="border-top" title="Top border"></button> <button data-command="border-left" title="Left border"></button> <button data-command="border-right" title="Right border"></button> <button data-command="border-bottom" title="Bottom border"></button> <button data-command="border-double-bottom" title="Double bottom border"></button> <button data-command="border-outside" title="Outside borders"></button> <button data-command="border-all" title="All borders"></button> <button data-command="border-none" title="Clear borders"></button><div separator></div><div class="treb-menu treb-color-menu treb-submenu" data-color-command="border-color" data-replace-color="border" title="Border color" data-default-color-text="Default border color"><button data-icon="palette" data-color-bar="border" data-color="{}"></button></div></div></div></div><div composite><button data-command="fill-color" data-color-bar="fill" data-color="{}" title="Fill color"></button><div class="treb-menu treb-color-menu" data-color-command="fill-color" data-replace-color="fill" data-default-color-text="No fill"><button dropdown title="Color options"></button><div class="treb-color-chooser"><div class="treb-caption">Theme colors</div><div class="treb-swatches"></div><div class="treb-caption">No color</div><div class="treb-default-swatch"><button class="treb-default-color" data-command="set-color" data-color="{}"></button> <span class="treb-default-color-label" data-command="set-color" data-color="{}">...</span></div><div class="treb-caption">Other colors</div><div class="treb-swatches"></div><div><input placeholder="New color" class="treb-color-input"> <button data-command="set-color" data-color=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg></button></div></div></div></div><div composite><button data-command="text-color" data-color-bar="text" data-color="{}" title="Text color"></button><div class="treb-menu treb-color-menu" data-color-command="text-color" data-replace-color="text" data-default-color-text="Default text color"><button dropdown title="Color options"></button></div></div><div composite font-scale><div class="treb-font-scale-icon"></div><input class="treb-font-scale" title="Font scale"><div class="treb-menu"><button dropdown title="Font scale options"></button><div><button data-command="font-scale" data-scale="0.8">0.80</button> <button data-command="font-scale" data-scale="0.9">0.90</button> <button data-command="font-scale" data-scale="1.0">1.00</button> <button data-command="font-scale" data-scale="1.1">1.10</button> <button data-command="font-scale" data-scale="1.25">1.25</button> <button data-command="font-scale" data-scale="1.5">1.50</button> <button data-command="font-scale" data-scale="2.0">2.00</button></div></div></div><div composite font-stack><button class="treb-font-stack" data-command="font-stack" data-font-stack="" title="Font stack"></button><div class="treb-menu"><button dropdown title="Font stack options"></button><div><button data-command="font-stack" data-font-stack="default"></button> <button data-command="font-stack" data-font-stack="transitional"></button> <button data-command="font-stack" data-font-stack="monospace"></button> <button data-command="font-stack" data-font-stack="handwritten"></button> <button data-command="font-stack" data-font-stack="ui"></button></div></div></div><div composite><input class="treb-number-format" title="Number format"><div class="treb-menu"><button dropdown title="Number formats"></button><div class="treb-number-format-menu"></div></div></div><div class="treb-split"><button data-command="decrease-precision" title="Decrease precision"></button> <button data-command="increase-precision" title="Increase precision"></button></div><div class="treb-menu"><button data-icon="layout" title="Rows & columns"></button><div><button data-command="insert-row">Insert row</button> <button data-command="insert-column">Insert column</button> <button data-command="delete-row">Delete row</button> <button data-command="delete-column">Delete column</button><div separator add-remove-sheet></div><button data-command="insert-sheet" add-remove-sheet>Add sheet</button> <button data-command="delete-sheet" add-remove-sheet>Delete sheet</button></div></div><div composite chart-menu><button data-command="insert-column-chart" data-target="annotation" title="Insert column chart"></button><div class="treb-menu"><button dropdown title="Chart options"></button><div class="treb-icon-buttons" data-replace="annotation"><button data-command="insert-column-chart" title="Insert column chart"></button> <button data-command="insert-donut-chart" title="Insert donut chart"></button> <button data-command="insert-bar-chart" title="Insert bar chart"></button> <button data-command="insert-line-chart" title="Insert line chart"></button><div separator></div><button data-command="insert-image" title="Insert image"></button></div></div></div><button data-command="recalculate" title="Recalculate" recalculate-button></button>';var io={close_dialog:"Close dialog",insert_function:"Insert function...",delete_sheet:"Delete current sheet",add_sheet:"Add sheet",document_modified:"This document has been modified from the original version.",recalculate:"Recalculate",toggle_toolbar:"Toggle toolbar",export:"Export as XLSX",revert:"Revert to original version",about:"What's this?",toggle_sidebar:"Toggle sidebar"},rt=class{root;sheet;border_color;color_bar_elements={};replace_targets={};layout_element;views;revert_button;revert_state=!1;toolbar_controls={};swatch_lists={};DOM;constructor(e){typeof e=="string"&&(e=document.querySelector(e)),this.DOM=H.GetInstance(e?.ownerDocument),this.DOM.view&&e instanceof this.DOM.view.HTMLElement&&(this.root=e,this.DOM.doc?.head.querySelector("style[treb-stylesheet]")||this.DOM.doc?.head.prepend(this.DOM.Create("style",void 0,void 0,{text:eo,attrs:{"treb-stylesheet":""}})))}CoerceAttributeValue(e){if(e===null||e.toString().toLowerCase()==="true"||e==="")return!0;if(e.toLowerCase()==="false")return!1;{let t=Number(e);if(!isNaN(t))return t}return e||""}ParseOptionAttributes(){let e={};if(this.root){let t=this.root.getAttributeNames();for(let r of t){switch(r){case"class":case"style":case"id":continue;case"data-options":case"options":{let n=(this.root.getAttribute(r)||"").split(",");for(let o of n){let s=o.split(/=/);s.length===1?e[s[0]]=!0:e[s[0]]=this.CoerceAttributeValue(s[1])}}continue;case"data-treb":continue;case"inline-document":continue;case"src":e.document=this.root.getAttribute("src")||void 0;continue}e[r.replace(/-/g,"_")]=this.CoerceAttributeValue(this.root.getAttribute(r))}}return{...e}}AttachElement(e={}){if(e={...this.ParseOptionAttributes(),...e},this.root){if(!e.headless){let t=this.root.getBoundingClientRect();(!t.width||!t.height)&&this.root.classList.add("treb-default-size")}if(this.root.hasAttribute("inline-document")){let t=this.root.getAttribute("inline-document")||"";for(let r of Array.from(this.root.children))if(this.DOM.view&&r instanceof this.DOM.view.HTMLScriptElement&&r.type==="application/json"){let i=r.getAttribute("name")||"";if(i===t||!i&&t==="true"){let n=r.textContent;if(n)try{e.inline_document=JSON.parse(n)}catch(o){console.error(o)}break}}e.inline_document||console.warn("inline document failed")}this.root.innerHTML=to,e.container=this.root.querySelector(".treb-layout-spreadsheet")}this.sheet=new vr(e),this.root&&this.CreateLayout(this.sheet,this.root)}CreateLayout(e,t){new ResizeObserver(()=>e.Resize()).observe(t),this.layout_element=t.querySelector(".treb-main");let i=t.querySelector(".treb-toggle-sidebar-button");if(i&&this.layout_element){let c=this.layout_element;i.addEventListener("click",()=>{let d=c.getAttribute("collapsed");typeof d=="string"&&(d===""||d==="true")?c.removeAttribute("collapsed"):c.setAttribute("collapsed","")})}(e.options.toolbar==="show"||e.options.toolbar==="show-narrow")&&this.layout_element?.setAttribute("toolbar",""),e.options.collapsed&&this.layout_element?.setAttribute("collapsed","");let n=t.querySelector("[data-command=revert-indicator]");this.DOM.view&&n instanceof this.DOM.view.HTMLElement&&(e.options.revert_indicator?n.addEventListener("click",()=>{e.HandleToolbarMessage({command:"revert-indicator"})}):n.style.display="none"),t.querySelector(".treb-layout-sidebar")?.addEventListener("click",c=>{let d=c.target;if(d.dataset.command)switch(d.dataset.command){case"toggle-toolbar":this.ToggleToolbar();break;default:e.HandleToolbarMessage({command:d.dataset.command});break}}),e.options.toolbar&&this.AttachToolbar(e,t);let s={"table-button":!!e.options.table_button,revert:!!e.options.revert_button,toolbar:!!e.options.toolbar,export:!!e.options.export,"insert-function":!!e.options.insert_function_button,resize:!!e.options.resizable,"add-tab":!!e.options.add_tab,"delete-tab":!!e.options.delete_tab||!!e.options.add_tab};for(let[c,d]of Object.entries(s))if(!d){let u=this.layout_element.querySelectorAll(`[data-conditional=${c}]`);for(let h of Array.from(u))h.style.display="none"}if(e.options.revert_button&&(this.revert_button=this.layout_element.querySelector("[data-command=revert]")||void 0),e.options.resizable){let c={width:0,height:0},d={x:0,y:0},u={x:0,y:0};this.views=t.querySelector(".treb-views")||void 0;let h,m,f=t.querySelector(".treb-layout-resize-handle"),p=()=>g(),b=x=>{x.buttons===0?g():(u.x=x.screenX-d.x,u.y=x.screenY-d.y,m&&(m.style.width=c.width+u.x+"px",m.style.height=c.height+u.y+"px"))},g=()=>{if(u.x||u.y){let x=t.getBoundingClientRect();e.options.constrain_width||(t.style.width=x.width+u.x+"px"),t.style.height=x.height+u.y+"px"}h&&(h.removeEventListener("mouseup",p),h.removeEventListener("mousemove",b),h.parentElement?.removeChild(h),h=void 0),m?.parentElement?.removeChild(m),m=void 0};f.addEventListener("mousedown",x=>{x.stopPropagation(),x.preventDefault();let v=t.querySelector(".treb-main");m=this.DOM.Div("treb-resize-rect",v),h=this.DOM.Div("treb-resize-mask",v,{attrs:{style:"cursor: nw-resize;"},events:{mouseup:p,mousemove:b}}),d.x=x.screenX,d.y=x.screenY,u.x=0,u.y=0;let w=this.views?.querySelectorAll(".treb-spreadsheet-body"),_=Array.from(w||[]).map(C=>C.getBoundingClientRect());if(_.length){let C=JSON.parse(JSON.stringify(_.shift()));for(let R of _)C.top=Math.min(R.top,C.top),C.left=Math.min(R.left,C.left),C.right=Math.max(R.right,C.right),C.bottom=Math.max(R.bottom,C.bottom);let S=C.right-C.left,A=C.bottom-C.top;m.style.top=C.top+"px",m.style.left=C.left+"px",m.style.width=S+"px",m.style.height=A+"px",c.width=S,c.height=A}})}let a=Array.from(this.layout_element.querySelectorAll("[data-title]"));for(let c of a)if(c instanceof HTMLElement){if(c.dataset.activeTitle)continue;c.dataset.title&&io[c.dataset.title]&&(c.title=io[c.dataset.title])}setTimeout(()=>this.layout_element?.setAttribute("animate",""),250)}ToggleToolbar(){if(this.layout_element){let e=this.layout_element.getAttribute("toolbar");typeof e=="string"&&(e===""||e==="true")?this.layout_element.removeAttribute("toolbar"):this.layout_element.setAttribute("toolbar","")}}UpdateSelectionStyle(e,t,r){let i=e.selection_state;r.value="";for(let a of Object.values(this.toolbar_controls))a&&(a.removeAttribute("active"),a.dataset.inactiveTitle&&(a.title=a.dataset.inactiveTitle));let n=a=>{a&&(a.setAttribute("active",""),a.dataset.activeTitle&&(a.title=a.dataset.activeTitle))};if(i.comment&&(n(this.toolbar_controls.comment),r.value=i.comment),i.style?.locked&&n(this.toolbar_controls.locked),i.frozen&&n(this.toolbar_controls.freeze),i.style?.wrap&&n(this.toolbar_controls.wrap),this.toolbar_controls.table&&(i.table?(n(this.toolbar_controls.table),this.toolbar_controls.table.dataset.command="remove-table"):this.toolbar_controls.table.dataset.command="insert-table"),this.toolbar_controls.merge&&(i.merge?(n(this.toolbar_controls.merge),this.toolbar_controls.merge.dataset.command="unmerge-cells"):this.toolbar_controls.merge.dataset.command="merge-cells"),this.toolbar_controls.stack)if(i.style?.font_face)if(i.style.font_face.startsWith("stack:")){let a=i.style.font_face.substring(6);this.toolbar_controls.stack.textContent=jt[a]||"",this.toolbar_controls.stack.dataset.fontStack=a}else this.toolbar_controls.stack.textContent="",this.toolbar_controls.stack.dataset.fontStack="";else this.toolbar_controls.stack.textContent=jt.default||"",this.toolbar_controls.stack.dataset.fontStack="default";let o=this.toolbar_controls.format;o&&(i.style?.number_format?o.value=L.SymbolicName(i.style.number_format)||i.style.number_format:o.value="General");let s=this.toolbar_controls.scale;switch(s&&(s.value=e.FormatNumber(i.relative_font_size||1,"0.00")),i.style?.horizontal_align){case"left":n(this.toolbar_controls.left);break;case"center":n(this.toolbar_controls.center);break;case"right":n(this.toolbar_controls.right);break}switch(i.style?.vertical_align){case"top":n(this.toolbar_controls.top);break;case"middle":n(this.toolbar_controls.middle);break;case"bottom":n(this.toolbar_controls.bottom);break}}UpdateDocumentStyles(e,t){{let s=this.DOM.Fragment(),a=e.document_styles.theme_colors.length,c=["Background","Text","Background","Text","Accent"];if(a){let m=e.document_styles.theme_colors[0].length;for(let f=0;f<m;f++)for(let p=0;p<a;p++){let b=e.document_styles.theme_colors[p][f],g=`background: ${b.resolved};`,x=c[p]||c[4];Ke(b.color)&&b.color.tint?x+=` (${(b.color.tint>0?"+":"")+b.color.tint*100}%)`:p===0?this.color_bar_elements.fill?.style.setProperty("--treb-default-color",b.resolved):p===1&&(this.color_bar_elements.text?.style.setProperty("--treb-default-color",b.resolved),this.color_bar_elements.border?.style.setProperty("--treb-default-color",b.resolved)),this.DOM.Create("button",void 0,s,{attrs:{style:g,title:x},data:{command:"set-color",color:JSON.stringify(b.color)}})}}this.swatch_lists.theme?.replaceChildren(s),s=this.DOM.Fragment();let d=["Black","White","Gray","Red","Orange","Yellow","Green","Blue","Indigo","Violet"],u=d.map(m=>m.toLowerCase()),h=e.document_styles.colors.filter(m=>!u.includes(m.toLowerCase()));for(let m of[...d,...h]){let f=`background: ${m.toLowerCase()};`;this.DOM.Create("button",void 0,s,{attrs:{style:f,title:m},data:{command:"set-color",color:JSON.stringify({text:m.toLowerCase()})}})}this.swatch_lists.other?.replaceChildren(s)}let r=["General","Number","Integer","Percent","Fraction","Accounting","Currency","Scientific"],i=["Timestamp","Long Date","Short Date"];for(let s of e.document_styles.number_formats){if(L.SymbolicName(L.Translate(s)))continue;L.Get(s).date_format?i.push(s):r.push(s)}let n=s=>this.DOM.Create("button",void 0,void 0,{text:s,data:{format:s,command:"number-format"}}),o=this.DOM.Fragment();o.append(...r.map(s=>n(s))),o.append(this.DOM.Div(void 0,void 0,{attrs:{separator:""}})),o.append(...i.map(s=>n(s))),t.textContent="",t.append(o)}UpdateRevertState(e){let t=e.can_revert;this.revert_state!==t&&(this.revert_state=t,(this.revert_button||e.options.revert_indicator)&&(this.revert_state?this.views?.classList.add("treb-can-revert"):this.views?.classList.remove("treb-can-revert"),this.revert_button&&(this.revert_button.dataset.canRevert=t?"true":"false",t?(this.revert_button.classList.remove("sidebar-disabled"),this.revert_button.title="Revert to original version"):(this.revert_button.classList.add("sidebar-disabled"),this.revert_button.title="This is the original version of the document"))))}ReplaceTemplate(e,t,r=!0){let i=e.querySelector(t);if(i&&i.parentElement){for(let n of Array.from(i.content.children))i.parentElement.insertBefore(n,i);r&&i.parentElement.removeChild(i)}else console.warn("template not found",t)}AttachToolbar(e,t){let r=t.querySelector(".treb-layout-header"),i=t.querySelector(".treb-toolbar");i.innerHTML=ro;let n=[];if(e.options.toolbar==="narrow"||e.options.toolbar==="show-narrow"?n.push(...Array.from(i.querySelectorAll("[wide]"))):n.push(...Array.from(i.querySelectorAll("[narrow]"))),e.options.file_menu||n.push(i.querySelector("[file-menu]")),e.options.indent_buttons||n.push(i.querySelector("[indent-group]")),e.options.font_scale||n.push(i.querySelector("[font-scale]")),!e.options.font_stack)n.push(i.querySelector("[font-stack]"));else{let v=i.querySelectorAll("[font-stack] button[data-font-stack]");for(let w of v)if(w.dataset.fontStack){let _=jt[w.dataset.fontStack];w.textContent=_||""}}e.options.chart_menu||n.push(i.querySelector("[chart-menu]")),e.options.freeze_button||n.push(i.querySelector("[freeze-button]")),e.options.table_button||n.push(i.querySelector("[table-button]")),!e.options.add_tab&&!e.options.delete_tab&&n.push(...Array.from(i.querySelectorAll("[add-remove-sheet]"))),e.options.toolbar_recalculate_button||n.push(i.querySelector("[recalculate-button]"));for(let v of n)v&&v.parentElement?.removeChild(v);let o=i.querySelector(".treb-color-chooser"),s=i.querySelector(".treb-comment-box textarea");for(let[v,w]of Object.entries({top:"[wide] [data-command=align-top]",middle:"[wide] [data-command=align-middle]",bottom:"[wide] [data-command=align-bottom]",left:"[wide] [data-command=justify-left]",right:"[wide] [data-command=justify-right]",center:"[wide] [data-command=justify-center]",wrap:"[data-command=wrap-text]",merge:"[data-id=merge]",comment:"[data-icon=comment]",locked:"[data-command=lock-cells]",freeze:"[data-command=freeze-panes]",table:"[data-icon=table]",format:"input.treb-number-format",scale:"input.treb-font-scale",stack:"button.treb-font-stack"})){let _=i.querySelector(w);_&&(this.toolbar_controls[v]=_)}let a=o.querySelectorAll(".treb-swatches");this.swatch_lists={theme:a[0],other:a[1]};let c=t.querySelector("[data-command=increase-precision");c&&(c.textContent=this.sheet?.FormatNumber(0,"0.00")||""),c=t.querySelector("[data-command=decrease-precision"),c&&(c.textContent=this.sheet?.FormatNumber(0,"0.0")||""),c=i.querySelector("[data-command=update-comment]"),s.addEventListener("keydown",v=>{v.key==="Enter"&&(v.shiftKey||v.ctrlKey)&&c.click()});for(let v of["border","annotation","align","justify"])this.replace_targets[v]=i.querySelector(`[data-target=${v}`);for(let v of["fill","text","border"])this.color_bar_elements[v]=i.querySelector(`[data-color-bar=${v}]`);i.addEventListener("click",v=>{let w=v.target,_={format:w.dataset.format,scale:w.dataset.scale,font_stack:w.dataset.fontStack},C=w?.dataset.command;if(C){let S=w.parentElement?.dataset.replace;if(S){let A=this.replace_targets[S];A&&(A.dataset.command=C,A.title=w.title||"")}switch(/^border-/.test(C)&&(_.color=this.border_color||{}),C){case"text-color":case"fill-color":_.color={};try{_.color=JSON.parse(w.dataset.color||"{}")}catch(A){console.error(A)}break;case"set-color":C=o.dataset.colorCommand||"",_.color={};try{_.color=JSON.parse(w.dataset.color||"{}")}catch(A){console.error(A)}if(C==="border-color"&&(this.border_color=_.color),o.dataset.target){let A=this.color_bar_elements[o.dataset.target];A&&(A.style.setProperty("--treb-color-bar-color",w.style.backgroundColor),A.dataset.color=w.dataset.color||"{}")}break;case"update-comment":_.comment=s.value;break}e.HandleToolbarMessage({command:C,..._})}});let d=(v,w)=>{let _=i.querySelector(v);if(_){let C="";_.addEventListener("focusin",()=>C=_.value),_.addEventListener("keydown",S=>{switch(S.key){case"Escape":_.value=C,e.Focus();break;case"Enter":w(_.value)||(_.value=C,e.Focus());break;default:return}S.stopPropagation(),S.preventDefault()})}};d("input.treb-number-format",v=>v?(e.HandleToolbarMessage({command:"number-format",format:v}),!0):!1),d("input.treb-font-scale",v=>{let w=Number(v);return!w||isNaN(w)?(console.warn("invalid scale value"),!1):(e.HandleToolbarMessage({command:"font-scale",scale:w}),!0)});let u=o.querySelector("input"),h=o.querySelector("input + button");u.addEventListener("input",v=>{if(v instanceof InputEvent&&v.isComposing)return;h.style.background=u.value||"";let w=h.style.backgroundColor||"#fff",_=oe.MeasureColor(w),C=j.RGBToHSL(_[0],_[1],_[2]);h.style.color=C.l>.5?"#000":"#fff",h.dataset.color=JSON.stringify(h.style.backgroundColor?{text:h.style.backgroundColor}:{})}),u.addEventListener("keydown",v=>{v.key==="Enter"&&(v.stopPropagation(),v.preventDefault(),h.click())}),/firefox/i.test(navigator.userAgent)?r.addEventListener("scroll",()=>{this.DOM.view&&this.DOM.doc?.activeElement instanceof this.DOM.view.HTMLElement&&this.DOM.doc.activeElement?.blur()}):r.addEventListener("scroll",()=>e.Focus());let m=!1,f=v=>{v.key==="Escape"&&(v.stopPropagation(),v.preventDefault(),Promise.resolve().then(()=>e.Focus()))},p=v=>{if(m){if(v.relatedTarget instanceof Node&&i.contains(v.relatedTarget))return;i.removeEventListener("keydown",f),i.removeEventListener("focusout",p),m=!1}},b=v=>{let w=v.target,_=w?.parentElement;if(w?.classList.contains("treb-menu")){_=w;for(let C of Array.from(_.children))if(C.tagName==="BUTTON"){w=C;break}}else if(!_?.classList.contains("treb-menu"))return;if(w&&_){if(m||(i.addEventListener("focusout",p),i.addEventListener("keydown",f),m=!0),_.dataset.colorCommand){o.querySelector(".treb-default-color")?.setAttribute("title",_.dataset.defaultColorText||"Default color");let te=o.querySelector(".treb-default-color-label");te&&(te.textContent=_.dataset.defaultColorText||"Default color"),_.appendChild(o),o.dataset.colorCommand=_.dataset.colorCommand,o.dataset.target=_.dataset.replaceColor||""}let C=_.querySelector("div"),S=r.getBoundingClientRect(),A=w.getBoundingClientRect(),{left:R}=A,k=_.parentElement;k?.hasAttribute("composite")&&(R=k.firstElementChild.getBoundingClientRect().left);let z=C.getBoundingClientRect();_.classList.contains("treb-submenu")?(C.style.top=A.top-z.height/2+"px",R+A.width+6+z.width>S.right?C.style.left=R-6-z.width+"px":C.style.left=R+A.width+6+"px"):(C.style.top=A.bottom+"px",R+z.width>S.right-6?C.style.left=A.right-z.width+"px":C.style.left=R+"px");let W=C.querySelector("textarea");W&&requestAnimationFrame(()=>W.focus())}},g=this.root?.querySelector(".treb-number-format-menu");g&&(this.UpdateDocumentStyles(e,g),this.UpdateSelectionStyle(e,i,s),e.Subscribe(v=>{switch(v.type){case"focus-view":break;case"data":case"document-change":case"load":case"reset":this.UpdateDocumentStyles(e,g),this.UpdateSelectionStyle(e,i,s),this.UpdateRevertState(e);break;case"theme-change":this.UpdateDocumentStyles(e,g),this.UpdateSelectionStyle(e,i,s);break;case"annotation-selection":case"selection":this.UpdateSelectionStyle(e,i,s);break}}));let x=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);if(i.addEventListener("focusin",v=>{b(v)}),x){let v=Array.from(i.querySelectorAll(".treb-menu"));for(let w of v)w.tabIndex=0;i.addEventListener("mousedown",w=>{b(w)})}}};var wr=class{version="31.9.1";CreateSpreadsheet(e){let t=e.container,r=new rt(t);if(r.AttachElement(e),!r.sheet)throw new Error("construction failed");return r.sheet}},Us=new wr;if(typeof HTMLElement<"u"){class l extends HTMLElement{get sheet(){return this.instance.sheet}instance;constructor(){super(),this.instance=new rt(this)}connectedCallback(){this.instance.AttachElement()}}typeof customElements<"u"&&(customElements.get("treb-spreadsheet")?console.info("custom element treb-spreadsheet is already defined."):customElements.define("treb-spreadsheet",l))}export{Us as TREB,wr as TREBGlobal};
